<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E293B">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DropLit">
  <meta name="application-name" content="DropLit">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="DropLit - Voice-first idea capture app. Never lose your ideas again.">
  <title>DropLit</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #FF6B4A;
      --color-primary-dark: #E85A3A;
      --color-primary-light: #FF8A70;
      --color-recording: #EF4444;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-error: #EF4444;
      --color-merge: #8B5CF6;
      --color-bg: #F5F5F4;
      --color-bg-card: #FFFFFF;
      --color-bg-soft: #E7E5E4;
      --color-bg-btn: #E7E5E4;
      --color-text: #1C1917;
      --color-text-soft: #57534E;
      --color-text-muted: #78716C;
      --color-border: #D6D3D1;
      --color-active: #FF6B4A;
      --cat-tasks-bg: #FEF3C7; --cat-tasks-text: #92400E;
      --cat-ideas-bg: #E0E7FF; --cat-ideas-text: #3730A3;
      --cat-handmagic-bg: #FCE7F3; --cat-handmagic-text: #9D174D;
      --cat-design-bg: #D1FAE5; --cat-design-text: #065F46;
      --cat-bugs-bg: #FEE2E2; --cat-bugs-text: #991B1B;
      --cat-questions-bg: #E0F2FE; --cat-questions-text: #075985;
      --cat-sketch-bg: #FEE2E2; --cat-sketch-text: #DC2626;
      --cat-scan-bg: #DBEAFE; --cat-scan-text: #1D4ED8;
      --cat-photo-bg: #F3E8FF; --cat-photo-text: #7C3AED;
      --cat-audio-bg: #FEF9C3; --cat-audio-text: #854D0E;
      --cat-inbox-bg: #F5F5F4; --cat-inbox-text: #57534E;
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      --shadow-card: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-fab: 0 4px 14px rgba(255,107,74,0.4);
      --shadow-scroll: 0 2px 10px rgba(0,0,0,0.1);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
    body { font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); -webkit-font-smoothing: antialiased; }
    
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; max-width: 480px; margin: 0 auto; background: var(--color-bg); position: relative; padding-top: var(--safe-top); }

    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--color-bg-card); position: relative; padding-top: max(10px, env(safe-area-inset-top)); z-index: 100; }
    /* Shadow element - always at bottom of visible top bar area */
    .header::after { content: ''; position: absolute; left: 0; right: 0; bottom: -8px; height: 8px; background: linear-gradient(to bottom, rgba(0,0,0,0.06), transparent); pointer-events: none; z-index: 99; }
    /* When filters visible - hide header shadow, filters will have its own */
    body.filters-visible .header::after { display: none; }
    .logo-btn { width: 52px; height: 52px; border: none; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 3px 12px rgba(255,107,74,0.3); transition: all 0.2s; }
    .logo-btn:active { transform: scale(0.95); }
    .logo-btn svg { width: 22px; height: 22px; }
    .logo-btn.filters-open { transform: rotate(180deg); }
    
    /* Filters toggle - hidden by default */
    .filters-wrap { position: relative; z-index: 99; }
    .filters-wrap::after { content: ''; position: absolute; left: 0; right: 0; top: 100%; height: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.08), transparent); pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100; }
    body.filters-visible .filters-wrap::after { opacity: 1; }
    .filters { max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease; padding: 0; background: var(--color-bg-card); }
    body.filters-visible .filters { max-height: 200px; opacity: 1; padding: 8px 10px; }
    body.filters-visible .logo-btn { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
    .header-title { font-size: 0.9rem; font-weight: 700; color: var(--color-text); display: none; }
    .header-title span { color: var(--color-primary); }
    .header-add-btn { position: absolute; left: 50%; transform: translateX(-50%); display: flex; align-items: center; justify-content: center; gap: 6px; height: 48px; padding: 0 20px; background: linear-gradient(135deg, #8B5CF6, #7C3AED); border: none; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.8rem; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.15s; box-shadow: 0 3px 12px rgba(139,92,246,0.3); }
    .header-add-btn:hover { transform: translateX(-50%) scale(1.03); box-shadow: 0 4px 14px rgba(139,92,246,0.4); }
    .header-add-btn:active { transform: translateX(-50%) scale(0.97); }
    .header-add-btn svg { width: 12px; height: 12px; }
    body.chat-open .header-add-btn { display: none; }
    .btn-icon { width: 52px; height: 52px; border: none; background: var(--color-bg); border: 2px solid var(--color-border); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-soft); flex-shrink: 0; transition: all 0.15s; }
    .btn-icon:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .btn-icon:active { transform: scale(0.95); }
    .btn-icon.active { background: linear-gradient(135deg, #8B5CF6, #7C3AED); border-color: transparent; color: white; }

    .network-banner { display: none; padding: 6px; background: var(--color-error); color: white; font-size: 0.7rem; font-weight: 600; text-align: center; }
    .network-banner.show { display: block; }
    .warning { padding: 8px; background: #FEF3C7; color: #92400E; font-size: 0.75rem; text-align: center; font-weight: 600; display: none; }

    /* Filters */
    .time-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 8px; }
    .time-btn { height: 34px; padding: 0 12px; border: 2px solid transparent; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .time-btn:active { transform: scale(0.97); }
    .time-btn[data-time="all"] { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .time-btn[data-time="all"] .cnt { background: rgba(255,255,255,0.25); color: white; }
    .time-btn:not([data-time="all"]).active { border-color: var(--color-active); background: var(--color-bg-btn); color: var(--color-text-soft); }
    .time-btn:not([data-time="all"]).active .cnt { background: var(--color-active); color: white; }
    .cnt { min-width: 20px; height: 20px; padding: 0 6px; background: rgba(0,0,0,0.08); border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; }
    .sort-btn { height: 34px; width: 40px; padding: 0; border: 2px solid transparent; background: var(--color-bg-btn); border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .sort-btn:active { transform: scale(0.97); }
    .sort-btn.desc { border-color: var(--color-active); }

    .cat-row { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; scroll-behavior: smooth; padding: 2px 4px; }
    .cat-row::-webkit-scrollbar { display: none; }
    .cat { flex-shrink: 0; height: 34px; padding: 0 12px; border: 2px solid transparent; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .cat:active { transform: scale(0.97); }
    .cat.active { border-color: var(--color-active); }
    .cat[data-category="tasks"] { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .cat[data-category="tasks"] .cnt { background: rgba(146,64,14,0.15); }
    .cat[data-category="ideas"] { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .cat[data-category="ideas"] .cnt { background: rgba(55,48,163,0.15); }
    .cat[data-category="handmagic"] { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .cat[data-category="handmagic"] .cnt { background: rgba(157,23,77,0.15); }
    .cat[data-category="design"] { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .cat[data-category="design"] .cnt { background: rgba(6,95,70,0.15); }
    .cat[data-category="bugs"] { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .cat[data-category="bugs"] .cnt { background: rgba(153,27,27,0.15); }
    .cat[data-category="questions"] { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .cat[data-category="questions"] .cnt { background: rgba(7,89,133,0.15); }
    .cat[data-category="inbox"] { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .cat[data-category="inbox"] .cnt { background: rgba(0,0,0,0.08); }
    .cat[data-category="photo"] { background: var(--cat-photo-bg); color: var(--cat-photo-text); }
    .cat[data-category="photo"] .cnt { background: rgba(124,58,237,0.15); }
    .cat[data-category="sketch"] { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    .cat[data-category="sketch"] .cnt { background: rgba(220,38,38,0.15); }
    .cat[data-category="scan"] { background: var(--cat-scan-bg); color: var(--cat-scan-text); }
    .cat[data-category="scan"] .cnt { background: rgba(29,78,216,0.15); }
    .cat-add { flex-shrink: 0; width: 34px; height: 34px; border: 2px dashed var(--color-border); border-radius: var(--radius-full); background: transparent; color: var(--color-text-muted); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .cat-add:active { border-color: var(--color-primary); color: var(--color-primary); }

    /* Ideas container */
    .ideas-wrap { flex: 1; overflow-y: auto; padding: 12px 14px 100px; -webkit-overflow-scrolling: touch; position: relative; z-index: 1; }
    .ideas { display: flex; flex-direction: column; gap: 2px; }
    .date-sep { display: flex; align-items: center; justify-content: center; padding: 16px 0 8px; font-size: 0.65rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.08em; }

    /* Card */
    .card { background: var(--color-bg-card); border-radius: var(--radius-md); padding: 12px 14px; box-shadow: var(--shadow-card); cursor: pointer; transition: all 0.15s; margin-bottom: 8px; position: relative; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
    .card.active { box-shadow: 0 0 0 2px #8B5CF6, var(--shadow-card); }
    .card.editing { box-shadow: 0 0 0 2px #8B5CF6, var(--shadow-card); }
    .card.selected { box-shadow: 0 0 0 2px var(--color-merge), var(--shadow-card); background: #F5F3FF; }
    /* Checkbox removed in v0.8.2 */
    .card-checkbox { display: none !important; }
    .card-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .card-chars { font-size: 0.7rem; color: var(--color-text-muted); font-weight: 500; }
    .card-time { font-size: 0.7rem; color: var(--color-text-muted); font-weight: 500; margin-left: auto; }
    .card-cat { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.6rem; font-weight: 700; text-transform: uppercase; cursor: pointer; letter-spacing: 0.02em; }
    .card-cat:active { opacity: 0.8; }
    .card-cat.tasks { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .card-cat.ideas { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .card-cat.handmagic { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .card-cat.design { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .card-cat.bugs { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .card-cat.questions { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .card-cat.inbox { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .card-cat.sketch { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    
    /* Card markers */
    .card-marker { font-size: 0.9rem; margin-left: 6px; opacity: 0.9; }
    .card-marker.pop { animation: markerPop 0.2s ease; }
    @keyframes markerPop { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    
    /* Markers panel (shown when card is active) - BELOW actions */
    .card-markers { display: none; flex-wrap: wrap; gap: 6px; padding: 10px 12px; margin-top: 12px; border-top: 1px solid var(--color-border); background: var(--color-bg-btn); border-radius: var(--radius-md); }
    .card.active .card-markers { display: flex; }
    .marker-btn { width: 36px; height: 36px; border: none; background: var(--color-bg-card); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; opacity: 0.4; }
    .marker-btn:hover { opacity: 0.7; transform: scale(1.1); }
    .marker-btn:active { transform: scale(0.95); }
    .marker-btn.active { opacity: 1; background: var(--color-bg); box-shadow: 0 0 0 2px var(--color-primary); }
    .card-cat.scan { background: var(--cat-scan-bg); color: var(--cat-scan-text); }
    .card-cat.photo { background: var(--cat-photo-bg); color: var(--cat-photo-text); }
    .card-cat.audio { background: var(--cat-audio-bg); color: var(--cat-audio-text); }
    
    /* Audio Player in Card */
    .card-audio-player {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: var(--radius-md);
      padding: 16px;
      margin: 8px 0;
    }
    .audio-waveform {
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      margin-bottom: 12px;
    }
    .audio-waveform-bar {
      width: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      transition: background 0.1s;
    }
    .audio-waveform-bar.played {
      background: var(--color-primary);
    }
    .audio-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .audio-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .audio-btn:active {
      transform: scale(0.95);
    }
    .audio-btn.play {
      width: 56px;
      height: 56px;
      background: var(--color-primary);
    }
    .audio-btn.play:active {
      background: var(--color-primary-dark);
    }
    .audio-time {
      display: flex;
      justify-content: space-between;
      color: rgba(255,255,255,0.6);
      font-size: 0.75rem;
      margin-top: 8px;
    }
    .audio-meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .audio-meta-tag {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      border-radius: 4px;
    }
    
    .card-text { font-size: 1.05rem; line-height: 1.5; color: var(--color-text); padding-right: 30px; }
    .card-text a { color: var(--color-primary); text-decoration: underline; word-break: break-all; }
    .card-text a:active { opacity: 0.7; }
    .card-text.truncated { max-height: 500px; overflow: hidden; position: relative; } /* ~20 lines for text drops */
    .card-text.truncated::after { content: ''; position: absolute; bottom: 0; left: 0; right: 30px; height: 40px; background: linear-gradient(transparent, var(--color-bg-card)); pointer-events: none; }
    .card-text.expanded { max-height: none !important; }
    .card-text.expanded::after { display: none; }
    .card-image { width: 100%; max-height: 200px; object-fit: cover; border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer; }
    .card-image:active { opacity: 0.9; }
    .card-media-meta { font-size: 0.7rem; color: var(--color-text-muted); display: flex; gap: 10px; margin-bottom: 4px; }
    .card-notes { font-size: 0.85rem; color: var(--color-text-soft); line-height: 1.4; max-height: 60px; overflow: hidden; position: relative; } /* ~2-3 lines for photo captions */
    .card-notes::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 25px; background: linear-gradient(transparent, var(--color-bg-card)); pointer-events: none; }
    .card-notes.expanded { max-height: none; }
    .card-notes.expanded::after { display: none; }
    .card-more { display: none; padding: 8px 0 4px; font-size: 0.8rem; color: var(--color-primary); font-weight: 600; cursor: pointer; }
    .card-more.show { display: block; }
    /* No extra padding - checkboxes removed */
    .card-edit { display: none; margin-top: 10px; }
    .card.editing .card-text { display: none; }
    .card.editing .card-edit { display: block; }
    .card-ta { width: 100%; min-height: 180px; padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-family: var(--font-main); font-size: 1.05rem; line-height: 1.5; color: var(--color-text); resize: vertical; background: var(--color-bg); }
    .card-ta:focus { outline: none; border-color: var(--color-primary); }
    
    .card-actions { display: none; gap: 6px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--color-border); overflow-x: auto; scrollbar-width: none; }
    .card-actions::-webkit-scrollbar { display: none; }
    .card.active .card-actions { display: flex; }
    .card.editing .card-actions { display: none; }
    .select-mode .card.active .card-actions { display: none; }
    .card-edit-actions { display: none; gap: 6px; margin-top: 10px; }
    .card.editing .card-edit-actions { display: flex; }
    .act { flex-shrink: 0; height: 34px; padding: 0 12px; border: 2px solid var(--color-border); background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 700; color: var(--color-text-soft); cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 5px; white-space: nowrap; transition: all 0.15s; }
    .act:active { background: var(--color-bg-soft); }
    .act.primary { background: var(--color-primary); color: white; border-color: transparent; }
    .act.ai { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border-color: transparent; }
    .act.danger { background: rgba(239,68,68,0.1); color: #EF4444; border-color: rgba(239,68,68,0.5); }
    .act.merge { background: var(--color-merge); color: white; border-color: transparent; }
    .act.secondary { background: var(--color-bg-btn); color: var(--color-text-soft); }

    /* Empty state */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 30px; }
    .empty-icon { width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; opacity: 0.12; }
    .empty-icon svg { width: 100px; height: 100px; fill: #3B82F6; }
    .empty-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; color: var(--color-text-muted); }
    .empty-text { font-size: 0.85rem; color: var(--color-text-muted); }

    /* FAB - Record button */
    .fab-record { position: fixed; bottom: calc(24px + var(--safe-bottom)); right: 20px; width: 56px; height: 56px; border: none; background: #06B6D4; border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(6,182,212,0.4); z-index: 50; transition: all 0.2s; }
    .fab-record:active { transform: scale(0.95); }
    .fab-record.recording { background: var(--color-recording); animation: pulse 1.5s ease infinite; box-shadow: 0 4px 14px rgba(239,68,68,0.4); }
    .fab-record svg { width: 24px; height: 24px; color: white; }
    .select-mode .fab-record, .editing-mode .fab-record { display: none; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 12px rgba(239,68,68,0)} }

    /* FAB - Camera button */
    .fab-camera { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 20px; width: 56px; height: 56px; border: none; background: #FF6B4A; border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(255,107,74,0.4); z-index: 50; transition: all 0.2s; }
    .fab-camera:active { transform: scale(0.95); }
    .fab-camera svg { width: 24px; height: 24px; color: white; }
    .select-mode .fab-camera, .editing-mode .fab-camera { display: none !important; }
    .camera-input { display: none; }

    /* FAB - Plus button (center) */
    .fab-askai { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); height: 52px; padding: 0 24px; border: none; background: linear-gradient(135deg, #FF6B4A, #06B6D4); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 50; transition: all 0.2s; animation: askaiPulse 2.5s ease-in-out infinite; font-family: var(--font-main); font-size: 0.85rem; font-weight: 700; color: white; letter-spacing: 1px; text-transform: uppercase; }
    @keyframes askaiPulse { 
      0%, 100% { 
        transform: translateX(-50%) scale(1); 
        box-shadow: 0 0 20px rgba(255,107,74,0.6), 0 0 20px rgba(6,182,212,0.6), 0 0 40px rgba(255,107,74,0.3), 0 0 40px rgba(6,182,212,0.3); 
      } 
      50% { 
        transform: translateX(-50%) scale(1.05); 
        box-shadow: 0 0 30px rgba(255,107,74,0.8), 0 0 30px rgba(6,182,212,0.8), 0 0 60px rgba(255,107,74,0.5), 0 0 60px rgba(6,182,212,0.5); 
      } 
    }
    .fab-askai:hover { animation: none; transform: translateX(-50%) scale(1.05); box-shadow: 0 0 35px rgba(255,107,74,0.8), 0 0 35px rgba(6,182,212,0.8); }
    .fab-askai:active { transform: translateX(-50%) scale(0.97); }
    .fab-askai .sparkle { font-size: 1.1rem; animation: sparkle 1.5s ease-in-out infinite; }
    @keyframes sparkle { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.15); } }
    .select-mode .fab-askai, .editing-mode .fab-askai { display: none !important; }

    /* Ask AI Panel - Full Screen Slide Up */
    .ask-ai-panel { position: fixed; inset: 0; top: 0; background: var(--color-bg-card); border-radius: 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); }
    .ask-ai-panel.show { transform: translateY(0); }
    .ask-ai-handle { padding: 8px 0 4px; display: flex; justify-content: center; cursor: grab; background: linear-gradient(135deg, #8B5CF6, #7C3AED); padding-top: max(8px, env(safe-area-inset-top)); }
    .ask-ai-handle-bar { width: 40px; height: 4px; background: rgba(255,255,255,0.4); border-radius: 3px; }
    .ask-ai-header { background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; padding: 8px 20px 14px; display: flex; align-items: center; justify-content: space-between; }
    .ask-ai-header-left { display: flex; align-items: center; gap: 12px; }
    .ask-ai-avatar { width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
    .ask-ai-title { font-size: 1.15rem; font-weight: 600; }
    .ask-ai-subtitle { font-size: 0.8rem; opacity: 0.85; }
    /* Speaking indicator removed - status shown in subtitle */
    @keyframes speakPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    .ask-ai-close { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.2); border-radius: 50%; color: white; font-size: 1.3rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
    .ask-ai-close:hover { background: rgba(255,255,255,0.3); }
    .ask-ai-messages { flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 16px; background: var(--color-bg); }
    .ask-ai-message { display: flex; flex-direction: column; max-width: 85%; animation: msgFadeIn 0.3s ease; }
    @keyframes msgFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .ask-ai-message.user { align-self: flex-end; }
    .ask-ai-message.ai { align-self: flex-start; }
    .ask-ai-bubble { padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; }
    .ask-ai-message.user .ask-ai-bubble { background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border-bottom-right-radius: 4px; }
    .ask-ai-message.ai .ask-ai-bubble { background: var(--color-bg-card); color: var(--color-text); border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-bottom-left-radius: 4px; }
    .ask-ai-time { font-size: 0.7rem; color: var(--color-text-muted); margin-top: 4px; padding: 0 6px; }
    .ask-ai-message.user .ask-ai-time { text-align: right; }
    .ask-ai-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .ask-ai-message.user .ask-ai-actions { justify-content: flex-end; }
    .ask-ai-action-btn { height: 34px; padding: 0 16px; border: 2px solid var(--color-border); border-radius: var(--radius-full); background: var(--color-bg-card); font-family: var(--font-main); font-size: 0.75rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; }
    .ask-ai-action-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .ask-ai-action-btn.speak-btn { border-color: #06B6D4; color: #06B6D4; }
    .ask-ai-action-btn.speak-btn:hover { background: #06B6D4; color: white; }
    .ask-ai-action-btn.created { border-color: #10B981; color: #10B981; cursor: default; }
    .ask-ai-action-btn.created:hover, .ask-ai-action-btn.created:focus, .ask-ai-action-btn.created:active { border-color: #10B981; color: #10B981; outline: none; background: var(--color-bg-card); }
    .ask-ai-action-btn.autodrop-saved { border-color: #10B981; color: #10B981; cursor: default; background: transparent; }
    .ask-ai-action-btn.autodrop-saved:hover, .ask-ai-action-btn.autodrop-saved:focus { border-color: #10B981; color: #10B981; outline: none; background: transparent; }
    .ask-ai-action-btn:focus { outline: none; }
    .ask-ai-action-btn.primary { background: linear-gradient(135deg, #8B5CF6, #7C3AED); border-color: transparent; color: white; }
    .ask-ai-action-btn.primary:hover { transform: scale(1.03); }
    .ask-ai-typing { display: flex; align-items: center; gap: 5px; padding: 14px 18px; background: var(--color-bg-card); box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 18px; border-bottom-left-radius: 4px; width: fit-content; }
    .ask-ai-typing-dot { width: 8px; height: 8px; background: #8B5CF6; border-radius: 50%; animation: typingPulse 1.4s infinite; }
    .ask-ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ask-ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingPulse { 0%, 60%, 100% { opacity: 0.3; transform: scale(1); } 30% { opacity: 1; transform: scale(1.2); } }
    .ask-ai-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; }
    .ask-ai-empty-icon { font-size: 4rem; margin-bottom: 20px; }
    .ask-ai-empty-title { font-size: 1.2rem; font-weight: 600; color: var(--color-text); margin-bottom: 8px; }
    .ask-ai-empty-text { font-size: 0.95rem; color: var(--color-text-muted); line-height: 1.5; max-width: 280px; }
    .ask-ai-prompts { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 24px; justify-content: center; }
    .ask-ai-prompt { padding: 10px 16px; background: var(--color-bg-card); border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.85rem; color: var(--color-text-soft); cursor: pointer; transition: all 0.15s; }
    .ask-ai-prompt:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .ask-ai-input-area { padding: 12px 16px; padding-bottom: max(24px, env(safe-area-inset-bottom)); background: var(--color-bg-card); border-top: 1px solid var(--color-border); flex-shrink: 0; }
    .ask-ai-input-row { display: flex; align-items: center; gap: 10px; }
    .ask-ai-input { flex: 1; padding: 14px 18px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 1rem; background: var(--color-bg); color: var(--color-text); outline: none; transition: border-color 0.15s; }
    .ask-ai-input:focus { border-color: var(--color-primary); }
    .ask-ai-input::placeholder { color: var(--color-text-muted); }
    .ask-ai-btn { width: 48px; height: 48px; min-width: 48px; min-height: 48px; max-width: 48px; max-height: 48px; flex: 0 0 48px; align-self: center; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .ask-ai-btn-voice { background: var(--color-bg); border: 2px solid var(--color-border); color: var(--color-text-soft); }
    .ask-ai-btn-voice:hover { border-color: #FF6B4A; color: #FF6B4A; }
    .ask-ai-btn-voice.recording { background: #FF6B4A; border-color: #FF6B4A; color: white; animation: pulse 1s infinite; }
    .ask-ai-btn-send { background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; }
    .ask-ai-btn-send:hover { transform: scale(1.05); }
    .ask-ai-btn-send:disabled { background: var(--color-border); cursor: not-allowed; transform: none; }
    .ask-ai-char-count { text-align: right; font-size: 0.7rem; color: var(--color-text-muted); margin-top: 8px; padding-right: 4px; }
    .ask-ai-char-count.warning { color: #FF6B4A; }
    
    /* Voice Mode: Large mic button */
    .ask-ai-voice-large { display: none; width: 100%; padding: 18px 24px; border: 2px solid var(--color-border); border-radius: var(--radius-full); background: var(--color-bg); color: var(--color-text); font-family: var(--font-main); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; align-items: center; justify-content: center; gap: 12px; }
    .ask-ai-voice-large:hover { border-color: #10B981; background: rgba(16, 185, 129, 0.05); }
    .ask-ai-voice-large.listening { border-color: #10B981; background: rgba(16, 185, 129, 0.1); color: #10B981; animation: pulse 1.5s infinite; }
    .ask-ai-voice-large svg { flex-shrink: 0; }
    
    /* Voice Mode: Header buttons */
    .ask-ai-header-btn { height: 44px; padding: 0 20px; border: none; border-radius: 22px; font-family: var(--font-main); font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; cursor: pointer; transition: all 0.15s; }
    .ask-ai-btn-done { background: rgba(255,255,255,0.2); color: white; }
    .ask-ai-btn-done:hover { background: rgba(255,255,255,0.3); }
    .ask-ai-btn-stop { background: #EF4444; color: white; display: none; }
    .ask-ai-btn-stop:hover { background: #DC2626; }
    .ask-ai-btn-autodrop { background: #10B981; color: white; }
    .ask-ai-btn-autodrop:hover { background: #059669; }
    .ask-ai-btn-autodrop.off { background: rgba(255,255,255,0.2); }
    .ask-ai-btn-autodrop.off:hover { background: rgba(255,255,255,0.3); }
    
    /* Voice Mode active: show large button, hide input row */
    .ask-ai-panel.voice-mode-active .ask-ai-input-row { display: none; }
    .ask-ai-panel.voice-mode-active .ask-ai-char-count { display: none; }
    .ask-ai-panel.voice-mode-active .ask-ai-voice-large { display: flex; }
    .ask-ai-panel.voice-mode-active .ask-ai-close { display: none; }
    .ask-ai-panel.voice-mode-active .ask-ai-btn-done { display: block; }
    
    /* Stop button visible when processing/speaking */
    .ask-ai-panel.aski-busy .ask-ai-btn-stop { display: block; }
    .ask-ai-panel.aski-busy .ask-ai-btn-done { display: none; }
    .ask-ai-panel.aski-busy .ask-ai-close { display: none; }
    
    body.chat-open .fab-camera, body.chat-open .fab-askai, body.chat-open .fab-record { opacity: 0; pointer-events: none; }

    /* Plus menu */
    .plus-menu { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--color-bg-card); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); z-index: 49; opacity: 0; visibility: hidden; transition: all 0.2s ease; min-width: 280px; overflow: hidden; padding: 12px; }
    .plus-menu.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .plus-menu-item { display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; transition: all 0.15s; border: 1.5px solid var(--color-border); border-radius: 12px; background: var(--color-bg); width: 100%; text-align: left; font-family: var(--font-main); margin-bottom: 8px; }
    .plus-menu-item:last-child { margin-bottom: 0; }
    .plus-menu-item:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .plus-menu-item:active { transform: scale(0.98); }
    .plus-menu-item .icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--color-bg-btn); border-radius: 10px; color: var(--color-text-muted); flex-shrink: 0; }
    .plus-menu-item .icon svg { width: 20px; height: 20px; }
    .plus-menu-item .info { flex: 1; }
    .plus-menu-item .title { font-size: 0.9rem; font-weight: 600; color: var(--color-text); }
    .plus-menu-item .desc { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 2px; }
    .plus-menu-divider { height: 1px; background: var(--color-border); margin: 8px 0; }
    .plus-menu-label { padding: 4px 4px 8px; font-size: 0.65rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .plus-menu-item.magic { border-color: rgba(139,92,246,0.3); background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(236,72,153,0.05)); }
    .plus-menu-item.magic .icon { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(236,72,153,0.15)); color: #8B5CF6; }
    .plus-menu-item.magic:hover { border-color: #8B5CF6; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.1)); }
    .plus-menu-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 48; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
    .plus-menu-backdrop.show { opacity: 1; visibility: visible; }
    
    /* AI Magic Modal */
    .magic-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .magic-modal.show { opacity: 1; visibility: visible; }
    .magic-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.2s; }
    .magic-modal.show .magic-content { transform: translateY(0); }
    .magic-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .magic-header h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .magic-header p { font-size: 0.85rem; opacity: 0.9; }
    .magic-body { padding: 20px; }
    .magic-photo-section { margin-bottom: 16px; }
    .magic-photo-btn { width: 100%; padding: 14px; border: 2px dashed var(--color-border); border-radius: 12px; background: var(--color-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); transition: all 0.2s; }
    .magic-photo-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .magic-photo-btn.has-photo { border-style: solid; border-color: #10B981; background: rgba(16,185,129,0.05); color: #059669; }
    .magic-photo-preview { position: relative; margin-top: 12px; border-radius: 12px; overflow: hidden; }
    .magic-photo-preview img { width: 100%; max-height: 150px; object-fit: cover; display: block; }
    .magic-photo-remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border: none; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .magic-photo-menu { position: absolute; bottom: 100%; left: 0; right: 0; background: var(--color-bg-card); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-bottom: 8px; overflow: hidden; display: none; }
    .magic-photo-menu.show { display: block; }
    .magic-photo-menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text); }
    .magic-photo-menu-item:hover { background: var(--color-bg-btn); }
    .magic-photo-menu-item:active { background: var(--color-border); }
    .magic-input-area { width: 100%; min-height: 80px; padding: 14px; border: 2px solid var(--color-border); border-radius: 12px; font-family: var(--font-main); font-size: 1rem; resize: none; margin-bottom: 16px; }
    .magic-input-area:focus { outline: none; border-color: #8B5CF6; }
    .magic-input-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 6px; display: block; }
    .magic-voice-btn { width: 100%; padding: 14px; border: 2px dashed var(--color-border); border-radius: 12px; background: var(--color-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); margin-bottom: 16px; transition: all 0.2s; }
    .magic-voice-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .magic-voice-btn.recording { border-color: var(--color-recording); background: rgba(239,68,68,0.1); color: var(--color-recording); animation: pulse 1s infinite; }
    .magic-styles { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .magic-style { padding: 8px 16px; border: 2px solid var(--color-border); border-radius: 20px; background: none; font-family: var(--font-main); font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
    .magic-style:hover { border-color: #8B5CF6; }
    .magic-style.active { border-color: #8B5CF6; background: rgba(139,92,246,0.1); color: #8B5CF6; }
    .magic-generate { width: 100%; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; font-family: var(--font-main); font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
    .magic-generate:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139,92,246,0.4); }
    .magic-generate:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .magic-footer { padding: 16px 20px; border-top: 1px solid var(--color-border); }
    .magic-cancel { padding: 10px 24px; border: none; background: none; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); cursor: pointer; }
    
    /* Drops picker modal */
    .drops-picker { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 250; display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .drops-picker.show { opacity: 1; visibility: visible; }
    .drops-picker-content { background: var(--color-bg-card); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 70vh; overflow: hidden; transform: translateY(100%); transition: transform 0.3s; }
    .drops-picker.show .drops-picker-content { transform: translateY(0); }
    .drops-picker-header { padding: 16px 20px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .drops-picker-header h3 { font-size: 1.1rem; }
    .drops-picker-close { width: 32px; height: 32px; border: none; background: var(--color-bg-btn); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    .drops-picker-grid { padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; overflow-y: auto; max-height: calc(70vh - 70px); }
    .drops-picker-item { aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: all 0.15s; }
    .drops-picker-item:hover { border-color: #8B5CF6; }
    .drops-picker-item img { width: 100%; height: 100%; object-fit: cover; }
    .drops-picker-empty { grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--color-text-muted); }
    
    /* AI Tools Modal (for text drops) */
    .ai-tools-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .ai-tools-modal.show { opacity: 1; visibility: visible; }
    .ai-tools-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.2s; }
    .ai-tools-modal.show .ai-tools-content { transform: translateY(0); }
    .ai-tools-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; }
    .ai-tools-header h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .ai-tools-header p { font-size: 0.85rem; opacity: 0.9; }
    .ai-tools-preview { padding: 16px 20px; background: var(--color-bg); border-bottom: 1px solid var(--color-border); }
    .ai-tools-preview-text { font-size: 0.9rem; color: var(--color-text-soft); line-height: 1.5; max-height: 80px; overflow: hidden; position: relative; }
    .ai-tools-preview-text::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, var(--color-bg)); }
    .ai-tools-preview-label { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .ai-tools-body { padding: 20px; }
    .ai-tools-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .ai-tool-btn { display: flex; align-items: center; gap: 14px; padding: 16px; border: 2px solid var(--color-border); border-radius: 14px; background: var(--color-bg-card); cursor: pointer; transition: all 0.15s; text-align: left; font-family: var(--font-main); }
    .ai-tool-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .ai-tool-btn:active { transform: scale(0.98); }
    .ai-tool-btn .icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); border-radius: 10px; color: #6366F1; }
    .ai-tool-btn .icon svg { width: 22px; height: 22px; }
    .ai-tool-btn .info { flex: 1; }
    .ai-tool-btn .title { font-size: 1rem; font-weight: 600; color: var(--color-text); margin-bottom: 2px; }
    .ai-tool-btn .desc { font-size: 0.8rem; color: var(--color-text-muted); }
    .ai-tools-option { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--color-bg); border-radius: 12px; margin-bottom: 16px; }
    .ai-tools-option input[type="checkbox"] { width: 20px; height: 20px; accent-color: #8B5CF6; }
    .ai-tools-option-label { flex: 1; }
    .ai-tools-option-label .title { font-size: 0.9rem; font-weight: 500; color: var(--color-text); }
    .ai-tools-option-label .current { font-size: 0.8rem; color: var(--color-text-muted); }
    .ai-tools-footer { padding: 16px 20px; border-top: 1px solid var(--color-border); }
    
    /* AI Result Modal (large) */
    .ai-result-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 210; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .ai-result-modal.show { opacity: 1; visibility: visible; }
    .ai-result-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 420px; max-height: 90vh; overflow: hidden; transform: translateY(20px); transition: transform 0.2s; display: flex; flex-direction: column; }
    .ai-result-modal.show .ai-result-content { transform: translateY(0); }
    .ai-result-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #10B981, #3B82F6); color: white; flex-shrink: 0; }
    .ai-result-header h2 { font-size: 1.2rem; }
    .ai-result-body { padding: 20px; flex: 1; overflow-y: auto; }
    .ai-result-text { font-size: max(1rem, 16px); line-height: 1.6; color: var(--color-text); white-space: pre-wrap; }
    .ai-result-category { margin-top: 20px; padding: 16px; background: var(--color-bg); border-radius: 12px; }
    .ai-result-category-title { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .ai-result-category-row { display: flex; align-items: center; gap: 10px; }
    .ai-result-category-current { font-size: 0.9rem; color: var(--color-text-soft); }
    .ai-result-category-arrow { color: var(--color-text-muted); }
    .ai-result-category-suggested { font-size: 0.9rem; font-weight: 600; color: #8B5CF6; }
    .ai-result-category-actions { display: flex; gap: 8px; margin-top: 12px; }
    .ai-result-category-btn { flex: 1; padding: 10px; border: 2px solid var(--color-border); border-radius: 8px; background: none; font-family: var(--font-main); font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
    .ai-result-category-btn:hover { border-color: #8B5CF6; }
    .ai-result-category-btn.accept { border-color: #10B981; background: rgba(16,185,129,0.1); color: #059669; }
    .ai-result-actions { padding: 20px; border-top: 1px solid var(--color-border); display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .ai-result-action-btn { padding: 14px; border: none; border-radius: 12px; font-family: var(--font-main); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .ai-result-action-btn.primary { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .ai-result-action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139,92,246,0.3); }
    .ai-result-action-btn.secondary { background: var(--color-bg-btn); color: var(--color-text); }
    .ai-result-action-btn.secondary:hover { background: var(--color-border); }
    .ai-result-action-row { display: flex; gap: 10px; }
    .ai-result-action-row .ai-result-action-btn { flex: 1; }
    .ai-result-cancel { width: 100%; padding: 14px; margin-top: 8px; border: 2px solid var(--color-border); border-radius: 12px; background: var(--color-bg); font-family: var(--font-main); font-size: 1rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; transition: all 0.15s; }
    .ai-result-cancel:hover { border-color: var(--color-text-muted); background: var(--color-bg-soft); }
    
    /* B2 FIX: Tasks Preview List */
    .tasks-preview-list { display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; }
    .tasks-preview-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: var(--color-bg); border-radius: 10px; font-size: 0.9rem; line-height: 1.4; }
    .tasks-preview-num { flex-shrink: 0; width: 24px; height: 24px; background: var(--cat-tasks-bg); color: var(--cat-tasks-text); border-radius: 50%; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
    .tasks-preview-text { flex: 1; color: var(--color-text); }
    
    /* I1 FIX: Translate Language Buttons */
    .translate-langs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .translate-lang-btn { padding: 14px 16px; border: 2px solid var(--color-border); border-radius: 12px; background: var(--color-bg); font-family: var(--font-main); font-size: 0.95rem; font-weight: 500; color: var(--color-text); cursor: pointer; transition: all 0.15s; text-align: left; }
    .translate-lang-btn:hover { border-color: #3B82F6; background: rgba(59, 130, 246, 0.05); }
    .translate-lang-btn:active { transform: scale(0.98); }
    
    /* AI Loading Indicator (compact, inside modal) */
    .ai-loading-inline { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; }
    .ai-loading-dots { display: flex; gap: 6px; margin-bottom: 16px; }
    .ai-loading-dots span { width: 10px; height: 10px; background: #8B5CF6; border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
    .ai-loading-dots span:nth-child(1) { animation-delay: 0s; }
    .ai-loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .ai-loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    .ai-loading-dots span:nth-child(4) { animation-delay: 0.6s; }
    .ai-loading-dots span:nth-child(5) { animation-delay: 0.8s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .ai-loading-label { font-size: 0.9rem; color: var(--color-text-soft); }
    .ai-loading-dots.magic span { background: linear-gradient(135deg, #8B5CF6, #EC4899); }
    .magic-loading { display: none; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; }
    .magic-loading.show { display: flex; }
    .magic-form.hidden { display: none; }
    
    /* Main Menu Modal */
    .main-menu { position: fixed; top: calc(72px + env(safe-area-inset-top, 0px)); left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 150; opacity: 0; visibility: hidden; transition: all 0.25s; }
    .main-menu.show { opacity: 1; visibility: visible; }
    .main-menu-content { background: var(--color-bg-card); width: 100%; height: 100%; overflow-y: auto; transform: translateY(-20px); transition: transform 0.25s; padding-bottom: 100px; }
    .main-menu.show .main-menu-content { transform: translateY(0); }
    .main-menu-header { display: none; }
    .main-menu-close { display: none; }
    .main-menu-footer { padding: 16px 20px 24px; display: none; }
    
    /* Balance Card */
    .balance-card { margin: 16px 16px 0 16px; padding: 16px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 16px; color: white; }
    .balance-label { font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; }
    .balance-value { font-size: 1.8rem; font-weight: 700; }
    .balance-hint { font-size: 0.75rem; opacity: 0.8; margin-top: 6px; }
    
    /* Menu Sections */
    .menu-section { padding: 16px 20px; border-bottom: 1px solid var(--color-border); }
    .menu-section:last-child { border-bottom: none; }
    .menu-section.no-border { border-bottom: none; }
    .menu-section-title { font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    
    /* Search Box */
    .menu-search { display: flex; gap: 10px; }
    .menu-search-input { flex: 1; padding: 14px 16px; border: 2px solid var(--color-border); border-radius: 16px; font-size: 1rem; font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); min-width: 0; }
    .menu-search-input:focus { border-color: #8B5CF6; outline: none; }
    .menu-search-btn { width: 52px; height: 52px; flex-shrink: 0; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: 12px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
    .menu-search-btn:hover { transform: scale(1.05); }
    .menu-search-btn:active { transform: scale(0.95); }
    .menu-search-btn svg { width: 22px; height: 22px; }
    
    /* Undo List */
    .undo-header { display: flex; align-items: center; justify-content: space-between; }
    .undo-header-left { display: flex; align-items: center; gap: 8px; }
    .undo-toggle-btn { padding: 6px 12px; border: 1px solid var(--color-border); background: var(--color-bg); border-radius: 8px; font-size: 0.8rem; color: var(--color-text-muted); cursor: pointer; }
    .undo-toggle-btn:hover { border-color: #8B5CF6; }
    .undo-main-btn { flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.15s; }
    .undo-main-btn:hover { transform: scale(1.02); }
    .undo-main-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .undo-list { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border); }
    .undo-list.show { display: flex; }
    .undo-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--color-bg); border-radius: 12px; }
    .undo-item-icon { width: 36px; height: 36px; background: rgba(139,92,246,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .undo-item-info { flex: 1; }
    .undo-item-title { font-size: 0.9rem; font-weight: 500; color: var(--color-text); }
    .undo-item-time { font-size: 0.75rem; color: var(--color-text-muted); }
    .undo-item-btn { padding: 8px 16px; border: none; background: #8B5CF6; color: white; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .undo-item-btn:hover { background: #7C3AED; }
    .undo-empty { text-align: center; padding: 20px; color: var(--color-text-muted); font-size: 0.9rem; }
    
    /* Settings Items */
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--color-border); }
    .settings-item.no-border { border-bottom: none; padding-bottom: 6px; }
    .section-divider + .settings-item { padding-top: 0; border-top: none; }
    .settings-item:last-child { border-bottom: none; padding-bottom: 0; }
    .settings-item-left { display: flex; align-items: center; gap: 12px; }
    .settings-item-icon { font-size: 1.2rem; }
    .settings-item-label { font-size: 0.95rem; color: var(--color-text); }
    .settings-item-hint { font-size: 0.7rem; color: var(--color-text-muted); margin-left: 8px; }
    .settings-item-warning { font-size: 0.8rem; color: #EF4444; margin-left: 8px; display: flex; align-items: center; gap: 4px; }
    .settings-item-warning svg { stroke: #EF4444; flex-shrink: 0; }
    .settings-toggle { width: 50px; height: 28px; background: var(--color-border); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.2s; }
    .settings-toggle.active { background: #8B5CF6; }
    .settings-toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .settings-toggle.active::after { transform: translateX(22px); }
    .settings-btn { padding: 10px 20px; border: 2px solid var(--color-border); background: none; border-radius: 10px; font-size: 0.9rem; font-family: var(--font-main); color: var(--color-text); cursor: pointer; transition: all 0.15s; }
    .settings-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .settings-btn.danger { border-color: #EF4444; color: #EF4444; }
    .settings-btn.danger:hover { background: rgba(239,68,68,0.1); }
    
    /* About Section */
    .menu-about { text-align: center; padding: 20px; }
    .menu-about-logo { width: 50px; height: 50px; background: linear-gradient(135deg, #3B82F6, #8B5CF6); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; }
    .menu-about-logo svg { width: 28px; height: 28px; fill: white; }
    .menu-about-name { font-size: 1.1rem; font-weight: 700; color: var(--color-text); }
    .menu-about-ver { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; }
    
    /* Search indicator */
    .search-indicator { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border-bottom: 1px solid var(--color-border); }
    .search-indicator-text { font-size: 0.9rem; color: var(--color-text); }
    .search-indicator-text span { font-weight: 600; color: #8B5CF6; }
    .search-indicator-clear { padding: 6px 12px; border: none; background: rgba(239,68,68,0.1); color: #EF4444; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
    
    /* Font size variants */
    body.font-small { font-size: 14px; }
    body.font-normal { font-size: 16px; }
    body.font-large { font-size: 18px; }
    
    /* Card text */
    body.font-small .card-text { font-size: 0.95rem; }
    body.font-normal .card-text { font-size: 1.05rem; }
    body.font-large .card-text { font-size: 1.2rem; }
    
    /* Chat messages */
    body.font-small .ask-ai-bubble { font-size: 0.9rem; }
    body.font-normal .ask-ai-bubble { font-size: 1rem; }
    body.font-large .ask-ai-bubble { font-size: 1.15rem; }
    
    /* Card notes/caption */
    body.font-small .card-notes { font-size: 0.8rem; }
    body.font-normal .card-notes { font-size: 0.85rem; }
    body.font-large .card-notes { font-size: 1rem; }
    
    /* Card meta (time, chars) */
    body.font-small .card-time, body.font-small .card-chars { font-size: 0.7rem; }
    body.font-normal .card-time, body.font-normal .card-chars { font-size: 0.75rem; }
    body.font-large .card-time, body.font-large .card-chars { font-size: 0.85rem; }
    
    /* Card header */
    body.font-small .card-head { font-size: 0.75rem; }
    body.font-normal .card-head { font-size: 0.8rem; }
    body.font-large .card-head { font-size: 0.9rem; }
    
    /* Category badges */
    body.font-small .card-cat { font-size: 0.65rem; padding: 3px 8px; }
    body.font-normal .card-cat { font-size: 0.7rem; padding: 4px 10px; }
    body.font-large .card-cat { font-size: 0.8rem; padding: 5px 12px; }
    
    /* Filter buttons */
    body.font-small .cat, body.font-small .time-btn { font-size: 0.75rem; padding: 6px 10px; }
    body.font-normal .cat, body.font-normal .time-btn { font-size: 0.8rem; padding: 7px 12px; }
    body.font-large .cat, body.font-large .time-btn { font-size: 0.9rem; padding: 8px 14px; }
    
    /* Action buttons - same as filter buttons */
    body.font-small .act, body.font-small .select-btn, body.font-small .modal-btn { font-size: 0.75rem; padding: 6px 10px; }
    body.font-normal .act, body.font-normal .select-btn, body.font-normal .modal-btn { font-size: 0.8rem; padding: 7px 12px; }
    body.font-large .act, body.font-large .select-btn, body.font-large .modal-btn { font-size: 0.9rem; padding: 8px 14px; }
    
    /* Textarea (edit mode) */
    body.font-small .card-ta { font-size: 0.95rem; }
    body.font-normal .card-ta { font-size: 1.05rem; }
    body.font-large .card-ta { font-size: 1.2rem; min-height: 200px; }
    
    /* Media meta */
    body.font-small .card-media-meta { font-size: 0.7rem; }
    body.font-normal .card-media-meta { font-size: 0.75rem; }
    body.font-large .card-media-meta { font-size: 0.85rem; }
    
    /* Date separator */
    body.font-small .date-sep { font-size: 0.75rem; }
    body.font-normal .date-sep { font-size: 0.8rem; }
    body.font-large .date-sep { font-size: 0.9rem; }
    
    /* Modal titles */
    body.font-small .modal-title { font-size: 1rem; }
    body.font-normal .modal-title { font-size: 1.1rem; }
    body.font-large .modal-title { font-size: 1.3rem; }
    
    /* Menu */
    body.font-large .menu-section-title { font-size: 0.85rem; }
    body.font-large .settings-item-label { font-size: 1.05rem; }
    body.font-large .undo-item-title { font-size: 1rem; }
    body.font-large .balance-value { font-size: 2rem; }
    
    /* Font size selector */
    .font-size-selector { display: flex; gap: 8px; }
    .font-size-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--color-border); background: var(--color-bg); border-radius: 10px; font-family: var(--font-main); cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .font-size-btn:hover { border-color: #8B5CF6; }
    .font-size-btn.active { border-color: #8B5CF6; background: rgba(139,92,246,0.1); }
    .font-size-btn .size-label { font-weight: 600; color: var(--color-text); }
    .font-size-btn .size-preview { color: var(--color-text-muted); }
    .font-size-btn[data-size="small"] .size-preview { font-size: 12px; }
    .font-size-btn[data-size="normal"] .size-preview { font-size: 14px; }
    .font-size-btn[data-size="large"] .size-preview { font-size: 16px; }
    
    /* AI Result with Actions */
    .ai-result-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
    .ai-result-btn { flex: 1; min-width: 100px; padding: 12px 16px; border: none; border-radius: 10px; font-family: var(--font-main); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .ai-result-btn.primary { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .ai-result-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(139,92,246,0.3); }
    .ai-result-btn.secondary { background: var(--color-bg-btn); color: var(--color-text); }
    .ai-result-btn.secondary:hover { background: var(--color-border); }

    /* Text input modal */
    .text-input-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
    .text-input-modal.show { display: flex; }
    .text-input-content { background: var(--color-bg-card); width: 100%; max-height: 70vh; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); animation: slideUp 0.25s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .text-input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .text-input-title { font-size: 1.1rem; font-weight: 600; color: var(--color-text); }
    .text-input-close { width: 32px; height: 32px; border: none; background: var(--color-bg-btn); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-soft); font-size: 1.2rem; }
    .text-input-area { width: 100%; min-height: 120px; padding: 14px; border: 1px solid var(--color-border); border-radius: 12px; font-family: var(--font-main); font-size: 1rem; resize: none; background: var(--color-bg); color: var(--color-text); }
    .text-input-area:focus { outline: none; border-color: var(--color-primary); }
    .text-input-actions { display: flex; gap: 12px; margin-top: 16px; }
    .text-input-btn { flex: 1; height: 48px; border: none; border-radius: 12px; font-family: var(--font-main); font-size: 0.95rem; font-weight: 600; cursor: pointer; }
    .text-input-btn.cancel { background: var(--color-bg-btn); color: var(--color-text-soft); }
    .text-input-btn.save { background: var(--color-primary); color: white; }

    /* Recording status */
    .rec-status { position: fixed; bottom: calc(96px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 8px; padding: 10px 20px; background: var(--color-bg-card); border-radius: var(--radius-full); box-shadow: var(--shadow-scroll); z-index: 50; }
    .rec-status.show { display: flex; }
    .rec-dot { width: 8px; height: 8px; background: var(--color-recording); border-radius: 50%; animation: blink 1s ease infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .rec-text { font-size: 0.8rem; font-weight: 600; color: var(--color-text); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Scroll FAB */
    .scroll-fab { position: fixed; right: 20px; width: 44px; height: 44px; border: none; background: var(--color-bg-card); border-radius: var(--radius-full); box-shadow: var(--shadow-scroll); cursor: pointer; display: none; align-items: center; justify-content: center; color: var(--color-primary); font-size: 1.1rem; font-weight: 700; z-index: 40; transition: all 0.2s; }
    .scroll-fab.show { display: flex; }
    .scroll-fab:active { transform: scale(0.9); }
    .scroll-fab.top { bottom: calc(160px + var(--safe-bottom)); }
    .scroll-fab.bottom { bottom: calc(100px + var(--safe-bottom)); }
    .editing-mode .scroll-fab, .select-mode .scroll-fab { display: none !important; }
    
    /* B1 FIX: Keep header visible when keyboard appears */
    .editing-mode .header, .editing-mode .filters { position: sticky; top: 0; z-index: 10; background: var(--color-bg-card); }
    .editing-mode .ideas-wrap { padding-bottom: 350px; }

    /* Selection bar */
    .select-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-bg-card); border-top: 1px solid var(--color-border); padding: 12px 16px calc(12px + var(--safe-bottom)); display: none; align-items: center; justify-content: space-between; gap: 10px; z-index: 60; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
    .select-bar.show { display: flex; }
    .select-info { font-size: 0.85rem; font-weight: 600; color: var(--color-text); }
    .select-actions { display: flex; gap: 8px; }
    .select-btn { height: 34px; padding: 0 12px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; text-transform: uppercase; transition: all 0.15s; }
    .select-btn:active { transform: scale(0.97); }
    .select-btn.cancel { background: var(--color-bg-btn); color: var(--color-text-soft); border-color: var(--color-border); }
    .select-btn.merge { background: var(--color-merge); color: white; border-color: transparent; }
    .select-btn.delete { background: var(--color-error); color: white; border-color: transparent; }

    /* Modals - TYPE-C (compact, 320px) */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; padding: 20px; z-index: 100; backdrop-filter: blur(4px); }
    .overlay.show { display: flex; }
    .modal { width: 100%; max-width: 320px; background: var(--color-bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: modalIn 0.25s ease; }
    .modal.type-b { max-width: 360px; padding: 0; overflow: hidden; }
    .modal.type-b .modal-header { padding: 16px 20px; background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); }
    .modal.type-b .modal-header h3 { font-size: 1rem; font-weight: 700; margin: 0; }
    .modal.type-b .modal-body { padding: 20px; }
    .modal.type-b .modal-actions { padding: 0 20px 20px; }
    @keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .modal-text { font-size: 0.85rem; color: var(--color-text-soft); margin-bottom: 20px; line-height: 1.6; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { height: 34px; padding: 0 12px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: all 0.15s; }
    .modal-btn:active { transform: scale(0.97); }
    .modal-btn.sec { background: var(--color-bg-btn); color: var(--color-text); border-color: var(--color-border); }
    .modal-btn.pri { background: var(--color-primary); color: white; border-color: transparent; }
    .modal-btn.merge { background: var(--color-merge); color: white; border-color: transparent; }
    .modal-btn.danger { background: var(--color-error); color: white; border-color: transparent; }

    /* ========== UNIFIED PILLS SYSTEM v0.9.29 ========== */
    
    /* Pills - Small (34px) for compact areas */
    .pill-s { height: 34px; padding: 0 14px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.15s; background: var(--color-bg-btn); color: var(--color-text-soft); }
    .pill-s:active { transform: scale(0.97); }
    .pill-s.sec { background: var(--color-bg-btn); color: var(--color-text); border-color: var(--color-border); }
    .pill-s.pri { background: var(--color-primary); color: white; border-color: transparent; }
    .pill-s.active { background: rgba(139,92,246,0.15); border-color: #8B5CF6; color: #8B5CF6; }

    /* Pills - Medium (40px) for TYPE-B modals */
    .pill-m { height: 40px; padding: 0 16px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.75rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; background: var(--color-bg-btn); color: var(--color-text-soft); }
    .pill-m:active { transform: scale(0.97); }
    .pill-m.sec { background: var(--color-bg-btn); color: var(--color-text); border-color: var(--color-border); }
    .pill-m.pri { background: var(--color-primary); color: white; border-color: transparent; }
    .pill-m.ai { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border-color: transparent; }
    .pill-m.magic { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; border-color: transparent; }
    .pill-m.merge { background: var(--color-merge); color: white; border-color: transparent; }
    .pill-m.danger { background: var(--color-error); color: white; border-color: transparent; }
    .pill-m.active { background: rgba(139,92,246,0.15); border-color: #8B5CF6; color: #8B5CF6; }

    /* Pills - Large (48px) for TYPE-A modals */
    .pill-l { height: 48px; padding: 0 24px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.85rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; background: var(--color-bg-btn); color: var(--color-text-soft); width: 100%; }
    .pill-l:active { transform: scale(0.98); }
    .pill-l.sec { background: var(--color-bg-btn); color: var(--color-text); border-color: var(--color-border); }
    .pill-l.pri { background: var(--color-primary); color: white; border-color: transparent; }
    .pill-l.ai { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border-color: transparent; }
    .pill-l.magic { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; border-color: transparent; }
    .pill-l.success { background: linear-gradient(135deg, #10B981, #3B82F6); color: white; border-color: transparent; }
    .pill-l.merge { background: var(--color-merge); color: white; border-color: transparent; }
    .pill-l.danger { background: var(--color-error); color: white; border-color: transparent; }
    .pill-l:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* Pills - XL (56px) for main CTA */
    .pill-xl { height: 56px; padding: 0 32px; border: 2px solid var(--color-border); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 1rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.15s; background: var(--color-bg-btn); color: var(--color-text-soft); width: 100%; }
    .pill-xl:active { transform: scale(0.98); }
    .pill-xl.magic { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; border-color: transparent; }
    .pill-xl.ai { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border-color: transparent; }
    .pill-xl.pri { background: var(--color-primary); color: white; border-color: transparent; }

    /* Centered Section Divider */
    .section-divider { display: flex; align-items: center; gap: 12px; margin: 16px 0 12px 0; }
    .section-divider:first-child { margin-top: 0; }
    .section-divider::before, .section-divider::after { content: ''; flex: 1; height: 1px; background: var(--color-border); }
    .section-divider span { font-size: 0.65rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

    /* NEW badge for fresh drops */
    .new-badge { padding: 3px 8px; border-radius: var(--radius-full); font-size: 0.55rem; font-weight: 700; text-transform: uppercase; background: #D1FAE5; color: #065F46; margin-right: 6px; }

    /* Pill row for side-by-side buttons */
    .pill-row { display: flex; gap: 10px; width: 100%; }
    .pill-row .pill-l, .pill-row .pill-m { flex: 1; width: auto; }

    .cat-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .modal:not(.type-b) .cat-grid { margin-bottom: 20px; }
    .cat-opt { padding: 10px 16px; border: none; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; }
    .cat-opt:active { transform: scale(1.05); }
    .cat-opt[data-cat="tasks"] { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .cat-opt[data-cat="ideas"] { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .cat-opt[data-cat="handmagic"] { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .cat-opt[data-cat="design"] { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .cat-opt[data-cat="bugs"] { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .cat-opt[data-cat="questions"] { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .cat-opt[data-cat="inbox"] { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .cat-opt[data-cat="sketch"] { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    .cat-opt[data-cat="scan"] { background: var(--cat-scan-bg); color: var(--cat-scan-text); }

    .send-opts { display: flex; flex-direction: column; gap: 8px; }
    .modal:not(.type-b) .send-opts { margin-bottom: 20px; }
    .send-opt { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--color-bg); border-radius: var(--radius-md); cursor: pointer; }
    .send-opt:active { background: var(--color-bg-soft); }
    .send-icon { width: 36px; height: 36px; background: var(--color-bg-card); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: var(--shadow-card); }
    .send-info { flex: 1; }
    .send-title { font-size: 0.85rem; font-weight: 600; }
    .send-desc { font-size: 0.7rem; color: var(--color-text-muted); }
    .send-badge { font-size: 0.55rem; font-weight: 700; padding: 3px 8px; background: linear-gradient(135deg,#8B5CF6,#6366F1); color: white; border-radius: var(--radius-full); text-transform: uppercase; }
    .send-div { display: flex; align-items: center; gap: 10px; margin: 6px 0; font-size: 0.6rem; color: var(--color-text-muted); text-transform: uppercase; font-weight: 600; }
    .send-div::before, .send-div::after { content: ''; flex: 1; height: 1px; background: var(--color-border); }

    .export-box { background: var(--color-bg); border-radius: var(--radius-sm); padding: 12px; font-family: monospace; font-size: 0.65rem; max-height: 180px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
    .modal:not(.type-b) .export-box { margin-bottom: 16px; }

    .about-brand { text-align: center; padding: 20px 0; margin-bottom: 16px; border-bottom: 1px solid var(--color-border); }
    .about-logo { width: 72px; height: 72px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: var(--shadow-fab); }
    .about-logo svg { width: 36px; height: 36px; }
    .about-name { font-size: 1.4rem; font-weight: 800; }
    .about-ver { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }

    .toast-wrap { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; }
    .toast { padding: 12px 20px; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: auto; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--color-success); color: white; }
    .toast.warning { background: var(--color-warning); color: white; }
    .toast.error { background: var(--color-error); color: white; }
    .toast.info { background: var(--color-text); color: white; }

    /* Merge preview */
    .merge-preview { background: var(--color-bg); border-radius: var(--radius-sm); padding: 12px; font-size: 0.9rem; max-height: 200px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap; }
    .modal:not(.type-b) .merge-preview { margin-bottom: 16px; }
    .merge-options { margin-bottom: 12px; }
    .merge-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--color-text-soft); cursor: pointer; }
    .merge-toggle input { width: 18px; height: 18px; accent-color: var(--color-primary); }

    /* Image viewer */
    .image-viewer { background: rgba(0,0,0,0.95); padding: 0; overflow: hidden; }
    .image-viewer.show { display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; }
    .image-viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 50px 0 0; touch-action: none; min-height: 0; position: relative; }
    .image-viewer img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; border-radius: 0; transform-origin: center center; user-select: none; -webkit-user-drag: none; will-change: transform; transition: transform 0.2s ease; }
    .image-viewer img.portrait { width: 100%; max-width: 100%; height: auto; max-height: none; }
    .image-viewer img.landscape { width: auto; max-width: 100%; height: auto; max-height: 100%; }
    .image-viewer img.zoomed { max-width: none; max-height: none; }
    .image-viewer-close { position: absolute; top: 16px; right: 16px; width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; z-index: 10; }
    .image-viewer-close:active { background: rgba(255,255,255,0.3); }
    
    /* AI button on photo */
    .image-viewer-ai { position: absolute; top: 72px; right: 16px; width: 52px; height: 52px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(139,92,246,0.4); transition: transform 0.15s; }
    .image-viewer-ai:active { transform: scale(0.9); }
    
    /* Markers button on photo */
    .image-viewer-markers { position: absolute; top: 16px; left: 16px; min-width: 44px; height: 44px; padding: 0 12px; background: rgba(255,255,255,0.15); border-radius: 22px; display: flex; align-items: center; justify-content: center; gap: 4px; color: white; font-size: 1.1rem; cursor: pointer; z-index: 10; }
    .image-viewer-markers:active { background: rgba(255,255,255,0.3); }
    .image-viewer-markers.has-markers { background: rgba(139,92,246,0.6); }
    
    /* Photo AI Tools Modal */
    .photo-ai-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 250; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-ai-modal.show { opacity: 1; visibility: visible; }
    .photo-ai-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 360px; overflow: hidden; transform: scale(0.9); transition: transform 0.2s; }
    .photo-ai-modal.show .photo-ai-content { transform: scale(1); }
    .photo-ai-header { padding: 20px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; text-align: center; }
    .photo-ai-header h3 { font-size: 1.2rem; margin: 0; }
    .photo-ai-header p { font-size: 0.85rem; opacity: 0.9; margin: 4px 0 0; }
    .photo-ai-tools { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .photo-ai-btn { display: flex; align-items: center; gap: 14px; padding: 16px; border: none; background: var(--color-bg); border-radius: 14px; cursor: pointer; transition: all 0.15s; text-align: left; }
    .photo-ai-btn:hover { background: rgba(139,92,246,0.1); }
    .photo-ai-btn:active { transform: scale(0.98); }
    .photo-ai-btn .icon { width: 44px; height: 44px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
    .photo-ai-btn .info { flex: 1; }
    .photo-ai-btn .title { font-size: 1rem; font-weight: 600; color: var(--color-text); }
    .photo-ai-btn .desc { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; }
    .photo-ai-cancel { padding: 14px; border: none; background: none; width: 100%; font-size: 0.95rem; color: var(--color-text-muted); cursor: pointer; border-top: 1px solid var(--color-border); }
    
    /* Photo AI Result Modal */
    .photo-ai-result { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 260; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-ai-result.show { opacity: 1; visibility: visible; }
    .photo-ai-result-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    .photo-ai-result-header { padding: 16px 20px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; }
    .photo-ai-result-header h3 { font-size: 1.1rem; margin: 0; }
    .photo-ai-result-text { flex: 1; padding: 16px 20px; overflow-y: auto; font-size: 0.95rem; line-height: 1.5; color: var(--color-text); }
    .photo-ai-result-actions { padding: 12px 16px 16px; display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--color-border); }
    .photo-ai-result-btn { padding: 14px; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .photo-ai-result-btn.primary { background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; }
    .photo-ai-result-btn.secondary { background: var(--color-bg); color: var(--color-text); }
    .photo-ai-result-btn:active { transform: scale(0.98); }
    
    /* Photo Markers Modal */
    .photo-markers-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 250; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-markers-modal.show { opacity: 1; visibility: visible; }
    .photo-markers-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 320px; padding: 20px; text-align: center; }
    .photo-markers-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }
    .photo-markers-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 16px; }
    .photo-marker-btn { width: 56px; height: 56px; border: 2px solid var(--color-border); background: var(--color-bg); border-radius: 14px; font-size: 1.6rem; cursor: pointer; transition: all 0.15s; }
    .photo-marker-btn:active { transform: scale(0.9); }
    .photo-marker-btn.active { border-color: #8B5CF6; background: rgba(139,92,246,0.15); }
    .photo-markers-done { width: 100%; padding: 14px; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .image-viewer-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: var(--radius-full); display: none; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; z-index: 10; }
    .image-viewer-nav:active { background: rgba(255,255,255,0.3); }
    .image-viewer-nav.prev { left: 10px; }
    .image-viewer-nav.next { right: 10px; }
    .image-viewer-nav.show { display: flex; }
    .image-viewer-panel { flex-shrink: 0; background: var(--color-bg-card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; padding: 12px 16px calc(12px + env(safe-area-inset-bottom, 0px)) 16px; width: 100%; box-sizing: border-box; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
    .image-meta { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 8px; display: flex; gap: 12px; flex-wrap: wrap; }
    .image-meta span { display: flex; align-items: center; gap: 4px; }
    .image-caption-display { font-size: 0.9rem; color: var(--color-text); line-height: 1.4; flex: 1; }
    .image-caption-display.empty { color: var(--color-text-muted); font-style: italic; }
    .image-caption-display.hidden { display: none; }
    .image-caption-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .caption-edit-btn { height: 28px; padding: 0 10px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; flex-shrink: 0; text-transform: uppercase; }
    .caption-edit-btn:active { background: var(--color-bg-soft); }
    .image-notes-wrap { display: none; }
    .image-notes-wrap.editing { display: block; }
    .image-notes { width: 100%; padding: 10px; border: 2px solid var(--color-primary); border-radius: var(--radius-sm); font-family: var(--font-main); font-size: 0.9rem; resize: none; background: var(--color-bg); }
    .image-notes:focus { outline: none; }
    .image-actions { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; margin-top: 12px; }
    .image-actions::-webkit-scrollbar { display: none; }
    .image-actions.hidden { display: none; }
    .image-edit-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
    .img-act { flex-shrink: 0; height: 36px; padding: 0 14px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
    .img-act.delete { background: rgba(239,68,68,0.15); color: #EF4444; }
    .img-act:active { background: var(--color-bg-soft); }
    .img-act.primary { background: var(--color-primary); color: white; }
    .image-counter { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); color: white; padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; z-index: 10; }

    @media print {
      body * { visibility: hidden; }
      .image-viewer, .image-viewer img { visibility: visible; }
      .image-viewer { position: absolute; left: 0; top: 0; background: white; }
      .image-viewer img { max-width: 100%; max-height: 100%; }
      .image-viewer-close, .image-viewer-panel { display: none !important; }
    }

    @media (min-width:481px) { 
      .app { margin: 20px auto; height: calc(100vh - 40px); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
      .fab-record { right: calc(50% - 220px); }
      .fab-camera { left: calc(50% - 220px); }
      .scroll-fab { right: calc(50% - 220px); }
      .select-bar { left: 50%; right: auto; transform: translateX(-50%); max-width: 480px; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="header">
      <button class="logo-btn" id="logoBtn" onclick="toggleFilters()" title="Toggle filters">
        <svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
      </button>
      <div class="header-title"><span>Drop</span>Lit</div>
      <button class="header-add-btn" onclick="togglePlusMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12h14"/></svg>
        Create Drop
      </button>
      <button class="btn-icon" id="menuToggleBtn" onclick="toggleMainMenu()">
        <svg class="menu-icon-open" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        <svg class="menu-icon-close" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="display:none;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </header>
    <div class="network-banner" id="netBanner">No internet</div>
    <div class="warning" id="warning">Speech recognition not supported. Use Chrome.</div>
    <div class="search-indicator" id="searchIndicator" style="display:none">
      <span class="search-indicator-text">Searching: <span id="searchQueryDisplay"></span></span>
      <button class="search-indicator-clear" onclick="clearSearch()"> Clear</button>
    </div>
    <div class="filters-wrap">
    <div class="filters">
      <div class="time-row" id="timeRow">
        <button class="time-btn" data-time="all">All <span class="cnt" id="cntAll">0</span></button>
        <button class="time-btn" data-time="today">Today <span class="cnt" id="cntToday">0</span></button>
        <button class="time-btn" data-time="7days">7d <span class="cnt" id="cnt7d">0</span></button>
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()" title="Sort order"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
      </div>
      <div class="cat-row" id="cats">
        <button class="cat" data-category="tasks">Tasks <span class="cnt" id="cntTasks">0</span></button>
        <button class="cat" data-category="ideas">Ideas <span class="cnt" id="cntIdeas">0</span></button>
        <button class="cat" data-category="handmagic">Handmagic <span class="cnt" id="cntHandmagic">0</span></button>
        <button class="cat" data-category="design">Design <span class="cnt" id="cntDesign">0</span></button>
        <button class="cat" data-category="bugs">Bugs <span class="cnt" id="cntBugs">0</span></button>
        <button class="cat" data-category="questions">Questions <span class="cnt" id="cntQuestions">0</span></button>
        <button class="cat" data-category="inbox">Inbox <span class="cnt" id="cntInbox">0</span></button>
        <button class="cat" data-category="photo">Photo <span class="cnt" id="cntPhoto">0</span></button>
        <button class="cat" data-category="sketch">Sketch <span class="cnt" id="cntSketch">0</span></button>
        <button class="cat" data-category="scan">Scan <span class="cnt" id="cntScan">0</span></button>
        <button class="cat-add" onclick="addCatPrompt()">+</button>
      </div>
    </div>
    </div>
    <div class="ideas-wrap" id="ideasWrap">
      <div class="ideas" id="ideasList"></div>
      <div class="empty" id="emptyState">
        <div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div>
        <div class="empty-title">Your ideas start here</div>
        <div class="empty-text">SHOOT  PRESS  SPEAK</div>
      </div>
    </div>
  </div>

  <button class="fab-camera" id="fabCamera" onclick="document.getElementById('cameraInput').click()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
  </button>
  <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
  <input type="file" id="imageUpload" class="camera-input" accept="image/*" onchange="handleUploadedImage(event)">
  <input type="file" id="fileUpload" style="display:none" accept=".txt,.md,.csv,.json" onchange="handleUploadedFile(event)">

  <!-- FAB Ask AI button -->
  <button class="fab-askai" id="fabAskAI" onclick="openAskAI()">
    ASK AI
  </button>

  <!-- Plus menu backdrop -->
  <div class="plus-menu-backdrop" id="plusBackdrop" onclick="closePlusMenu()"></div>

  <!-- Plus menu -->
  <div class="plus-menu" id="plusMenu">
    <div class="section-divider"><span>Create</span></div>
    <button class="plus-menu-item" onclick="openTextInput()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg></span>
      <div class="info">
        <div class="title">New Drop</div>
        <div class="desc">Text note or idea</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="pasteLink()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
      <div class="info">
        <div class="title">Paste Link</div>
        <div class="desc">Save URL from clipboard</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="uploadImage()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></span>
      <div class="info">
        <div class="title">Upload Image</div>
        <div class="desc">Photo from gallery</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="uploadFile()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></span>
      <div class="info">
        <div class="title">Upload File</div>
        <div class="desc">Document or PDF</div>
      </div>
    </button>
    <div class="section-divider"><span>AI Magic</span></div>
    <button class="plus-menu-item magic" onclick="openMagic('poem')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
      <div class="info">
        <div class="title">Create Poem</div>
        <div class="desc">AI-generated poetry</div>
      </div>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('greeting')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></span>
      <div class="info">
        <div class="title">Create Greeting</div>
        <div class="desc">Birthday, holiday wishes</div>
      </div>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('speech')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
      <div class="info">
        <div class="title">Create Speech</div>
        <div class="desc">Toast or presentation</div>
      </div>
    </button>
  </div>

  <!-- Text input modal -->
  <div class="text-input-modal" id="textInputModal">
    <div class="text-input-content">
      <div class="text-input-header">
        <span class="text-input-title">New Drop</span>
        <button class="text-input-close" onclick="closeTextInput()"></button>
      </div>
      <textarea class="text-input-area" id="textInputArea" placeholder="Type your idea here..."></textarea>
      <div class="text-input-actions">
        <button class="text-input-btn cancel" onclick="closeTextInput()">Cancel</button>
        <button class="text-input-btn save" onclick="saveTextNote()">Save</button>
      </div>
    </div>
  </div>

  <!-- AI Magic Modal -->
  <div class="magic-modal" id="magicModal" onclick="if(event.target===this)closeMagic()">
    <div class="magic-content">
      <div class="magic-header">
        <h2 id="magicTitle">Create Poem</h2>
        <p id="magicSubtitle">Tell me what it should be about</p>
      </div>
      <div class="magic-body">
        <!-- Loading indicator -->
        <div class="magic-loading" id="magicLoading">
          <div class="ai-loading-dots magic">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
          <div class="ai-loading-label" id="magicLoadingLabel">Creating magic...</div>
        </div>
        <!-- Form -->
        <div class="magic-form" id="magicForm">
        <!-- Photo section -->
        <div class="magic-photo-section">
          <div style="position: relative;">
            <button class="pill-l sec" id="magicPhotoBtn" onclick="togglePhotoMenu()">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
              <span id="magicPhotoBtnText">Add photo (optional)</span>
            </button>
            <div class="magic-photo-menu" id="magicPhotoMenu">
              <button class="magic-photo-menu-item" onclick="takeMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Take photo
              </button>
              <button class="magic-photo-menu-item" onclick="chooseMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg> Choose from gallery
              </button>
              <button class="magic-photo-menu-item" onclick="openDropsPicker()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg> Choose from Drops
              </button>
            </div>
          </div>
          <div class="magic-photo-preview" id="magicPhotoPreview" style="display: none;">
            <img id="magicPhotoImg" src="" alt="Selected photo">
            <button class="magic-photo-remove" onclick="removeMagicPhoto()"></button>
          </div>
          <input type="file" id="magicPhotoInput" accept="image/*" style="display:none" onchange="handleMagicPhoto(event)">
          <input type="file" id="magicCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleMagicPhoto(event)">
        </div>
        
        <label class="magic-input-label" id="magicInputLabel">Add details (optional if photo added)</label>
        <textarea class="magic-input-area" id="magicInput" placeholder="Example: Birthday greeting for mom, she loves gardening and has 2 grandkids..."></textarea>
        <button class="pill-l sec" id="magicVoiceBtn" onclick="toggleMagicVoice()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="magicVoiceText">Tap to speak</span>
        </button>
        <div class="magic-styles" id="magicStyles">
          <button class="magic-style active" data-style="classic">Classic</button>
          <button class="magic-style" data-style="funny">Funny</button>
          <button class="magic-style" data-style="tender">Tender</button>
          <button class="magic-style" data-style="epic">Epic</button>
        </div>
        <button class="pill-xl magic" id="magicGenerate" onclick="generateMagic()">
          Create Magic
        </button>
        </div><!-- end magic-form -->
      </div>
      <div class="magic-footer">
        <button class="pill-l sec" onclick="closeMagic()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Drops Picker Modal -->
  <div class="drops-picker" id="dropsPicker" onclick="if(event.target===this)closeDropsPicker()">
    <div class="drops-picker-content">
      <div class="drops-picker-header">
        <h3>Choose from Drops</h3>
        <button class="drops-picker-close" onclick="closeDropsPicker()"></button>
      </div>
      <div class="drops-picker-grid" id="dropsPickerGrid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- AI Tools Modal (for text drops) -->
  <div class="ai-tools-modal" id="aiToolsModal" onclick="if(event.target===this)closeAITools()">
    <div class="ai-tools-content">
      <div class="ai-tools-header">
        <h2>AI Tools</h2>
        <p>What would you like to do?</p>
      </div>
      <div class="ai-tools-preview">
        <div class="ai-tools-preview-label">Selected drop:</div>
        <div class="ai-tools-preview-text" id="aiToolsPreviewText"></div>
      </div>
      <div class="ai-tools-body">
        <div class="ai-tools-grid">
          <button class="ai-tool-btn" onclick="runAITool('summarize')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></span>
            <div class="info">
              <div class="title">Summarize</div>
              <div class="desc">Make it shorter and clearer</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('tasks')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg></span>
            <div class="info">
              <div class="title">Create Tasks</div>
              <div class="desc">Extract actionable to-dos</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('expand')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
            <div class="info">
              <div class="title">Expand</div>
              <div class="desc">Add more details and ideas</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('rewrite')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></span>
            <div class="info">
              <div class="title">Rewrite</div>
              <div class="desc">Different style or tone</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('enhance')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></span>
            <div class="info">
              <div class="title">Enhance</div>
              <div class="desc">Fix errors, punctuation, formatting</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="openTranslateModal()">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg></span>
            <div class="info">
              <div class="title">Translate</div>
              <div class="desc">Translate to another language</div>
            </div>
          </button>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsCheckCategory" checked>
          <div class="ai-tools-option-label">
            <div class="title">Also check/update category</div>
            <div class="current">Current: <span id="aiToolsCurrentCategory">INBOX</span></div>
          </div>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsRemoveLineBreaks">
          <div class="ai-tools-option-label">
            <div class="title">Remove extra line breaks</div>
            <div class="current">Join paragraphs into continuous text</div>
          </div>
        </div>
      </div>
      <div class="ai-tools-footer">
        <button class="pill-l sec" onclick="closeAITools()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Result Modal (large, with actions) -->
  <div class="ai-result-modal" id="aiResultModal2" onclick="if(event.target===this)closeAIResult2()">
    <div class="ai-result-content">
      <div class="ai-result-header">
        <h2 id="aiResult2Title">Result</h2>
      </div>
      <div class="ai-result-body">
        <div class="ai-result-text" id="aiResult2Text"></div>
        <div class="ai-result-category" id="aiResult2Category" style="display:none;">
          <div class="ai-result-category-title">Suggested category</div>
          <div class="ai-result-category-row">
            <span class="ai-result-category-current" id="aiResult2CurrentCat">INBOX</span>
            <span class="ai-result-category-arrow"></span>
            <span class="ai-result-category-suggested" id="aiResult2SuggestedCat">TASKS</span>
          </div>
          <div class="ai-result-category-actions">
            <button class="ai-result-category-btn" onclick="keepCategory()">Keep current</button>
            <button class="ai-result-category-btn accept" onclick="acceptCategory()">Change</button>
          </div>
        </div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l magic" onclick="replaceOriginal()">Replace original</button>
        <div class="pill-row">
          <button class="pill-l sec" onclick="createNewDrop()">New Drop</button>
          <button class="pill-l sec" onclick="copyResult2()">Copy</button>
        </div>
        <button class="pill-l sec" onclick="closeAIResult2()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- B2 FIX: Tasks Confirmation Modal -->
  <div class="ai-result-modal" id="tasksConfirmModal" onclick="if(event.target===this)closeTasksConfirm()">
    <div class="ai-result-content">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #10B981, #3B82F6);">
        <h2>Extracted Tasks</h2>
      </div>
      <div class="ai-result-body">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 12px;">Found <span id="tasksCount">0</span> tasks. Each will become a separate drop:</p>
        <div class="tasks-preview-list" id="tasksPreviewList"></div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l success" onclick="confirmCreateTasks()">
          Create <span id="tasksCountBtn">0</span> Task Drops
        </button>
        <button class="pill-l sec" onclick="closeTasksConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- I1 FIX: Translate Modal -->
  <div class="ai-result-modal" id="translateModal" onclick="if(event.target===this)closeTranslateModal()">
    <div class="ai-result-content" style="max-width: 360px;">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #3B82F6, #10B981);">
        <h2>Translate</h2>
      </div>
      <div class="ai-result-body" style="padding: 20px;">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 16px;">Select target language:</p>
        <div class="translate-langs">
          <button class="translate-lang-btn" onclick="runTranslate('English')"> English</button>
          <button class="translate-lang-btn" onclick="runTranslate('Russian')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Spanish')"> Espaol</button>
          <button class="translate-lang-btn" onclick="runTranslate('German')"> Deutsch</button>
          <button class="translate-lang-btn" onclick="runTranslate('French')"> Franais</button>
          <button class="translate-lang-btn" onclick="runTranslate('Chinese')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Japanese')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Portuguese')"> Portugus</button>
        </div>
      </div>
      <div class="ai-result-actions" style="padding: 16px 20px;">
        <button class="pill-l sec" onclick="closeTranslateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <button class="fab-record" id="fabRecord" onclick="toggleRec()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
  </button>

  <div class="rec-status" id="recStatus">
    <span class="rec-dot"></span>
    <span class="rec-text" id="recText">Listening...</span>
  </div>

  <button class="scroll-fab top" id="scrollTop" onclick="scrollToTop()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg></button>
  <button class="scroll-fab bottom" id="scrollBottom" onclick="scrollToBottom()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>

  <!-- Ask AI Panel -->
  <div class="ask-ai-panel" id="askAIPanel">
    <div class="ask-ai-handle" onclick="closeAskAI()">
      <div class="ask-ai-handle-bar"></div>
    </div>
    <div class="ask-ai-header">
      <div class="ask-ai-header-left">
        <div class="ask-ai-avatar">A</div>
        <div>
          <div class="ask-ai-title">Aski</div>
          <div class="ask-ai-subtitle" id="askiSubtitle">AI Assistant</div>
        </div>
      </div>
      <button class="ask-ai-header-btn ask-ai-btn-autodrop" id="autoDropIndicator" onclick="toggleAutoDropFromChat()" style="display: none;">AUTO</button>
      <button class="ask-ai-header-btn ask-ai-btn-stop" id="askiStopBtn" onclick="stopAskiResponse()">STOP</button>
      <button class="ask-ai-header-btn ask-ai-btn-done" onclick="closeAskAI()">HIDE</button>
      <button class="ask-ai-close" onclick="closeAskAI()"></button>
    </div>
    <div class="ask-ai-messages" id="askAIMessages">
      <div class="ask-ai-empty" id="askAIEmpty">
        <div class="ask-ai-empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <div class="ask-ai-empty-title">Ask me anything</div>
        <div class="ask-ai-empty-text">I'm here to help  answer questions, give ideas, or just chat.</div>
        <div class="ask-ai-prompts">
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('   ?')"> ?</button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt(' ')"></button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('  ?')"> </button>
        </div>
      </div>
    </div>
    <div class="ask-ai-input-area">
      <div class="ask-ai-input-row">
        <button class="ask-ai-btn ask-ai-btn-voice" id="askAIVoiceBtn" onclick="toggleAskAIVoice()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        </button>
        <input type="text" class="ask-ai-input" id="askAIInput" placeholder="Ask anything..." maxlength="500" oninput="updateAskAICharCount()" onkeypress="if(event.key==='Enter' && this.value.trim()) sendAskAIMessage()">
        <button class="ask-ai-btn ask-ai-btn-send" id="askAISendBtn" onclick="console.log('Send clicked'); sendAskAIMessage()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9 22 2Z"/></svg>
        </button>
      </div>
      <button class="ask-ai-voice-large" id="askAIVoiceLarge" onclick="toggleAskAIVoice()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        <span id="voiceLargeText">Tap to talk</span>
      </button>
      <div class="ask-ai-char-count" id="askAICharCount">0 / 500</div>
    </div>
  </div>

  <!-- Selection bar for merge -->
  <div class="select-bar" id="selectBar">
    <div class="select-info"><span id="selectCount">0</span> selected</div>
    <div class="select-actions">
      <button class="select-btn cancel" onclick="cancelSelect()">Cancel</button>
      <button class="select-btn delete" onclick="deleteSelected()">Delete</button>
      <button class="select-btn merge" onclick="showMergePreview()">Merge/Copy</button>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Main Menu Modal -->
  <div class="main-menu" id="mainMenu" onclick="if(event.target===this)closeMainMenu()">
    <div class="main-menu-content">
      <div class="main-menu-header">
        <h2><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg> Menu</h2>
        <button class="pill-s sec" onclick="closeMainMenu()">Close</button>
      </div>
      
      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-label">AI Token Balance</div>
        <div class="balance-value" id="tokenBalance"></div>
        <div class="balance-hint">Tokens refresh monthly  <span id="tokenUsage">Loading...</span></div>
      </div>
      
      <!-- Search Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Search</span></div>
        <input type="text" class="menu-search-input" id="menuSearchInput" placeholder="Search drops..." onkeypress="if(event.key==='Enter')performSearch()" style="width: 100%; margin-bottom: 16px;">
        <div class="pill-row">
          <button class="pill-m sec" onclick="startVoiceSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
            Voice
          </button>
          <button class="pill-m pri" onclick="performSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Search
          </button>
        </div>
      </div>
      
      <!-- Audio Recording Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span> Audio Drop</span></div>
        <button class="pill-l" id="audioRecordBtn" onclick="toggleAudioRecording()" style="width: 100%; background: linear-gradient(135deg, #F59E0B, #D97706); color: white;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="audioRecordBtnText">Record Audio Drop</span>
        </button>
        <div style="text-align: center; font-size: 0.75rem; color: var(--color-text-muted); margin-top: 8px;">
          Record voice memos, sounds, or music
        </div>
      </div>
      
      <!-- Undo Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Undo</span></div>
        <div class="undo-header">
          <button class="pill-l ai" id="undoMainBtn" onclick="undoLast()" disabled>
             Undo Last Action
          </button>
        </div>
        <div id="undoLastInfo" style="text-align: center; font-size: 0.85rem; color: var(--color-text-muted); margin-top: 8px;"></div>
        <button class="pill-l sec" id="undoToggleBtn" onclick="toggleUndoList()" style="display: none; margin-top: 12px;">
          Show history (0)
        </button>
        <div class="undo-list" id="undoList"></div>
      </div>
      
      <!-- Settings Section -->
      <div class="menu-section no-border">
        <div class="section-divider"><span>Aski Voice</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
            <span class="settings-item-label">Voice Mode</span>
            <span class="settings-item-warning"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Uses more battery</span>
          </div>
          <div class="settings-toggle" id="voiceModeToggle" onclick="toggleVoiceMode()"></div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span>
            <span class="settings-item-label">Auto-speak replies</span>
          </div>
          <div class="settings-toggle" id="autoSpeakToggle" onclick="toggleAutoSpeak()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></span>
            <span class="settings-item-label">TTS Provider</span>
          </div>
          <div class="pill-row" id="ttsProviderSelector">
            <button class="pill-m" data-provider="openai" onclick="setTTSProvider('openai')">OpenAI</button>
            <button class="pill-m" data-provider="elevenlabs" onclick="setTTSProvider('elevenlabs')">ElevenLabs</button>
            <button class="pill-m" data-provider="browser" onclick="setTTSProvider('browser')">Browser</button>
          </div>
        </div>
        
        <!-- OpenAI Voice Settings -->
        <div id="openaiVoiceSettings">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">OpenAI Voice</span>
            </div>
            <div class="pill-row" id="voiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="nova" onclick="setAskiVoice('nova')">Nova</button>
              <button class="pill-m" data-voice="shimmer" onclick="setAskiVoice('shimmer')">Shimmer</button>
              <button class="pill-m" data-voice="alloy" onclick="setAskiVoice('alloy')">Alloy</button>
              <button class="pill-m" data-voice="onyx" onclick="setAskiVoice('onyx')">Onyx</button>
              <button class="pill-m" data-voice="echo" onclick="setAskiVoice('echo')">Echo</button>
              <button class="pill-m" data-voice="fable" onclick="setAskiVoice('fable')">Fable</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">OpenAI API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="openaiApiKeyInput" placeholder="sk-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveOpenAIKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('openai')" id="apiKeyToggleBtn" style="min-width: 60px;">Show</button>
            </div>
            <div id="apiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
          </div>
        </div>
        
        <!-- ElevenLabs Voice Settings -->
        <div id="elevenlabsVoiceSettings" style="display: none;">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">ElevenLabs Voice (Russian)</span>
            </div>
            <div class="pill-row" id="elevenlabsVoiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="Nadia" data-voiceid="gedzfqL7OGdPbwm0ynTP" onclick="selectElevenLabsVoice('Nadia','gedzfqL7OGdPbwm0ynTP')">Nadia</button>
              <button class="pill-m" data-voice="Larisa" data-voiceid="AB9XsbSA4eLG12t2myjN" onclick="selectElevenLabsVoice('Larisa','AB9XsbSA4eLG12t2myjN')">Larisa</button>
              <button class="pill-m" data-voice="Dmitry" data-voiceid="kwajW3Xh5svCeKU5ky2S" onclick="selectElevenLabsVoice('Dmitry','kwajW3Xh5svCeKU5ky2S')">Dmitry</button>
              <button class="pill-m" data-voice="Bella" data-voiceid="EXAVITQu4vr4xnSDxMaL" onclick="selectElevenLabsVoice('Bella','EXAVITQu4vr4xnSDxMaL')">Bella</button>
              <button class="pill-m" data-voice="Rachel" data-voiceid="21m00Tcm4TlvDq8ikWAM" onclick="selectElevenLabsVoice('Rachel','21m00Tcm4TlvDq8ikWAM')">Rachel</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview  Native Russian speakers</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">ElevenLabs API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="elevenlabsApiKeyInput" placeholder="xi-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveElevenLabsKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('elevenlabs')" id="elevenlabsApiKeyToggleBtn" style="min-width: 60px;">Show</button>
            </div>
            <div id="elevenlabsApiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
            <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 4px;">
              Get free API key at <a href="https://elevenlabs.io" target="_blank" style="color: #8B5CF6;">elevenlabs.io</a> (10K chars/month free)
            </div>
          </div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
            <span class="settings-item-label">Listen time after Aski, sec</span>
          </div>
          <div class="pill-row" id="listenCyclesSelector">
            <button class="pill-m" data-cycles="10" onclick="setListenCycles(10)">10</button>
            <button class="pill-m active" data-cycles="15" onclick="setListenCycles(15)">15</button>
            <button class="pill-m" data-cycles="20" onclick="setListenCycles(20)">20</button>
            <button class="pill-m" data-cycles="25" onclick="setListenCycles(25)">25</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Aski Chat</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg></span>
            <span class="settings-item-label">AutoDrop</span>
            <span class="settings-item-hint" style="font-size: 0.7rem; color: var(--color-text-muted); margin-left: 8px;">Auto-save all messages</span>
          </div>
          <div class="settings-toggle" id="autoDropToggle" onclick="toggleAutoDrop()"></div>
        </div>
        
        <div class="section-divider"><span>Display</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></span>
            <span class="settings-item-label">Dark mode</span>
          </div>
          <div class="settings-toggle" id="darkModeToggle" onclick="toggleDarkMode()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></span>
            <span class="settings-item-label">Font size</span>
          </div>
          <div class="pill-row" id="fontSizeSelector">
            <button class="pill-m" data-size="small" onclick="setFontSize('small')">Small</button>
            <button class="pill-m active" data-size="normal" onclick="setFontSize('normal')">Normal</button>
            <button class="pill-m" data-size="large" onclick="setFontSize('large')">Large</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Cloud</span></div>
        
        <div class="settings-item no-border">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></span>
            <span class="settings-item-label">Sync to Syntrise</span>
          </div>
          <button class="pill-m pri" onclick="syncToCloud()">Sync</button>
        </div>
        
        <div class="section-divider"><span>Data</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v3"/><path d="M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3"/><path d="M4 12h16"/><path d="m9 8-4 4 4 4"/><path d="m15 8 4 4-4 4"/></svg></span>
            <span class="settings-item-label">Export data</span>
          </div>
          <button class="pill-m sec" onclick="exportData()">Export</button>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></span>
            <span class="settings-item-label">Import data</span>
          </div>
          <button class="pill-m sec" onclick="document.getElementById('importFileInput').click()">Import</button>
          <input type="file" id="importFileInput" style="display:none" accept=".json" onchange="handleImportFile(event)">
        </div>
        
        <div class="settings-item no-border" style="padding-bottom: 0;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></span>
            <span class="settings-item-label">Clear all data</span>
          </div>
          <button class="pill-m danger" onclick="clearAllData()">Clear</button>
        </div>
        
        <div class="section-divider"><span>About</span></div>
        
        <div class="menu-about" onclick="closeMainMenu(); openAbout();" style="cursor: pointer;">
          <div class="menu-about-logo">
            <svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
          </div>
          <div class="menu-about-name">DropLit</div>
          <div class="menu-about-ver">v0.9.29 by Syntrise</div>
          <div style="font-size: 0.7rem; color: var(--color-primary); margin-top: 8px;">Tap for more info</div>
        </div>
      </div>
      
      <!-- Footer with Close button -->
      <div class="main-menu-footer">
        <button class="pill-l sec" onclick="closeMainMenu()">Close Menu</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="aboutModal"><div class="modal"><div class="about-brand"><div class="about-logo"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div><div class="about-name">DropLit</div><div class="about-ver">v0.9.29 by Syntrise</div></div><div class="modal-text" style="text-align:center">Voice-first idea capture.<br>Long press card to select & merge.</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAbout()">Got it</button></div></div></div>
  <div class="overlay" id="catModal"><div class="modal type-b"><div class="modal-header"><h3>Move to Category</h3></div><div class="modal-body"><div class="cat-grid"><button class="cat-opt" data-cat="tasks" onclick="changeCat('tasks')">Tasks</button><button class="cat-opt" data-cat="ideas" onclick="changeCat('ideas')">Ideas</button><button class="cat-opt" data-cat="handmagic" onclick="changeCat('handmagic')">Handmagic</button><button class="cat-opt" data-cat="design" onclick="changeCat('design')">Design</button><button class="cat-opt" data-cat="bugs" onclick="changeCat('bugs')">Bugs</button><button class="cat-opt" data-cat="questions" onclick="changeCat('questions')">Questions</button><button class="cat-opt" data-cat="sketch" onclick="changeCat('sketch')">Sketch</button><button class="cat-opt" data-cat="scan" onclick="changeCat('scan')">Scan</button><button class="cat-opt" data-cat="inbox" onclick="changeCat('inbox')">Inbox</button></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeCatModal()">Cancel</button></div></div></div>
  <div class="overlay" id="sendModal"><div class="modal type-b"><div class="modal-header"><h3>Share Drop</h3></div><div class="modal-body"><div class="send-opts"><div class="send-opt" onclick="sendAI()"><div class="send-icon">AI</div><div class="send-info"><div class="send-title">AI Assistant</div><div class="send-desc">Copy + open Claude</div></div><span class="send-badge">Pro</span></div><div class="send-div">or share via</div><div class="send-opt" onclick="shareNative()"><div class="send-icon">...</div><div class="send-info"><div class="send-title">Share...</div><div class="send-desc">WhatsApp, Telegram</div></div></div><div class="send-opt" onclick="sendMail()"><div class="send-icon">@</div><div class="send-info"><div class="send-title">Email</div><div class="send-desc">Send via email</div></div></div><div class="send-opt" onclick="copyClip()"><div class="send-icon">#</div><div class="send-info"><div class="send-title">Copy</div><div class="send-desc">Copy to clipboard</div></div></div></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeSendModal()">Cancel</button></div></div></div>
  <div class="overlay" id="exportModal"><div class="modal type-b"><div class="modal-header"><h3>Export Data</h3></div><div class="modal-body"><div class="export-box" id="exportBox"></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeExportModal()">Close</button><button class="modal-btn pri" onclick="copyExport()">Copy All</button></div></div></div>
  <div class="overlay" id="delModal"><div class="modal"><div class="modal-title">Delete this idea?</div><div class="modal-text">This action cannot be undone.</div><div class="modal-actions"><button class="modal-btn sec" onclick="closeDelModal()">Cancel</button><button class="modal-btn danger" onclick="confirmDel()">Delete</button></div></div></div>
  <div class="overlay" id="settingsModal"><div class="modal type-b"><div class="modal-header"><h3>Settings</h3></div><div class="modal-body"><div class="modal-text" style="margin-bottom:0;">Syntrise CORE:<br>Sync your ideas to cloud</div></div><div class="modal-actions"><button class="modal-btn sec" onclick="syncToCloud()">Sync</button><button class="modal-btn sec" onclick="exportAll()">Export</button><button class="modal-btn pri" onclick="closeSettings()">Done</button></div></div></div>
  <div class="overlay" id="addCatModal"><div class="modal"><div class="modal-title">Add Category</div><div class="modal-text">Custom categories coming in a future update!</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAddCatModal()">OK</button></div></div></div>
  <div class="overlay" id="mergeModal"><div class="modal type-b"><div class="modal-header"><h3>Merge Preview</h3></div><div class="modal-body"><div class="merge-options"><label class="merge-toggle"><input type="checkbox" id="mergeSimple" onchange="updateMergePreview()"><span>Simple merge (no headers)</span></label></div><div class="merge-preview" id="mergePreview"></div></div><div class="modal-actions"><button class="pill-m sec" onclick="closeMergeModal()">Cancel</button><button class="pill-m sec" onclick="copyMerged()">Copy</button><button class="pill-m merge" onclick="saveMerged()">Save Merge</button></div></div></div>
  <div class="overlay image-viewer" id="imageViewer" onclick="handleImageViewerClick(event)">
    <div class="image-viewer-close" onclick="closeImageViewer()"></div>
    <div class="image-viewer-markers" id="imageViewerMarkers" onclick="openPhotoMarkers()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.47"/></svg></div>
    <div class="image-viewer-ai" onclick="openPhotoAI()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></div>
    <div class="image-counter" id="imageCounter">1 / 1</div>
    <div class="image-viewer-nav prev" id="imgNavPrev" onclick="navigateImage(-1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg></div>
    <div class="image-viewer-nav next" id="imgNavNext" onclick="navigateImage(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg></div>
    <div class="image-viewer-content" id="imageViewerContent">
      <img id="imageViewerImg" src="" alt="Full size">
    </div>
    <div class="image-viewer-panel" onclick="event.stopPropagation()">
      <div class="image-meta" id="imageMeta"></div>
      <div class="image-caption-row">
        <button class="caption-edit-btn" onclick="startEditCaption()">Edit</button>
        <div class="image-caption-display" id="imageCaptionDisplay"></div>
      </div>
      <div class="image-notes-wrap" id="imageNotesWrap">
        <textarea class="image-notes" id="imageNotes" placeholder="Add caption or notes..." rows="2"></textarea>
        <div class="image-edit-actions" id="imageEditActions">
          <button class="img-act" onclick="cancelEditCaption()">Cancel</button>
          <button class="img-act primary" onclick="saveCaption()">Save</button>
        </div>
      </div>
      <div class="image-actions" id="imageActions">
        <button class="img-act" onclick="shareImage()">Share</button>
        <button class="img-act" onclick="saveImageToGallery()">Download</button>
        <button class="img-act delete" onclick="deleteFromViewer()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo AI Tools Modal -->
  <div class="photo-ai-modal" id="photoAIModal" onclick="if(event.target===this)closePhotoAI()">
    <div class="photo-ai-content">
      <div class="photo-ai-header">
        <h3>AI Tools</h3>
        <p>What would you like to do?</p>
      </div>
      <div class="photo-ai-tools">
        <button class="photo-ai-btn" onclick="runPhotoAI('ocr')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></div>
          <div class="info">
            <div class="title">Extract Text (OCR)</div>
            <div class="desc">Read and copy text from image</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="runPhotoAI('describe')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div>
          <div class="info">
            <div class="title">Describe Image</div>
            <div class="desc">AI generates detailed description</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="startEditCaption(); closePhotoAI();">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></div>
          <div class="info">
            <div class="title">Edit Caption</div>
            <div class="desc">Add or edit photo notes</div>
          </div>
        </button>
      </div>
      <button class="pill-l sec" onclick="closePhotoAI()">Cancel</button>
    </div>
  </div>

  <!-- Photo AI Result Modal -->
  <div class="photo-ai-result" id="photoAIResult" onclick="if(event.target===this)closePhotoAIResult()">
    <div class="photo-ai-result-content">
      <div class="photo-ai-result-header">
        <h3 id="photoAIResultTitle">Result</h3>
      </div>
      <div class="photo-ai-result-text" id="photoAIResultText"></div>
      <div class="photo-ai-result-actions">
        <button class="pill-l ai" onclick="savePhotoAIToCaption()">Set as Caption</button>
        <button class="pill-l sec" onclick="savePhotoAIToNewDrop()">Create New Drop</button>
        <button class="pill-l sec" onclick="copyPhotoAIResult()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Photo Markers Modal -->
  <div class="photo-markers-modal" id="photoMarkersModal" onclick="if(event.target===this)closePhotoMarkersModal()">
    <div class="photo-markers-content">
      <div class="photo-markers-title">Add Markers</div>
      <div class="photo-markers-grid" id="photoMarkersGrid"></div>
      <button class="photo-markers-done" onclick="closePhotoMarkersModal()">Done</button>
    </div>
  </div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}
let ideas=JSON.parse(localStorage.getItem('droplit_ideas'))||[];
let curCat='all',curTime='all',sortAsc=true,isRec=false,recognition=null,saved=false;
let sendId=null,delId=null,catChangeId=null,editId=null,activeCardId=null;
let selectMode=false,selectedIds=[];
let lastScrollTop=0,longPressTimer=null;

// AI Configuration
const AI_API_URL = '/api/ai';
let aiProcessing = false;

const CATS={
  tasks:{name:'TASKS',single:'TASK',kw:['task','tasks','todo','','','','',''],isMedia:false},
  ideas:{name:'IDEAS',single:'IDEA',kw:['idea','ideas','','','',''],isMedia:false},
  handmagic:{name:'HANDMAGIC',single:'HANDMAGIC',kw:['handmagic','','',' '],isMedia:false},
  design:{name:'DESIGN',single:'DESIGN',kw:['design','','ui','ux','','',''],isMedia:false},
  bugs:{name:'BUGS',single:'BUG',kw:['bug','bugs','fix','','','','',''],isMedia:false},
  questions:{name:'QUESTIONS',single:'QUESTION',kw:['question','questions','','','','claude',''],isMedia:false},
  link:{name:'LINKS',single:'LINK',kw:['link','url','http','https','www',''],isMedia:false},
  sketch:{name:'SKETCHES',single:'SKETCH',kw:[],isMedia:true},
  scan:{name:'SCANS',single:'SCAN',kw:[],isMedia:true},
  photo:{name:'PHOTOS',single:'PHOTO',kw:[],isMedia:true},
  audio:{name:'AUDIO',single:'AUDIO',kw:[],isMedia:true,isAudio:true},
  inbox:{name:'INBOX',single:'INBOX',kw:[],isMedia:false}
};
const MEDIA_CATS=['photo','sketch','scan','audio'];

// Markers system (scalable for future)
const MARKERS={
  heart:'',
  star:'',
  fire:'',
  done:'',
  trash:'',
  think:''
};
// Currently enabled markers (MVP = only heart)
const ENABLED_MARKERS=['heart'];

function parseD(s){
  if(!s||typeof s!=='string')return new Date(0);
  const parts=s.split('.');
  if(parts.length!==3)return new Date(0);
  const[d,m,y]=parts.map(Number);
  return new Date(y,m-1,d);
}
function inDays(s,n){
  if(!s)return false;
  try{return(new Date()-parseD(s))/(864e5)<=n;}catch(e){return false;}
}
function isToday(s){
  if(!s)return false;
  return s===new Date().toLocaleDateString('ru-RU');
}

const ideasWrap=document.getElementById('ideasWrap');
const scrollTopBtn=document.getElementById('scrollTop');
const scrollBottomBtn=document.getElementById('scrollBottom');
let scrollTimeout=null;

ideasWrap.addEventListener('scroll',()=>{
  const st=ideasWrap.scrollTop;
  const maxScroll=ideasWrap.scrollHeight-ideasWrap.clientHeight;
  const dir=st>lastScrollTop?1:-1;
  lastScrollTop=st;
  clearTimeout(scrollTimeout);
  scrollTopBtn.classList.remove('show');
  scrollBottomBtn.classList.remove('show');
  if(maxScroll>300){
    if(dir<0 && st>200) scrollTopBtn.classList.add('show');
    else if(dir>0 && st<maxScroll-200) scrollBottomBtn.classList.add('show');
  }
  scrollTimeout=setTimeout(()=>{
    scrollTopBtn.classList.remove('show');
    scrollBottomBtn.classList.remove('show');
  },2000);
});

function scrollToTop(){ideasWrap.scrollTo({top:0,behavior:'smooth'});scrollTopBtn.classList.remove('show');}
function scrollToBottom(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'smooth'});scrollBottomBtn.classList.remove('show');}
function scrollToBottomInstant(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'instant'});}
function toggleSort(){sortAsc=!sortAsc;document.getElementById('sortBtn').innerHTML=sortAsc?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>';document.getElementById('sortBtn').classList.toggle('desc',!sortAsc);render();}

// Selection mode
function enterSelectMode(id){
  selectMode=true;
  selectedIds=[id];
  activeCardId=null;
  document.body.classList.add('select-mode');
  document.getElementById('fabRecord').style.display='none';
  document.getElementById('fabCamera').style.display='none';
  updateSelectBar();
  render();
}

function cancelSelect(){
  selectMode=false;
  selectedIds=[];
  document.body.classList.remove('select-mode');
  document.getElementById('selectBar').classList.remove('show');
  document.getElementById('fabRecord').style.display='flex';
  document.getElementById('fabCamera').style.display='flex';
  render();
}

function deleteSelected(){
  if(selectedIds.length===0)return;
  const count=selectedIds.length;
  if(confirm('Delete '+count+' selected items?')){
    ideas=ideas.filter(i=>!selectedIds.includes(i.id));
    save();
    cancelSelect();
    render();counts();
    toast(count+' items deleted','info');
  }
}

function toggleSelect(id){
  if(selectedIds.includes(id)){
    selectedIds=selectedIds.filter(x=>x!==id);
    if(selectedIds.length===0) cancelSelect();
  } else {
    selectedIds.push(id);
  }
  updateSelectBar();
  render();
}

function updateSelectBar(){
  document.getElementById('selectCount').textContent=selectedIds.length;
  document.getElementById('selectBar').classList.toggle('show',selectMode&&selectedIds.length>0);
}

function getMergedText(simple=false){
  const selected=ideas.filter(i=>selectedIds.includes(i.id));
  // Sort by timestamp
  selected.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  
  if(simple){
    // Simple merge - just text, double newline between
    return selected.map(i=>{
      if(i.isMedia){
        return i.notes||'[Photo '+i.date+' '+i.time+']';
      }
      return i.text;
    }).join('\n\n');
  }
  
  // List merge with headers
  return selected.map(i=>{
    const cat=CATS[i.category]?.name||'INBOX';
    if(i.isMedia){
      const content=i.notes||'[Photo '+i.date+' '+i.time+']';
      return `- [${cat}] ${content}`;
    }
    return `- [${cat}] ${i.text}`;
  }).join('\n');
}

function updateMergePreview(){
  const simple=document.getElementById('mergeSimple').checked;
  document.getElementById('mergePreview').textContent=getMergedText(simple);
}

function showMergePreview(){
  if(selectedIds.length<2){toast('Select at least 2 cards','warning');return;}
  // Check if any selected item is media
  const hasMedia=selectedIds.some(id=>{
    const item=ideas.find(x=>x.id===id);
    return item&&item.isMedia;
  });
  if(hasMedia){toast('Cannot merge media items','warning');return;}
  
  // Get current checkbox state and update preview accordingly
  const simple=document.getElementById('mergeSimple').checked;
  const mergedText = getMergedText(simple);
  document.getElementById('mergePreview').textContent=mergedText;
  
  // Warning for large merge
  const charCount = mergedText.length;
  if (charCount > 10000) {
    toast(`Large merge: ${Math.round(charCount/1000)}K chars`, 'warning');
  }
  
  document.getElementById('mergeModal').classList.add('show');
}

function closeMergeModal(){document.getElementById('mergeModal').classList.remove('show');}

function copyMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  navigator.clipboard.writeText(getMergedText(simple));
  toast('Copied to clipboard!','success');
  closeMergeModal();
}

function saveMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  const text=getMergedText(simple);
  
  // Check size limit
  const MAX_DROP_SIZE = 50000; // 50KB
  if (text.length > MAX_DROP_SIZE) {
    toast(`Too large! Max: ${MAX_DROP_SIZE/1000}K chars`, 'error');
    return;
  }
  
  const mergedId = Date.now();
  const idea={id:mergedId,text:text,category:'inbox',timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMerged:true};
  ideas.push(idea);
  
  // Save undo
  saveUndo('merge', { mergedId: mergedId, count: selectedIds.length });
  
  save();
  closeMergeModal();
  cancelSelect();
  resetToShowAll();
  toast('Merged & saved!','success');
}

// Card interactions
function handleCardClick(id,e){
  // Ignore clicks on category badge, action buttons, textarea, checkbox, markers
  if(e.target.closest('.card-cat')||e.target.closest('.act')||e.target.closest('.card-ta')||e.target.closest('.card-checkbox')||e.target.closest('.card-markers'))return;
  
  const item=ideas.find(x=>x.id===id);
  
  if(selectMode){
    // In select mode - always toggle selection
    toggleSelect(id);
  } else if(editId && editId !== id) {
    // If editing another card, don't activate this one
    return;
  } else if(item && item.isMedia) {
    // For media cards - open viewer directly
    viewImage(id,e);
  } else {
    // For text cards - toggle expand/collapse (optimized - no full render)
    const prevId = activeCardId;
    activeCardId = activeCardId===id ? null : id;
    
    // Remove active from previous card
    if(prevId) {
      const prevCard = document.querySelector('.card[data-id="'+prevId+'"]');
      if(prevCard) prevCard.classList.remove('active');
    }
    
    // Add active to new card (or none if deactivating)
    if(activeCardId) {
      const newCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
      if(newCard) newCard.classList.add('active');
    }
  }
}

function toggleMarker(id,marker,e){
  if(e){e.stopPropagation();}
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Initialize markers array if needed
  if(!item.markers)item.markers=[];
  
  // Toggle marker (silent - no toast per B3 fix)
  const idx=item.markers.indexOf(marker);
  if(idx===-1){
    item.markers.push(marker);
  } else {
    item.markers.splice(idx,1);
  }
  
  save();
  render();
  
  // Update photo markers button if in image viewer
  if(currentImageId === id) {
    updatePhotoMarkersButton();
  }
}

function handleCardLongPress(id){
  if(!selectMode){
    enterSelectMode(id);
    if(navigator.vibrate)navigator.vibrate(50);
  }
}

let touchStartX=0,touchStartY=0;

function cardTouchStart(id,e){
  if(selectMode||editId)return;
  const touch=e.touches[0];
  touchStartX=touch.clientX;
  touchStartY=touch.clientY;
  longPressTimer=setTimeout(()=>handleCardLongPress(id),800);
}

function cardTouchMove(e){
  if(!longPressTimer)return;
  const touch=e.touches[0];
  const dx=Math.abs(touch.clientX-touchStartX);
  const dy=Math.abs(touch.clientY-touchStartY);
  // Cancel if moved more than 10px (scrolling)
  if(dx>10||dy>10){
    clearTimeout(longPressTimer);
    longPressTimer=null;
  }
}

function cardTouchEnd(){
  clearTimeout(longPressTimer);
  longPressTimer=null;
}

document.addEventListener('click',(e)=>{
  if(activeCardId&&!e.target.closest('.card')&&!e.target.closest('.overlay')&&!e.target.closest('.fab-record')&&!e.target.closest('.select-bar')){
    const prevCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
    if(prevCard) prevCard.classList.remove('active');
    activeCardId=null;
  }
});

function initSR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('warning').style.display='block';document.getElementById('fabRecord').style.opacity='0.5';return false;}
  recognition=new SR();
  recognition.lang='ru-RU';
  recognition.continuous=false;
  recognition.interimResults=true;
  recognition.maxAlternatives=1;
  recognition.onstart=async()=>{isRec=true;saved=false;updateRecUI(true);await acquireWakeLock();};
  recognition.onresult=(e)=>{
    let f='',i='';
    for(let x=0;x<e.results.length;x++){if(e.results[x].isFinal)f+=e.results[x][0].transcript;else i+=e.results[x][0].transcript;}
    document.getElementById('recText').textContent=(f||i)||'Listening...';
    if(f&&!saved){saved=true;saveIdea(f.trim());}
  };
  recognition.onerror=(e)=>{
    if(e.error==='no-speech')toast('No speech detected','warning');
    else if(e.error==='not-allowed')toast('Microphone access denied','error');
    isRec=false;updateRecUI(false);releaseWakeLock();
  };
  recognition.onend=()=>{isRec=false;updateRecUI(false);releaseWakeLock();};
  return true;
}

// B4 FIX: Wake Lock to prevent screen from turning off during recording
let wakeLock = null;
async function acquireWakeLock() {
  if ('wakeLock' in navigator) {
    try { 
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock acquired');
      // Re-acquire if released (e.g., when tab becomes visible again)
      wakeLock.addEventListener('release', () => {
        console.log('Wake Lock released');
        wakeLock = null;
      });
    } 
    catch (err) { console.log('Wake Lock error:', err); }
  }
}
function releaseWakeLock() {
  if (wakeLock) { 
    wakeLock.release(); 
    wakeLock = null; 
    console.log('Wake Lock released manually');
  }
}

function toggleRec(){if(isRec)recognition.stop();else{saved=false;recognition.start();}}
function updateRecUI(on){
  const fab=document.getElementById('fabRecord'),status=document.getElementById('recStatus');
  if(on){fab.classList.add('recording');status.classList.add('show');document.getElementById('recText').textContent='Listening...';}
  else{fab.classList.remove('recording');status.classList.remove('show');}
}
function detectCat(t){
  const l=t.toLowerCase();
  for(const[k,v]of Object.entries(CATS)){
    if(k==='inbox'||!v.kw||v.kw.length===0)continue;
    for(const w of v.kw){
      // Check: starts with word, contains word with spaces, or ends with word
      if(l.startsWith(w+' ')||l.startsWith(w+',')||l.startsWith(w+'.')||
         l.includes(' '+w+' ')||l.includes(' '+w+',')||l.includes(' '+w+'.')||
         l.endsWith(' '+w)||l===w)return k;
    }
  }
  return'inbox';
}
function saveIdea(t){
  const c=detectCat(t);
  const idea={id:Date.now(),text:t,category:c,timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMedia:false};
  ideas.push(idea);save(idea);
  resetToShowAll();
  toast('Saved to '+CATS[c].name,'success');
}

function resetToShowAll(){
  try{
    // Reset filter variables
    curCat='all';
    curTime='7days';
    activeCardId=null;
    sortAsc=true;
    // Update sort button UI
    const sortBtn=document.getElementById('sortBtn');
    if(sortBtn){
      sortBtn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
      sortBtn.classList.remove('desc');
    }
    // Remove active class from category buttons
    document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
    // Update time buttons - activate 7d
    document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
    const btn7d=document.querySelector('.time-btn[data-time="7days"]');
    if(btn7d)btn7d.classList.add('active');
    // Render and scroll (instant, no animation)
    render();
    counts();
    setTimeout(()=>{
      const wrap=document.getElementById('ideasWrap');
      if(wrap)wrap.scrollTo({top:wrap.scrollHeight,behavior:'auto'});
    },50);
  }catch(err){
    console.error('resetToShowAll error:',err);
  }
}

function handlePhoto(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing photo...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200; // Max dimension
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    // Compress to JPEG 70% quality
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    savePhoto(dataUrl,null);
  };
  img.onerror=function(){
    toast('Failed to load photo','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read photo','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

function savePhoto(dataUrl,geo){
  const idea={
    id:Date.now(),
    text:'',
    notes:'',
    image:dataUrl,
    category:'photo',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    geo:geo,
    isMedia:true
  };
  ideas.push(idea);
  save();
  toast('Photo saved!','success');
  try{
    resetToShowAll();
  }catch(err){
    // Silent fail - photo is saved
  }
}

// ============================================
// ASK AI CHAT FUNCTIONS
// ============================================

let askAIMessages = [];
let askAIVoiceRecognition = null;

function openAskAI() {
  const panel = document.getElementById('askAIPanel');
  panel.classList.add('show');
  document.body.classList.add('chat-open');
  // No auto-focus - voice-first approach, keyboard won't popup
  
  // Keep screen on while chat is open (like TikTok)
  acquireWakeLock();
  
  // Update UI based on Voice Mode
  updateVoiceModeUI();
  
  // Update AutoDrop indicator
  updateAutoDropIndicator();
  
  // Voice Mode: start in sleep mode, user taps mic to activate
  if (isVoiceModeEnabled()) {
    voiceModeLocked = false;
    voiceModeSleeping = true; // Start sleeping - wait for user tap
    askiIsProcessing = false;
    updateVoiceModeIndicator('sleeping');
  }
}

function closeAskAI() {
  const panel = document.getElementById('askAIPanel');
  panel.classList.remove('show', 'voice-mode-active', 'aski-busy');
  document.body.classList.remove('chat-open');
  
  // Stop everything and reset all voice states
  voiceModeLocked = true;
  voiceModeSleeping = false;
  
  clearVoiceModeTimeout();
  stopVoiceModeListening();
  askiStopSpeaking();
  updateVoiceModeIndicator('');
  
  // Allow screen to sleep when chat is closed
  releaseWakeLock();
}

// Update UI based on Voice Mode setting
function updateVoiceModeUI() {
  const panel = document.getElementById('askAIPanel');
  if (isVoiceModeEnabled()) {
    panel.classList.add('voice-mode-active');
  } else {
    panel.classList.remove('voice-mode-active');
  }
}

// Set Aski busy state (processing or speaking)
function setAskiBusy(busy) {
  const panel = document.getElementById('askAIPanel');
  if (busy) {
    panel.classList.add('aski-busy');
  } else {
    panel.classList.remove('aski-busy');
  }
}

// Stop Aski response (speaking or waiting for API)
function stopAskiResponse() {
  console.log('Stopping Aski response');
  askiStopSpeaking();
  askiIsProcessing = false;
  voiceModeLocked = false;
  setAskiBusy(false);
  
  // Go to sleep mode
  if (isVoiceModeEnabled()) {
    voiceModeSleeping = true;
    updateVoiceModeIndicator('sleeping');
  }
  showToast('Stopped');
}

function setAskAIPrompt(text) {
  const input = document.getElementById('askAIInput');
  input.value = text;
  updateAskAICharCount();
  input.focus();
}

function updateAskAICharCount() {
  const input = document.getElementById('askAIInput');
  const count = input.value.length;
  const counter = document.getElementById('askAICharCount');
  counter.textContent = `${count} / 500`;
  counter.classList.toggle('warning', count > 450);
  document.getElementById('askAISendBtn').disabled = count === 0;
}

// ============================================
// ASKI VOICE (Text-to-Speech) + VOICE MODE
// ============================================

let askiIsSpeaking = false;
let askiCurrentUtterance = null;
let askiVoice = localStorage.getItem('aski_voice') || 'nova'; // OpenAI TTS voice
let askiApiKey = localStorage.getItem('openai_tts_key') || '';

// TTS Provider settings
let ttsProvider = localStorage.getItem('tts_provider') || 'openai'; // openai, elevenlabs, browser
let elevenlabsApiKey = localStorage.getItem('elevenlabs_tts_key') || '';
let elevenlabsVoice = localStorage.getItem('elevenlabs_voice') || 'Nadia';
let elevenlabsVoiceId = localStorage.getItem('elevenlabs_voice_id') || 'gedzfqL7OGdPbwm0ynTP';

// ElevenLabs voices - Russian native speakers
const ELEVENLABS_VOICES = {
  // Russian voices (tested & working)
  'Nadia': 'gedzfqL7OGdPbwm0ynTP',      // Russian female - RECOMMENDED
  'Larisa': 'AB9XsbSA4eLG12t2myjN',     // Russian female
  'Dmitry': 'kwajW3Xh5svCeKU5ky2S',     // Russian male
  // Multilingual voices (English + Russian)
  'Bella': 'EXAVITQu4vr4xnSDxMaL',      // English/Russian female
  'Rachel': '21m00Tcm4TlvDq8ikWAM'      // English/Russian female
};

// Loaded voices from API (will be populated dynamically)
let elevenlabsLoadedVoices = [];

// Load voices from ElevenLabs API
async function loadElevenLabsVoices() {
  if (!elevenlabsApiKey) {
    showToast('Enter ElevenLabs API key first');
    return;
  }
  
  showToast('Loading voices...');
  
  try {
    const response = await fetch('https://api.elevenlabs.io/v1/voices', {
      method: 'GET',
      headers: {
        'xi-api-key': elevenlabsApiKey
      }
    });
    
    if (!response.ok) {
      showToast('Failed to load voices');
      return;
    }
    
    const data = await response.json();
    elevenlabsLoadedVoices = data.voices || [];
    
    console.log('Loaded voices:', elevenlabsLoadedVoices.length);
    
    // Update voice selector with loaded voices
    updateElevenLabsVoiceSelector();
    
    showToast(`Loaded ${elevenlabsLoadedVoices.length} voices`);
    
  } catch (error) {
    console.error('Error loading voices:', error);
    showToast('Error loading voices');
  }
}

// Update ElevenLabs voice selector with loaded voices
function updateElevenLabsVoiceSelector() {
  const selector = document.getElementById('elevenlabsVoiceSelector');
  if (!selector) return;
  
  // If we have loaded voices, show them
  if (elevenlabsLoadedVoices.length > 0) {
    let html = '';
    
    // Group by category: default voices first, then others
    const defaultVoices = elevenlabsLoadedVoices.filter(v => v.category === 'premade' || v.category === 'default');
    const otherVoices = elevenlabsLoadedVoices.filter(v => v.category !== 'premade' && v.category !== 'default');
    
    // Show default voices
    defaultVoices.slice(0, 12).forEach(voice => {
      const isActive = elevenlabsVoiceId === voice.voice_id;
      html += `<button class="pill-m ${isActive ? 'active' : ''}" data-voice="${voice.name}" data-voiceid="${voice.voice_id}" onclick="selectElevenLabsVoice('${voice.name}', '${voice.voice_id}')">${voice.name}</button>`;
    });
    
    // Add separator if there are other voices
    if (otherVoices.length > 0) {
      html += `<div style="width: 100%; font-size: 0.7rem; color: var(--color-text-muted); margin: 8px 0 4px;">Library voices:</div>`;
      otherVoices.slice(0, 12).forEach(voice => {
        const isActive = elevenlabsVoiceId === voice.voice_id;
        html += `<button class="pill-m ${isActive ? 'active' : ''}" data-voice="${voice.name}" data-voiceid="${voice.voice_id}" onclick="selectElevenLabsVoice('${voice.name}', '${voice.voice_id}')">${voice.name}</button>`;
      });
    }
    
    selector.innerHTML = html;
  }
}

// Select ElevenLabs voice
function selectElevenLabsVoice(name, voiceId) {
  elevenlabsVoice = name;
  elevenlabsVoiceId = voiceId;
  localStorage.setItem('elevenlabs_voice', name);
  localStorage.setItem('elevenlabs_voice_id', voiceId);
  
  // Update UI - remove active from all, add to selected
  document.querySelectorAll('#elevenlabsVoiceSelector .pill-m').forEach(btn => {
    btn.classList.remove('active');
  });
  const selectedBtn = document.querySelector(`#elevenlabsVoiceSelector .pill-m[data-voiceid="${voiceId}"]`);
  if (selectedBtn) {
    selectedBtn.classList.add('active');
  }
  
  // Preview
  previewElevenLabsVoice(name);
}

// Remove emojis from text before speaking
function removeEmojis(text) {
  return text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]|[\u{231A}-\u{231B}]|[\u{23E9}-\u{23F3}]|[\u{23F8}-\u{23FA}]|[\u{25AA}-\u{25AB}]|[\u{25B6}]|[\u{25C0}]|[\u{25FB}-\u{25FE}]|[\u{2614}-\u{2615}]|[\u{2648}-\u{2653}]|[\u{267F}]|[\u{2693}]|[\u{26A1}]|[\u{26AA}-\u{26AB}]|[\u{26BD}-\u{26BE}]|[\u{26C4}-\u{26C5}]|[\u{26CE}]|[\u{26D4}]|[\u{26EA}]|[\u{26F2}-\u{26F3}]|[\u{26F5}]|[\u{26FA}]|[\u{26FD}]|[\u{2702}]|[\u{2705}]|[\u{2708}-\u{270D}]|[\u{270F}]|[\u{2712}]|[\u{2714}]|[\u{2716}]|[\u{271D}]|[\u{2721}]|[\u{2728}]|[\u{2733}-\u{2734}]|[\u{2744}]|[\u{2747}]|[\u{274C}]|[\u{274E}]|[\u{2753}-\u{2755}]|[\u{2757}]|[\u{2763}-\u{2764}]|[\u{2795}-\u{2797}]|[\u{27A1}]|[\u{27B0}]|[\u{27BF}]|[\u{2934}-\u{2935}]|[\u{2B05}-\u{2B07}]|[\u{2B1B}-\u{2B1C}]|[\u{2B50}]|[\u{2B55}]|[\u{3030}]|[\u{303D}]|[\u{3297}]|[\u{3299}]|[\u{1F004}]|[\u{1F0CF}]|[\u{1F170}-\u{1F171}]|[\u{1F17E}-\u{1F17F}]|[\u{1F18E}]|[\u{1F191}-\u{1F19A}]|[\u{1F201}-\u{1F202}]|[\u{1F21A}]|[\u{1F22F}]|[\u{1F232}-\u{1F23A}]|[\u{1F250}-\u{1F251}]||||||||||||||||||||/gu, '').trim();
}

// Detect language from text
function detectLanguage(text) {
  const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
  const chineseRegex = /[\u4E00-\u9FFF]/;
  const koreanRegex = /[\uAC00-\uD7AF\u1100-\u11FF]/;
  const cyrillicRegex = /[\u0400-\u04FF]/;
  const arabicRegex = /[\u0600-\u06FF]/;
  const hebrewRegex = /[\u0590-\u05FF]/;
  
  if (japaneseRegex.test(text) && !chineseRegex.test(text.replace(/[\u4E00-\u9FAF]/g, ''))) {
    return 'ja-JP';
  }
  if (chineseRegex.test(text)) return 'zh-CN';
  if (koreanRegex.test(text)) return 'ko-KR';
  if (cyrillicRegex.test(text)) return 'ru-RU';
  if (arabicRegex.test(text)) return 'ar-SA';
  if (hebrewRegex.test(text)) return 'he-IL';
  
  return 'en-US';
}

// Get best available voice for language and gender preference
function getVoiceForLang(lang) {
  const voices = speechSynthesis.getVoices();
  const langPrefix = lang.split('-')[0];
  
  // Filter voices by language
  let langVoices = voices.filter(v => v.lang === lang || v.lang.startsWith(langPrefix));
  
  if (langVoices.length === 0) {
    langVoices = voices;
  }
  
  // Try to find voice matching gender preference (for browser TTS fallback)
  // Map OpenAI voices to gender preference
  const femaleVoices = ['nova', 'shimmer'];
  const preferFemale = femaleVoices.includes(askiVoice);
  
  // Common female voice name patterns
  const femalePatterns = /female|woman|samantha|victoria|karen|moira|tessa|milena|anna|elena|irina|natasha|yuna|mei|xiaoxiao|huihui|sayaka|kyoko|siri.*female/i;
  // Common male voice name patterns  
  const malePatterns = /male|man|daniel|alex|tom|oliver|boris|yuri|maxim|ichiro|otoya|siri.*male/i;
  
  let preferredVoice = null;
  
  if (preferFemale) {
    preferredVoice = langVoices.find(v => femalePatterns.test(v.name));
  } else {
    preferredVoice = langVoices.find(v => malePatterns.test(v.name));
  }
  
  return preferredVoice || langVoices[0] || voices[0];
}

// ===== AUDIO PLAYBACK via AudioContext (for Android compatibility) =====
let globalAudioContext = null;
let currentAudioSource = null;

function getAudioContext() {
  if (!globalAudioContext) {
    globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  return globalAudioContext;
}

// Play audio blob using AudioContext (works on Android!)
async function playAudioBlob(blob, onEnd = null) {
  try {
    const ctx = getAudioContext();
    
    // Resume if suspended (required after page load)
    if (ctx.state === 'suspended') {
      await ctx.resume();
    }
    
    // Stop current playback
    if (currentAudioSource) {
      try { currentAudioSource.stop(); } catch(e) {}
      currentAudioSource = null;
    }
    
    // Decode audio
    const arrayBuffer = await blob.arrayBuffer();
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
    
    // Create source and play
    const source = ctx.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(ctx.destination);
    
    source.onended = () => {
      currentAudioSource = null;
      if (onEnd) onEnd();
    };
    
    currentAudioSource = source;
    source.start();
    
    return true;
  } catch (error) {
    console.error('AudioContext playback error:', error);
    return false;
  }
}

// Stop current audio playback
function stopAudioPlayback() {
  if (currentAudioSource) {
    try { currentAudioSource.stop(); } catch(e) {}
    currentAudioSource = null;
  }
}

// ===== TTS Functions =====

// Speak text with Aski's voice
let askiAudio = null; // Current audio element for OpenAI TTS

async function askiSpeak(text, lang = null, onEnd = null) {
  if (askiIsSpeaking) {
    askiStopSpeaking();
  }
  
  // Remove emojis before speaking
  const cleanText = removeEmojis(text);
  if (!cleanText) {
    if (onEnd) onEnd();
    return;
  }
  
  // :    localStorage   
  ttsProvider = localStorage.getItem('tts_provider') || 'openai';
  elevenlabsApiKey = localStorage.getItem('elevenlabs_tts_key') || '';
  elevenlabsVoiceId = localStorage.getItem('elevenlabs_voice_id') || 'gedzfqL7OGdPbwm0ynTP';
  askiApiKey = localStorage.getItem('openai_tts_key') || '';
  
  // Route to appropriate TTS provider
  if (ttsProvider === 'elevenlabs') {
    if (elevenlabsApiKey) {
      await askiSpeakElevenLabs(cleanText, onEnd);
    } else {
      showToast('ElevenLabs: no API key');
      askiSpeakBrowser(cleanText, lang, onEnd);
    }
  } else if (ttsProvider === 'openai') {
    if (askiApiKey) {
      await askiSpeakOpenAI(cleanText, onEnd);
    } else {
      askiSpeakBrowser(cleanText, lang, onEnd);
    }
  } else {
    // Browser TTS
    askiSpeakBrowser(cleanText, lang, onEnd);
  }
}

// OpenAI TTS
async function askiSpeakOpenAI(text, onEnd = null) {
  try {
    askiIsSpeaking = true;
    updateSpeakingIndicator(true);
    updateVoiceModeIndicator('speaking');
    
    const response = await fetch('https://api.openai.com/v1/audio/speech', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${askiApiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'tts-1',
        input: text,
        voice: askiVoice,
        response_format: 'mp3'
      })
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      showToast('TTS error: ' + (error.error?.message || response.status));
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      askiSpeakBrowser(text, null, onEnd);
      return;
    }
    
    const blob = await response.blob();
    
    // Play using AudioContext (works on Android!)
    const success = await playAudioBlob(blob, () => {
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      if (onEnd) onEnd();
    });
    
    if (!success) {
      // Fallback to browser TTS
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      askiSpeakBrowser(text, null, onEnd);
    }
    
  } catch (error) {
    console.error('OpenAI TTS error:', error);
    askiIsSpeaking = false;
    updateSpeakingIndicator(false);
    askiSpeakBrowser(text, null, onEnd);
  }
}

// ElevenLabs TTS
async function askiSpeakElevenLabs(text, onEnd = null) {
  // Check if we have API key
  if (!elevenlabsApiKey) {
    showToast('ElevenLabs: no API key');
    askiSpeakBrowser(text, null, onEnd);
    return;
  }
  
  try {
    askiIsSpeaking = true;
    updateSpeakingIndicator(true);
    updateVoiceModeIndicator('speaking');
    
    // Use stored voice ID
    const voiceId = elevenlabsVoiceId || 'gedzfqL7OGdPbwm0ynTP';
    
    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
      method: 'POST',
      headers: {
        'xi-api-key': elevenlabsApiKey,
        'Content-Type': 'application/json',
        'Accept': 'audio/mpeg'
      },
      body: JSON.stringify({
        text: text,
        model_id: 'eleven_multilingual_v2',
        voice_settings: {
          stability: 0.5,
          similarity_boost: 0.75
        }
      })
    });
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      const errMsg = error.detail?.message || error.detail?.status || error.detail || response.status;
      showToast('ElevenLabs: ' + errMsg);
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      askiSpeakBrowser(text, null, onEnd);
      return;
    }
    
    const blob = await response.blob();
    
    // Play using AudioContext (works on Android!)
    const success = await playAudioBlob(blob, () => {
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      if (onEnd) onEnd();
    });
    
    if (!success) {
      askiIsSpeaking = false;
      updateSpeakingIndicator(false);
      askiSpeakBrowser(text, null, onEnd);
    }
    
  } catch (error) {
    showToast('ElevenLabs: ' + (error.message || 'network error'));
    askiIsSpeaking = false;
    updateSpeakingIndicator(false);
    askiSpeakBrowser(text, null, onEnd);
  }
}

// ===== AUDIO DROP FUNCTIONS =====

// Audio recording state
let audioRecorder = null;
let audioRecordingChunks = [];
let audioRecordingStream = null;
let currentPlayingAudioId = null;
let currentAudioElement = null;

// Format duration in M:SS
function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return mins + ':' + secs.toString().padStart(2, '0');
}

// Format file size
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + 'B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
  return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
}

// Start recording audio
async function startAudioRecording() {
  try {
    // Request microphone access
    audioRecordingStream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });
    
    audioRecordingChunks = [];
    audioRecorder = new MediaRecorder(audioRecordingStream, {
      mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
    });
    
    audioRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        audioRecordingChunks.push(e.data);
      }
    };
    
    audioRecorder.onstop = async () => {
      const blob = new Blob(audioRecordingChunks, { type: audioRecorder.mimeType });
      await saveAudioDrop(blob);
      
      // Stop all tracks
      audioRecordingStream.getTracks().forEach(track => track.stop());
      audioRecordingStream = null;
      
      // Reset UI
      updateAudioRecordButton(false);
    };
    
    audioRecorder.start(100); // Collect data every 100ms
    showToast(' Recording...');
    
    // Update UI
    updateAudioRecordButton(true);
    
  } catch (error) {
    showToast('Microphone access denied');
    console.error('Audio recording error:', error);
  }
}

// Update audio record button UI
function updateAudioRecordButton(isRecording) {
  const btn = document.getElementById('audioRecordBtn');
  const btnText = document.getElementById('audioRecordBtnText');
  
  if (btn && btnText) {
    if (isRecording) {
      btn.style.background = 'linear-gradient(135deg, #EF4444, #DC2626)';
      btn.style.animation = 'pulse 1s infinite';
      btnText.textContent = ' Stop Recording';
    } else {
      btn.style.background = 'linear-gradient(135deg, #F59E0B, #D97706)';
      btn.style.animation = 'none';
      btnText.textContent = 'Record Audio Drop';
    }
  }
}

// Stop recording audio
function stopAudioRecording() {
  if (audioRecorder && audioRecorder.state === 'recording') {
    audioRecorder.stop();
    showToast('Processing audio...');
  }
}

// Toggle audio recording
function toggleAudioRecording() {
  if (audioRecorder && audioRecorder.state === 'recording') {
    stopAudioRecording();
  } else {
    startAudioRecording();
  }
}

// Generate simple waveform from audio buffer
async function generateWaveform(blob, numBars = 40) {
  try {
    const ctx = getAudioContext();
    const arrayBuffer = await blob.arrayBuffer();
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
    const rawData = audioBuffer.getChannelData(0);
    const blockSize = Math.floor(rawData.length / numBars);
    const waveform = [];
    
    for (let i = 0; i < numBars; i++) {
      let sum = 0;
      for (let j = 0; j < blockSize; j++) {
        sum += Math.abs(rawData[i * blockSize + j] || 0);
      }
      waveform.push(Math.min(1, (sum / blockSize) * 3)); // Normalize and amplify
    }
    
    return waveform;
  } catch (e) {
    console.error('Waveform generation error:', e);
    return Array(numBars).fill(0.3); // Default waveform
  }
}

// Save audio drop
async function saveAudioDrop(blob) {
  try {
    // Generate waveform
    const waveform = await generateWaveform(blob);
    
    // Get duration
    const ctx = getAudioContext();
    const arrayBuffer = await blob.arrayBuffer();
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer.slice(0)); // Clone buffer
    const duration = audioBuffer.duration;
    
    // Convert blob to base64 for storage
    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64Data = reader.result;
      
      const drop = {
        id: Date.now(),
        text: '',
        category: 'audio',
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString('ru-RU'),
        time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
        isMedia: true,
        audioData: base64Data,
        audioFormat: blob.type.split('/')[1] || 'webm',
        audioSize: blob.size,
        audioBitrate: Math.round((blob.size * 8) / duration),
        duration: duration,
        waveform: waveform,
        notes: ''
      };
      
      ideas.unshift(drop);
      save(drop);
      render();
      counts();
      
      showToast(' Audio saved! ' + formatDuration(duration));
    };
    reader.readAsDataURL(blob);
    
  } catch (error) {
    console.error('Save audio error:', error);
    showToast('Error saving audio');
  }
}

// Play audio drop
function playAudioDrop(id, event) {
  if (event) event.stopPropagation();
  
  const item = ideas.find(x => x.id === id);
  if (!item || !item.audioData) {
    showToast('Audio not found');
    return;
  }
  
  // Stop current playback
  if (currentAudioElement) {
    currentAudioElement.pause();
    currentAudioElement = null;
    
    // Reset previous play button
    if (currentPlayingAudioId) {
      const prevBtn = document.getElementById('playbtn-' + currentPlayingAudioId);
      if (prevBtn) {
        prevBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
      }
    }
    
    // If same audio, just stop
    if (currentPlayingAudioId === id) {
      currentPlayingAudioId = null;
      return;
    }
  }
  
  currentPlayingAudioId = id;
  currentAudioElement = new Audio(item.audioData);
  
  const playBtn = document.getElementById('playbtn-' + id);
  const timeEl = document.getElementById('audiotime-' + id);
  
  currentAudioElement.onplay = () => {
    if (playBtn) {
      playBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
    }
  };
  
  currentAudioElement.ontimeupdate = () => {
    if (timeEl) {
      timeEl.textContent = formatDuration(currentAudioElement.currentTime);
    }
    // Update waveform progress
    updateWaveformProgress(id, currentAudioElement.currentTime / currentAudioElement.duration);
  };
  
  currentAudioElement.onended = () => {
    if (playBtn) {
      playBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
    }
    if (timeEl) {
      timeEl.textContent = '0:00';
    }
    updateWaveformProgress(id, 0);
    currentPlayingAudioId = null;
    currentAudioElement = null;
  };
  
  currentAudioElement.onerror = () => {
    showToast('Error playing audio');
    currentPlayingAudioId = null;
    currentAudioElement = null;
  };
  
  currentAudioElement.play();
}

// Toggle play/pause for audio in card
function togglePlayAudio(id, event) {
  if (event) event.stopPropagation();
  playAudioDrop(id, event);
}

// Seek audio
function seekAudio(id, seconds, event) {
  if (event) event.stopPropagation();
  
  if (currentPlayingAudioId === id && currentAudioElement) {
    currentAudioElement.currentTime = Math.max(0, Math.min(
      currentAudioElement.duration,
      currentAudioElement.currentTime + seconds
    ));
  }
}

// Update waveform progress visualization
function updateWaveformProgress(id, progress) {
  const waveform = document.getElementById('waveform-' + id);
  if (!waveform) return;
  
  const bars = waveform.querySelectorAll('.audio-waveform-bar');
  const playedBars = Math.floor(bars.length * progress);
  
  bars.forEach((bar, i) => {
    if (i < playedBars) {
      bar.classList.add('played');
    } else {
      bar.classList.remove('played');
    }
  });
}

// Transcribe audio using Whisper API
async function transcribeAudio(id) {
  const item = ideas.find(x => x.id === id);
  if (!item || !item.audioData) {
    showToast('Audio not found');
    return;
  }
  
  if (!askiApiKey) {
    showToast('Enter OpenAI API key first');
    return;
  }
  
  showToast('Transcribing...');
  
  try {
    // Convert base64 to blob
    const response = await fetch(item.audioData);
    const blob = await response.blob();
    
    // Create form data
    const formData = new FormData();
    formData.append('file', blob, 'audio.' + (item.audioFormat || 'webm'));
    formData.append('model', 'whisper-1');
    
    const result = await fetch('https://api.openai.com/v1/audio/transcriptions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + askiApiKey
      },
      body: formData
    });
    
    if (!result.ok) {
      const error = await result.json().catch(() => ({}));
      showToast('Transcription error: ' + (error.error?.message || result.status));
      return;
    }
    
    const data = await result.json();
    const transcript = data.text;
    
    // Update the drop with transcript
    item.notes = transcript;
    item.text = transcript;
    updateDrop(item);
    render();
    
    showToast('Transcribed: ' + transcript.substring(0, 50) + '...');
    
  } catch (error) {
    console.error('Transcription error:', error);
    showToast('Transcription failed');
  }
}

// Fallback browser TTS
function askiSpeakBrowser(text, lang = null, onEnd = null) {
  if (!('speechSynthesis' in window)) {
    showToast('Voice not supported');
    if (onEnd) onEnd();
    return;
  }
  
  const detectedLang = lang || detectLanguage(text);
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = detectedLang;
  utterance.rate = 0.95;
  utterance.volume = 1.0;
  
  const voice = getVoiceForLang(detectedLang);
  if (voice) utterance.voice = voice;
  
  utterance.onstart = () => {
    askiIsSpeaking = true;
    updateSpeakingIndicator(true);
    updateVoiceModeIndicator('speaking');
  };
  
  utterance.onend = () => {
    askiIsSpeaking = false;
    askiCurrentUtterance = null;
    updateSpeakingIndicator(false);
    if (onEnd) onEnd();
  };
  
  utterance.onerror = () => {
    askiIsSpeaking = false;
    askiCurrentUtterance = null;
    updateSpeakingIndicator(false);
    if (onEnd) onEnd();
  };
  
  askiCurrentUtterance = utterance;
  speechSynthesis.speak(utterance);
}

// Stop speaking
function askiStopSpeaking() {
  // Stop AudioContext playback
  stopAudioPlayback();
  // Stop legacy Audio element (if any)
  if (askiAudio) {
    askiAudio.pause();
    askiAudio.currentTime = 0;
    askiAudio = null;
  }
  // Stop browser TTS
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }
  askiIsSpeaking = false;
  askiCurrentUtterance = null;
  updateSpeakingIndicator(false);
}

// Toggle speak for a message
function toggleAskiSpeak(btn) {
  if (askiIsSpeaking) {
    askiStopSpeaking();
    return;
  }
  
  const bubble = btn.closest('.ask-ai-message').querySelector('.ask-ai-bubble');
  const text = bubble.textContent;
  askiSpeak(text);
}

// Update speaking indicator in header
function updateSpeakingIndicator(isSpeaking) {
  // Removed - status shown in subtitle instead
}

// ============================================
// VOICE MODE (Full voice conversation)
// ============================================

let voiceModeEnabled = false;
let voiceModeRecognition = null;
let askiIsProcessing = false; // True when waiting for API response
let voiceModeLocked = false;  // Prevents mic when Aski is speaking/processing
let voiceModeSleeping = false; // Sleep mode - waiting for user tap
let voiceModeTimeout = null;  // Timer (kept for potential future use)
let voiceModeCyclesLeft = 0;  // How many listening cycles before sleep

// Audio feedback for voice mode
function playVoiceBeep(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    if (type === 'start') {
      // Rising tone - mic ON
      osc.frequency.setValueAtTime(600, ctx.currentTime);
      osc.frequency.linearRampToValueAtTime(900, ctx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.15, ctx.currentTime);
    } else {
      // Falling
