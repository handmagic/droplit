<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E293B">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DropLit">
  <meta name="application-name" content="DropLit">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="DropLit - Voice-first idea capture app. Never lose your ideas again.">
  <title>DropLit</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/utils.js"></script>
  <script src="js/tts.js"></script>
  <script src="js/tts-stream.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // AutoDrop check - must be defined before chat.js
    function isAutoDropEnabled() {
      return localStorage.getItem('droplit_autodrop') === 'true';
    }
  </script>
  <script src="js/chat.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/photo.js"></script>
  <script src="js/sync.js"></script>
  <script src="js/notifications.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Insights Banner -->
  <div class="insights-banner" id="insightsBanner">
    <div class="insights-banner-icon">üéÇ</div>
    <div class="insights-banner-content">
      <div class="insights-banner-title" id="insightTitle">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</div>
      <div class="insights-banner-text" id="insightText">...</div>
    </div>
    <button class="insights-banner-close" onclick="dismissInsight()">√ó</button>
  </div>

  <!-- Notification Permission Banner -->
  <div class="notif-banner" id="notifBanner">
    <div class="notif-banner-title">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</div>
    <div class="notif-banner-text">ASKI —Å–º–æ–∂–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–Ω—è—Ö —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö</div>
    <div class="notif-banner-actions">
      <button class="notif-banner-btn secondary" onclick="dismissNotifBanner()">–ü–æ–∑–∂–µ</button>
      <button class="notif-banner-btn primary" onclick="requestNotifPermission()">–í–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </div>

  <div class="app" id="app">
    <header class="header">
      <button class="logo-btn" id="logoBtn" onclick="toggleFilters()" title="Toggle filters">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
      </button>
      <div class="header-title"><span class="title-drop">Drop</span><span class="title-lit">Lit</span></div>
      <button class="btn-icon" id="menuToggleBtn" onclick="toggleMainMenu()">
        <svg class="menu-icon-open" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        <svg class="menu-icon-close" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="display:none;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </header>
    <div class="network-banner" id="netBanner">No internet</div>
    <div class="warning" id="warning">Speech recognition not supported. Use Chrome.</div>
    <div class="search-indicator" id="searchIndicator" style="display:none">
      <span class="search-indicator-text">Searching: <span id="searchQueryDisplay"></span></span>
      <button class="search-indicator-clear" onclick="clearSearch()">‚úï Clear</button>
    </div>
    <div class="filters-wrap">
    <div class="filters">
      <div class="time-row" id="timeRow">
        <button class="time-btn" data-time="all">All <span class="cnt" id="cntAll">0</span></button>
        <button class="time-btn" data-time="today">Today <span class="cnt" id="cntToday">0</span></button>
        <button class="time-btn" data-time="7days">week <span class="cnt" id="cnt7d">0</span></button>
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()" title="Sort order"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
      </div>
      <div class="cat-row" id="cats">
        <button class="cat" data-category="tasks">Tasks <span class="cnt" id="cntTasks">0</span></button>
        <button class="cat" data-category="ideas">Ideas <span class="cnt" id="cntIdeas">0</span></button>
        <button class="cat" data-category="handmagic">Handmagic <span class="cnt" id="cntHandmagic">0</span></button>
        <button class="cat" data-category="design">Design <span class="cnt" id="cntDesign">0</span></button>
        <button class="cat" data-category="bugs">Bugs <span class="cnt" id="cntBugs">0</span></button>
        <button class="cat" data-category="questions">Questions <span class="cnt" id="cntQuestions">0</span></button>
        <button class="cat" data-category="inbox">Inbox <span class="cnt" id="cntInbox">0</span></button>
        <button class="cat" data-category="audio">Audio <span class="cnt" id="cntAudio">0</span></button>
        <button class="cat" data-category="photo">Photo <span class="cnt" id="cntPhoto">0</span></button>
        <button class="cat" data-category="sketch">Sketch <span class="cnt" id="cntSketch">0</span></button>
        <button class="cat" data-category="scan">Scan <span class="cnt" id="cntScan">0</span></button>
        <button class="cat-add" onclick="addCatPrompt()">+</button>
      </div>
    </div>
    </div>
    <div class="ideas-wrap" id="ideasWrap">
      <div class="ideas" id="ideasList"></div>
      <div class="empty" id="emptyState">
        <div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div>
        <div class="empty-title">Your ideas start here</div>
        <div class="empty-text">SHOOT ¬∑ PRESS ¬∑ SPEAK</div>
      </div>
    </div>
  </div>

<input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
  <input type="file" id="imageUpload" class="camera-input" accept="image/*" onchange="handleUploadedImage(event)">
  <input type="file" id="fileUpload" style="display:none" accept=".txt,.md,.csv,.json" onchange="handleUploadedFile(event)">
  
  <!-- FAB Container - all bottom buttons -->
  <div class="fab-container" id="fabContainer">
    <button class="fab-camera" id="fabCamera" onclick="document.getElementById('cameraInput').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    </button>
    <button class="fab-pill" id="fabAskAI" onclick="openAskAI()">AI CHAT</button>
    <button class="fab-pill create" id="fabCreate" onclick="togglePlusMenu()">CREATE+</button>
    <button class="fab-record" id="fabRecord" onclick="handleFabClick(event)" ontouchstart="fabTouchStart()" ontouchend="fabTouchEnd()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
    </button>
  </div>

  <!-- Plus menu backdrop -->
  <div class="plus-menu-backdrop" id="plusBackdrop" onclick="closePlusMenu()"></div>

  <!-- Plus menu -->
  <div class="plus-menu" id="plusMenu">
    <div class="section-divider"><span>Create</span></div>
    <button class="plus-menu-item" onclick="openTextInput()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg></span>
      <div class="info">
        <div class="title">New Drop</div>
        <div class="desc">Text note or idea</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="pasteLink()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span>
      <div class="info">
        <div class="title">Paste Link</div>
        <div class="desc">Save URL from clipboard</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="uploadImage()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></span>
      <div class="info">
        <div class="title">Upload Image</div>
        <div class="desc">Photo from gallery</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="uploadFile()">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></span>
      <div class="info">
        <div class="title">Upload File</div>
        <div class="desc">Document or PDF</div>
      </div>
    </button>
    <button class="plus-menu-item" onclick="openAudioRecorder()" style="border-color: #F59E0B;">
      <span class="icon" style="background: linear-gradient(135deg, #FEF3C7, #FDE68A); color: #92400E;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
      <div class="info">
        <div class="title">Record Audio</div>
        <div class="desc">Voice memo or sound</div>
      </div>
    </button>
    <div class="section-divider"><span>AI Magic</span></div>
    <button class="plus-menu-item magic" onclick="openMagic('poem')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
      <div class="info">
        <div class="title">Create Poem</div>
        <div class="desc">AI-generated poetry</div>
      </div>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('greeting')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></span>
      <div class="info">
        <div class="title">Create Greeting</div>
        <div class="desc">Birthday, holiday wishes</div>
      </div>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('speech')">
      <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
      <div class="info">
        <div class="title">Create Speech</div>
        <div class="desc">Toast or presentation</div>
      </div>
    </button>
  </div>

  <!-- Text input modal -->
  <div class="text-input-modal" id="textInputModal">
    <div class="text-input-content">
      <div class="text-input-header">
        <span class="text-input-title">New Drop</span>
        <button class="text-input-close" onclick="closeTextInput()">√ó</button>
      </div>
      <textarea class="text-input-area" id="textInputArea" placeholder="Type your idea here..."></textarea>
      <div class="text-input-actions">
        <button class="text-input-btn cancel" onclick="closeTextInput()">Cancel</button>
        <button class="text-input-btn save" onclick="saveTextNote()">Save</button>
      </div>
    </div>
  </div>

  <!-- AI Magic Modal -->
  <div class="magic-modal" id="magicModal" onclick="if(event.target===this)closeMagic()">
    <div class="magic-content">
      <div class="magic-header">
        <h2 id="magicTitle">Create Poem</h2>
        <p id="magicSubtitle">Tell me what it should be about</p>
      </div>
      <div class="magic-body">
        <!-- Loading indicator -->
        <div class="magic-loading" id="magicLoading">
          <div class="ai-loading-dots magic">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
          <div class="ai-loading-label" id="magicLoadingLabel">Creating magic...</div>
        </div>
        <!-- Form -->
        <div class="magic-form" id="magicForm">
        <!-- Photo section -->
        <div class="magic-photo-section">
          <div style="position: relative;">
            <button class="pill-l sec" id="magicPhotoBtn" onclick="togglePhotoMenu()">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
              <span id="magicPhotoBtnText">Add photo (optional)</span>
            </button>
            <div class="magic-photo-menu" id="magicPhotoMenu">
              <button class="magic-photo-menu-item" onclick="takeMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg> Take photo
              </button>
              <button class="magic-photo-menu-item" onclick="chooseMagicPhoto()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg> Choose from gallery
              </button>
              <button class="magic-photo-menu-item" onclick="openDropsPicker()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg> Choose from Drops
              </button>
            </div>
          </div>
          <div class="magic-photo-preview" id="magicPhotoPreview" style="display: none;">
            <img id="magicPhotoImg" src="" alt="Selected photo">
            <button class="magic-photo-remove" onclick="removeMagicPhoto()">√ó</button>
          </div>
          <input type="file" id="magicPhotoInput" accept="image/*" style="display:none" onchange="handleMagicPhoto(event)">
          <input type="file" id="magicCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleMagicPhoto(event)">
        </div>
        
        <label class="magic-input-label" id="magicInputLabel">Add details (optional if photo added)</label>
        <textarea class="magic-input-area" id="magicInput" placeholder="Example: Birthday greeting for mom, she loves gardening and has 2 grandkids..."></textarea>
        <button class="pill-l sec" id="magicVoiceBtn" onclick="toggleMagicVoice()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="magicVoiceText">Tap to speak</span>
        </button>
        <div class="magic-styles" id="magicStyles">
          <button class="magic-style active" data-style="classic">Classic</button>
          <button class="magic-style" data-style="funny">Funny</button>
          <button class="magic-style" data-style="tender">Tender</button>
          <button class="magic-style" data-style="epic">Epic</button>
        </div>
        <button class="pill-xl magic" id="magicGenerate" onclick="generateMagic()">
          Create Magic
        </button>
        </div><!-- end magic-form -->
      </div>
      <div class="magic-footer">
        <button class="pill-l sec" onclick="closeMagic()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Drops Picker Modal -->
  <div class="drops-picker" id="dropsPicker" onclick="if(event.target===this)closeDropsPicker()">
    <div class="drops-picker-content">
      <div class="drops-picker-header">
        <h3>Choose from Drops</h3>
        <button class="drops-picker-close" onclick="closeDropsPicker()">√ó</button>
      </div>
      <div class="drops-picker-grid" id="dropsPickerGrid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- Audio Recorder Modal -->
  <div class="audio-recorder-modal" id="audioRecorderModal" onclick="if(event.target===this)closeAudioRecorder()">
    <div class="audio-recorder-content">
      <div class="audio-recorder-header">
        <h2>AUDIO RECORDER</h2>
      </div>
      <div class="audio-recorder-body">
        <div class="audio-recorder-waveform" id="recorderWaveform">
          <div class="bar" style="height:20px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:40px"></div>
          <div class="bar" style="height:60px"></div>
          <div class="bar" style="height:45px"></div>
          <div class="bar" style="height:30px"></div>
          <div class="bar" style="height:55px"></div>
          <div class="bar" style="height:70px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:60px"></div>
          <div class="bar" style="height:45px"></div>
          <div class="bar" style="height:25px"></div>
          <div class="bar" style="height:40px"></div>
          <div class="bar" style="height:55px"></div>
          <div class="bar" style="height:35px"></div>
          <div class="bar" style="height:50px"></div>
          <div class="bar" style="height:65px"></div>
          <div class="bar" style="height:40px"></div>
        </div>
        <div class="audio-recorder-time" id="recorderTime">0:00</div>
        <div class="audio-recorder-controls">
          <button class="ctrl-btn rewind" onclick="recorderRewind()">&lt;&lt;</button>
          <button class="ctrl-btn" id="recorderStopBtn" onclick="recorderStop()" style="background:#EF4444; color:white; font-weight:700;">STOP</button>
          <button class="ctrl-btn play" id="recorderPlayBtn" onclick="recorderPlayPause()">PLAY</button>
          <button class="ctrl-btn forward" onclick="recorderForward()">&gt;&gt;</button>
        </div>
        <button class="audio-recorder-main-btn ready" id="recorderMainBtn" onclick="recorderToggleRecord()">
          <span id="recorderMainText">TAP TO RECORD</span>
        </button>
        <div class="audio-recorder-actions">
          <button class="act-btn delete" onclick="recorderDelete()" disabled>DELETE</button>
          <button class="act-btn create" onclick="recorderCreateDrop()" disabled>CREATE DROP</button>
          <button class="act-btn share" onclick="recorderShare()" disabled>SHARE</button>
        </div>
        <button class="audio-recorder-cancel" onclick="closeAudioRecorder()">CANCEL</button>
      </div>
    </div>
  </div>

  <!-- AI Tools Modal (for text drops) -->
  <div class="ai-tools-modal" id="aiToolsModal" onclick="if(event.target===this)closeAITools()">
    <div class="ai-tools-content">
      <div class="ai-tools-header">
        <h2>AI Tools</h2>
        <p>What would you like to do?</p>
      </div>
      <div class="ai-tools-preview">
        <div class="ai-tools-preview-label">Selected drop:</div>
        <div class="ai-tools-preview-text" id="aiToolsPreviewText"></div>
      </div>
      <div class="ai-tools-body">
        <div class="ai-tools-grid">
          <button class="ai-tool-btn" onclick="runAITool('summarize')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></span>
            <div class="info">
              <div class="title">Summarize</div>
              <div class="desc">Make it shorter and clearer</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('tasks')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg></span>
            <div class="info">
              <div class="title">Create Tasks</div>
              <div class="desc">Extract actionable to-dos</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('expand')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></span>
            <div class="info">
              <div class="title">Expand</div>
              <div class="desc">Add more details and ideas</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('rewrite')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></span>
            <div class="info">
              <div class="title">Rewrite</div>
              <div class="desc">Different style or tone</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('enhance')">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></span>
            <div class="info">
              <div class="title">Enhance</div>
              <div class="desc">Fix errors, punctuation, formatting</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="openTranslateModal()">
            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg></span>
            <div class="info">
              <div class="title">Translate</div>
              <div class="desc">Translate to another language</div>
            </div>
          </button>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsCheckCategory" checked>
          <div class="ai-tools-option-label">
            <div class="title">Also check/update category</div>
            <div class="current">Current: <span id="aiToolsCurrentCategory">INBOX</span></div>
          </div>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsRemoveLineBreaks">
          <div class="ai-tools-option-label">
            <div class="title">Remove extra line breaks</div>
            <div class="current">Join paragraphs into continuous text</div>
          </div>
        </div>
      </div>
      <div class="ai-tools-footer">
        <button class="pill-l sec" onclick="closeAITools()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Result Modal (large, with actions) -->
  <div class="ai-result-modal" id="aiResultModal2" onclick="if(event.target===this)closeAIResult2()">
    <div class="ai-result-content">
      <div class="ai-result-header">
        <h2 id="aiResult2Title">Result</h2>
      </div>
      <div class="ai-result-body">
        <div class="ai-result-text" id="aiResult2Text"></div>
        <div class="ai-result-category" id="aiResult2Category" style="display:none;">
          <div class="ai-result-category-title">Suggested category</div>
          <div class="ai-result-category-row">
            <span class="ai-result-category-current" id="aiResult2CurrentCat">INBOX</span>
            <span class="ai-result-category-arrow">‚Üí</span>
            <span class="ai-result-category-suggested" id="aiResult2SuggestedCat">TASKS</span>
          </div>
          <div class="ai-result-category-actions">
            <button class="ai-result-category-btn" onclick="keepCategory()">Keep current</button>
            <button class="ai-result-category-btn accept" onclick="acceptCategory()">Change</button>
          </div>
        </div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l magic" onclick="replaceOriginal()">Replace original</button>
        <div class="pill-row">
          <button class="pill-l sec" onclick="createNewDrop()">New Drop</button>
          <button class="pill-l sec" onclick="copyResult2()">Copy</button>
        </div>
        <button class="pill-l sec" onclick="closeAIResult2()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- B2 FIX: Tasks Confirmation Modal -->
  <div class="ai-result-modal" id="tasksConfirmModal" onclick="if(event.target===this)closeTasksConfirm()">
    <div class="ai-result-content">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #10B981, #3B82F6);">
        <h2>Extracted Tasks</h2>
      </div>
      <div class="ai-result-body">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 12px;">Found <span id="tasksCount">0</span> tasks. Each will become a separate drop:</p>
        <div class="tasks-preview-list" id="tasksPreviewList"></div>
      </div>
      <div class="ai-result-actions">
        <button class="pill-l success" onclick="confirmCreateTasks()">
          Create <span id="tasksCountBtn">0</span> Task Drops
        </button>
        <button class="pill-l sec" onclick="closeTasksConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- I1 FIX: Translate Modal -->
  <div class="ai-result-modal" id="translateModal" onclick="if(event.target===this)closeTranslateModal()">
    <div class="ai-result-content" style="max-width: 360px;">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #3B82F6, #10B981);">
        <h2>Translate</h2>
      </div>
      <div class="ai-result-body" style="padding: 20px;">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 16px;">Select target language:</p>
        <div class="translate-langs">
          <button class="translate-lang-btn" onclick="runTranslate('English')">üá¨üáß English</button>
          <button class="translate-lang-btn" onclick="runTranslate('Russian')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
          <button class="translate-lang-btn" onclick="runTranslate('Spanish')">üá™üá∏ Espa√±ol</button>
          <button class="translate-lang-btn" onclick="runTranslate('German')">üá©üá™ Deutsch</button>
          <button class="translate-lang-btn" onclick="runTranslate('French')">üá´üá∑ Fran√ßais</button>
          <button class="translate-lang-btn" onclick="runTranslate('Chinese')">üá®üá≥ ‰∏≠Êñá</button>
          <button class="translate-lang-btn" onclick="runTranslate('Japanese')">üáØüáµ Êó•Êú¨Ë™û</button>
          <button class="translate-lang-btn" onclick="runTranslate('Portuguese')">üáßüá∑ Portugu√™s</button>
        </div>
      </div>
      <div class="ai-result-actions" style="padding: 16px 20px;">
        <button class="pill-l sec" onclick="closeTranslateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="rec-status" id="recStatus">
    <span class="rec-dot"></span>
    <span class="rec-text" id="recText">Listening...</span>
  </div>

  <button class="scroll-fab top" id="scrollTop" onclick="scrollToTop()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg></button>
  <button class="scroll-fab bottom" id="scrollBottom" onclick="scrollToBottom()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>

  <!-- Ask AI Panel -->
  <div class="ask-ai-panel" id="askAIPanel">
    <div class="ask-ai-handle" onclick="closeAskAI()">
      <div class="ask-ai-handle-bar"></div>
    </div>
    <div class="ask-ai-header">
      <div class="ask-ai-header-left">
        <div class="ask-ai-avatar">A</div>
        <div>
          <div class="ask-ai-title">Aski</div>
          <div class="ask-ai-subtitle" id="askiSubtitle">AI Assistant</div>
        </div>
      </div>
      <button class="pill-s ask-ai-btn-autodrop" id="autoDropIndicator" onclick="toggleAutoDropFromChat()" style="position: relative; z-index: 10; min-width: 100px;">AUTODROP</button>
      <button class="ask-ai-close" onclick="closeAskAI()">√ó</button>
    </div>
    <div class="ask-ai-messages" id="askAIMessages">
      <div class="ask-ai-empty" id="askAIEmpty">
        <div class="ask-ai-empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <div class="ask-ai-empty-title">Ask me anything</div>
        <div class="ask-ai-empty-text">I'm here to help ‚Äî answer questions, give ideas, or just chat.</div>
        <div class="ask-ai-prompts">
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞ —É–∂–∏–Ω?')">–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å?</button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ù–∞–ø–∏—à–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ')">–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
          <button class="ask-ai-prompt" onclick="setAskAIPrompt('–ö–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –¥–µ–Ω—å?')">–ü–ª–∞–Ω –¥–Ω—è</button>
        </div>
      </div>
    </div>
    <div class="ask-ai-input-area">
      <div class="ask-ai-input-row">
        <button class="ask-ai-btn ask-ai-btn-voice" id="askAIVoiceBtn" onclick="toggleAskAIVoice()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        </button>
        <textarea class="ask-ai-input" id="askAIInput" placeholder="Ask anything..." maxlength="2000" rows="2" oninput="updateAskAICharCount(); autoResizeTextarea(this);" onkeypress="if(event.key==='Enter' && !event.shiftKey && this.value.trim()) { event.preventDefault(); sendAskAIMessage(); }"></textarea>
        <button class="ask-ai-btn ask-ai-btn-send" id="askAISendBtn" onclick="console.log('Send clicked'); sendAskAIMessage()">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9 22 2Z"/></svg>
        </button>
      </div>
	  <div class="ask-ai-controls-bottom" id="askAIControlsBottom">
        <button class="ask-ai-control-left" id="askAIControlLeft" onclick="handleChatControlLeft()">HIDE</button>
        <button class="ask-ai-control-right" id="askAIControlRight" onclick="toggleAskAIVoice()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
          <span id="askAIControlRightText">TAP TO TALK</span>
        </button>
      </div>
      <button class="ask-ai-voice-large" id="askAIVoiceLarge" onclick="toggleAskAIVoice()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        <span id="voiceLargeText">Tap to talk</span>
      </button>
      <div class="ask-ai-char-count" id="askAICharCount">0 / 2000</div>
    </div>
  </div>

  <!-- Selection bar for merge -->
  <div class="select-bar" id="selectBar">
    <div class="select-info"><span id="selectCount">0</span> selected</div>
    <div class="select-actions">
      <button class="select-btn cancel" onclick="cancelSelect()">Cancel</button>
      <button class="select-btn delete" onclick="deleteSelected()">Delete</button>
      <button class="select-btn merge" onclick="showMergePreview()">Merge/Copy</button>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Main Menu Modal -->
  <div class="main-menu" id="mainMenu" onclick="if(event.target===this)closeMainMenu()">
    <div class="main-menu-content">
      <div class="main-menu-header">
        <h2><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg> Menu</h2>
        <button class="pill-s sec" onclick="closeMainMenu()">Close</button>
      </div>
      
      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-label">AI Token Balance</div>
        <div class="balance-value" id="tokenBalance">‚Äî</div>
        <div class="balance-hint">Tokens refresh monthly ‚Ä¢ <span id="tokenUsage">Loading...</span></div>
      </div>
      
      <!-- Search Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Search</span></div>
        <input type="text" class="menu-search-input" id="menuSearchInput" placeholder="Search drops..." onkeypress="if(event.key==='Enter')performSearch()" style="width: 100%; margin-bottom: 16px;">
        <div class="pill-row">
          <button class="pill-m sec" onclick="startVoiceSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
            Voice
          </button>
          <button class="pill-m pri" onclick="performSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Search
          </button>
        </div>
      </div>
      
      <!-- Undo Section -->
      <div class="menu-section" style="border-bottom: none;">
        <div class="section-divider"><span>Undo</span></div>
        <div class="undo-header">
          <button class="pill-l ai" id="undoMainBtn" onclick="undoLast()" disabled>
            ‚Ü∂ Undo Last Action
          </button>
        </div>
        <div id="undoLastInfo" style="text-align: center; font-size: 0.85rem; color: var(--color-text-muted); margin-top: 8px;"></div>
        <button class="pill-l sec" id="undoToggleBtn" onclick="toggleUndoList()" style="display: none; margin-top: 12px;">
          Show history (0)
        </button>
        <div class="undo-list" id="undoList"></div>
      </div>
      
      <!-- Settings Section -->
      <div class="menu-section no-border">
        <div class="section-divider"><span>Aski Voice</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg></span>
            <span class="settings-item-label">Voice Mode</span>
            <span class="settings-item-warning"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> Uses more battery</span>
          </div>
          <div class="settings-toggle" id="voiceModeToggle" onclick="toggleVoiceMode()"></div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span>
            <span class="settings-item-label">Auto-speak replies</span>
          </div>
          <div class="settings-toggle" id="autoSpeakToggle" onclick="toggleAutoSpeak()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></span>
            <span class="settings-item-label">TTS Provider</span>
          </div>
          <div class="pill-row" id="ttsProviderSelector">
            <button class="pill-m" data-provider="openai" onclick="setTTSProvider('openai')">OpenAI</button>
            <button class="pill-m" data-provider="elevenlabs" onclick="setTTSProvider('elevenlabs')">ElevenLabs</button>
            <button class="pill-m" data-provider="browser" onclick="setTTSProvider('browser')">Browser</button>
          </div>
        </div>
        
        <!-- OpenAI Voice Settings -->
        <div id="openaiVoiceSettings">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">OpenAI Voice</span>
            </div>
            <div class="pill-row" id="voiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="nova" onclick="setAskiVoice('nova')">Nova</button>
              <button class="pill-m" data-voice="shimmer" onclick="setAskiVoice('shimmer')">Shimmer</button>
              <button class="pill-m" data-voice="alloy" onclick="setAskiVoice('alloy')">Alloy</button>
              <button class="pill-m" data-voice="onyx" onclick="setAskiVoice('onyx')">Onyx</button>
              <button class="pill-m" data-voice="echo" onclick="setAskiVoice('echo')">Echo</button>
              <button class="pill-m" data-voice="fable" onclick="setAskiVoice('fable')">Fable</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">OpenAI API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="openaiApiKeyInput" placeholder="sk-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveOpenAIKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('openai')" id="apiKeyToggleBtn" style="min-width: 60px;">Show</button>
            </div>
            <div id="apiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
          </div>
        </div>
        
        <!-- ElevenLabs Voice Settings -->
        <div id="elevenlabsVoiceSettings" style="display: none;">
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></span>
              <span class="settings-item-label">ElevenLabs Voice (Russian)</span>
            </div>
            <div class="pill-row" id="elevenlabsVoiceSelector" style="flex-wrap: wrap;">
              <button class="pill-m" data-voice="Nadia" data-voiceid="gedzfqL7OGdPbwm0ynTP" onclick="selectElevenLabsVoice('Nadia','gedzfqL7OGdPbwm0ynTP')">Nadia</button>
              <button class="pill-m" data-voice="Larisa" data-voiceid="AB9XsbSA4eLG12t2myjN" onclick="selectElevenLabsVoice('Larisa','AB9XsbSA4eLG12t2myjN')">Larisa</button>
              <button class="pill-m" data-voice="Dmitry" data-voiceid="kwajW3Xh5svCeKU5ky2S" onclick="selectElevenLabsVoice('Dmitry','kwajW3Xh5svCeKU5ky2S')">Dmitry</button>
              <button class="pill-m" data-voice="Bella" data-voiceid="EXAVITQu4vr4xnSDxMaL" onclick="selectElevenLabsVoice('Bella','EXAVITQu4vr4xnSDxMaL')">Bella</button>
              <button class="pill-m" data-voice="Rachel" data-voiceid="21m00Tcm4TlvDq8ikWAM" onclick="selectElevenLabsVoice('Rachel','21m00Tcm4TlvDq8ikWAM')">Rachel</button>
            </div>
            <div class="voice-preview-hint" style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px;">Tap voice to preview ‚Ä¢ Native Russian speakers</div>
          </div>
          
          <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
            <div class="settings-item-left">
              <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
              <span class="settings-item-label">ElevenLabs API Key</span>
            </div>
            <div style="width: 100%; display: flex; gap: 8px;">
              <input type="password" id="elevenlabsApiKeyInput" placeholder="xi-..." style="flex: 1; padding: 10px 14px; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: var(--font-main); font-size: 0.9rem; background: var(--color-bg);" oninput="saveElevenLabsKey()">
              <button class="pill-m" onclick="toggleApiKeyVisibility('elevenlabs')" id="elevenlabsApiKeyToggleBtn" style="min-width: 60px;">Show</button>
              <button class="pill-m" onclick="testElevenLabsKey()" style="min-width: 50px; background: #8B5CF6; color: white;">Test</button>
            </div>
            <div id="elevenlabsApiKeyStatus" style="font-size: 0.75rem; color: var(--color-text-muted);"></div>
            <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 4px;">
              Get free API key at <a href="https://elevenlabs.io" target="_blank" style="color: #8B5CF6;">elevenlabs.io</a> (10K chars/month free)
            </div>
          </div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
            <span class="settings-item-label">Listen time after Aski, sec</span>
          </div>
          <div class="pill-row" id="listenCyclesSelector">
            <button class="pill-m" data-cycles="10" onclick="setListenCycles(10)">10</button>
            <button class="pill-m active" data-cycles="15" onclick="setListenCycles(15)">15</button>
            <button class="pill-m" data-cycles="20" onclick="setListenCycles(20)">20</button>
            <button class="pill-m" data-cycles="25" onclick="setListenCycles(25)">25</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Aski Chat</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg></span>
            <span class="settings-item-label">AutoDrop</span>
            <span class="settings-item-hint" style="font-size: 0.7rem; color: var(--color-text-muted); margin-left: 8px;">Auto-save all messages</span>
          </div>
          <div class="settings-toggle" id="autoDropToggle" onclick="toggleAutoDrop()"></div>
        </div>
        
        <div class="section-divider"><span>Display</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></svg></span>
            <span class="settings-item-label">Compact feed</span>
          </div>
          <div class="settings-toggle" id="rollUpModeToggle" onclick="toggleRollUpMode()"></div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></span>
            <span class="settings-item-label">Dark mode</span>
          </div>
          <div class="settings-toggle" id="darkModeToggle" onclick="toggleDarkMode()"></div>
        </div>
        
        <div class="settings-item no-border" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></span>
            <span class="settings-item-label">Font size</span>
          </div>
          <div class="pill-row" id="fontSizeSelector">
            <button class="pill-m" data-size="small" onclick="setFontSize('small')">Small</button>
            <button class="pill-m" data-size="normal" onclick="setFontSize('normal')">Normal</button>
            <button class="pill-m" data-size="large" onclick="setFontSize('large')">Large</button>
          </div>
        </div>
        
        <div class="section-divider"><span>Cloud</span></div>
        
        <div class="settings-item no-border">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></span>
            <div>
              <span class="settings-item-label">Cloud Sync</span>
              <div id="lastSyncInfo" style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 2px;">Last sync: ‚Äî</div>
            </div>
          </div>
          <button class="pill-m pri" onclick="manualSync()">Sync Now</button>
        </div>
        
        <div class="section-divider"><span>Data</span></div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v3"/><path d="M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3"/><path d="M4 12h16"/><path d="m9 8-4 4 4 4"/><path d="m15 8 4 4-4 4"/></svg></span>
            <span class="settings-item-label">Export data</span>
          </div>
          <button class="pill-m sec" onclick="exportData()">Export</button>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></span>
            <span class="settings-item-label">Import data</span>
          </div>
          <button class="pill-m sec" onclick="document.getElementById('importFileInput').click()">Import</button>
          <input type="file" id="importFileInput" style="display:none" accept=".json" onchange="handleImportFile(event)">
        </div>
        
        <div class="settings-item no-border" style="padding-bottom: 0;">
          <div class="settings-item-left">
            <span class="settings-item-icon"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></span>
            <span class="settings-item-label">Clear all data</span>
          </div>
          <button class="pill-m danger" onclick="clearAllData()">Clear</button>
        </div>
        
        <div class="section-divider"><span>About</span></div>
        
        <!-- Debug button -->
        <div style="padding: 12px 0;">
          <button class="pill-l sec" onclick="showDebugInfo()" style="width: 100%;">üîß Debug & Sync Info</button>
        </div>
        
        <div class="menu-about" onclick="closeMainMenu(); openAbout();" style="cursor: pointer;">
          <div class="menu-about-logo">
            <svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
          </div>
          <div class="menu-about-name">DropLit</div>
          <div class="menu-about-ver">v0.9.69 by Syntrise</div>
          <div style="font-size: 0.7rem; color: var(--color-primary); margin-top: 8px;">Tap for more info</div>
        </div>
      </div>
      
      <!-- Footer with Close button -->
      <div class="main-menu-footer">
        <button class="pill-l sec" onclick="showDebugInfo()" style="margin-right: 8px;">üîß Debug</button>
        <button class="pill-l sec" onclick="closeMainMenu()">Close Menu</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="aboutModal"><div class="modal"><div class="about-brand"><div class="about-logo"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div><div class="about-name">DropLit</div><div class="about-ver">v0.9.69 by Syntrise</div></div><div class="modal-text" style="text-align:center">Voice-first idea capture.<br>Long press card to select & merge.</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAbout()">Got it</button></div></div></div>
  <div class="overlay" id="catModal"><div class="modal type-b"><div class="modal-header"><h3>Move to Category</h3></div><div class="modal-body"><div class="cat-grid"><button class="cat-opt" data-cat="tasks" onclick="changeCat('tasks')">Tasks</button><button class="cat-opt" data-cat="ideas" onclick="changeCat('ideas')">Ideas</button><button class="cat-opt" data-cat="handmagic" onclick="changeCat('handmagic')">Handmagic</button><button class="cat-opt" data-cat="design" onclick="changeCat('design')">Design</button><button class="cat-opt" data-cat="bugs" onclick="changeCat('bugs')">Bugs</button><button class="cat-opt" data-cat="questions" onclick="changeCat('questions')">Questions</button><button class="cat-opt" data-cat="sketch" onclick="changeCat('sketch')">Sketch</button><button class="cat-opt" data-cat="scan" onclick="changeCat('scan')">Scan</button><button class="cat-opt" data-cat="inbox" onclick="changeCat('inbox')">Inbox</button></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeCatModal()">Cancel</button></div></div></div>
  <div class="overlay" id="sendModal"><div class="modal type-b"><div class="modal-header"><h3>Share Drop</h3></div><div class="modal-body"><div class="send-opts"><div class="send-opt" onclick="sendAI()"><div class="send-icon">AI</div><div class="send-info"><div class="send-title">AI Assistant</div><div class="send-desc">Copy + open Claude</div></div><span class="send-badge">Pro</span></div><div class="send-div">or share via</div><div class="send-opt" onclick="shareNative()"><div class="send-icon">...</div><div class="send-info"><div class="send-title">Share...</div><div class="send-desc">WhatsApp, Telegram</div></div></div><div class="send-opt" onclick="sendMail()"><div class="send-icon">@</div><div class="send-info"><div class="send-title">Email</div><div class="send-desc">Send via email</div></div></div><div class="send-opt" onclick="copyClip()"><div class="send-icon">#</div><div class="send-info"><div class="send-title">Copy</div><div class="send-desc">Copy to clipboard</div></div></div></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeSendModal()">Cancel</button></div></div></div>
  <div class="overlay" id="exportModal"><div class="modal type-b"><div class="modal-header"><h3>Export Data</h3></div><div class="modal-body"><div class="export-box" id="exportBox"></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeExportModal()">Close</button><button class="modal-btn pri" onclick="copyExport()">Copy All</button></div></div></div>
  <div class="overlay" id="delModal"><div class="modal"><div class="modal-title">Delete this idea?</div><div class="modal-text">This action cannot be undone.</div><div class="modal-actions"><button class="modal-btn sec" onclick="closeDelModal()">Cancel</button><button class="modal-btn danger" onclick="confirmDel()">Delete</button></div></div></div>
  <div class="overlay" id="creatorModal"><div class="modal type-b creator-modal"><div class="modal-header" id="creatorModalHeader"><div class="creator-modal-avatar" id="creatorModalAvatar"></div><div class="creator-modal-info"><h3 id="creatorModalName">Creator</h3><span class="creator-modal-role" id="creatorModalRole"></span></div></div><div class="modal-body"><div class="creator-info"><div class="creator-info-row"><span class="creator-info-label">Created</span><span class="creator-info-value" id="creatorModalDate">‚Äî</span></div><div class="creator-info-row"><span class="creator-info-label">Copyright</span><span class="creator-info-value" id="creatorModalCopyright">¬© 2025</span></div></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="filterByCreator()">Show only</button><button class="modal-btn sec" onclick="closeCreatorModal()">Close</button></div></div></div>
  <div class="overlay" id="settingsModal"><div class="modal type-b"><div class="modal-header"><h3>Settings</h3></div><div class="modal-body"><div class="modal-text" style="margin-bottom:0;">Syntrise CORE:<br>Sync your ideas to cloud</div></div><div class="modal-actions"><button class="modal-btn sec" onclick="syncToCloud()">Sync</button><button class="modal-btn sec" onclick="exportAll()">Export</button><button class="modal-btn pri" onclick="closeSettings()">Done</button></div></div></div>
  <div class="overlay" id="addCatModal"><div class="modal"><div class="modal-title">Add Category</div><div class="modal-text">Custom categories coming in a future update!</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAddCatModal()">OK</button></div></div></div>
  <div class="overlay" id="mergeModal"><div class="modal type-b"><div class="modal-header"><h3>Merge Preview</h3></div><div class="modal-body"><div class="merge-options"><label class="merge-toggle"><input type="checkbox" id="mergeSimple" onchange="updateMergePreview()"><span>Simple merge (no headers)</span></label></div><div class="merge-preview" id="mergePreview"></div></div><div class="modal-actions"><button class="pill-m sec" onclick="closeMergeModal()">Cancel</button><button class="pill-m sec" onclick="copyMerged()">Copy</button><button class="pill-m merge" onclick="saveMerged()">Save Merge</button></div></div></div>
  <div class="overlay image-viewer" id="imageViewer" onclick="handleImageViewerClick(event)">
    <div class="image-viewer-close" onclick="closeImageViewer()">‚úï</div>
    <div class="image-viewer-markers" id="imageViewerMarkers" onclick="openPhotoMarkers()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.47"/></svg></div>
    <div class="image-viewer-ai" onclick="openPhotoAI()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg></div>
    <div class="image-counter" id="imageCounter">1 / 1</div>
    <div class="image-viewer-nav prev" id="imgNavPrev" onclick="navigateImage(-1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg></div>
    <div class="image-viewer-nav next" id="imgNavNext" onclick="navigateImage(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg></div>
    <div class="image-viewer-content" id="imageViewerContent">
      <img id="imageViewerImg" src="" alt="Full size">
    </div>
    <div class="image-viewer-panel" onclick="event.stopPropagation()">
      <div class="image-meta" id="imageMeta"></div>
      <div class="image-caption-row">
        <button class="caption-edit-btn" onclick="startEditCaption()">Edit</button>
        <div class="image-caption-display" id="imageCaptionDisplay"></div>
      </div>
      <div class="image-notes-wrap" id="imageNotesWrap">
        <textarea class="image-notes" id="imageNotes" placeholder="Add caption or notes..." rows="2"></textarea>
        <div class="image-edit-actions" id="imageEditActions">
          <button class="img-act" onclick="cancelEditCaption()">Cancel</button>
          <button class="img-act primary" onclick="saveCaption()">Save</button>
        </div>
      </div>
      <div class="image-actions" id="imageActions">
        <button class="img-act" onclick="shareImage()">Share</button>
        <button class="img-act" onclick="saveImageToGallery()">Download</button>
        <button class="img-act delete" onclick="deleteFromViewer()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo AI Tools Modal -->
  <div class="photo-ai-modal" id="photoAIModal" onclick="if(event.target===this)closePhotoAI()">
    <div class="photo-ai-content">
      <div class="photo-ai-header">
        <h3>AI Tools</h3>
        <p>What would you like to do?</p>
      </div>
      <div class="photo-ai-tools">
        <button class="photo-ai-btn" onclick="runPhotoAI('ocr')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></div>
          <div class="info">
            <div class="title">Extract Text (OCR)</div>
            <div class="desc">Read and copy text from image</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="runPhotoAI('describe')">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div>
          <div class="info">
            <div class="title">Describe Image</div>
            <div class="desc">AI generates detailed description</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="startEditCaption(); closePhotoAI();">
          <div class="icon"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></div>
          <div class="info">
            <div class="title">Edit Caption</div>
            <div class="desc">Add or edit photo notes</div>
          </div>
        </button>
      </div>
      <button class="pill-l sec" onclick="closePhotoAI()">Cancel</button>
    </div>
  </div>

  <!-- Photo AI Result Modal -->
  <div class="photo-ai-result" id="photoAIResult" onclick="if(event.target===this)closePhotoAIResult()">
    <div class="photo-ai-result-content">
      <div class="photo-ai-result-header">
        <h3 id="photoAIResultTitle">Result</h3>
      </div>
      <div class="photo-ai-result-text" id="photoAIResultText"></div>
      <div class="photo-ai-result-actions">
        <button class="pill-l ai" onclick="savePhotoAIToCaption()">Set as Caption</button>
        <button class="pill-l sec" onclick="savePhotoAIToNewDrop()">Create New Drop</button>
        <button class="pill-l sec" onclick="copyPhotoAIResult()">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Photo Markers Modal -->
  <div class="photo-markers-modal" id="photoMarkersModal" onclick="if(event.target===this)closePhotoMarkersModal()">
    <div class="photo-markers-content">
      <div class="photo-markers-title">Add Markers</div>
      <div class="photo-markers-grid" id="photoMarkersGrid"></div>
      <button class="photo-markers-done" onclick="closePhotoMarkersModal()">Done</button>
    </div>
  </div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}

let ideas=JSON.parse(localStorage.getItem('droplit_ideas'))||[];

// ============================================
// AUTO-FIX: Repair string IDs (v0.9.58)
// ============================================
(function autoFixIds() {
  let fixed = 0;
  ideas = ideas.map((item, index) => {
    if (typeof item.id === 'string') {
      item.id = Date.now() + index; // Unique numeric ID
      fixed++;
    }
    return item;
  });
  if (fixed > 0) {
    localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
    console.log(`‚úÖ Auto-fixed ${fixed} drop(s) with string IDs`);
  }
})();

let curCat='all',curTime='all',sortAsc=true,isRec=false,recognition=null,saved=false;
let sendId=null,delId=null,catChangeId=null,editId=null,activeCardId=null,creatorModalId=null;
let selectMode=false,selectedIds=[];
let lastScrollTop=0,longPressTimer=null;

// AI Configuration
const AI_API_URL = '/api/ai';
const STREAMING_ENABLED = true;
let aiProcessing = false;
let showArchived = false;
let rollUpMode = false;

function stopAllAudio() {
  document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
  if (window.speechSynthesis) window.speechSynthesis.cancel();
  if (typeof window.stopTTS === 'function') window.stopTTS();
}

const ideasWrap=document.getElementById('ideasWrap');
const scrollTopBtn=document.getElementById('scrollTop');
const scrollBottomBtn=document.getElementById('scrollBottom');
let scrollTimeout=null;

ideasWrap.addEventListener('scroll',()=>{
  const st=ideasWrap.scrollTop;
  const maxScroll=ideasWrap.scrollHeight-ideasWrap.clientHeight;
  const dir=st>lastScrollTop?1:-1;
  lastScrollTop=st;
  clearTimeout(scrollTimeout);
  scrollTopBtn.classList.remove('show');
  scrollBottomBtn.classList.remove('show');
  if(maxScroll>300){
    if(dir<0 && st>200) scrollTopBtn.classList.add('show');
    else if(dir>0 && st<maxScroll-200) scrollBottomBtn.classList.add('show');
  }
  scrollTimeout=setTimeout(()=>{
    scrollTopBtn.classList.remove('show');
    scrollBottomBtn.classList.remove('show');
  },2000);
});

function scrollToTop(){ideasWrap.scrollTo({top:0,behavior:'smooth'});scrollTopBtn.classList.remove('show');}
function scrollToBottom(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'smooth'});scrollBottomBtn.classList.remove('show');}
function scrollToBottomInstant(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'instant'});}
function toggleSort(){sortAsc=!sortAsc;document.getElementById('sortBtn').innerHTML=sortAsc?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>';document.getElementById('sortBtn').classList.toggle('desc',!sortAsc);render();}

// Selection mode
function enterSelectMode(id){
  selectMode=true;
  selectedIds=[id];
  activeCardId=null;
  document.body.classList.add('select-mode');
  document.getElementById('fabRecord').style.display='none';
  document.getElementById('fabCamera').style.display='none';
  updateSelectBar();
  // Fast targeted update instead of render()
  const card = document.querySelector('.card[data-id="'+id+'"]');
  if(card) {
    card.classList.add('selected');
    card.classList.remove('active');
    const checkbox = card.querySelector('.card-checkbox');
    if(checkbox) checkbox.textContent = '‚úì';
  }
}

function cancelSelect(){
  // Remove selected class from tracked cards
  selectedIds.forEach(id => {
    const card = document.querySelector('.card[data-id="'+id+'"]');
    if(card) {
      card.classList.remove('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '';
    }
  });
  // Fallback: remove .selected from ANY card that might have it
  document.querySelectorAll('.card.selected').forEach(card => {
    card.classList.remove('selected');
    const checkbox = card.querySelector('.card-checkbox');
    if(checkbox) checkbox.textContent = '';
  });
  selectMode=false;
  selectedIds=[];
  document.body.classList.remove('select-mode');
  document.getElementById('selectBar').classList.remove('show');
  document.getElementById('fabRecord').style.display='flex';
  document.getElementById('fabCamera').style.display='flex';
}

function deleteSelected(){
  if(selectedIds.length===0)return;
  const count=selectedIds.length;
  if(confirm('Delete '+count+' selected items?')){
    ideas=ideas.filter(i=>!selectedIds.includes(i.id));
    save();
    cancelSelect();
    render();counts();
    toast(count+' items deleted','info');
  }
}

function toggleSelect(id){
  const card = document.querySelector('.card[data-id="'+id+'"]');
  
  if(selectedIds.includes(id)){
    // DESELECT: First remove visual, then update array
    if(card) {
      card.classList.remove('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '';
    }
    selectedIds=selectedIds.filter(x=>x!==id);
    if(selectedIds.length===0) {
      cancelSelect();
      // Extra safety: ensure no orphan selected cards
      document.querySelectorAll('.card.selected').forEach(c => {
        c.classList.remove('selected');
        const cb = c.querySelector('.card-checkbox');
        if(cb) cb.textContent = '';
      });
      return;
    }
    updateSelectBar();
  } else {
    // SELECT: Add to array and update visual
    selectedIds.push(id);
    updateSelectBar();
    if(card) {
      card.classList.add('selected');
      const checkbox = card.querySelector('.card-checkbox');
      if(checkbox) checkbox.textContent = '‚úì';
    }
  }
}

function updateSelectBar(){
  document.getElementById('selectCount').textContent=selectedIds.length;
  document.getElementById('selectBar').classList.toggle('show',selectMode&&selectedIds.length>0);
}

function getMergedText(simple=false){
  const selected=ideas.filter(i=>selectedIds.includes(i.id));
  // Sort by timestamp
  selected.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  
  if(simple){
    // Simple merge - just text, double newline between
    return selected.map(i=>{
      if(i.isMedia){
        return i.notes||'[Photo '+i.date+' '+i.time+']';
      }
      return i.text;
    }).join('\n\n');
  }
  
  // List merge with headers
  return selected.map(i=>{
    const cat=CATS[i.category]?.name||'INBOX';
    if(i.isMedia){
      const content=i.notes||'[Photo '+i.date+' '+i.time+']';
      return `- [${cat}] ${content}`;
    }
    return `- [${cat}] ${i.text}`;
  }).join('\n');
}

function updateMergePreview(){
  const simple=document.getElementById('mergeSimple').checked;
  document.getElementById('mergePreview').textContent=getMergedText(simple);
}

function showMergePreview(){
  if(selectedIds.length<2){toast('Select at least 2 cards','warning');return;}
  // Check if any selected item is media
  const hasMedia=selectedIds.some(id=>{
    const item=ideas.find(x=>x.id===id);
    return item&&item.isMedia;
  });
  if(hasMedia){toast('Cannot merge media items','warning');return;}
  
  // Get current checkbox state and update preview accordingly
  const simple=document.getElementById('mergeSimple').checked;
  const mergedText = getMergedText(simple);
  document.getElementById('mergePreview').textContent=mergedText;
  
  // Warning for large merge
  const charCount = mergedText.length;
  if (charCount > 10000) {
    toast(`Large merge: ${Math.round(charCount/1000)}K chars`, 'warning');
  }
  
  document.getElementById('mergeModal').classList.add('show');
}

function closeMergeModal(){stopAllAudio();document.getElementById('mergeModal').classList.remove('show');}

function copyMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  navigator.clipboard.writeText(getMergedText(simple));
  toast('Copied to clipboard!','success');
  closeMergeModal();
}

function saveMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  const text=getMergedText(simple);
  
  // Check size limit
  const MAX_DROP_SIZE = 50000; // 50KB
  if (text.length > MAX_DROP_SIZE) {
    toast(`Too large! Max: ${MAX_DROP_SIZE/1000}K chars`, 'error');
    return;
  }
  
  const mergedId = Date.now();
  const idea={id:mergedId,text:text,category:'inbox',timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMerged:true};
  ideas.push(idea);
  
  // Save undo
  saveUndo('merge', { mergedId: mergedId, count: selectedIds.length });
  
  save();
  playDropSound(); // Play signature sound
  closeMergeModal();
  cancelSelect();
  resetToShowAll();
  toast('Merged & saved!','success');
}

// Card interactions
function handleCardClick(id,e){
  // Ignore clicks on category badge, action buttons, textarea, checkbox, markers
  if(e.target.closest('.card-cat')||e.target.closest('.act')||e.target.closest('.card-ta')||e.target.closest('.card-checkbox')||e.target.closest('.card-markers')||e.target.closest('.card-avatar'))return;
  
  // Ignore clicks on audio player buttons only
  if(e.target.closest('.audio-btn'))return;
  
  const item=ideas.find(x=>x.id===id);
  
  if(selectMode){
    // In select mode - always toggle selection
    toggleSelect(id);
  } else if(editId && editId !== id) {
    // If editing another card, don't activate this one
    return;
  } else if(item && item.isMedia && item.category !== 'audio') {
    // For image/photo cards - open viewer directly (NOT for audio)
    viewImage(id,e);
  } else {
    // For text cards AND audio cards - toggle expand/collapse
    const prevId = activeCardId;
    activeCardId = activeCardId===id ? null : id;
    
    // Stop audio when deactivating or switching cards
    if(prevId) stopAllAudio();
    
    // Fast class manipulation (no render)
    if(prevId) {
      const prevCard = document.querySelector('.card[data-id="'+prevId+'"]');
      if(prevCard) {
        prevCard.classList.remove('active');
        if(rollUpMode) prevCard.classList.add('roll-up');
      }
    }
    if(activeCardId) {
      const newCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
      if(newCard) {
        // Remember top position before expanding
        const topBefore = newCard.getBoundingClientRect().top;
        
        newCard.classList.add('active');
        newCard.classList.remove('roll-up');
        
        // Keep top position fixed (expand only down)
        requestAnimationFrame(() => {
          const topAfter = newCard.getBoundingClientRect().top;
          const diff = topAfter - topBefore;
          if(Math.abs(diff) > 2) {
            ideasWrap.scrollTop += diff;
          }
        });
      }
    }
  }
}

function toggleMarker(id,marker,e){
  if(e){e.stopPropagation();}
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Initialize markers array if needed
  if(!item.markers)item.markers=[];
  
  // Toggle marker (silent - no toast per B3 fix)
  const idx=item.markers.indexOf(marker);
  if(idx===-1){
    item.markers.push(marker);
  } else {
    item.markers.splice(idx,1);
  }
  
  save();
  
  // Fast DOM update (no render)
  const card = document.querySelector('.card[data-id="'+id+'"]');
  if(card) {
    // 1. Update header marker display
    const row2 = card.querySelector('.card-row2');
    if(row2) {
      let existingMarker = row2.querySelector('.card-marker');
      if(item.markers && item.markers.length) {
        const markerText = item.markers.map(m => MARKERS[m] || '').join('');
        if(existingMarker) {
          existingMarker.textContent = markerText;
        } else {
          // Insert before NEW badge if exists, otherwise at end
          const newBadge = row2.querySelector('.new-badge');
          const span = document.createElement('span');
          span.className = 'card-marker';
          span.textContent = markerText;
          if(newBadge) {
            row2.insertBefore(span, newBadge);
          } else {
            row2.appendChild(span);
          }
        }
      } else if(existingMarker) {
        existingMarker.remove();
      }
    }
    
    // 2. Update marker buttons state
    const markersPanel = card.querySelector('.card-markers');
    if(markersPanel) {
      markersPanel.querySelectorAll('.marker-btn').forEach(btn => {
        const mk = Object.keys(MARKERS).find(k => MARKERS[k] === btn.textContent);
        if(mk) {
          btn.classList.toggle('active', item.markers && item.markers.includes(mk));
        }
      });
    }
  }
  
  // Update photo markers button if in image viewer
  if(currentImageId === id) {
    updatePhotoMarkersButton();
  }
}

function handleCardLongPress(id){
  if(!selectMode){
    enterSelectMode(id);
    if(navigator.vibrate)navigator.vibrate(50);
  }
}

let touchStartX=0,touchStartY=0;

function cardTouchStart(id,e){
  if(selectMode||editId)return;
  const touch=e.touches[0];
  touchStartX=touch.clientX;
  touchStartY=touch.clientY;
  longPressTimer=setTimeout(()=>handleCardLongPress(id),800);
}

function cardTouchMove(e){
  if(!longPressTimer)return;
  const touch=e.touches[0];
  const dx=Math.abs(touch.clientX-touchStartX);
  const dy=Math.abs(touch.clientY-touchStartY);
  // Cancel if moved more than 10px (scrolling)
  if(dx>10||dy>10){
    clearTimeout(longPressTimer);
    longPressTimer=null;
  }
}

function cardTouchEnd(){
  clearTimeout(longPressTimer);
  longPressTimer=null;
}

document.addEventListener('click',(e)=>{
  if(activeCardId&&!e.target.closest('.card')&&!e.target.closest('.overlay')&&!e.target.closest('.fab-record')&&!e.target.closest('.select-bar')){
    stopAllAudio();
    const prevCard = document.querySelector('.card[data-id="'+activeCardId+'"]');
    if(prevCard) {
      prevCard.classList.remove('active');
      if(rollUpMode) prevCard.classList.add('roll-up');
    }
    activeCardId=null;
  }
});

function initSR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('warning').style.display='block';document.getElementById('fabRecord').style.opacity='0.5';return false;}
  recognition=new SR();
  recognition.lang='ru-RU';
  recognition.continuous=false;
  recognition.interimResults=true;
  recognition.maxAlternatives=1;
  recognition.onstart=async()=>{isRec=true;saved=false;updateRecUI(true);await acquireWakeLock();};
  recognition.onresult=(e)=>{
    let f='',i='';
    for(let x=0;x<e.results.length;x++){if(e.results[x].isFinal)f+=e.results[x][0].transcript;else i+=e.results[x][0].transcript;}
    document.getElementById('recText').textContent=(f||i)||'Listening...';
    if(f&&!saved){saved=true;saveIdea(f.trim());}
  };
  recognition.onerror=(e)=>{
    if(e.error==='no-speech')toast('No speech detected','warning');
    else if(e.error==='not-allowed')toast('Microphone access denied','error');
    isRec=false;updateRecUI(false);releaseWakeLock();
  };
  recognition.onend=()=>{isRec=false;updateRecUI(false);releaseWakeLock();};
  return true;
}

// B4 FIX: Wake Lock to prevent screen from turning off during recording
let wakeLock = null;
async function acquireWakeLock() {
  if ('wakeLock' in navigator) {
    try { 
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock acquired');
      // Re-acquire if released (e.g., when tab becomes visible again)
      wakeLock.addEventListener('release', () => {
        console.log('Wake Lock released');
        wakeLock = null;
      });
    } 
    catch (err) { console.log('Wake Lock error:', err); }
  }
}
function releaseWakeLock() {
  if (wakeLock) { 
    wakeLock.release(); 
    wakeLock = null; 
    console.log('Wake Lock released manually');
  }
}

// ===== FAB DOUBLE-TAP & LONG-PRESS =====
let fabLastTap = 0;
let fabLongPressTimer = null;

function handleFabClick(event) {
  const now = Date.now();
  const timeDiff = now - fabLastTap;
  fabLastTap = now;
  
  // Double-tap detection (within 300ms)
  if (timeDiff < 300 && timeDiff > 0) {
    event.preventDefault();
    openAudioRecorder();
    return;
  }
  
  // Single tap - normal voice recognition
  toggleRec();
}

function fabTouchStart() {
  // Long press detection (500ms)
  fabLongPressTimer = setTimeout(() => {
    openAudioRecorder();
    fabLongPressTimer = null;
  }, 500);
}

function fabTouchEnd() {
  if (fabLongPressTimer) {
    clearTimeout(fabLongPressTimer);
    fabLongPressTimer = null;
  }
}

function toggleRec(){if(isRec)recognition.stop();else{saved=false;recognition.start();}}
function updateRecUI(on){
  const fab=document.getElementById('fabRecord'),status=document.getElementById('recStatus');
  if(on){fab.classList.add('recording');status.classList.add('show');document.getElementById('recText').textContent='Listening...';}
  else{fab.classList.remove('recording');status.classList.remove('show');}
}
function detectCat(t){
  const l=t.toLowerCase();
  for(const[k,v]of Object.entries(CATS)){
    if(k==='inbox'||!v.kw||v.kw.length===0)continue;
    for(const w of v.kw){
      // Check: starts with word, contains word with spaces, or ends with word
      if(l.startsWith(w+' ')||l.startsWith(w+',')||l.startsWith(w+'.')||
         l.includes(' '+w+' ')||l.includes(' '+w+',')||l.includes(' '+w+'.')||
         l.endsWith(' '+w)||l===w)return k;
    }
  }
  return'inbox';
}
function saveIdea(t){
  // ============================================
  // SLASH COMMANDS (v0.9.58)
  // ============================================
  if (t.startsWith('/')) {
    const cmd = t.toLowerCase().trim();
    
    if (cmd === '/fix') {
      // Fix string IDs
      let fixed = 0;
      ideas = ideas.map((item, index) => {
        if (typeof item.id === 'string') {
          item.id = Date.now() + index;
          fixed++;
        }
        return item;
      });
      if (fixed > 0) {
        localStorage.setItem('droplit_ideas', JSON.stringify(ideas));
        toast(`‚úÖ Fixed ${fixed} drop(s)!`, 'success');
        render();
      } else {
        toast('All IDs are OK!', 'info');
      }
      return;
    }
    
    if (cmd === '/debug') {
      // Show debug info
      const total = ideas.length;
      const stringIds = ideas.filter(i => typeof i.id === 'string').length;
      const merged = ideas.filter(i => i.isMerged).length;
      const audio = ideas.filter(i => i.category === 'audio').length;
      const userId = currentUser ? currentUser.id.substring(0, 8) + '...' : 'Not logged in';
      const deviceId = DEVICE_ID || 'Not set';
      const syncStatus = syncEnabled ? 'Enabled' : 'Disabled';
      alert(`DropLit Debug v0.9.69\n\n=== DROPS ===\nTotal: ${total}\nString IDs: ${stringIds}\nMerged: ${merged}\nAudio: ${audio}\n\n=== SYNC ===\nUser ID: ${userId}\nDevice ID: ${deviceId}\nSync: ${syncStatus}\n\n=== STORAGE ===\nLocalStorage: ${(localStorage.getItem('droplit_ideas')?.length / 1024).toFixed(1)} KB`);
      return;
    }
    
    if (cmd === '/clear') {
      if (confirm('‚ö†Ô∏è Delete ALL drops? This cannot be undone!')) {
        ideas = [];
        localStorage.removeItem('droplit_ideas');
        toast('All drops deleted', 'warning');
        render();
        counts();
      }
      return;
    }
    
    if (cmd === '/help') {
      alert('DropLit Commands:\n\n/fix - Repair broken IDs\n/debug - Show stats\n/clear - Delete all drops\n/help - This message');
      return;
    }
  }
  
  const c=detectCat(t);
  const idea={id:Date.now(),text:t,category:c,timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMedia:false};
  ideas.push(idea);save(idea);
  playDropSound(); // Play signature sound
  resetToShowAll();
  toast('Saved to '+CATS[c].name,'success');
}

function resetToShowAll(){
  try{
    // Reset filter variables
    curCat='all';
    curTime='7days';
    activeCardId=null;
    sortAsc=true;
    // Update sort button UI
    const sortBtn=document.getElementById('sortBtn');
    if(sortBtn){
      sortBtn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
      sortBtn.classList.remove('desc');
    }
    // Remove active class from category buttons
    document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
    // Update time buttons - activate 7d
    document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
    const btn7d=document.querySelector('.time-btn[data-time="7days"]');
    if(btn7d)btn7d.classList.add('active');
    // Render and scroll (instant, no animation)
    render();
    counts();
    setTimeout(()=>{
      const wrap=document.getElementById('ideasWrap');
      if(wrap)wrap.scrollTo({top:wrap.scrollHeight,behavior:'auto'});
    },50);
  }catch(err){
    console.error('resetToShowAll error:',err);
  }
}

function handlePhoto(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing photo...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200; // Max dimension
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    // Compress to JPEG 70% quality
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    savePhoto(dataUrl,null);
  };
  img.onerror=function(){
    toast('Failed to load photo','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read photo','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

function savePhoto(dataUrl,geo){
  const idea={
    id:Date.now(),
    text:'',
    notes:'',
    image:dataUrl,
    category:'photo',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    geo:geo,
    isMedia:true
  };
  ideas.push(idea);
  save();
  playDropSound(); // Play signature sound
  toast('Photo saved!','success');
  try{
    resetToShowAll();
  }catch(err){
    // Silent fail - photo is saved
  }
}

// ============================================
// PLUS MENU FUNCTIONS
// ============================================

function togglePlusMenu(){
  const menu=document.getElementById('plusMenu');
  const backdrop=document.getElementById('plusBackdrop');
  
  if(menu.classList.contains('show')){
    closePlusMenu();
  } else {
    menu.classList.add('show');
    backdrop.classList.add('show');
  }
}

function closePlusMenu(){
  document.getElementById('plusMenu').classList.remove('show');
  document.getElementById('plusBackdrop').classList.remove('show');
}

// TEXT NOTE
function openTextInput(){
  closePlusMenu();
  document.getElementById('textInputModal').classList.add('show');
  setTimeout(()=>{
    document.getElementById('textInputArea').focus();
  },100);
}

function closeTextInput(){
  document.getElementById('textInputModal').classList.remove('show');
  document.getElementById('textInputArea').value='';
}

function saveTextNote(){
  const text=document.getElementById('textInputArea').value.trim();
  if(!text){
    toast('Please enter some text','error');
    return;
  }
  
  const category=detectCat(text);
  const idea={
    id:Date.now(),
    text:text,
    category:category,
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
  };
  ideas.push(idea);
  save();
  playDropSound();
  toast('Note saved!','success');
  closeTextInput();
  resetToShowAll();
}

// PASTE LINK
async function pasteLink(){
  closePlusMenu();
  
  try{
    // Try to read from clipboard
    const text=await navigator.clipboard.readText();
    
    if(text&&isUrl(text.trim())){
      createLinkCard(text.trim());
    } else if(text&&text.trim()){
      // Not a URL but has text - ask user
      toast('Clipboard: "'+text.substring(0,30)+'..."','info');
      // Create as text note with the link
      const category=detectCat(text);
      const idea={
        id:Date.now(),
        text:text.trim(),
        category:category,
        timestamp:new Date().toISOString(),
        date:new Date().toLocaleDateString('ru-RU'),
        time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
      };
      ideas.push(idea);
      save();
      playDropSound();
      toast('Saved from clipboard!','success');
      resetToShowAll();
    } else {
      toast('Clipboard is empty','error');
    }
  }catch(err){
    // Clipboard API not available or denied
    toast('Cannot access clipboard. Please paste manually.','error');
    openTextInput();
  }
}

function isUrl(str){
  return /^(https?:\/\/|www\.)/i.test(str);
}

function createLinkCard(url){
  // Ensure URL has protocol
  let href=url;
  if(url.startsWith('www.'))href='https://'+url;
  
  const idea={
    id:Date.now(),
    text:href,
    category:'link',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    isLink:true
  };
  ideas.push(idea);
  save();
  playDropSound();
  toast('Link saved!','success');
  resetToShowAll();
}

// UPLOAD IMAGE
function uploadImage(){
  closePlusMenu();
  document.getElementById('imageUpload').click();
}

function handleUploadedImage(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing image...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200;
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    
    // Save as uploaded image (no geo)
    const idea={
      id:Date.now(),
      text:'',
      notes:'',
      image:dataUrl,
      category:'photo',
      timestamp:new Date().toISOString(),
      date:new Date().toLocaleDateString('ru-RU'),
      time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
      geo:null,
      isMedia:true,
      isUploaded:true
    };
    ideas.push(idea);
    save();
    playDropSound();
    toast('Image uploaded!','success');
    resetToShowAll();
  };
  img.onerror=function(){
    toast('Failed to load image','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read image','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

// ============================================
// FILE UPLOAD (v0.8.2)
// ============================================

const MAX_FILE_SIZE = 50 * 1024; // 50KB limit
const SUPPORTED_TEXT_EXTENSIONS = ['txt', 'md', 'csv', 'json'];

function uploadFile(){
  closePlusMenu();
  document.getElementById('fileUpload').click();
}

function handleUploadedFile(e){
  const file = e.target.files[0];
  if (!file) return;
  
  // Check extension
  const ext = file.name.split('.').pop().toLowerCase();
  if (!SUPPORTED_TEXT_EXTENSIONS.includes(ext)) {
    toast('Supported: .txt, .md, .csv, .json', 'error');
    e.target.value = '';
    return;
  }
  
  // Check size
  if (file.size > MAX_FILE_SIZE) {
    const sizeKB = Math.round(file.size / 1024);
    toast(`File too large (${sizeKB}KB). Max: 50KB`, 'error');
    e.target.value = '';
    return;
  }
  
  toast('Reading file...', 'info');
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const text = ev.target.result;
    
    if (!text || text.trim().length === 0) {
      toast('File is empty', 'error');
      return;
    }
    
    // Create drop from file content
    const idea = {
      id: Date.now(),
      text: text.trim(),
      category: detectCat(text.trim()),
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      isImported: true,
      sourceFile: file.name
    };
    
    ideas.push(idea);
    save();
    
    const charCount = text.length;
    toast(`Imported! ${charCount} chars from ${file.name}`, 'success');
    resetToShowAll();
  };
  
  reader.onerror = function() {
    toast('Failed to read file', 'error');
  };
  
  reader.readAsText(file);
  e.target.value = '';
}

function aiProcess(id){toast('AI processing coming soon!','info');}
function openCatModal(id){
  catChangeId=id;
  const item=ideas.find(x=>x.id===id);
  const isMedia=item?.isMedia;
  const grid=document.querySelector('#catModal .cat-grid');
  // Show only appropriate categories
  grid.querySelectorAll('.cat-opt').forEach(btn=>{
    const cat=btn.dataset.cat;
    if(isMedia){
      // Media items can only go to sketch, scan, inbox
      btn.style.display=MEDIA_CATS.includes(cat)?'block':'none';
    } else {
      // Text items can go to all except sketch, scan
      btn.style.display=!CATS[cat]?.isMedia?'block':'none';
    }
  });
  document.getElementById('catModal').classList.add('show');
}
function closeCatModal(){stopAllAudio();document.getElementById('catModal').classList.remove('show');catChangeId=null;}
function changeCat(c){if(catChangeId){const i=ideas.find(x=>x.id===catChangeId);if(i){saveUndo('category',{id:i.id,previousCategory:i.category,newCategory:c});i.category=c;save();render();counts();toast('Moved to '+CATS[c].name,'success');}}closeCatModal();}
function openCreatorModal(id, e) {
  if(e) e.stopPropagation();
  const item = ideas.find(x => x.id === id);
  if(!item) return;
  
  creatorModalId = id;
  const creator = item.creator || 'user';
  const creatorName = creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : (item.creatorName || 'You');
  const creatorRole = creator === 'aski' ? 'AI Assistant' : creator === 'system' ? 'System Service' : (item.creatorRole || '');
  const creatorStatus = item.creatorStatus || ''; // 'public', 'verified', 'vip', or ''
  
  const avatarSvg = creator === 'aski' 
    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>'
    : creator === 'system'
    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'
    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
  
  document.getElementById('creatorModalAvatar').innerHTML = avatarSvg;
  document.getElementById('creatorModalAvatar').className = 'creator-modal-avatar ' + creator;
  document.getElementById('creatorModalName').textContent = creatorName;
  document.getElementById('creatorModalRole').textContent = creatorRole;
  document.getElementById('creatorModalDate').textContent = item.date + ' ' + item.time;
  document.getElementById('creatorModalCopyright').textContent = '¬© ' + new Date(item.timestamp || Date.now()).getFullYear() + ' ' + creatorName;
  
  // Set header gradient based on status
  const header = document.getElementById('creatorModalHeader');
  header.className = 'modal-header ' + creatorStatus;
  
  document.getElementById('creatorModal').classList.add('show');
}

function filterByCreator() {
  const item = ideas.find(x => x.id === creatorModalId);
  if(!item) return;
  
  const creator = item.creator || 'user';
  const creatorName = item.creatorName || (creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : 'You');
  
  // Set filter (we'll use a special filter mode)
  window.filterCreator = creator === 'user' ? (item.creatorName || 'You') : creator;
  
  closeCreatorModal();
  render();
  toast('Showing drops by ' + creatorName, 'success');
}

function clearCreatorFilter() {
  window.filterCreator = null;
  render();
  toast('Filter cleared', 'success');
}

function closeCreatorModal() {
  stopAllAudio();
  document.getElementById('creatorModal').classList.remove('show');
  creatorModalId = null;
}

function reqDel(id){delId=id;document.getElementById('delModal').classList.add('show');}
function closeDelModal(){stopAllAudio();document.getElementById('delModal').classList.remove('show');delId=null;}
function confirmDel(){
  if(delId){
    const delItem=ideas.find(x=>x.id===delId);
    if(delItem) {
      saveUndo('delete',{...delItem});
      // Sync delete to Supabase (v0.9.58)
      if (syncEnabled && currentUser) {
        deleteDropFromServer(delId);
      }
    }
    ideas=ideas.filter(x=>x.id!==delId);
    save();
    activeCardId=null;
    render();
    counts();
    toast('Deleted','info');
  }
  closeDelModal();
}
function startEdit(id){if(editId)cancelEdit(editId);editId=id;activeCardId=id;document.body.classList.add('editing-mode');render();setTimeout(()=>{const card=document.querySelector('[data-id="'+id+'"]');const ta=card?.querySelector('.card-ta');if(ta){card.scrollIntoView({behavior:'smooth',block:'center'});ta.focus();}},100);}
function saveEdit(id){
  const card=document.querySelector('[data-id="'+id+'"]'),ta=card?.querySelector('.card-ta');
  if(ta){
    const t=ta.value.trim();
    if(t){
      const i=ideas.find(x=>x.id===id);
      if(i&&t!==i.text){
        saveUndo('edit',{id:i.id,previousText:i.text});
        i.text=t;
        i.category=detectCat(t);
        save();
        // Sync update to Supabase (v0.9.58)
        if (syncEnabled && currentUser) {
          syncDropToServer(i, 'update');
        }
        toast('Saved','success');
      }
    }
  }
  editId=null;
  document.body.classList.remove('editing-mode');
  render();
  counts();
}
function cancelEdit(id){editId=null;document.body.classList.remove('editing-mode');render();}
function openSendModal(id){sendId=id;document.getElementById('sendModal').classList.add('show');}
function closeSendModal(){stopAllAudio();document.getElementById('sendModal').classList.remove('show');sendId=null;}
function sendAI(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);window.open('https://claude.ai','_blank');toast('Copied to clipboard!','success');}closeSendModal();}
function shareNative(){const i=ideas.find(x=>x.id===sendId);if(i&&navigator.share)navigator.share({title:'DropLit',text:i.text}).catch(()=>{});else if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function sendMail(){const i=ideas.find(x=>x.id===sendId);if(i)window.open('mailto:?subject='+encodeURIComponent('DropLit: '+CATS[i.category].name)+'&body='+encodeURIComponent(i.text));closeSendModal();}
function copyClip(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function copyIdea(id){const i=ideas.find(x=>x.id===id);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}}

function duplicateCard(id){
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Create copy with new timestamp
  const now=new Date();
  const copy={
    id: Date.now(),
    text: item.text,
    category: item.category,
    timestamp: now.toISOString(),
    date: now.toLocaleDateString('ru-RU'),
    time: now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    markers: item.markers ? [...item.markers] : [],
    notes: item.notes || ''
  };
  
  // Copy media if exists
  if(item.isMedia){
    copy.isMedia = true;
    copy.image = item.image;
  }
  
  ideas.push(copy);
  save();
  activeCardId=null;
  render();
  
  toast('Duplicated!','success');
  
  // Scroll to the new card at bottom
  setTimeout(()=>{
    const card=document.querySelector('[data-id="'+copy.id+'"]');
    if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
  },100);
}
function save(newDrop){
  try{
    const data=JSON.stringify(ideas);
    localStorage.setItem('droplit_ideas',data);
    
    // Sync to Supabase (v0.9.58)
    if (newDrop && syncEnabled && currentUser) {
      syncDropToServer(newDrop, 'create');
    }
    
    // Legacy: Sync to Syntrise CORE
    if (newDrop && window.SyntriseCore) {
      syncDropToCore(newDrop);
    }
  }catch(err){
    // Storage full - usually QuotaExceededError
    const sizeMB=(JSON.stringify(ideas).length/1024/1024).toFixed(1);
    toast('Storage full ('+sizeMB+'MB)! Delete old photos','error');
  }
}
function smartTime(i){
  if(!i.date && !i.time) return '';
  
  const td=new Date().toLocaleDateString('ru-RU');
  const yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');
  
  // Normalize date to ru-RU format if it's ISO
  let dateStr = i.date || '';
  if(dateStr.includes('-') && !dateStr.includes('T')){
    // ISO format: 2026-01-02 -> 02.01.2026
    const [y,m,d] = dateStr.split('-');
    dateStr = d+'.'+m+'.'+y;
  } else if(dateStr.includes('T')){
    // Full ISO: 2026-01-02T12:00:00
    const dt = new Date(dateStr);
    dateStr = dt.toLocaleDateString('ru-RU');
  }
  
  const timeStr = i.time || '';
  
  if(dateStr===td) return timeStr;
  if(dateStr===yd) return 'Yesterday '+timeStr;
  
  const p=dateStr.split('.');
  if(p.length >= 2){
    return p[0]+'.'+p[1]+' '+timeStr;
  }
  return timeStr;
}

// NEW badge for drops < 15 minutes old
function isNewDrop(i) {
  if (!i.date || !i.time) return false;
  const [d, m, y] = i.date.split('.');
  const [h, min] = i.time.split(':');
  const created = new Date(+y, +m - 1, +d, +h, +min);
  const diff = Date.now() - created.getTime();
  return diff < 15 * 60 * 1000; // 15 minutes
}
function filtered(){
  let f=[...ideas].filter(x=>x&&x.date); // Filter out invalid entries
  
  // Apply search filter
  if(searchMode && searchQuery) {
    f = f.filter(x => {
      const text = (x.text || '').toLowerCase();
      const notes = (x.notes || '').toLowerCase();
      return text.includes(searchQuery) || notes.includes(searchQuery);
    });
    return f; // Skip other filters when searching
  }
  
  if(curTime==='today')f=f.filter(x=>isToday(x.date));
  else if(curTime==='7days')f=f.filter(x=>inDays(x.date,7));
  if(curCat!=='all')f=f.filter(x=>x.category===curCat);
  // Filter by creator if set
  if(window.filterCreator) {
    f = f.filter(x => {
      const c = x.creator || 'user';
      if(window.filterCreator === 'aski') return c === 'aski';
      if(window.filterCreator === 'system') return c === 'system';
      return c === 'user' && (x.creatorName || 'You') === window.filterCreator;
    });
  }
  return f;
}

function toggleRollUpMode() {
  rollUpMode = !rollUpMode;
  localStorage.setItem('droplit_rollup_mode', rollUpMode ? 'true' : 'false');
  document.getElementById('rollUpModeToggle')?.classList.toggle('active', rollUpMode);
  
  // Apply to all cards instantly (no render)
  document.querySelectorAll('.card').forEach(card => {
    const isActive = card.classList.contains('active');
    if(rollUpMode && !isActive) {
      card.classList.add('roll-up');
    } else {
      card.classList.remove('roll-up');
    }
  });
}

function render(){
  const wrap=document.getElementById('ideasList'),empty=document.getElementById('emptyState'),list=filtered();
  if(!list.length){wrap.innerHTML='';empty.style.display='flex';return;}
  empty.style.display='none';
  const grp={};for(const i of list){if(!grp[i.date])grp[i.date]=[];grp[i.date].push(i);}
  let dates=Object.keys(grp).sort((a,b)=>sortAsc?parseD(a)-parseD(b):parseD(b)-parseD(a));
  let h='';
  const td=new Date().toLocaleDateString('ru-RU'),yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');
  for(const d of dates){
    let lbl=d;if(d===td)lbl='Today';else if(d===yd)lbl='Yesterday';
    h+='<div class="date-sep">'+lbl+'</div>';
    // Sort within day by timestamp (precise to millisecond)
    let dayIdeas=grp[d].slice().sort((a,b)=>{
      // Use timestamp for precise sorting (includes seconds/ms)
      const tsA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
      const tsB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
      return sortAsc ? tsA - tsB : tsB - tsA;
    });
    for(const i of dayIdeas){
      const isActive=activeCardId===i.id;
      const isEditing=editId===i.id;
      const isSelected=selectedIds.includes(i.id);
      const isRollUp=rollUpMode&&!isActive;
      const cc=i.isMedia?0:(i.text?.length||0);
      const isTruncated=cc>1000; /* ~20 lines */
      // Determine creator type and display name
      const creator = i.creator || 'user';
      const creatorName = creator === 'aski' ? 'ASKI' : creator === 'system' ? 'System' : (i.creatorName || 'Benedict Cumberbatch');
      const creatorRole = creator === 'aski' ? '' : creator === 'system' ? '' : (i.creatorRole || 'Creator');
      const creatorStatus = i.creatorStatus || (creator === 'user' ? 'public' : ''); // Demo: public for user
      const avatarSvg = creator === 'aski' 
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3Z"/></svg>'
        : creator === 'system'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
      // Verified badge SVG (checkmark)
      const badgeSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
      const verifiedBadge = creatorStatus ? '<span class="verified-badge '+creatorStatus+'">'+badgeSvg+'</span>' : '';
      const roleText = creatorRole ? '<span class="card-role">, '+creatorRole+'</span>' : '';
      // Card with full width, avatar inside
      h+='<div class="card'+(isActive?' active':'')+(isEditing?' editing':'')+(isSelected?' selected':'')+(isRollUp?' roll-up':'')+'" data-id="'+i.id+'" onclick="handleCardClick('+i.id+',event)" ontouchstart="cardTouchStart('+i.id+',event)" ontouchmove="cardTouchMove(event)" ontouchend="cardTouchEnd()" ontouchcancel="cardTouchEnd()">';
      h+='<div class="card-checkbox">'+(isSelected?'‚úì':'')+'</div>';
      // Header: Avatar left, two rows right
      h+='<div class="card-header">';
      h+='<div class="card-avatar '+creator+'" onclick="openCreatorModal('+i.id+',event)">'+avatarSvg+'</div>';
      h+='<div class="card-header-content">';
      // Row 1: Badge + Name + Role + Time
      h+='<div class="card-row1">';
      h+='<span class="card-creator">'+verifiedBadge+creatorName+roleText+'</span>';
      h+='<span class="card-time">'+smartTime(i)+'</span>';
      h+='</div>';
      // Row 2: Category + params + NEW
      h+='<div class="card-row2">';
      h+='<span class="card-cat '+i.category+'" onclick="openCatModal('+i.id+')">'+(CATS[i.category]?.single||'INBOX')+'</span>';
      // Counter: text=chars, audio=duration, image=dimensions
      if(i.category==='audio'){
        h+='<span class="card-chars">'+formatDuration(i.duration||0)+'</span>';
      } else if(i.isMedia&&i.imageDimensions){
        h+='<span class="card-chars">'+i.imageDimensions+'</span>';
      } else if(i.isMedia){
        h+='<span class="card-chars">IMG</span>';
      } else {
        h+='<span class="card-chars">'+cc+'</span>';
      }
      // Markers
      if(i.markers&&i.markers.length){
        h+='<span class="card-marker">'+i.markers.map(m=>MARKERS[m]||'').join('')+'</span>';
      }
      if(isNewDrop(i))h+='<span class="new-badge">NEW</span>';
      h+='</div>';
      h+='</div>'; // close card-header-content
      h+='</div>'; // close card-header
      // Audio player
      if(i.category==='audio'&&i.audioData){
        h+='<div class="card-audio-player" data-audio-id="'+i.id+'">';
        h+='<div class="audio-waveform" id="waveform-'+i.id+'">';
        for(let bi=0;bi<30;bi++){
          const bh=8+Math.random()*32;
          h+='<div class="audio-waveform-bar" style="height:'+bh+'px"></div>';
        }
        h+='</div>';
        h+='<div class="audio-controls">';
        h+='<button class="audio-btn" onclick="seekAudio('+i.id+',-10,event)">&lt;&lt;</button>';
        h+='<button class="audio-btn play" onclick="togglePlayAudio('+i.id+',event)" id="playbtn-'+i.id+'">PLAY</button>';
        h+='<button class="audio-btn" onclick="seekAudio('+i.id+',10,event)">&gt;&gt;</button>';
        h+='</div>';
        h+='<div class="audio-time"><span id="audiotime-'+i.id+'">0:00</span><span>'+formatDuration(i.duration||0)+'</span></div>';
        if(i.audioFormat)h+='<div class="audio-format">'+i.audioFormat.toUpperCase()+'</div>';
        h+='</div>';
      } else if(i.isMedia&&i.image){
        h+='<img class="card-image" src="'+i.image+'" alt="Photo" loading="lazy">';
        // Show date/geo and notes under image
        h+='<div class="card-media-meta">';
        h+='<span>'+i.date+' '+i.time+'</span>';
        if(i.geo)h+='<span>'+i.geo.lat.toFixed(2)+','+i.geo.lng.toFixed(2)+'</span>';
        h+='</div>';
        if(i.notes){
          const notesLong = i.notes.length > 100;
          h+='<div class="card-notes'+(notesLong?'':' expanded')+'" id="notes-'+i.id+'">'+esc(i.notes)+'</div>';
          if(notesLong)h+='<div class="card-more show" onclick="toggleNotesExpand('+i.id+',event)">Show more</div>';
        }
      }
      if(i.text){
        h+='<div class="card-text'+(isTruncated?' truncated':'')+'" id="text-'+i.id+'">'+linkify(i.text)+'</div>';
        if(isTruncated)h+='<div class="card-more show" onclick="toggleExpand('+i.id+',event)">Show more</div>';
      }
      if(!i.isMedia){
        h+='<div class="card-edit"><textarea class="card-ta">'+esc(i.text||'')+'</textarea></div>';
      }
      h+='<div class="card-actions">';
      if(i.category==='audio'){
        h+='<button class="act ai" onclick="transcribeAudio('+i.id+')">Transcribe</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      } else if(i.isMedia){
        h+='<button class="act" onclick="viewImage('+i.id+',event)">View</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      } else {
        h+='<button class="act ai" onclick="openAITools('+i.id+')">AI Tools</button>';
        h+='<button class="act act-tts" onclick="speakDrop('+i.id+',event)">Read</button>';
        h+='<button class="act" onclick="startEdit('+i.id+')">Edit</button>';
        h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
        h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
        h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
        h+='<button class="act danger" onclick="reqDel('+i.id+')">Del</button>';
      }
      h+='</div>';
      if(!i.isMedia){
        h+='<div class="card-edit-actions"><button class="act primary" onclick="saveEdit('+i.id+')">Save</button><button class="act secondary" onclick="cancelEdit('+i.id+')">Cancel</button></div>';
      }
      // Markers panel at bottom
      h+='<div class="card-markers">';
      for(const mk of Object.keys(MARKERS)){
        const isMarked=i.markers&&i.markers.includes(mk);
        h+='<button class="marker-btn'+(isMarked?' active':'')+'" onclick="toggleMarker('+i.id+',\''+mk+'\',event)">'+MARKERS[mk]+'</button>';
      }
      h+='</div>';
      // Copyright line
      const copyrightYear = new Date(i.timestamp || Date.now()).getFullYear();
      const copyrightName = creatorName;
      h+='<div class="card-copyright">¬© '+copyrightYear+' '+copyrightName+'</div>';
      h+='</div>'; // close card
    }
  }
  wrap.innerHTML=h;
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

function linkify(text){
  // First escape HTML, then convert URLs to links
  const escaped=esc(text);
  // URL regex - matches http, https, and www
  const urlRegex=/(\b(https?:\/\/|www\.)[^\s<]+[^\s<.,;:!?\)\]'"])/gi;
  return escaped.replace(urlRegex,(url)=>{
    let href=url;
    if(url.startsWith('www.'))href='https://'+url;
    return '<a href="'+href+'" target="_blank" rel="noopener" onclick="event.stopPropagation()">'+url+'</a>';
  });
}

function toggleExpand(id,e){
  e.stopPropagation();
  const textEl=document.getElementById('text-'+id);
  const btn=e.target;
  if(textEl.classList.contains('expanded')){
    textEl.classList.remove('expanded');
    textEl.classList.add('truncated');
    btn.textContent='Show more';
  } else {
    textEl.classList.add('expanded');
    textEl.classList.remove('truncated');
    btn.textContent='Show less';
  }
}

function toggleNotesExpand(id,e){
  e.stopPropagation();
  const notesEl=document.getElementById('notes-'+id);
  const btn=e.target;
  if(notesEl.classList.contains('expanded')){
    notesEl.classList.remove('expanded');
    btn.textContent='Show more';
  } else {
    notesEl.classList.add('expanded');
    btn.textContent='Show less';
  }
}

let currentImageId=null;
let allMediaIds=[];
let currentMediaIndex=0;
let currentImageOrientation='';

// ============================================
// ZOOM/PAN SYSTEM (iOS/Android standard)
// ============================================

// State
let scale = 1;           // Current zoom level (1 = fit-to-screen)
let offsetX = 0;         // Pan offset X
let offsetY = 0;         // Pan offset Y
const MIN_SCALE = 1;     // Fit to screen
const MAX_SCALE = 4;     // Maximum zoom
const DOUBLE_TAP_SCALE = 2; // Double-tap zoom level

// Touch tracking
let lastTapTime = 0;
let lastTapX = 0;
let lastTapY = 0;

// Pinch state
let isPinching = false;
let pinchStartScale = 1;
let pinchStartDistance = 0;
let pinchCenterX = 0;
let pinchCenterY = 0;

// Pan state  
let isPanning = false;
let panStartX = 0;
let panStartY = 0;
let panStartOffsetX = 0;
let panStartOffsetY = 0;

// Swipe state
let swipeStartX = 0;
let swipeStartY = 0;
let isSwiping = false;

// Caption edit state
let isEditingCaption=false;

function getMediaItems(){
  return ideas.filter(i=>i.isMedia&&i.image);
}

function viewImage(id,e){
  if(e)e.stopPropagation();
  const item=ideas.find(x=>x.id===id);
  if(!item||!item.image)return;
  
  allMediaIds=getMediaItems().map(i=>i.id);
  currentMediaIndex=allMediaIds.indexOf(id);
  currentImageId=id;
  isEditingCaption=false;
  
  // Reset zoom/pan
  resetTransform();
  
  showImagePanel();
  loadCurrentImage();
  updateNavigation();
  updatePhotoMarkersButton();
  
  document.getElementById('imageViewer').classList.add('show');
  
  const content=document.getElementById('imageViewerContent');
  content.addEventListener('touchstart',handleTouchStart,{passive:false});
  content.addEventListener('touchmove',handleTouchMove,{passive:false});
  content.addEventListener('touchend',handleTouchEnd,{passive:false});
}

function loadCurrentImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  img.style.opacity = '1';
  
  // Reset transform
  resetTransform();
  applyTransform(false);
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

function updateCaptionDisplay(item){
  const display=document.getElementById('imageCaptionDisplay');
  if(item.notes&&item.notes.trim()){
    display.textContent=item.notes;
    display.classList.remove('empty');
  } else {
    display.textContent='No caption';
    display.classList.add('empty');
  }
}

function showImagePanel(){
  isEditingCaption=false;
  
  // Show caption row, hide edit area
  const captionRow=document.querySelector('.image-caption-row');
  const notesWrap=document.getElementById('imageNotesWrap');
  
  if(captionRow) captionRow.style.display='flex';
  if(notesWrap) notesWrap.classList.remove('editing');
}

function updateNavigation(){
  const counter=document.getElementById('imageCounter');
  const prevBtn=document.getElementById('imgNavPrev');
  const nextBtn=document.getElementById('imgNavNext');
  
  counter.textContent=(currentMediaIndex+1)+' / '+allMediaIds.length;
  
  if(allMediaIds.length>1){
    prevBtn.classList.toggle('show',currentMediaIndex>0);
    nextBtn.classList.toggle('show',currentMediaIndex<allMediaIds.length-1);
  } else {
    prevBtn.classList.remove('show');
    nextBtn.classList.remove('show');
  }
}

function navigateImage(direction){
  const newIndex=currentMediaIndex+direction;
  if(newIndex<0||newIndex>=allMediaIds.length)return;
  
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom before navigating
  resetTransform();
  
  const img = document.getElementById('imageViewerImg');
  
  // Quick fade transition for button navigation
  img.style.transition = 'opacity 0.15s ease-out';
  img.style.opacity = '0';
  
  setTimeout(() => {
    currentMediaIndex=newIndex;
    currentImageId=allMediaIds[currentMediaIndex];
    loadCurrentImageNoReset();
    
    img.style.transition = 'opacity 0.15s ease-out';
    img.style.opacity = '1';
    updateNavigation();
    updatePhotoMarkersButton();
  }, 100);
}

function loadCurrentImageNoReset(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

// ============================================
// TRANSFORM HELPERS
// ============================================

function resetTransform(){
  scale = 1;
  offsetX = 0;
  offsetY = 0;
}

function applyTransform(animate = true){
  const img = document.getElementById('imageViewerImg');
  if(!img) return;
  
  img.style.transition = animate ? 'transform 0.25s ease-out' : 'none';
  img.style.transform = `scale(${scale}) translate(${offsetX}px, ${offsetY}px)`;
  
  // Update class for CSS
  if(scale > 1){
    img.classList.remove('portrait','landscape');
    img.classList.add('zoomed');
  } else {
    img.classList.remove('zoomed');
    if(currentImageOrientation){
      img.classList.add(currentImageOrientation);
    }
  }
}

function clampOffset(){
  // Restrict pan so image doesn't go outside bounds
  const img = document.getElementById('imageViewerImg');
  const content = document.getElementById('imageViewerContent');
  if(!img || !content) return;
  
  const contentRect = content.getBoundingClientRect();
  
  // Calculate how much image can move based on scale
  // When scale=1, no movement allowed. When scale>1, allow proportional movement.
  const imgWidth = img.offsetWidth || 300;
  const imgHeight = img.offsetHeight || 300;
  
  const scaledWidth = imgWidth * scale;
  const scaledHeight = imgHeight * scale;
  
  // Max offset is half the overflow (scaled size - container size) / 2, divided by scale
  const maxOffsetX = Math.max(0, (scaledWidth - contentRect.width) / 2 / scale);
  const maxOffsetY = Math.max(0, (scaledHeight - contentRect.height) / 2 / scale);
  
  offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
  offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
}

// ============================================
// TOUCH HANDLERS
// ============================================

function handleTouchStart(e){
  const touches = e.touches;
  
  if(touches.length === 2){
    // PINCH START
    e.preventDefault();
    isPinching = true;
    isPanning = false;
    isSwiping = false;
    
    pinchStartScale = scale;
    pinchStartDistance = getPinchDistance(touches);
    
  } else if(touches.length === 1){
    // SINGLE TOUCH START
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    if(scale > 1){
      // Zoomed in - start panning
      isPanning = true;
      isSwiping = false;
      panStartX = x;
      panStartY = y;
      panStartOffsetX = offsetX;
      panStartOffsetY = offsetY;
    } else {
      // Not zoomed - could be swipe or tap
      isSwiping = true;
      isPanning = false;
      swipeStartX = x;
      swipeStartY = y;
    }
    
    isPinching = false;
  }
}

function handleTouchMove(e){
  const touches = e.touches;
  
  if(isPinching && touches.length === 2){
    // PINCH MOVE
    e.preventDefault();
    
    const newDistance = getPinchDistance(touches);
    const scaleChange = newDistance / pinchStartDistance;
    let newScale = pinchStartScale * scaleChange;
    
    // Clamp scale
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    scale = newScale;
    
    // Apply without animation for smooth feel
    applyTransform(false);
    
  } else if(isPanning && touches.length === 1){
    // PAN MOVE
    e.preventDefault();
    
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    // Calculate delta and apply to offset (divide by scale for correct movement)
    offsetX = panStartOffsetX + (x - panStartX) / scale;
    offsetY = panStartOffsetY + (y - panStartY) / scale;
    
    // Clamp to bounds
    clampOffset();
    
    // Apply without animation
    applyTransform(false);
    
  } else if(isSwiping && touches.length === 1 && scale <= 1){
    // SWIPE MOVE - image follows finger
    const deltaX = touches[0].clientX - swipeStartX;
    const deltaY = touches[0].clientY - swipeStartY;
    
    // Only horizontal swipe
    if(Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 5){
      e.preventDefault();
      
      // Move image with finger (with resistance at edges)
      const img = document.getElementById('imageViewerImg');
      let moveX = deltaX;
      
      // Add resistance if at first/last image
      if((currentMediaIndex === 0 && deltaX > 0) || 
         (currentMediaIndex === allMediaIds.length - 1 && deltaX < 0)){
        moveX = deltaX * 0.3; // Rubber band effect
      }
      
      img.style.transition = 'none';
      img.style.transform = `translateX(${moveX}px)`;
      img.style.opacity = Math.max(0.5, 1 - Math.abs(deltaX) / 500);
    }
  }
}

function handleTouchEnd(e){
  const changedTouches = e.changedTouches;
  
  if(isPinching){
    // PINCH END
    isPinching = false;
    
    // Snap to 1 if close
    if(scale < 1.1){
      scale = 1;
      offsetX = 0;
      offsetY = 0;
    } else {
      // Clamp offset after pinch
      clampOffset();
    }
    
    applyTransform(true);
    return;
  }
  
  if(isPanning){
    // PAN END
    isPanning = false;
    
    // Check for double-tap while zoomed (to reset)
    const now = Date.now();
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const dx = Math.abs(x - panStartX);
    const dy = Math.abs(y - panStartY);
    
    // If didn't move much, might be a tap
    if(dx < 10 && dy < 10){
      if(now - lastTapTime < 300){
        // Double tap while zoomed - reset to fit
        e.preventDefault();
        resetTransform();
        applyTransform(true);
        lastTapTime = 0;
        return;
      }
      lastTapTime = now;
    }
    return;
  }
  
  if(isSwiping && scale <= 1){
    // SWIPE END (not zoomed)
    isSwiping = false;
    
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const deltaX = x - swipeStartX;
    const deltaY = y - swipeStartY;
    const img = document.getElementById('imageViewerImg');
    
    // Check for SWIPE (horizontal, more than 80px threshold)
    if(Math.abs(deltaX) > 80 && Math.abs(deltaY) < 100){
      // Animate current image out
      const direction = deltaX > 0 ? 1 : -1;
      const canNavigate = (direction > 0 && currentMediaIndex > 0) || 
                          (direction < 0 && currentMediaIndex < allMediaIds.length - 1);
      
      if(canNavigate){
        // Slide out completely
        img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
        img.style.transform = `translateX(${direction * 300}px)`;
        img.style.opacity = '0';
        
        setTimeout(() => {
          // Update index
          currentMediaIndex += (direction > 0 ? -1 : 1);
          currentImageId = allMediaIds[currentMediaIndex];
          
          // Position for slide in
          img.style.transition = 'none';
          img.style.transform = `translateX(${-direction * 100}px)`;
          
          loadCurrentImageNoReset();
          
          // Animate in
          setTimeout(() => {
            img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
            img.style.transform = 'translateX(0)';
            img.style.opacity = '1';
            updateNavigation();
            updatePhotoMarkersButton();
          }, 20);
        }, 150);
        return;
      }
    }
    
    // Return to center (swipe cancelled or at edge)
    img.style.transition = 'transform 0.25s ease-out, opacity 0.15s ease-out';
    img.style.transform = 'translateX(0)';
    img.style.opacity = '1';
    
    // Check for DOUBLE TAP (to zoom in)
    const now = Date.now();
    const tapDist = Math.sqrt(
      Math.pow(x - lastTapX, 2) + Math.pow(y - lastTapY, 2)
    );
    
    if(now - lastTapTime < 300 && tapDist < 30 && Math.abs(deltaX) < 10){
      // DOUBLE TAP - zoom to 2x centered on tap point
      e.preventDefault();
      doubleTapZoom(x, y);
      lastTapTime = 0;
      lastTapX = 0;
      lastTapY = 0;
    } else {
      lastTapTime = now;
      lastTapX = x;
      lastTapY = y;
    }
  }
  
  isSwiping = false;
  isPanning = false;
}

function doubleTapZoom(tapX, tapY){
  if(scale > 1){
    // Already zoomed - reset to fit
    resetTransform();
  } else {
    // Zoom to 2x, centered on tap point
    const content = document.getElementById('imageViewerContent');
    const img = document.getElementById('imageViewerImg');
    if(!content || !img) return;
    
    const rect = content.getBoundingClientRect();
    
    // Calculate offset to center on tap point
    const tapRelX = tapX - (rect.left + rect.width / 2);
    const tapRelY = tapY - (rect.top + rect.height / 2);
    
    // New scale
    scale = DOUBLE_TAP_SCALE;
    
    // Offset to keep tap point in same screen position
    offsetX = -tapRelX / scale;
    offsetY = -tapRelY / scale;
    
    // Clamp
    clampOffset();
  }
  
  applyTransform(true);
}

function getPinchDistance(touches){
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Caption editing
function startEditCaption(){
  isEditingCaption=true;
  const item=ideas.find(x=>x.id===currentImageId);
  
  document.getElementById('imageNotes').value=item?.notes||'';
  
  // Show edit area, hide caption row
  document.querySelector('.image-caption-row').style.display='none';
  document.getElementById('imageNotesWrap').classList.add('editing');
  
  setTimeout(()=>{
    document.getElementById('imageNotes').focus();
  },100);
}

function saveCaption(){
  const notes=document.getElementById('imageNotes').value.trim();
  const item=ideas.find(x=>x.id===currentImageId);
  if(item){
    item.notes=notes;
    save();
    render();
    updateCaptionDisplay(item);
  }
  showImagePanel();
}

function cancelEditCaption(){
  showImagePanel();
}

function handleImageViewerClick(e){
  if(e.target.classList.contains('image-viewer')){
    closeImageViewer();
  }
}

function closeImageViewer(){
  stopAllAudio();
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom/pan state
  resetTransform();
  isPinching=false;
  isPanning=false;
  isSwiping=false;
  isEditingCaption=false;
  
  const content=document.getElementById('imageViewerContent');
  content.removeEventListener('touchstart',handleTouchStart);
  content.removeEventListener('touchmove',handleTouchMove);
  content.removeEventListener('touchend',handleTouchEnd);
  
  currentImageId=null;
  allMediaIds=[];
  document.getElementById('imageViewer').classList.remove('show');
  document.getElementById('imageViewerImg').src='';
}

function shareImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  fetch(item.image)
    .then(res=>res.blob())
    .then(blob=>{
      const file=new File([blob],'droplit-sketch.jpg',{type:'image/jpeg'});
      if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
        navigator.share({
          files:[file],
          title:'DropLit Sketch',
          text:item.notes||'Shared from DropLit'
        }).catch(()=>{});
      } else {
        window.open(item.image,'_blank');
        toast('Use browser menu to share','info');
      }
    });
}

function saveImageToGallery(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const link=document.createElement('a');
  link.href=item.image;
  link.download='droplit-sketch-'+item.id+'.jpg';
  link.click();
  toast('Image saved!','success');
}

// ============================================
// AI FUNCTIONS (v0.8.2)
// ============================================

async function ocrImage() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('ocr', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'ocr', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const existingNotes = item.notes || '';
      const ocrText = data.result;
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- OCR ---\n' + ocrText;
      } else {
        item.notes = ocrText;
      }
      
      if (!item.text) {
        item.text = ocrText.substring(0, 200) + (ocrText.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Text extracted! ‚úÖ', 'success');
      showAIResult('OCR Result', ocrText);
    } else {
      toast(data.error || 'OCR failed', 'error');
    }
  } catch (error) {
    console.error('OCR error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

async function aiDescribe() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('describe', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'describe', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const description = data.result;
      const existingNotes = item.notes || '';
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- AI Description ---\n' + description;
      } else {
        item.notes = description;
      }
      
      if (!item.text) {
        item.text = description.substring(0, 200) + (description.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Image analyzed! ‚úÖ', 'success');
      showAIResult('AI Description', description);
    } else {
      toast(data.error || 'Analysis failed', 'error');
    }
  } catch (error) {
    console.error('AI describe error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

// AI Result Modal
function showAIResult(title, text) {
  let modal = document.getElementById('aiResultModal');
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'aiResultModal';
    modal.className = 'ai-result-modal';
    modal.onclick = function(e) { if(e.target === this) closeAIResult(); };
    modal.innerHTML = `
      <div class="ai-result-content">
        <div class="ai-result-header" style="background: linear-gradient(135deg, #8B5CF6, #EC4899);">
          <h2 id="aiResultTitle">AI Result</h2>
        </div>
        <div class="ai-result-body">
          <div id="aiResultContent" style="font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap;"></div>
        </div>
        <div class="ai-result-actions">
          <button class="pill-l magic" onclick="createDropFromResult()">Create Drop</button>
          <div class="pill-row">
            <button class="pill-l sec" onclick="shareResult()">Share</button>
            <button class="pill-l sec" onclick="copyAIResult()">Copy</button>
          </div>
          <button class="pill-l sec" onclick="closeAIResult()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('aiResultTitle').textContent = title;
  document.getElementById('aiResultContent').textContent = text;
  modal.classList.add('show');
}

function closeAIResult() {
  const modal = document.getElementById('aiResultModal');
  if (modal) modal.classList.remove('show');
}

function copyAIResult() {
  const content = document.getElementById('aiResultContent');
  if (content) {
    navigator.clipboard.writeText(content.textContent);
    toast('Copied!', 'success');
  }
}

// Create Drop from AI result
function createDropFromResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  const title = document.getElementById('aiResultTitle').textContent;
  
  // Determine category based on title
  let category = 'ideas';
  if (title.includes('Poem') || title.includes('–°—Ç–∏—Ö')) category = 'ideas';
  if (title.includes('Speech') || title.includes('–°–ø–∏—á')) category = 'ideas';
  if (title.includes('Greeting') || title.includes('–ü–æ–∑–¥—Ä–∞–≤')) category = 'ideas';
  
  const idea = {
    id: Date.now(),
    text: text,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true // Mark as AI generated
  };
  
  ideas.push(idea);
  save();
  closeAIResult();
  render();
  counts();
  toast('Drop created!', 'success');
}

// Share AI result
function shareResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  
  if (navigator.share) {
    navigator.share({
      text: text
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text);
    toast('Copied! Paste to share', 'success');
  }
}

// ============================================
// AI MAGIC FUNCTIONS (v0.8.2)
// ============================================

let currentMagicType = 'poem';
let magicRecognition = null;
let isMagicRecording = false;
let magicPhotoData = null; // Store selected photo

const MAGIC_CONFIG = {
  poem: {
    title: 'Create Poem',
    subtitle: 'Tell me what it should be about',
    placeholder: 'Example: Birthday greeting for mom, she loves gardening and has 2 grandkids...',
    styles: [
      { id: 'classic', label: 'Classic' },
      { id: 'funny', label: 'Funny' },
      { id: 'tender', label: 'Tender' },
      { id: 'epic', label: 'Epic' }
    ]
  },
  greeting: {
    title: 'Create Greeting',
    subtitle: 'Who is it for and what occasion?',
    placeholder: 'Example: New Year greeting for colleagues, warm and professional...',
    styles: [
      { id: 'warm', label: 'Warm' },
      { id: 'funny', label: 'Funny' },
      { id: 'formal', label: 'Formal' },
      { id: 'poetic', label: 'Poetic' }
    ]
  },
  speech: {
    title: 'Create Speech',
    subtitle: 'What occasion? Who is the audience?',
    placeholder: 'Example: Wedding toast for my best friend, he loves fishing, we know each other 15 years...',
    styles: [
      { id: 'short', label: 'Short (1-2 min)' },
      { id: 'medium', label: 'Medium (3-5 min)' },
      { id: 'long', label: 'Long (7-10 min)' }
    ]
  }
};

function openMagic(type) {
  closePlusMenu();
  currentMagicType = type;
  magicPhotoData = null; // Reset photo
  
  const config = MAGIC_CONFIG[type];
  if (!config) return;
  
  // Update UI
  document.getElementById('magicTitle').textContent = config.title;
  document.getElementById('magicSubtitle').textContent = config.subtitle;
  document.getElementById('magicInput').placeholder = config.placeholder;
  document.getElementById('magicInput').value = '';
  
  // Reset photo UI
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Update styles
  const stylesContainer = document.getElementById('magicStyles');
  stylesContainer.innerHTML = config.styles.map((s, i) => 
    `<button class="magic-style${i === 0 ? ' active' : ''}" data-style="${s.id}">${s.label}</button>`
  ).join('');
  
  // Add click handlers to styles
  stylesContainer.querySelectorAll('.magic-style').forEach(btn => {
    btn.onclick = () => {
      stylesContainer.querySelectorAll('.magic-style').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });
  
  // Show modal
  document.getElementById('magicModal').classList.add('show');
  // Removed autofocus to prevent keyboard popup
}

function closeMagic() {
  document.getElementById('magicModal').classList.remove('show');
  document.getElementById('magicPhotoMenu').classList.remove('show');
  if (isMagicRecording) {
    stopMagicVoice();
  }
}

// ============================================
// MAGIC PHOTO FUNCTIONS
// ============================================

function togglePhotoMenu() {
  const menu = document.getElementById('magicPhotoMenu');
  menu.classList.toggle('show');
}

function takeMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicCameraInput').click();
}

function chooseMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicPhotoInput').click();
}

function handleMagicPhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    magicPhotoData = e.target.result;
    showMagicPhotoPreview(magicPhotoData);
  };
  reader.readAsDataURL(file);
  
  // Reset input so same file can be selected again
  event.target.value = '';
}

function showMagicPhotoPreview(dataUrl) {
  document.getElementById('magicPhotoImg').src = dataUrl;
  document.getElementById('magicPhotoPreview').style.display = 'block';
  document.getElementById('magicPhotoBtn').classList.add('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Photo added ‚úì';
  document.getElementById('magicInputLabel').textContent = 'Add details about this photo (optional)';
}

function removeMagicPhoto() {
  magicPhotoData = null;
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicInputLabel').textContent = 'Add details (optional if photo added)';
}

// Drops Picker
function openDropsPicker() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Get all photo drops
  const photoDrops = ideas.filter(i => i.image);
  const grid = document.getElementById('dropsPickerGrid');
  
  if (photoDrops.length === 0) {
    grid.innerHTML = '<div class="drops-picker-empty">No photo drops yet.<br>Take some photos first!</div>';
  } else {
    grid.innerHTML = photoDrops.map(drop => `
      <div class="drops-picker-item" onclick="selectDropPhoto('${drop.id}')">
        <img src="${drop.image}" alt="Drop photo">
      </div>
    `).join('');
  }
  
  document.getElementById('dropsPicker').classList.add('show');
}

function closeDropsPicker() {
  document.getElementById('dropsPicker').classList.remove('show');
}

function selectDropPhoto(id) {
  const drop = ideas.find(i => i.id == id);
  if (drop && drop.image) {
    magicPhotoData = drop.image;
    showMagicPhotoPreview(drop.image);
  }
  closeDropsPicker();
}

function toggleMagicVoice() {
  if (isMagicRecording) {
    stopMagicVoice();
  } else {
    startMagicVoice();
  }
}

function startMagicVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    toast('Speech not supported', 'error');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  magicRecognition = new SpeechRecognition();
  magicRecognition.continuous = false; // Single phrase, no duplicates
  magicRecognition.interimResults = true;
  magicRecognition.maxAlternatives = 1;
  magicRecognition.lang = 'ru-RU';
  
  const inputEl = document.getElementById('magicInput');
  const existingText = inputEl.value;
  let finalTranscript = '';
  
  magicRecognition.onresult = (e) => {
    let interim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        finalTranscript += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Show interim while speaking
    document.getElementById('magicVoiceText').textContent = interim || finalTranscript || 'Listening...';
  };
  
  magicRecognition.onerror = (e) => {
    if (e.error === 'no-speech') toast('No speech detected', 'warning');
    stopMagicVoice();
  };
  
  magicRecognition.onend = () => {
    // Append final result to existing text
    if (finalTranscript) {
      inputEl.value = existingText + (existingText ? ' ' : '') + finalTranscript.trim();
    }
    stopMagicVoice();
  };
  
  magicRecognition.start();
  isMagicRecording = true;
  document.getElementById('magicVoiceBtn').classList.add('recording');
  document.getElementById('magicVoiceText').textContent = 'Listening...';
}

function stopMagicVoice() {
  if (magicRecognition) {
    magicRecognition.stop();
    magicRecognition = null;
  }
  isMagicRecording = false;
  document.getElementById('magicVoiceBtn').classList.remove('recording');
  document.getElementById('magicVoiceText').textContent = 'Tap to speak';
}

async function generateMagic() {
  const input = document.getElementById('magicInput').value.trim();
  
  // Need either text or photo
  if (!input && !magicPhotoData) {
    toast('Add a photo or describe what you want', 'error');
    return;
  }
  
  const activeStyle = document.querySelector('.magic-style.active');
  const style = activeStyle ? activeStyle.dataset.style : 'classic';
  
  // Get context
  const context = {
    timeOfDay: getTimeOfDay(),
    location: null
  };
  
  // Show loading in modal
  const loadingLabels = {
    poem: 'Creating your poem',
    greeting: 'Crafting your greeting',
    speech: 'Writing your speech'
  };
  document.getElementById('magicLoadingLabel').textContent = (loadingLabels[currentMagicType] || 'Creating magic') + '...';
  document.getElementById('magicForm').classList.add('hidden');
  document.getElementById('magicLoading').classList.add('show');
  
  try {
    const requestBody = {
      action: currentMagicType,
      text: input,
      style: style,
      context: context
    };
    
    // Add photo if present
    if (magicPhotoData) {
      requestBody.image = magicPhotoData;
    }
    
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody),
    });
    
    const data = await response.json();
    
    // Hide loading and close modal
    document.getElementById('magicLoading').classList.remove('show');
    document.getElementById('magicForm').classList.remove('hidden');
    closeMagic();
    
    if (data.success && data.result) {
      const titles = {
        poem: 'Your Poem',
        greeting: 'Your Greeting',
        speech: 'Your Speech'
      };
      
      showAIResult(titles[currentMagicType] || 'AI Result', data.result);
    } else {
      toast(data.error || 'Generation failed', 'error');
    }
  } catch (error) {
    console.error('Magic error:', error);
    document.getElementById('magicLoading').classList.remove('show');
    document.getElementById('magicForm').classList.remove('hidden');
    toast('Connection error', 'error');
  }
}

// ============================================
// AI LOADING INDICATOR (compact, inside modal)
// ============================================

const AI_LOADING_LABELS = {
  poem: 'Creating poem',
  greeting: 'Crafting greeting',
  speech: 'Writing speech',
  summarize: 'Summarizing',
  expand: 'Expanding',
  rewrite: 'Rewriting',
  enhance: 'Enhancing',
  translate: 'Translating',
  tasks: 'Extracting tasks',
  ocr: 'Reading text',
  describe: 'Analyzing image',
  default: 'Processing'
};

let currentLoadingModal = null;

function showAILoading(action, useModal2 = true) {
  const label = AI_LOADING_LABELS[action] || AI_LOADING_LABELS.default;
  
  const loadingHTML = `
    <div class="ai-loading-inline">
      <div class="ai-loading-dots">
        <span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="ai-loading-label">${label}...</div>
    </div>
  `;
  
  if (useModal2) {
    // Use AI Result Modal 2 (for AI Tools)
    currentLoadingModal = 'modal2';
    document.getElementById('aiResult2Title').textContent = label;
    document.getElementById('aiResult2Text').innerHTML = loadingHTML;
    document.querySelector('.ai-result-actions').style.display = 'none';
    document.getElementById('aiResult2Category').style.display = 'none';
    document.getElementById('aiResultModal2').classList.add('show');
  } else {
    // Use simple toast for Magic/OCR/Describe
    currentLoadingModal = 'toast';
    toast(label + '...', 'info');
  }
}

function hideAILoading() {
  if (currentLoadingModal === 'modal2') {
    // Restore action buttons
    document.querySelector('.ai-result-actions').style.display = 'flex';
  }
  currentLoadingModal = null;
}

function getTimeOfDay() {
  const hour = new Date().getHours();
  if (hour < 6) return 'night';
  if (hour < 12) return 'morning';
  if (hour < 18) return 'afternoon';
  return 'evening';
}

// ============================================
// AI TOOLS FOR TEXT DROPS (v0.8.2)
// ============================================

let aiToolsDropId = null;
let aiToolsResult = null;
let aiToolsSuggestedCategory = null;

function openAITools(id) {
  const drop = ideas.find(x => x.id === id);
  if (!drop || !drop.text) {
    toast('No text to process', 'error');
    return;
  }
  
  aiToolsDropId = id;
  
  // Show preview
  const previewText = drop.text.length > 200 
    ? drop.text.substring(0, 200) + '...' 
    : drop.text;
  document.getElementById('aiToolsPreviewText').textContent = previewText;
  
  // Show current category
  const catName = CATS[drop.category]?.single || drop.category.toUpperCase();
  document.getElementById('aiToolsCurrentCategory').textContent = catName;
  
  document.getElementById('aiToolsModal').classList.add('show');
}

function closeAITools() {
  document.getElementById('aiToolsModal').classList.remove('show');
  // Don't reset aiToolsDropId here - it's needed for Replace/Create Drop actions
}

async function runAITool(tool) {
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  const checkCategory = document.getElementById('aiToolsCheckCategory').checked;
  const removeLineBreaks = document.getElementById('aiToolsRemoveLineBreaks').checked;
  
  // Close tools modal and show loading overlay
  closeAITools();
  showAILoading(tool);
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: tool,
        text: drop.text,
        checkCategory: checkCategory
      }),
    });
    
    const data = await response.json();
    
    hideAILoading();
    
    if (data.success && data.result) {
      // Parse result (may be JSON or plain text)
      let resultText = data.result;
      let suggestedCat = null;
      
      // Try to extract JSON from response (may have markdown wrapper)
      let jsonStr = resultText;
      const jsonMatch = resultText.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else if (resultText.trim().startsWith('{')) {
        jsonStr = resultText.trim();
      }
      
      try {
        // Try to parse as JSON
        const parsed = JSON.parse(jsonStr);
        if (tool === 'summarize' && parsed.summary) {
          resultText = parsed.summary;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'expand' && parsed.expanded) {
          resultText = parsed.expanded;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'rewrite' && parsed.rewritten) {
          resultText = parsed.rewritten;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'enhance' && parsed.enhanced) {
          resultText = parsed.enhanced;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'tasks' && parsed.tasks) {
          // Create task drops
          createTaskDrops(parsed.tasks);
          return;
        } else {
          // JSON parsed but no expected field - use first text value found
          const textValue = parsed.summary || parsed.expanded || parsed.rewritten || parsed.enhanced || parsed.result || parsed.text;
          if (textValue) {
            resultText = textValue;
            suggestedCat = parsed.suggestedCategory;
          }
          // else keep original resultText (will be cleaned below)
        }
      } catch (e) {
        // Not JSON, use as plain text
        if (tool === 'tasks') {
          // Parse numbered list
          const tasks = resultText.split('\n')
            .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
            .filter(line => line.length > 0);
          createTaskDrops(tasks);
          return;
        }
        // For other tools, clean up any JSON-like artifacts
        if (resultText.trim().startsWith('{') || resultText.trim().startsWith('```')) {
          // Failed to parse, try to extract text manually
          const textMatch = resultText.match(/"(?:summary|expanded|rewritten|text)":\s*"([^"]+)"/);
          if (textMatch) {
            resultText = textMatch[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
          }
        }
      }
      
      // T1 FIX: Remove extra line breaks if option is checked
      if (removeLineBreaks && tool !== 'tasks') {
        resultText = resultText
          .replace(/\n+/g, ' ')      // Replace newlines with space
          .replace(/\s{2,}/g, ' ')   // Replace multiple spaces with single
          .trim();
      }
      
      // Show result modal
      showAIResult2(tool, resultText, drop.category, suggestedCat);
      
    } else {
      toast(data.error || 'Processing failed', 'error');
    }
  } catch (error) {
    console.error('AI Tools error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

// B2 FIX: Store pending tasks for confirmation
let pendingTasks = [];

function createTaskDrops(tasks) {
  if (!tasks || tasks.length === 0) {
    toast('No tasks found', 'warning');
    return;
  }
  
  // Show confirmation modal instead of creating immediately
  pendingTasks = tasks;
  showTasksConfirmModal(tasks);
}

function showTasksConfirmModal(tasks) {
  // Close AI Tools modal first to prevent it showing after Cancel
  closeAITools();
  
  document.getElementById('tasksCount').textContent = tasks.length;
  document.getElementById('tasksCountBtn').textContent = tasks.length;
  
  const listEl = document.getElementById('tasksPreviewList');
  listEl.innerHTML = tasks.map((task, i) => `
    <div class="tasks-preview-item">
      <span class="tasks-preview-num">${i + 1}</span>
      <span class="tasks-preview-text">${task}</span>
    </div>
  `).join('');
  
  document.getElementById('tasksConfirmModal').classList.add('show');
}

function closeTasksConfirm() {
  document.getElementById('tasksConfirmModal').classList.remove('show');
  pendingTasks = [];
  aiToolsDropId = null;
}

function confirmCreateTasks() {
  if (!pendingTasks || pendingTasks.length === 0) {
    closeTasksConfirm();
    return;
  }
  
  const createdIds = [];
  
  pendingTasks.forEach(taskText => {
    const id = Date.now() + Math.random();
    const idea = {
      id: id,
      text: taskText,
      category: 'tasks',
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      aiGenerated: true,
      sourceDropId: aiToolsDropId
    };
    ideas.push(idea);
    createdIds.push(id);
  });
  
  saveUndo('createTasks', { taskIds: createdIds });
  
  save();
  render();
  counts();
  toast(`Created ${pendingTasks.length} tasks! ‚úì`, 'success');
  
  closeTasksConfirm();
}

// ============================================
// I1 FIX: TRANSLATE FUNCTIONS
// ============================================

function openTranslateModal() {
  closeAITools();
  document.getElementById('translateModal').classList.add('show');
}

function closeTranslateModal() {
  document.getElementById('translateModal').classList.remove('show');
}

async function runTranslate(targetLang) {
  closeTranslateModal();
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  showAILoading('translate');
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'translate',
        text: drop.text,
        targetLang: targetLang
      }),
    });
    
    const data = await response.json();
    hideAILoading();
    
    if (data.success && data.result) {
      showAIResult2('translate', data.result, drop.category, null);
    } else {
      toast(data.error || 'Translation failed', 'error');
    }
  } catch (error) {
    console.error('Translate error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

function showAIResult2(tool, text, currentCategory, suggestedCategory) {
  aiToolsResult = text;
  aiToolsSuggestedCategory = suggestedCategory;
  
  const titles = {
    summarize: 'Summary',
    expand: 'Expanded',
    rewrite: 'Rewritten',
    enhance: 'Enhanced',
    translate: 'Translated'
  };
  
  document.getElementById('aiResult2Title').textContent = titles[tool] || 'Result';
  document.getElementById('aiResult2Text').textContent = text;
  
  // Show action buttons (may have been hidden during loading)
  document.querySelector('.ai-result-actions').style.display = 'flex';
  
  // Show category suggestion if available
  const catSection = document.getElementById('aiResult2Category');
  if (suggestedCategory && suggestedCategory !== currentCategory) {
    const currentName = CATS[currentCategory]?.single || currentCategory.toUpperCase();
    const suggestedName = CATS[suggestedCategory]?.single || suggestedCategory.toUpperCase();
    
    document.getElementById('aiResult2CurrentCat').textContent = currentName;
    document.getElementById('aiResult2SuggestedCat').textContent = suggestedName;
    catSection.style.display = 'block';
  } else {
    catSection.style.display = 'none';
  }
  
  document.getElementById('aiResultModal2').classList.add('show');
}

function closeAIResult2() {
  document.getElementById('aiResultModal2').classList.remove('show');
  aiToolsResult = null;
  aiToolsSuggestedCategory = null;
  aiToolsDropId = null; // Reset here when user closes without action
}

function replaceOriginal() {
  if (!aiToolsDropId || !aiToolsResult) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    // Save for undo
    saveUndo('replace', { id: drop.id, originalText: drop.text });
    
    // Save original in drop too
    if (!drop.originalText) {
      drop.originalText = drop.text;
    }
    drop.text = aiToolsResult;
    save();
    render();
    toast('Replaced! ‚úì', 'success');
  }
  
  closeAIResult2();
  aiToolsDropId = null;
}

function createNewDrop() {
  if (!aiToolsResult) return;
  
  const sourceDrop = ideas.find(x => x.id === aiToolsDropId);
  const category = aiToolsSuggestedCategory || sourceDrop?.category || 'ideas';
  
  const idea = {
    id: Date.now(),
    text: aiToolsResult,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true,
    sourceDropId: aiToolsDropId
  };
  
  ideas.push(idea);
  save();
  render();
  counts();
  toast('Drop created!', 'success');
  
  closeAIResult2();
  aiToolsDropId = null;
}

function copyResult2() {
  if (aiToolsResult) {
    navigator.clipboard.writeText(aiToolsResult);
    toast('Copied!', 'success');
  }
}

function keepCategory() {
  aiToolsSuggestedCategory = null;
  document.getElementById('aiResult2Category').style.display = 'none';
}

function acceptCategory() {
  if (!aiToolsDropId || !aiToolsSuggestedCategory) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    drop.category = aiToolsSuggestedCategory;
    save();
    counts();
  }
  
  document.getElementById('aiResult2Category').style.display = 'none';
  toast('Category updated! ‚úì', 'success');
}

function deleteFromViewer(){
  if(!currentImageId)return;
  if(confirm('Delete this image?')){
    ideas=ideas.filter(x=>x.id!==currentImageId);
    save();
    closeImageViewer();
    render();
    counts();
    toast('Deleted','info');
  }
}


function counts(){
  try{
    const validIdeas=ideas.filter(x=>x&&x.id&&x.category);
    const cntAll=document.getElementById('cntAll');
    const cntToday=document.getElementById('cntToday');
    const cnt7d=document.getElementById('cnt7d');
    
    if(cntAll)cntAll.textContent=validIdeas.length;
    if(cntToday)cntToday.textContent=validIdeas.filter(x=>x.date&&isToday(x.date)).length;
    if(cnt7d)cnt7d.textContent=validIdeas.filter(x=>x.date&&inDays(x.date,7)).length;
    
    // Count ALL items in each category
    for(const k of Object.keys(CATS)){
      const el=document.getElementById('cnt'+k.charAt(0).toUpperCase()+k.slice(1));
      if(el)el.textContent=validIdeas.filter(x=>x.category===k).length;
    }
  }catch(err){}
}

document.getElementById('timeRow').addEventListener('click',e=>{
  const b=e.target.closest('.time-btn');if(!b)return;
  document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
  if(b.dataset.time!=='all')b.classList.add('active');
  curTime=b.dataset.time;curCat='all';activeCardId=null;
  document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
  render();counts();
});

document.getElementById('cats').addEventListener('click',e=>{
  const c=e.target.closest('.cat');if(!c)return;
  if(c.classList.contains('active')){c.classList.remove('active');curCat='all';}
  else{document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));c.classList.add('active');curCat=c.dataset.category;}
  activeCardId=null;render();
});

// ============================================
// TOKEN BALANCE
// ============================================

async function updateTokenBalance() {
  // For now, show placeholder - will connect to real API later
  document.getElementById('tokenBalance').textContent = '‚àû Free Beta';
  document.getElementById('tokenUsage').textContent = 'Unlimited during beta';
  
  // TODO: Fetch real balance from API
  // try {
  //   const response = await fetch(AI_API_URL + '?action=balance');
  //   const data = await response.json();
  //   document.getElementById('tokenBalance').textContent = formatTokens(data.balance);
  //   document.getElementById('tokenUsage').textContent = `Used: ${formatTokens(data.used)}`;
  // } catch (e) {
  //   document.getElementById('tokenBalance').textContent = 'N/A';
  // }
}

function toast(m,t='info'){
  const w=document.getElementById('toastWrap'),el=document.createElement('div');
  el.className='toast '+t;
  el.innerHTML=({success:'OK',warning:'!',error:'X',info:'i'})[t]+' '+m;
  w.appendChild(el);
  setTimeout(()=>el.classList.add('show'),10);
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},2500);
}

function updateNet(){document.getElementById('netBanner').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);

// Handle page visibility changes (screen lock, tab switch)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // Page is hidden - stop voice mode listening
    if (voiceModeRecognition) {
      stopVoiceModeListening();
      voiceModeSleeping = true;
      updateVoiceModeIndicator('sleeping');
      console.log('Voice mode paused (page hidden)');
    }
  } else {
    // Page is visible again - re-acquire Wake Lock if chat is open
    if (document.getElementById('askAIPanel')?.classList.contains('show')) {
      acquireWakeLock();
      console.log('Wake Lock re-acquired (page visible)');
    }
  }
});

document.addEventListener('DOMContentLoaded',()=>{
  // Initialize roll-up mode BEFORE render
  if (localStorage.getItem('droplit_rollup_mode') === 'true') {
    rollUpMode = true;
    document.getElementById('rollUpModeToggle')?.classList.add('active');
  }
  
  initSR();render();counts();updateNet();initFiltersState();
  setTimeout(scrollToBottomInstant,50);
  
  // Initialize dark mode
  if (localStorage.getItem('droplit_darkmode') === 'true') {
    document.getElementById('darkModeToggle')?.classList.add('active');
    document.body.classList.add('dark-mode');
  }
  
  // Initialize auto-speak
  if (localStorage.getItem('aski_auto_speak') === 'true') {
    document.getElementById('autoSpeakToggle')?.classList.add('active');
  }
  
  // Initialize voice mode
  if (localStorage.getItem('aski_voice_mode') === 'true') {
    document.getElementById('voiceModeToggle')?.classList.add('active');
  }
  
  // Initialize voice selector (OpenAI TTS)
  const savedVoice = localStorage.getItem('aski_voice') || 'nova';
  document.querySelectorAll('#voiceSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.voice === savedVoice);
  });
  
  // Load OpenAI API key on page load
  setTimeout(loadOpenAIKey, 100);
  
  // Initialize listen time
  const savedSeconds = localStorage.getItem('aski_listen_seconds') || '15';
  document.querySelectorAll('#listenCyclesSelector .pill-m').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.cycles === savedSeconds);
  });
  
  // Initialize font size
  const savedFontSize = localStorage.getItem('droplit_fontsize') || 'normal';
  document.body.classList.add('font-' + savedFontSize);
});

// ============================================
// AUTODROP FUNCTIONS
// ============================================

function toggleAutoDrop() {
  const currentState = localStorage.getItem('droplit_autodrop');
  const newEnabled = currentState !== 'true';
  
  localStorage.setItem('droplit_autodrop', newEnabled ? 'true' : 'false');
  
  const toggle = document.getElementById('autoDropToggle');
  if (toggle) toggle.classList.toggle('active', newEnabled);
  updateAutoDropIndicator();
  toast(newEnabled ? 'AutoDrop enabled' : 'AutoDrop disabled');
}

function toggleAutoDropFromChat() {
  toggleAutoDrop();
}

function updateAutoDropIndicator() {
  const indicator = document.getElementById('autoDropIndicator');
  const rawValue = localStorage.getItem('droplit_autodrop');
  const enabled = rawValue === 'true';
  console.log('[AutoDrop] Update indicator - raw:', rawValue, 'enabled:', enabled);
  if (indicator) {
    indicator.classList.toggle('active', enabled);
    indicator.textContent = enabled ? 'AUTODROP ON' : 'AUTODROP';
  }
}

function autoSaveMessageAsDrop(text, isUser) {
  // Check localStorage directly for reliability
  const isEnabled = localStorage.getItem('droplit_autodrop') === 'true';
  
  if (!isEnabled) {
    console.log('[AutoDrop] Skipped - disabled');
    return;
  }
  
  if (!text || !text.trim()) return;
  
  const drop = {
    id: Date.now(),
    text: text,
    category: 'inbox',
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    isMedia: false,
    creator: isUser ? 'user' : 'aski'
  };
  
  ideas.unshift(drop);
  save(drop);
  
  // Don't call render() to avoid UI disruption during chat
  counts();
  
  console.log('AutoDrop saved:', isUser ? 'User' : 'ASKI', text.substring(0, 30) + '...');
}

// Initialize AutoDrop toggle on load
document.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('autoDropToggle');
  if (toggle) toggle.classList.toggle('active', isAutoDropEnabled());
  updateAutoDropIndicator();
});

</script>
</body>
</html>
