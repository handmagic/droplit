<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1E293B">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DropLit">
  <meta name="application-name" content="DropLit">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="DropLit - Voice-first idea capture app. Never lose your ideas again.">
  <title>DropLit</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #FF6B4A;
      --color-primary-dark: #E85A3A;
      --color-primary-light: #FF8A70;
      --color-recording: #EF4444;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-error: #EF4444;
      --color-merge: #8B5CF6;
      --color-bg: #F5F5F4;
      --color-bg-card: #FFFFFF;
      --color-bg-soft: #E7E5E4;
      --color-bg-btn: #E7E5E4;
      --color-text: #1C1917;
      --color-text-soft: #57534E;
      --color-text-muted: #78716C;
      --color-border: #D6D3D1;
      --color-active: #FF6B4A;
      --cat-tasks-bg: #FEF3C7; --cat-tasks-text: #92400E;
      --cat-ideas-bg: #E0E7FF; --cat-ideas-text: #3730A3;
      --cat-handmagic-bg: #FCE7F3; --cat-handmagic-text: #9D174D;
      --cat-design-bg: #D1FAE5; --cat-design-text: #065F46;
      --cat-bugs-bg: #FEE2E2; --cat-bugs-text: #991B1B;
      --cat-questions-bg: #E0F2FE; --cat-questions-text: #075985;
      --cat-sketch-bg: #FEE2E2; --cat-sketch-text: #DC2626;
      --cat-scan-bg: #DBEAFE; --cat-scan-text: #1D4ED8;
      --cat-photo-bg: #F3E8FF; --cat-photo-text: #7C3AED;
      --cat-inbox-bg: #F5F5F4; --cat-inbox-text: #57534E;
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      --shadow-card: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-fab: 0 4px 14px rgba(255,107,74,0.4);
      --shadow-scroll: 0 2px 10px rgba(0,0,0,0.1);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
    body { font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); -webkit-font-smoothing: antialiased; }
    
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; max-width: 480px; margin: 0 auto; background: var(--color-bg); position: relative; padding-top: var(--safe-top); }

    /* Header */
    .header { display: flex; align-items: center; padding: 8px 14px; background: var(--color-bg-card); border-bottom: 1px solid var(--color-border); gap: 10px; }
    .logo-btn { width: 36px; height: 36px; border: none; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(255,107,74,0.25); }
    .logo-btn:active { transform: scale(0.95); }
    .logo-btn svg { width: 18px; height: 18px; }
    .header-title { flex: 1; font-size: 0.9rem; font-weight: 700; color: var(--color-text); }
    .header-title span { color: var(--color-primary); }
    .btn-icon { width: 36px; height: 36px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-soft); flex-shrink: 0; }
    .btn-icon:active { background: var(--color-bg-soft); }

    .network-banner { display: none; padding: 6px; background: var(--color-error); color: white; font-size: 0.7rem; font-weight: 600; text-align: center; }
    .network-banner.show { display: block; }
    .warning { padding: 8px; background: #FEF3C7; color: #92400E; font-size: 0.75rem; text-align: center; font-weight: 600; display: none; }

    /* Filters */
    .filters { background: var(--color-bg-card); border-bottom: 1px solid var(--color-border); padding: 8px 10px; }
    .time-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 8px; }
    .time-btn { height: 34px; padding: 0 12px; border: 2px solid transparent; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .time-btn:active { transform: scale(0.97); }
    .time-btn[data-time="all"] { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .time-btn[data-time="all"] .cnt { background: rgba(255,255,255,0.25); color: white; }
    .time-btn:not([data-time="all"]).active { border-color: var(--color-active); background: var(--color-bg-btn); color: var(--color-text-soft); }
    .time-btn:not([data-time="all"]).active .cnt { background: var(--color-active); color: white; }
    .cnt { min-width: 20px; height: 20px; padding: 0 6px; background: rgba(0,0,0,0.08); border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; }
    .sort-btn { height: 34px; width: 40px; padding: 0; border: 2px solid transparent; background: var(--color-bg-btn); border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .sort-btn:active { transform: scale(0.97); }
    .sort-btn.desc { border-color: var(--color-active); }

    .cat-row { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; scroll-behavior: smooth; padding: 2px 4px; }
    .cat-row::-webkit-scrollbar { display: none; }
    .cat { flex-shrink: 0; height: 34px; padding: 0 12px; border: 2px solid transparent; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 700; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .cat:active { transform: scale(0.97); }
    .cat.active { border-color: var(--color-active); }
    .cat[data-category="tasks"] { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .cat[data-category="tasks"] .cnt { background: rgba(146,64,14,0.15); }
    .cat[data-category="ideas"] { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .cat[data-category="ideas"] .cnt { background: rgba(55,48,163,0.15); }
    .cat[data-category="handmagic"] { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .cat[data-category="handmagic"] .cnt { background: rgba(157,23,77,0.15); }
    .cat[data-category="design"] { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .cat[data-category="design"] .cnt { background: rgba(6,95,70,0.15); }
    .cat[data-category="bugs"] { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .cat[data-category="bugs"] .cnt { background: rgba(153,27,27,0.15); }
    .cat[data-category="questions"] { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .cat[data-category="questions"] .cnt { background: rgba(7,89,133,0.15); }
    .cat[data-category="inbox"] { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .cat[data-category="inbox"] .cnt { background: rgba(0,0,0,0.08); }
    .cat[data-category="photo"] { background: var(--cat-photo-bg); color: var(--cat-photo-text); }
    .cat[data-category="photo"] .cnt { background: rgba(124,58,237,0.15); }
    .cat[data-category="sketch"] { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    .cat[data-category="sketch"] .cnt { background: rgba(220,38,38,0.15); }
    .cat[data-category="scan"] { background: var(--cat-scan-bg); color: var(--cat-scan-text); }
    .cat[data-category="scan"] .cnt { background: rgba(29,78,216,0.15); }
    .cat-add { flex-shrink: 0; width: 34px; height: 34px; border: 2px dashed var(--color-border); border-radius: var(--radius-full); background: transparent; color: var(--color-text-muted); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .cat-add:active { border-color: var(--color-primary); color: var(--color-primary); }

    /* Ideas container */
    .ideas-wrap { flex: 1; overflow-y: auto; padding: 12px 14px 100px; -webkit-overflow-scrolling: touch; }
    .ideas { display: flex; flex-direction: column; gap: 2px; }
    .date-sep { display: flex; align-items: center; justify-content: center; padding: 16px 0 8px; font-size: 0.65rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.08em; }

    /* Card */
    .card { background: var(--color-bg-card); border-radius: var(--radius-md); padding: 12px 14px; box-shadow: var(--shadow-card); cursor: pointer; transition: all 0.15s; margin-bottom: 8px; position: relative; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
    .card:active { transform: scale(0.995); }
    .card.active { box-shadow: 0 0 0 2px var(--color-active), var(--shadow-card); }
    .card.editing { box-shadow: 0 0 0 2px var(--color-primary), var(--shadow-card); }
    .card.selected { box-shadow: 0 0 0 2px var(--color-merge), var(--shadow-card); background: #F5F3FF; }
    /* Checkbox removed in v0.8.2 */
    .card-checkbox { display: none !important; }
    .card-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .card-chars { font-size: 0.7rem; color: var(--color-text-muted); font-weight: 500; }
    .card-time { font-size: 0.7rem; color: var(--color-text-muted); font-weight: 500; margin-left: auto; }
    .card-cat { padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.6rem; font-weight: 700; text-transform: uppercase; cursor: pointer; letter-spacing: 0.02em; }
    .card-cat:active { opacity: 0.8; }
    .card-cat.tasks { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .card-cat.ideas { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .card-cat.handmagic { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .card-cat.design { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .card-cat.bugs { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .card-cat.questions { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .card-cat.inbox { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .card-cat.sketch { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    
    /* Card markers */
    .card-marker { font-size: 0.9rem; margin-left: 6px; opacity: 0.9; }
    .card-marker.pop { animation: markerPop 0.2s ease; }
    @keyframes markerPop { 0% { transform: scale(0); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    
    /* Markers panel (shown when card is active) - BELOW actions */
    .card-markers { display: none; flex-wrap: wrap; gap: 6px; padding: 10px 12px; margin-top: 12px; border-top: 1px solid var(--color-border); background: var(--color-bg-btn); border-radius: var(--radius-md); }
    .card.active .card-markers { display: flex; }
    .marker-btn { width: 36px; height: 36px; border: none; background: var(--color-bg-card); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; opacity: 0.4; }
    .marker-btn:hover { opacity: 0.7; transform: scale(1.1); }
    .marker-btn:active { transform: scale(0.95); }
    .marker-btn.active { opacity: 1; background: var(--color-bg); box-shadow: 0 0 0 2px var(--color-primary); }
    .card-cat.scan { background: var(--cat-scan-bg); color: var(--cat-scan-text); }
    .card-cat.photo { background: var(--cat-photo-bg); color: var(--cat-photo-text); }
    
    .card-text { font-size: 1.05rem; line-height: 1.5; color: var(--color-text); padding-right: 30px; }
    .card-text a { color: var(--color-primary); text-decoration: underline; word-break: break-all; }
    .card-text a:active { opacity: 0.7; }
    .card-text.truncated { max-height: 300px; overflow: hidden; position: relative; } /* ~12 lines for text drops */
    .card-text.truncated::after { content: ''; position: absolute; bottom: 0; left: 0; right: 30px; height: 40px; background: linear-gradient(transparent, var(--color-bg-card)); pointer-events: none; }
    .card-text.expanded { max-height: none !important; }
    .card-text.expanded::after { display: none; }
    .card-image { width: 100%; max-height: 200px; object-fit: cover; border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer; }
    .card-image:active { opacity: 0.9; }
    .card-media-meta { font-size: 0.7rem; color: var(--color-text-muted); display: flex; gap: 10px; margin-bottom: 4px; }
    .card-notes { font-size: 0.85rem; color: var(--color-text-soft); line-height: 1.4; max-height: 60px; overflow: hidden; position: relative; } /* ~2-3 lines for photo captions */
    .card-notes::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 25px; background: linear-gradient(transparent, var(--color-bg-card)); pointer-events: none; }
    .card-notes.expanded { max-height: none; }
    .card-notes.expanded::after { display: none; }
    .card-more { display: none; padding: 8px 0 4px; font-size: 0.8rem; color: var(--color-primary); font-weight: 600; cursor: pointer; }
    .card-more.show { display: block; }
    /* No extra padding - checkboxes removed */
    .card-edit { display: none; margin-top: 10px; }
    .card.editing .card-text { display: none; }
    .card.editing .card-edit { display: block; }
    .card-ta { width: 100%; min-height: 180px; padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-family: var(--font-main); font-size: 1.05rem; line-height: 1.5; color: var(--color-text); resize: vertical; background: var(--color-bg); }
    .card-ta:focus { outline: none; border-color: var(--color-primary); }
    
    .card-actions { display: none; gap: 6px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--color-border); overflow-x: auto; scrollbar-width: none; }
    .card-actions::-webkit-scrollbar { display: none; }
    .card.active .card-actions { display: flex; }
    .card.editing .card-actions { display: none; }
    .select-mode .card.active .card-actions { display: none; }
    .card-edit-actions { display: none; gap: 6px; margin-top: 10px; }
    .card.editing .card-edit-actions { display: flex; }
    .act { flex-shrink: 0; height: 32px; padding: 0 12px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .act:active { background: var(--color-bg-soft); }
    .act.primary { background: var(--color-primary); color: white; }
    .act.ai { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; }
    .act.merge { background: var(--color-merge); color: white; }
    .act.secondary { background: var(--color-bg-btn); color: var(--color-text-soft); }

    /* Empty state */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 30px; }
    .empty-icon { width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; opacity: 0.12; }
    .empty-icon svg { width: 100px; height: 100px; fill: #3B82F6; }
    .empty-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; color: var(--color-text-muted); }
    .empty-text { font-size: 0.85rem; color: var(--color-text-muted); }

    /* FAB - Record button */
    .fab-record { position: fixed; bottom: calc(24px + var(--safe-bottom)); right: 20px; width: 68px; height: 68px; border: none; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-fab); z-index: 50; transition: all 0.2s; }
    .fab-record:active { transform: scale(0.95); }
    .fab-record.recording { background: var(--color-recording); animation: pulse 1.5s ease infinite; box-shadow: 0 4px 14px rgba(239,68,68,0.4); }
    .fab-record svg { width: 30px; height: 30px; color: white; }
    .select-mode .fab-record, .editing-mode .fab-record { display: none; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 12px rgba(239,68,68,0)} }

    /* FAB - Camera button */
    .fab-camera { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 20px; width: 68px; height: 68px; border: none; background: linear-gradient(135deg, #6366F1, #8B5CF6); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(99,102,241,0.4); z-index: 50; transition: all 0.2s; }
    .fab-camera:active { transform: scale(0.95); }
    .fab-camera svg { width: 28px; height: 28px; color: white; }
    .select-mode .fab-camera, .editing-mode .fab-camera { display: none !important; }
    .camera-input { display: none; }

    /* FAB - Plus button (center) */
    .fab-plus { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); width: 68px; height: 68px; border: none; background: linear-gradient(135deg, #10B981, #059669); border-radius: var(--radius-full); cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 14px rgba(16,185,129,0.4); z-index: 50; transition: all 0.2s; }
    .fab-plus:active { transform: translateX(-50%) scale(0.95); }
    .fab-plus.open { transform: translateX(-50%) rotate(45deg); }
    .fab-plus svg { width: 28px; height: 28px; color: white; transition: transform 0.2s; }
    .select-mode .fab-plus, .editing-mode .fab-plus { display: none !important; }

    /* Plus menu */
    .plus-menu { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--color-bg-card); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); z-index: 49; opacity: 0; visibility: hidden; transition: all 0.2s ease; min-width: 220px; overflow: hidden; }
    .plus-menu.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .plus-menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; cursor: pointer; transition: background 0.15s; border: none; background: none; width: 100%; text-align: left; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text); }
    .plus-menu-item:hover { background: var(--color-bg-btn); }
    .plus-menu-item:active { background: var(--color-border); }
    .plus-menu-item span.icon { font-size: 1.3rem; width: 28px; text-align: center; }
    .plus-menu-divider { height: 1px; background: var(--color-border); margin: 4px 0; }
    .plus-menu-label { padding: 8px 20px 4px; font-size: 0.7rem; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .plus-menu-item.magic { background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(236,72,153,0.08)); }
    .plus-menu-item.magic:hover { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(236,72,153,0.15)); }
    .plus-menu-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 48; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
    .plus-menu-backdrop.show { opacity: 1; visibility: visible; }
    
    /* AI Magic Modal */
    .magic-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .magic-modal.show { opacity: 1; visibility: visible; }
    .magic-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.2s; }
    .magic-modal.show .magic-content { transform: translateY(0); }
    .magic-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .magic-header h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .magic-header p { font-size: 0.85rem; opacity: 0.9; }
    .magic-body { padding: 20px; }
    .magic-photo-section { margin-bottom: 16px; }
    .magic-photo-btn { width: 100%; padding: 14px; border: 2px dashed var(--color-border); border-radius: 12px; background: var(--color-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); transition: all 0.2s; }
    .magic-photo-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .magic-photo-btn.has-photo { border-style: solid; border-color: #10B981; background: rgba(16,185,129,0.05); color: #059669; }
    .magic-photo-preview { position: relative; margin-top: 12px; border-radius: 12px; overflow: hidden; }
    .magic-photo-preview img { width: 100%; max-height: 150px; object-fit: cover; display: block; }
    .magic-photo-remove { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border: none; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .magic-photo-menu { position: absolute; bottom: 100%; left: 0; right: 0; background: var(--color-bg-card); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); margin-bottom: 8px; overflow: hidden; display: none; }
    .magic-photo-menu.show { display: block; }
    .magic-photo-menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text); }
    .magic-photo-menu-item:hover { background: var(--color-bg-btn); }
    .magic-photo-menu-item:active { background: var(--color-border); }
    .magic-input-area { width: 100%; min-height: 80px; padding: 14px; border: 2px solid var(--color-border); border-radius: 12px; font-family: var(--font-main); font-size: 1rem; resize: none; margin-bottom: 16px; }
    .magic-input-area:focus { outline: none; border-color: #8B5CF6; }
    .magic-input-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 6px; display: block; }
    .magic-voice-btn { width: 100%; padding: 14px; border: 2px dashed var(--color-border); border-radius: 12px; background: var(--color-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); margin-bottom: 16px; transition: all 0.2s; }
    .magic-voice-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .magic-voice-btn.recording { border-color: var(--color-recording); background: rgba(239,68,68,0.1); color: var(--color-recording); animation: pulse 1s infinite; }
    .magic-styles { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .magic-style { padding: 8px 16px; border: 2px solid var(--color-border); border-radius: 20px; background: none; font-family: var(--font-main); font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
    .magic-style:hover { border-color: #8B5CF6; }
    .magic-style.active { border-color: #8B5CF6; background: rgba(139,92,246,0.1); color: #8B5CF6; }
    .magic-generate { width: 100%; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; font-family: var(--font-main); font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
    .magic-generate:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139,92,246,0.4); }
    .magic-generate:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .magic-footer { padding: 12px 20px; border-top: 1px solid var(--color-border); display: flex; justify-content: center; }
    .magic-cancel { padding: 10px 24px; border: none; background: none; font-family: var(--font-main); font-size: 0.95rem; color: var(--color-text-soft); cursor: pointer; }
    
    /* Drops picker modal */
    .drops-picker { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 250; display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .drops-picker.show { opacity: 1; visibility: visible; }
    .drops-picker-content { background: var(--color-bg-card); border-radius: 20px 20px 0 0; width: 100%; max-width: 480px; max-height: 70vh; overflow: hidden; transform: translateY(100%); transition: transform 0.3s; }
    .drops-picker.show .drops-picker-content { transform: translateY(0); }
    .drops-picker-header { padding: 16px 20px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .drops-picker-header h3 { font-size: 1.1rem; }
    .drops-picker-close { width: 32px; height: 32px; border: none; background: var(--color-bg-btn); border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    .drops-picker-grid { padding: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; overflow-y: auto; max-height: calc(70vh - 70px); }
    .drops-picker-item { aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: all 0.15s; }
    .drops-picker-item:hover { border-color: #8B5CF6; }
    .drops-picker-item img { width: 100%; height: 100%; object-fit: cover; }
    .drops-picker-empty { grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--color-text-muted); }
    
    /* AI Tools Modal (for text drops) */
    .ai-tools-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .ai-tools-modal.show { opacity: 1; visibility: visible; }
    .ai-tools-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; transform: translateY(20px); transition: transform 0.2s; }
    .ai-tools-modal.show .ai-tools-content { transform: translateY(0); }
    .ai-tools-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; }
    .ai-tools-header h2 { font-size: 1.3rem; margin-bottom: 4px; }
    .ai-tools-header p { font-size: 0.85rem; opacity: 0.9; }
    .ai-tools-preview { padding: 16px 20px; background: var(--color-bg); border-bottom: 1px solid var(--color-border); }
    .ai-tools-preview-text { font-size: 0.9rem; color: var(--color-text-soft); line-height: 1.5; max-height: 80px; overflow: hidden; position: relative; }
    .ai-tools-preview-text::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, var(--color-bg)); }
    .ai-tools-preview-label { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .ai-tools-body { padding: 20px; }
    .ai-tools-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .ai-tool-btn { display: flex; align-items: center; gap: 14px; padding: 16px; border: 2px solid var(--color-border); border-radius: 14px; background: var(--color-bg-card); cursor: pointer; transition: all 0.15s; text-align: left; font-family: var(--font-main); }
    .ai-tool-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .ai-tool-btn:active { transform: scale(0.98); }
    .ai-tool-btn .icon { font-size: 1.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); border-radius: 10px; }
    .ai-tool-btn .info { flex: 1; }
    .ai-tool-btn .title { font-size: 1rem; font-weight: 600; color: var(--color-text); margin-bottom: 2px; }
    .ai-tool-btn .desc { font-size: 0.8rem; color: var(--color-text-muted); }
    .ai-tools-option { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--color-bg); border-radius: 12px; margin-bottom: 16px; }
    .ai-tools-option input[type="checkbox"] { width: 20px; height: 20px; accent-color: #8B5CF6; }
    .ai-tools-option-label { flex: 1; }
    .ai-tools-option-label .title { font-size: 0.9rem; font-weight: 500; color: var(--color-text); }
    .ai-tools-option-label .current { font-size: 0.8rem; color: var(--color-text-muted); }
    .ai-tools-footer { padding: 16px 20px; border-top: 1px solid var(--color-border); text-align: center; }
    
    /* AI Result Modal (large) */
    .ai-result-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 210; display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .ai-result-modal.show { opacity: 1; visibility: visible; }
    .ai-result-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 420px; max-height: 90vh; overflow: hidden; transform: translateY(20px); transition: transform 0.2s; display: flex; flex-direction: column; }
    .ai-result-modal.show .ai-result-content { transform: translateY(0); }
    .ai-result-header { padding: 20px; text-align: center; background: linear-gradient(135deg, #10B981, #3B82F6); color: white; flex-shrink: 0; }
    .ai-result-header h2 { font-size: 1.2rem; }
    .ai-result-body { padding: 20px; flex: 1; overflow-y: auto; }
    .ai-result-text { font-size: max(1rem, 16px); line-height: 1.6; color: var(--color-text); white-space: pre-wrap; }
    .ai-result-category { margin-top: 20px; padding: 16px; background: var(--color-bg); border-radius: 12px; }
    .ai-result-category-title { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .ai-result-category-row { display: flex; align-items: center; gap: 10px; }
    .ai-result-category-current { font-size: 0.9rem; color: var(--color-text-soft); }
    .ai-result-category-arrow { color: var(--color-text-muted); }
    .ai-result-category-suggested { font-size: 0.9rem; font-weight: 600; color: #8B5CF6; }
    .ai-result-category-actions { display: flex; gap: 8px; margin-top: 12px; }
    .ai-result-category-btn { flex: 1; padding: 10px; border: 2px solid var(--color-border); border-radius: 8px; background: none; font-family: var(--font-main); font-size: 0.85rem; cursor: pointer; transition: all 0.15s; }
    .ai-result-category-btn:hover { border-color: #8B5CF6; }
    .ai-result-category-btn.accept { border-color: #10B981; background: rgba(16,185,129,0.1); color: #059669; }
    .ai-result-actions { padding: 20px; border-top: 1px solid var(--color-border); display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
    .ai-result-action-btn { padding: 14px; border: none; border-radius: 12px; font-family: var(--font-main); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .ai-result-action-btn.primary { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .ai-result-action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139,92,246,0.3); }
    .ai-result-action-btn.secondary { background: var(--color-bg-btn); color: var(--color-text); }
    .ai-result-action-btn.secondary:hover { background: var(--color-border); }
    .ai-result-action-row { display: flex; gap: 10px; }
    .ai-result-action-row .ai-result-action-btn { flex: 1; }
    .ai-result-cancel { width: 100%; padding: 14px; margin-top: 8px; border: 2px solid var(--color-border); border-radius: 12px; background: var(--color-bg); font-family: var(--font-main); font-size: 1rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; transition: all 0.15s; }
    .ai-result-cancel:hover { border-color: var(--color-text-muted); background: var(--color-bg-soft); }
    
    /* B2 FIX: Tasks Preview List */
    .tasks-preview-list { display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; }
    .tasks-preview-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px; background: var(--color-bg); border-radius: 10px; font-size: 0.9rem; line-height: 1.4; }
    .tasks-preview-num { flex-shrink: 0; width: 24px; height: 24px; background: var(--cat-tasks-bg); color: var(--cat-tasks-text); border-radius: 50%; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
    .tasks-preview-text { flex: 1; color: var(--color-text); }
    
    /* I1 FIX: Translate Language Buttons */
    .translate-langs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .translate-lang-btn { padding: 14px 16px; border: 2px solid var(--color-border); border-radius: 12px; background: var(--color-bg); font-family: var(--font-main); font-size: 0.95rem; font-weight: 500; color: var(--color-text); cursor: pointer; transition: all 0.15s; text-align: left; }
    .translate-lang-btn:hover { border-color: #3B82F6; background: rgba(59, 130, 246, 0.05); }
    .translate-lang-btn:active { transform: scale(0.98); }
    
    /* AI Loading Indicator (compact, inside modal) */
    .ai-loading-inline { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; }
    .ai-loading-dots { display: flex; gap: 6px; margin-bottom: 16px; }
    .ai-loading-dots span { width: 10px; height: 10px; background: #8B5CF6; border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
    .ai-loading-dots span:nth-child(1) { animation-delay: 0s; }
    .ai-loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .ai-loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    .ai-loading-dots span:nth-child(4) { animation-delay: 0.6s; }
    .ai-loading-dots span:nth-child(5) { animation-delay: 0.8s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .ai-loading-label { font-size: 0.9rem; color: var(--color-text-soft); }
    
    /* Main Menu Modal */
    .main-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: flex-start; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; overflow-y: auto; }
    .main-menu.show { opacity: 1; visibility: visible; }
    .main-menu-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 420px; margin: auto; transform: translateY(-20px); transition: transform 0.25s; }
    .main-menu.show .main-menu-content { transform: translateY(0); }
    .main-menu-header { padding: 20px; background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .main-menu-header h2 { font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
    .main-menu-close { padding: 8px 16px; border: none; background: rgba(255,255,255,0.1); border-radius: 20px; color: white; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: background 0.15s; }
    .main-menu-close:hover { background: rgba(255,255,255,0.2); }
    .main-menu-footer { padding: 16px 20px 24px; }
    .main-menu-footer-btn { width: 100%; padding: 14px; border: 2px solid var(--color-border); background: var(--color-bg); border-radius: 12px; font-family: var(--font-main); font-size: 1rem; font-weight: 600; color: var(--color-text); cursor: pointer; transition: all 0.15s; }
    .main-menu-footer-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    
    /* Balance Card */
    .balance-card { margin: 16px; padding: 16px; background: linear-gradient(135deg, #8B5CF6, #EC4899); border-radius: 16px; color: white; }
    .balance-label { font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; }
    .balance-value { font-size: 1.8rem; font-weight: 700; }
    .balance-hint { font-size: 0.75rem; opacity: 0.8; margin-top: 6px; }
    
    /* Menu Sections */
    .menu-section { padding: 16px 20px; border-bottom: 1px solid var(--color-border); }
    .menu-section:last-child { border-bottom: none; }
    .menu-section-title { font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    
    /* Search Box */
    .menu-search { display: flex; gap: 10px; }
    .menu-search-input { flex: 1; padding: 14px 16px; border: 2px solid var(--color-border); border-radius: 12px; font-size: 1rem; font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); min-width: 0; }
    .menu-search-input:focus { border-color: #8B5CF6; outline: none; }
    .menu-search-btn { width: 52px; height: 52px; flex-shrink: 0; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: 12px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
    .menu-search-btn:hover { transform: scale(1.05); }
    .menu-search-btn:active { transform: scale(0.95); }
    .menu-search-btn svg { width: 22px; height: 22px; }
    
    /* Undo List */
    .undo-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .undo-header-left { display: flex; align-items: center; gap: 8px; }
    .undo-toggle-btn { padding: 6px 12px; border: 1px solid var(--color-border); background: var(--color-bg); border-radius: 8px; font-size: 0.8rem; color: var(--color-text-muted); cursor: pointer; }
    .undo-toggle-btn:hover { border-color: #8B5CF6; }
    .undo-main-btn { flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.15s; }
    .undo-main-btn:hover { transform: scale(1.02); }
    .undo-main-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .undo-list { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border); }
    .undo-list.show { display: flex; }
    .undo-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--color-bg); border-radius: 12px; }
    .undo-item-icon { width: 36px; height: 36px; background: rgba(139,92,246,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .undo-item-info { flex: 1; }
    .undo-item-title { font-size: 0.9rem; font-weight: 500; color: var(--color-text); }
    .undo-item-time { font-size: 0.75rem; color: var(--color-text-muted); }
    .undo-item-btn { padding: 8px 16px; border: none; background: #8B5CF6; color: white; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .undo-item-btn:hover { background: #7C3AED; }
    .undo-empty { text-align: center; padding: 20px; color: var(--color-text-muted); font-size: 0.9rem; }
    
    /* Settings Items */
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--color-border); }
    .settings-item:last-child { border-bottom: none; }
    .settings-item-left { display: flex; align-items: center; gap: 12px; }
    .settings-item-icon { font-size: 1.2rem; }
    .settings-item-label { font-size: 0.95rem; color: var(--color-text); }
    .settings-toggle { width: 50px; height: 28px; background: var(--color-border); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.2s; }
    .settings-toggle.active { background: #8B5CF6; }
    .settings-toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .settings-toggle.active::after { transform: translateX(22px); }
    .settings-btn { padding: 10px 20px; border: 2px solid var(--color-border); background: none; border-radius: 10px; font-size: 0.9rem; font-family: var(--font-main); color: var(--color-text); cursor: pointer; transition: all 0.15s; }
    .settings-btn:hover { border-color: #8B5CF6; background: rgba(139,92,246,0.05); }
    .settings-btn.danger { border-color: #EF4444; color: #EF4444; }
    .settings-btn.danger:hover { background: rgba(239,68,68,0.1); }
    
    /* About Section */
    .menu-about { text-align: center; padding: 20px; }
    .menu-about-logo { width: 50px; height: 50px; background: linear-gradient(135deg, #3B82F6, #8B5CF6); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; }
    .menu-about-logo svg { width: 28px; height: 28px; fill: white; }
    .menu-about-name { font-size: 1.1rem; font-weight: 700; color: var(--color-text); }
    .menu-about-ver { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; }
    
    /* Search indicator */
    .search-indicator { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border-bottom: 1px solid var(--color-border); }
    .search-indicator-text { font-size: 0.9rem; color: var(--color-text); }
    .search-indicator-text span { font-weight: 600; color: #8B5CF6; }
    .search-indicator-clear { padding: 6px 12px; border: none; background: rgba(239,68,68,0.1); color: #EF4444; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
    
    /* Font size variants */
    body.font-small { font-size: 14px; }
    body.font-normal { font-size: 16px; }
    body.font-large { font-size: 18px; }
    
    /* Card text */
    body.font-small .card-text { font-size: 0.95rem; }
    body.font-normal .card-text { font-size: 1.05rem; }
    body.font-large .card-text { font-size: 1.2rem; }
    
    /* Card notes/caption */
    body.font-small .card-notes { font-size: 0.8rem; }
    body.font-normal .card-notes { font-size: 0.85rem; }
    body.font-large .card-notes { font-size: 1rem; }
    
    /* Card meta (time, chars) */
    body.font-small .card-time, body.font-small .card-chars { font-size: 0.7rem; }
    body.font-normal .card-time, body.font-normal .card-chars { font-size: 0.75rem; }
    body.font-large .card-time, body.font-large .card-chars { font-size: 0.85rem; }
    
    /* Card header */
    body.font-small .card-head { font-size: 0.75rem; }
    body.font-normal .card-head { font-size: 0.8rem; }
    body.font-large .card-head { font-size: 0.9rem; }
    
    /* Category badges */
    body.font-small .card-cat { font-size: 0.65rem; padding: 3px 8px; }
    body.font-normal .card-cat { font-size: 0.7rem; padding: 4px 10px; }
    body.font-large .card-cat { font-size: 0.8rem; padding: 5px 12px; }
    
    /* Filter buttons */
    body.font-small .cat, body.font-small .time-btn { font-size: 0.75rem; padding: 6px 10px; }
    body.font-normal .cat, body.font-normal .time-btn { font-size: 0.8rem; padding: 7px 12px; }
    body.font-large .cat, body.font-large .time-btn { font-size: 0.9rem; padding: 8px 14px; }
    
    /* Textarea (edit mode) */
    body.font-small .card-ta { font-size: 0.95rem; }
    body.font-normal .card-ta { font-size: 1.05rem; }
    body.font-large .card-ta { font-size: 1.2rem; min-height: 200px; }
    
    /* Media meta */
    body.font-small .card-media-meta { font-size: 0.7rem; }
    body.font-normal .card-media-meta { font-size: 0.75rem; }
    body.font-large .card-media-meta { font-size: 0.85rem; }
    
    /* Date separator */
    body.font-small .date-sep { font-size: 0.75rem; }
    body.font-normal .date-sep { font-size: 0.8rem; }
    body.font-large .date-sep { font-size: 0.9rem; }
    
    /* Modal titles */
    body.font-small .modal-title { font-size: 1rem; }
    body.font-normal .modal-title { font-size: 1.1rem; }
    body.font-large .modal-title { font-size: 1.3rem; }
    
    /* Menu */
    body.font-large .menu-section-title { font-size: 0.85rem; }
    body.font-large .settings-item-label { font-size: 1.05rem; }
    body.font-large .undo-item-title { font-size: 1rem; }
    body.font-large .balance-value { font-size: 2rem; }
    
    /* Font size selector */
    .font-size-selector { display: flex; gap: 8px; }
    .font-size-btn { flex: 1; padding: 12px 8px; border: 2px solid var(--color-border); background: var(--color-bg); border-radius: 10px; font-family: var(--font-main); cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .font-size-btn:hover { border-color: #8B5CF6; }
    .font-size-btn.active { border-color: #8B5CF6; background: rgba(139,92,246,0.1); }
    .font-size-btn .size-label { font-weight: 600; color: var(--color-text); }
    .font-size-btn .size-preview { color: var(--color-text-muted); }
    .font-size-btn[data-size="small"] .size-preview { font-size: 12px; }
    .font-size-btn[data-size="normal"] .size-preview { font-size: 14px; }
    .font-size-btn[data-size="large"] .size-preview { font-size: 16px; }
    
    /* AI Result with Actions */
    .ai-result-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
    .ai-result-btn { flex: 1; min-width: 100px; padding: 12px 16px; border: none; border-radius: 10px; font-family: var(--font-main); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .ai-result-btn.primary { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; }
    .ai-result-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(139,92,246,0.3); }
    .ai-result-btn.secondary { background: var(--color-bg-btn); color: var(--color-text); }
    .ai-result-btn.secondary:hover { background: var(--color-border); }

    /* Text input modal */
    .text-input-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
    .text-input-modal.show { display: flex; }
    .text-input-content { background: var(--color-bg-card); width: 100%; max-height: 70vh; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); animation: slideUp 0.25s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .text-input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .text-input-title { font-size: 1.1rem; font-weight: 600; color: var(--color-text); }
    .text-input-close { width: 32px; height: 32px; border: none; background: var(--color-bg-btn); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-soft); font-size: 1.2rem; }
    .text-input-area { width: 100%; min-height: 120px; padding: 14px; border: 1px solid var(--color-border); border-radius: 12px; font-family: var(--font-main); font-size: 1rem; resize: none; background: var(--color-bg); color: var(--color-text); }
    .text-input-area:focus { outline: none; border-color: var(--color-primary); }
    .text-input-actions { display: flex; gap: 12px; margin-top: 16px; }
    .text-input-btn { flex: 1; height: 48px; border: none; border-radius: 12px; font-family: var(--font-main); font-size: 0.95rem; font-weight: 600; cursor: pointer; }
    .text-input-btn.cancel { background: var(--color-bg-btn); color: var(--color-text-soft); }
    .text-input-btn.save { background: var(--color-primary); color: white; }

    /* Recording status */
    .rec-status { position: fixed; bottom: calc(96px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 8px; padding: 10px 20px; background: var(--color-bg-card); border-radius: var(--radius-full); box-shadow: var(--shadow-scroll); z-index: 50; }
    .rec-status.show { display: flex; }
    .rec-dot { width: 8px; height: 8px; background: var(--color-recording); border-radius: 50%; animation: blink 1s ease infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .rec-text { font-size: 0.8rem; font-weight: 600; color: var(--color-text); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Scroll FAB */
    .scroll-fab { position: fixed; right: 20px; width: 44px; height: 44px; border: none; background: var(--color-bg-card); border-radius: var(--radius-full); box-shadow: var(--shadow-scroll); cursor: pointer; display: none; align-items: center; justify-content: center; color: var(--color-primary); font-size: 1.1rem; font-weight: 700; z-index: 40; transition: all 0.2s; }
    .scroll-fab.show { display: flex; }
    .scroll-fab:active { transform: scale(0.9); }
    .scroll-fab.top { bottom: calc(160px + var(--safe-bottom)); }
    .scroll-fab.bottom { bottom: calc(100px + var(--safe-bottom)); }
    .editing-mode .scroll-fab, .select-mode .scroll-fab { display: none !important; }

    /* Selection bar */
    .select-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-bg-card); border-top: 1px solid var(--color-border); padding: 12px 16px calc(12px + var(--safe-bottom)); display: none; align-items: center; justify-content: space-between; gap: 10px; z-index: 60; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
    .select-bar.show { display: flex; }
    .select-info { font-size: 0.85rem; font-weight: 600; color: var(--color-text); }
    .select-actions { display: flex; gap: 8px; }
    .select-btn { height: 40px; padding: 0 20px; border: none; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .select-btn:active { transform: scale(0.97); }
    .select-btn.cancel { background: var(--color-bg-btn); color: var(--color-text-soft); }
    .select-btn.merge { background: var(--color-merge); color: white; }
    .select-btn.delete { background: var(--color-error); color: white; }

    /* Modals */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; padding: 20px; z-index: 100; backdrop-filter: blur(4px); }
    .overlay.show { display: flex; }
    .modal { width: 100%; max-width: 320px; background: var(--color-bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: modalIn 0.25s ease; }
    @keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; text-align: center; }
    .modal-text { font-size: 0.85rem; color: var(--color-text-soft); margin-bottom: 20px; line-height: 1.6; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { padding: 12px 24px; border: none; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.8rem; font-weight: 600; cursor: pointer; }
    .modal-btn:active { transform: scale(0.97); }
    .modal-btn.sec { background: var(--color-bg-btn); color: var(--color-text); }
    .modal-btn.pri { background: var(--color-primary); color: white; }
    .modal-btn.merge { background: var(--color-merge); color: white; }
    .modal-btn.danger { background: var(--color-error); color: white; }

    .cat-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
    .cat-opt { padding: 10px 16px; border: none; border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 700; cursor: pointer; text-transform: uppercase; }
    .cat-opt:active { transform: scale(1.05); }
    .cat-opt[data-cat="tasks"] { background: var(--cat-tasks-bg); color: var(--cat-tasks-text); }
    .cat-opt[data-cat="ideas"] { background: var(--cat-ideas-bg); color: var(--cat-ideas-text); }
    .cat-opt[data-cat="handmagic"] { background: var(--cat-handmagic-bg); color: var(--cat-handmagic-text); }
    .cat-opt[data-cat="design"] { background: var(--cat-design-bg); color: var(--cat-design-text); }
    .cat-opt[data-cat="bugs"] { background: var(--cat-bugs-bg); color: var(--cat-bugs-text); }
    .cat-opt[data-cat="questions"] { background: var(--cat-questions-bg); color: var(--cat-questions-text); }
    .cat-opt[data-cat="inbox"] { background: var(--color-bg-btn); color: var(--cat-inbox-text); }
    .cat-opt[data-cat="sketch"] { background: var(--cat-sketch-bg); color: var(--cat-sketch-text); }
    .cat-opt[data-cat="scan"] { background: var(--cat-scan-bg); color: var(--cat-scan-text); }

    .send-opts { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .send-opt { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--color-bg); border-radius: var(--radius-md); cursor: pointer; }
    .send-opt:active { background: var(--color-bg-soft); }
    .send-icon { width: 36px; height: 36px; background: var(--color-bg-card); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: var(--shadow-card); }
    .send-info { flex: 1; }
    .send-title { font-size: 0.85rem; font-weight: 600; }
    .send-desc { font-size: 0.7rem; color: var(--color-text-muted); }
    .send-badge { font-size: 0.55rem; font-weight: 700; padding: 3px 8px; background: linear-gradient(135deg,#8B5CF6,#6366F1); color: white; border-radius: var(--radius-full); text-transform: uppercase; }
    .send-div { display: flex; align-items: center; gap: 10px; margin: 6px 0; font-size: 0.6rem; color: var(--color-text-muted); text-transform: uppercase; font-weight: 600; }
    .send-div::before, .send-div::after { content: ''; flex: 1; height: 1px; background: var(--color-border); }

    .export-box { background: var(--color-bg); border-radius: var(--radius-sm); padding: 12px; font-family: monospace; font-size: 0.65rem; max-height: 180px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; margin-bottom: 16px; }

    .about-brand { text-align: center; padding: 20px 0; margin-bottom: 16px; border-bottom: 1px solid var(--color-border); }
    .about-logo { width: 72px; height: 72px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light)); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; box-shadow: var(--shadow-fab); }
    .about-logo svg { width: 36px; height: 36px; }
    .about-name { font-size: 1.4rem; font-weight: 800; }
    .about-ver { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }

    .toast-wrap { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; }
    .toast { padding: 12px 20px; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: auto; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--color-success); color: white; }
    .toast.warning { background: var(--color-warning); color: white; }
    .toast.error { background: var(--color-error); color: white; }
    .toast.info { background: var(--color-text); color: white; }

    /* Merge preview */
    .merge-preview { background: var(--color-bg); border-radius: var(--radius-sm); padding: 12px; font-size: 0.9rem; max-height: 200px; overflow-y: auto; margin-bottom: 16px; line-height: 1.6; white-space: pre-wrap; }
    .merge-options { margin-bottom: 12px; }
    .merge-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--color-text-soft); cursor: pointer; }
    .merge-toggle input { width: 18px; height: 18px; accent-color: var(--color-primary); }

    /* Image viewer */
    .image-viewer { background: rgba(0,0,0,0.95); padding: 0; overflow: hidden; }
    .image-viewer.show { display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; }
    .image-viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 50px 0 0; touch-action: none; min-height: 0; position: relative; }
    .image-viewer img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; border-radius: 0; transform-origin: center center; user-select: none; -webkit-user-drag: none; will-change: transform; transition: transform 0.2s ease; }
    .image-viewer img.portrait { width: 100%; max-width: 100%; height: auto; max-height: none; }
    .image-viewer img.landscape { width: auto; max-width: 100%; height: auto; max-height: 100%; }
    .image-viewer img.zoomed { max-width: none; max-height: none; }
    .image-viewer-close { position: absolute; top: 16px; right: 16px; width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; z-index: 10; }
    .image-viewer-close:active { background: rgba(255,255,255,0.3); }
    
    /* AI button on photo */
    .image-viewer-ai { position: absolute; top: 72px; right: 16px; width: 52px; height: 52px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(139,92,246,0.4); transition: transform 0.15s; }
    .image-viewer-ai:active { transform: scale(0.9); }
    
    /* Markers button on photo */
    .image-viewer-markers { position: absolute; top: 16px; left: 16px; min-width: 44px; height: 44px; padding: 0 12px; background: rgba(255,255,255,0.15); border-radius: 22px; display: flex; align-items: center; justify-content: center; gap: 4px; color: white; font-size: 1.1rem; cursor: pointer; z-index: 10; }
    .image-viewer-markers:active { background: rgba(255,255,255,0.3); }
    .image-viewer-markers.has-markers { background: rgba(139,92,246,0.6); }
    
    /* Photo AI Tools Modal */
    .photo-ai-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 250; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-ai-modal.show { opacity: 1; visibility: visible; }
    .photo-ai-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 360px; overflow: hidden; transform: scale(0.9); transition: transform 0.2s; }
    .photo-ai-modal.show .photo-ai-content { transform: scale(1); }
    .photo-ai-header { padding: 20px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; text-align: center; }
    .photo-ai-header h3 { font-size: 1.2rem; margin: 0; }
    .photo-ai-header p { font-size: 0.85rem; opacity: 0.9; margin: 4px 0 0; }
    .photo-ai-tools { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .photo-ai-btn { display: flex; align-items: center; gap: 14px; padding: 16px; border: none; background: var(--color-bg); border-radius: 14px; cursor: pointer; transition: all 0.15s; text-align: left; }
    .photo-ai-btn:hover { background: rgba(139,92,246,0.1); }
    .photo-ai-btn:active { transform: scale(0.98); }
    .photo-ai-btn .icon { width: 44px; height: 44px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
    .photo-ai-btn .info { flex: 1; }
    .photo-ai-btn .title { font-size: 1rem; font-weight: 600; color: var(--color-text); }
    .photo-ai-btn .desc { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; }
    .photo-ai-cancel { padding: 14px; border: none; background: none; width: 100%; font-size: 0.95rem; color: var(--color-text-muted); cursor: pointer; border-top: 1px solid var(--color-border); }
    
    /* Photo AI Result Modal */
    .photo-ai-result { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 260; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-ai-result.show { opacity: 1; visibility: visible; }
    .photo-ai-result-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    .photo-ai-result-header { padding: 16px 20px; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; }
    .photo-ai-result-header h3 { font-size: 1.1rem; margin: 0; }
    .photo-ai-result-text { flex: 1; padding: 16px 20px; overflow-y: auto; font-size: 0.95rem; line-height: 1.5; color: var(--color-text); }
    .photo-ai-result-actions { padding: 12px 16px 16px; display: flex; flex-direction: column; gap: 8px; border-top: 1px solid var(--color-border); }
    .photo-ai-result-btn { padding: 14px; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .photo-ai-result-btn.primary { background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; }
    .photo-ai-result-btn.secondary { background: var(--color-bg); color: var(--color-text); }
    .photo-ai-result-btn:active { transform: scale(0.98); }
    
    /* Photo Markers Modal */
    .photo-markers-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 250; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .photo-markers-modal.show { opacity: 1; visibility: visible; }
    .photo-markers-content { background: var(--color-bg-card); border-radius: 20px; width: 100%; max-width: 320px; padding: 20px; text-align: center; }
    .photo-markers-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }
    .photo-markers-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 16px; }
    .photo-marker-btn { width: 56px; height: 56px; border: 2px solid var(--color-border); background: var(--color-bg); border-radius: 14px; font-size: 1.6rem; cursor: pointer; transition: all 0.15s; }
    .photo-marker-btn:active { transform: scale(0.9); }
    .photo-marker-btn.active { border-color: #8B5CF6; background: rgba(139,92,246,0.15); }
    .photo-markers-done { width: 100%; padding: 14px; border: none; background: linear-gradient(135deg, #8B5CF6, #3B82F6); color: white; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .image-viewer-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: var(--radius-full); display: none; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; z-index: 10; }
    .image-viewer-nav:active { background: rgba(255,255,255,0.3); }
    .image-viewer-nav.prev { left: 10px; }
    .image-viewer-nav.next { right: 10px; }
    .image-viewer-nav.show { display: flex; }
    .image-viewer-panel { flex-shrink: 0; background: var(--color-bg-card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; padding: 12px 16px calc(12px + env(safe-area-inset-bottom, 0px)) 16px; width: 100%; box-sizing: border-box; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
    .image-meta { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 8px; display: flex; gap: 12px; flex-wrap: wrap; }
    .image-meta span { display: flex; align-items: center; gap: 4px; }
    .image-caption-display { font-size: 0.9rem; color: var(--color-text); line-height: 1.4; flex: 1; }
    .image-caption-display.empty { color: var(--color-text-muted); font-style: italic; }
    .image-caption-display.hidden { display: none; }
    .image-caption-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .caption-edit-btn { height: 28px; padding: 0 10px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.65rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; flex-shrink: 0; text-transform: uppercase; }
    .caption-edit-btn:active { background: var(--color-bg-soft); }
    .image-notes-wrap { display: none; }
    .image-notes-wrap.editing { display: block; }
    .image-notes { width: 100%; padding: 10px; border: 2px solid var(--color-primary); border-radius: var(--radius-sm); font-family: var(--font-main); font-size: 0.9rem; resize: none; background: var(--color-bg); }
    .image-notes:focus { outline: none; }
    .image-actions { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; margin-top: 12px; }
    .image-actions::-webkit-scrollbar { display: none; }
    .image-actions.hidden { display: none; }
    .image-edit-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
    .img-act { flex-shrink: 0; height: 36px; padding: 0 14px; border: none; background: var(--color-bg-btn); border-radius: var(--radius-full); font-family: var(--font-main); font-size: 0.7rem; font-weight: 600; color: var(--color-text-soft); cursor: pointer; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
    .img-act.delete { background: rgba(239,68,68,0.15); color: #EF4444; }
    .img-act:active { background: var(--color-bg-soft); }
    .img-act.primary { background: var(--color-primary); color: white; }
    .image-counter { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); color: white; padding: 4px 12px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; z-index: 10; }

    @media print {
      body * { visibility: hidden; }
      .image-viewer, .image-viewer img { visibility: visible; }
      .image-viewer { position: absolute; left: 0; top: 0; background: white; }
      .image-viewer img { max-width: 100%; max-height: 100%; }
      .image-viewer-close, .image-viewer-panel { display: none !important; }
    }

    @media (min-width:481px) { 
      .app { margin: 20px auto; height: calc(100vh - 40px); border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
      .fab-record { right: calc(50% - 220px); }
      .fab-camera { left: calc(50% - 220px); }
      .scroll-fab { right: calc(50% - 220px); }
      .select-bar { left: 50%; right: auto; transform: translateX(-50%); max-width: 480px; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="header">
      <button class="logo-btn" onclick="openAbout()">
        <svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
      </button>
      <div class="header-title"><span>Drop</span>Lit</div>
      <button class="btn-icon" onclick="openMainMenu()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
    </header>
    <div class="network-banner" id="netBanner">No internet</div>
    <div class="warning" id="warning">Speech recognition not supported. Use Chrome.</div>
    <div class="search-indicator" id="searchIndicator" style="display:none">
      <span class="search-indicator-text"> Searching: <span id="searchQueryDisplay"></span></span>
      <button class="search-indicator-clear" onclick="clearSearch()"> Clear</button>
    </div>
    <div class="filters">
      <div class="time-row" id="timeRow">
        <button class="time-btn" data-time="all">All <span class="cnt" id="cntAll">0</span></button>
        <button class="time-btn" data-time="today">Today <span class="cnt" id="cntToday">0</span></button>
        <button class="time-btn" data-time="7days">7d <span class="cnt" id="cnt7d">0</span></button>
        <button class="sort-btn" id="sortBtn" onclick="toggleSort()" title="Sort order"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg></button>
      </div>
      <div class="cat-row" id="cats">
        <button class="cat" data-category="tasks">Tasks <span class="cnt" id="cntTasks">0</span></button>
        <button class="cat" data-category="ideas">Ideas <span class="cnt" id="cntIdeas">0</span></button>
        <button class="cat" data-category="handmagic">Handmagic <span class="cnt" id="cntHandmagic">0</span></button>
        <button class="cat" data-category="design">Design <span class="cnt" id="cntDesign">0</span></button>
        <button class="cat" data-category="bugs">Bugs <span class="cnt" id="cntBugs">0</span></button>
        <button class="cat" data-category="questions">Questions <span class="cnt" id="cntQuestions">0</span></button>
        <button class="cat" data-category="inbox">Inbox <span class="cnt" id="cntInbox">0</span></button>
        <button class="cat" data-category="photo">Photo <span class="cnt" id="cntPhoto">0</span></button>
        <button class="cat" data-category="sketch">Sketch <span class="cnt" id="cntSketch">0</span></button>
        <button class="cat" data-category="scan">Scan <span class="cnt" id="cntScan">0</span></button>
        <button class="cat-add" onclick="addCatPrompt()">+</button>
      </div>
    </div>
    <div class="ideas-wrap" id="ideasWrap">
      <div class="ideas" id="ideasList"></div>
      <div class="empty" id="emptyState">
        <div class="empty-icon"><svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div>
        <div class="empty-title">Your ideas start here</div>
        <div class="empty-text"> Photo   Type   Speak</div>
      </div>
    </div>
  </div>

  <button class="fab-camera" id="fabCamera" onclick="document.getElementById('cameraInput').click()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
  </button>
  <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
  <input type="file" id="imageUpload" class="camera-input" accept="image/*" onchange="handleUploadedImage(event)">
  <input type="file" id="fileUpload" style="display:none" accept=".txt,.md,.csv,.json" onchange="handleUploadedFile(event)">

  <!-- FAB Plus button -->
  <button class="fab-plus" id="fabPlus" onclick="togglePlusMenu()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <!-- Plus menu backdrop -->
  <div class="plus-menu-backdrop" id="plusBackdrop" onclick="closePlusMenu()"></div>

  <!-- Plus menu -->
  <div class="plus-menu" id="plusMenu">
    <div class="plus-menu-label">Create</div>
    <button class="plus-menu-item" onclick="openTextInput()">
      <span class="icon"></span>
      <span>Text note</span>
    </button>
    <button class="plus-menu-item" onclick="pasteLink()">
      <span class="icon"></span>
      <span>Paste link</span>
    </button>
    <button class="plus-menu-item" onclick="uploadImage()">
      <span class="icon"></span>
      <span>Upload image</span>
    </button>
    <button class="plus-menu-item" onclick="uploadFile()">
      <span class="icon"></span>
      <span>Upload file</span>
    </button>
    <div class="plus-menu-divider"></div>
    <div class="plus-menu-label"> AI Magic</div>
    <button class="plus-menu-item magic" onclick="openMagic('poem')">
      <span class="icon"></span>
      <span>Create Poem</span>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('greeting')">
      <span class="icon"></span>
      <span>Create Greeting</span>
    </button>
    <button class="plus-menu-item magic" onclick="openMagic('speech')">
      <span class="icon"></span>
      <span>Create Speech</span>
    </button>
  </div>

  <!-- Text input modal -->
  <div class="text-input-modal" id="textInputModal">
    <div class="text-input-content">
      <div class="text-input-header">
        <span class="text-input-title">New text note</span>
        <button class="text-input-close" onclick="closeTextInput()"></button>
      </div>
      <textarea class="text-input-area" id="textInputArea" placeholder="Type your idea here..."></textarea>
      <div class="text-input-actions">
        <button class="text-input-btn cancel" onclick="closeTextInput()">Cancel</button>
        <button class="text-input-btn save" onclick="saveTextNote()">Save</button>
      </div>
    </div>
  </div>

  <!-- AI Magic Modal -->
  <div class="magic-modal" id="magicModal" onclick="if(event.target===this)closeMagic()">
    <div class="magic-content">
      <div class="magic-header">
        <h2 id="magicTitle"> Create Poem</h2>
        <p id="magicSubtitle">Tell me what it should be about</p>
      </div>
      <div class="magic-body">
        <!-- Photo section -->
        <div class="magic-photo-section">
          <div style="position: relative;">
            <button class="magic-photo-btn" id="magicPhotoBtn" onclick="togglePhotoMenu()">
              <span></span>
              <span id="magicPhotoBtnText">Add photo (optional)</span>
            </button>
            <div class="magic-photo-menu" id="magicPhotoMenu">
              <button class="magic-photo-menu-item" onclick="takeMagicPhoto()">
                <span></span> Take photo
              </button>
              <button class="magic-photo-menu-item" onclick="chooseMagicPhoto()">
                <span></span> Choose from gallery
              </button>
              <button class="magic-photo-menu-item" onclick="openDropsPicker()">
                <span></span> Choose from Drops
              </button>
            </div>
          </div>
          <div class="magic-photo-preview" id="magicPhotoPreview" style="display: none;">
            <img id="magicPhotoImg" src="" alt="Selected photo">
            <button class="magic-photo-remove" onclick="removeMagicPhoto()"></button>
          </div>
          <input type="file" id="magicPhotoInput" accept="image/*" style="display:none" onchange="handleMagicPhoto(event)">
          <input type="file" id="magicCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleMagicPhoto(event)">
        </div>
        
        <label class="magic-input-label" id="magicInputLabel">Add details (optional if photo added)</label>
        <textarea class="magic-input-area" id="magicInput" placeholder="Example: Birthday greeting for mom, she loves gardening and has 2 grandkids..."></textarea>
        <button class="magic-voice-btn" id="magicVoiceBtn" onclick="toggleMagicVoice()">
          <span></span>
          <span id="magicVoiceText">Tap to speak</span>
        </button>
        <div class="magic-styles" id="magicStyles">
          <button class="magic-style active" data-style="classic">Classic</button>
          <button class="magic-style" data-style="funny"> Funny</button>
          <button class="magic-style" data-style="tender"> Tender</button>
          <button class="magic-style" data-style="epic"> Epic</button>
        </div>
        <button class="magic-generate" id="magicGenerate" onclick="generateMagic()">
           Create Magic!
        </button>
      </div>
      <div class="magic-footer">
        <button class="magic-cancel" onclick="closeMagic()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Drops Picker Modal -->
  <div class="drops-picker" id="dropsPicker" onclick="if(event.target===this)closeDropsPicker()">
    <div class="drops-picker-content">
      <div class="drops-picker-header">
        <h3> Choose from Drops</h3>
        <button class="drops-picker-close" onclick="closeDropsPicker()"></button>
      </div>
      <div class="drops-picker-grid" id="dropsPickerGrid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- AI Tools Modal (for text drops) -->
  <div class="ai-tools-modal" id="aiToolsModal" onclick="if(event.target===this)closeAITools()">
    <div class="ai-tools-content">
      <div class="ai-tools-header">
        <h2> AI Tools</h2>
        <p>What would you like to do?</p>
      </div>
      <div class="ai-tools-preview">
        <div class="ai-tools-preview-label">Selected drop:</div>
        <div class="ai-tools-preview-text" id="aiToolsPreviewText"></div>
      </div>
      <div class="ai-tools-body">
        <div class="ai-tools-grid">
          <button class="ai-tool-btn" onclick="runAITool('summarize')">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Summarize</div>
              <div class="desc">Make it shorter and clearer</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('tasks')">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Create Tasks</div>
              <div class="desc">Extract actionable to-dos</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('expand')">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Expand</div>
              <div class="desc">Add more details and ideas</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('rewrite')">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Rewrite</div>
              <div class="desc">Different style or tone</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="runAITool('enhance')">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Enhance</div>
              <div class="desc">Fix errors, punctuation, formatting</div>
            </div>
          </button>
          <button class="ai-tool-btn" onclick="openTranslateModal()">
            <span class="icon"></span>
            <div class="info">
              <div class="title">Translate</div>
              <div class="desc">Translate to another language</div>
            </div>
          </button>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsCheckCategory" checked>
          <div class="ai-tools-option-label">
            <div class="title">Also check/update category</div>
            <div class="current">Current: <span id="aiToolsCurrentCategory">INBOX</span></div>
          </div>
        </div>
        <div class="ai-tools-option">
          <input type="checkbox" id="aiToolsRemoveLineBreaks">
          <div class="ai-tools-option-label">
            <div class="title">Remove extra line breaks</div>
            <div class="current">Join paragraphs into continuous text</div>
          </div>
        </div>
      </div>
      <div class="ai-tools-footer">
        <button class="magic-cancel" onclick="closeAITools()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- AI Result Modal (large, with actions) -->
  <div class="ai-result-modal" id="aiResultModal2" onclick="if(event.target===this)closeAIResult2()">
    <div class="ai-result-content">
      <div class="ai-result-header">
        <h2 id="aiResult2Title"> Result</h2>
      </div>
      <div class="ai-result-body">
        <div class="ai-result-text" id="aiResult2Text"></div>
        <div class="ai-result-category" id="aiResult2Category" style="display:none;">
          <div class="ai-result-category-title"> Suggested category</div>
          <div class="ai-result-category-row">
            <span class="ai-result-category-current" id="aiResult2CurrentCat">INBOX</span>
            <span class="ai-result-category-arrow"></span>
            <span class="ai-result-category-suggested" id="aiResult2SuggestedCat">TASKS</span>
          </div>
          <div class="ai-result-category-actions">
            <button class="ai-result-category-btn" onclick="keepCategory()">Keep current</button>
            <button class="ai-result-category-btn accept" onclick="acceptCategory()">Change </button>
          </div>
        </div>
      </div>
      <div class="ai-result-actions">
        <button class="ai-result-action-btn primary" onclick="replaceOriginal()">
           Replace original
        </button>
        <div class="ai-result-action-row">
          <button class="ai-result-action-btn secondary" onclick="createNewDrop()">
             New Drop
          </button>
          <button class="ai-result-action-btn secondary" onclick="copyResult2()">
             Copy
          </button>
        </div>
        <button class="ai-result-cancel" onclick="closeAIResult2()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- B2 FIX: Tasks Confirmation Modal -->
  <div class="ai-result-modal" id="tasksConfirmModal" onclick="if(event.target===this)closeTasksConfirm()">
    <div class="ai-result-content">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #F59E0B, #EF4444);">
        <h2> Extracted Tasks</h2>
      </div>
      <div class="ai-result-body">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 12px;">Found <span id="tasksCount">0</span> tasks. Each will become a separate drop:</p>
        <div class="tasks-preview-list" id="tasksPreviewList"></div>
      </div>
      <div class="ai-result-actions">
        <button class="ai-result-action-btn primary" onclick="confirmCreateTasks()">
           Create <span id="tasksCountBtn">0</span> Task Drops
        </button>
        <button class="ai-result-cancel" onclick="closeTasksConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- I1 FIX: Translate Modal -->
  <div class="ai-result-modal" id="translateModal" onclick="if(event.target===this)closeTranslateModal()">
    <div class="ai-result-content" style="max-width: 360px;">
      <div class="ai-result-header" style="background: linear-gradient(135deg, #3B82F6, #10B981);">
        <h2> Translate</h2>
      </div>
      <div class="ai-result-body" style="padding: 20px;">
        <p style="color: var(--color-text-muted); font-size: 0.85rem; margin-bottom: 16px;">Select target language:</p>
        <div class="translate-langs">
          <button class="translate-lang-btn" onclick="runTranslate('English')"> English</button>
          <button class="translate-lang-btn" onclick="runTranslate('Russian')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Spanish')"> Espaol</button>
          <button class="translate-lang-btn" onclick="runTranslate('German')"> Deutsch</button>
          <button class="translate-lang-btn" onclick="runTranslate('French')"> Franais</button>
          <button class="translate-lang-btn" onclick="runTranslate('Chinese')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Japanese')"> </button>
          <button class="translate-lang-btn" onclick="runTranslate('Portuguese')"> Portugus</button>
        </div>
      </div>
      <div class="ai-result-actions" style="padding: 16px 20px;">
        <button class="ai-result-cancel" onclick="closeTranslateModal()">Cancel</button>
      </div>
    </div>
  </div>

  <button class="fab-record" id="fabRecord" onclick="toggleRec()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
  </button>

  <div class="rec-status" id="recStatus">
    <span class="rec-dot"></span>
    <span class="rec-text" id="recText">Listening...</span>
  </div>

  <button class="scroll-fab top" id="scrollTop" onclick="scrollToTop()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg></button>
  <button class="scroll-fab bottom" id="scrollBottom" onclick="scrollToBottom()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg></button>

  <!-- Selection bar for merge -->
  <div class="select-bar" id="selectBar">
    <div class="select-info"><span id="selectCount">0</span> selected</div>
    <div class="select-actions">
      <button class="select-btn cancel" onclick="cancelSelect()">Cancel</button>
      <button class="select-btn delete" onclick="deleteSelected()">Delete</button>
      <button class="select-btn merge" onclick="showMergePreview()">Merge/Copy</button>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Main Menu Modal -->
  <div class="main-menu" id="mainMenu" onclick="if(event.target===this)closeMainMenu()">
    <div class="main-menu-content">
      <div class="main-menu-header">
        <h2> Menu</h2>
        <button class="main-menu-close" onclick="closeMainMenu()">Close </button>
      </div>
      
      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-label"> AI Token Balance</div>
        <div class="balance-value" id="tokenBalance"></div>
        <div class="balance-hint">Tokens refresh monthly  <span id="tokenUsage">Loading...</span></div>
      </div>
      
      <!-- Search Section -->
      <div class="menu-section">
        <div class="menu-section-title"> Search</div>
        <div class="menu-search">
          <input type="text" class="menu-search-input" id="menuSearchInput" placeholder="Search drops..." onkeypress="if(event.key==='Enter')performSearch()">
          <button class="menu-search-btn" onclick="startVoiceSearch()" title="Voice search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
          </button>
          <button class="menu-search-btn" onclick="performSearch()" title="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </button>
        </div>
      </div>
      
      <!-- Undo Section -->
      <div class="menu-section">
        <div class="undo-header">
          <button class="undo-main-btn" id="undoMainBtn" onclick="undoLast()" disabled>
             Undo Last Action
          </button>
        </div>
        <div id="undoLastInfo" style="text-align: center; font-size: 0.85rem; color: var(--color-text-muted); margin-top: 8px;"></div>
        <button class="undo-toggle-btn" id="undoToggleBtn" onclick="toggleUndoList()" style="display: none; margin-top: 12px; width: 100%;">
          Show history (0)
        </button>
        <div class="undo-list" id="undoList"></div>
      </div>
      
      <!-- Settings Section -->
      <div class="menu-section">
        <div class="menu-section-title"> Settings</div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"></span>
            <span class="settings-item-label">Dark mode</span>
          </div>
          <div class="settings-toggle" id="darkModeToggle" onclick="toggleDarkMode()"></div>
        </div>
        
        <div class="settings-item" style="flex-direction: column; align-items: flex-start; gap: 12px;">
          <div class="settings-item-left">
            <span class="settings-item-icon"></span>
            <span class="settings-item-label">Font size</span>
          </div>
          <div class="font-size-selector">
            <button class="font-size-btn" data-size="small" onclick="setFontSize('small')">
              <span class="size-label">Small</span>
              <span class="size-preview">Aa</span>
            </button>
            <button class="font-size-btn active" data-size="normal" onclick="setFontSize('normal')">
              <span class="size-label">Normal</span>
              <span class="size-preview">Aa</span>
            </button>
            <button class="font-size-btn" data-size="large" onclick="setFontSize('large')">
              <span class="size-label">Large</span>
              <span class="size-preview">Aa</span>
            </button>
          </div>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"></span>
            <span class="settings-item-label">Export data</span>
          </div>
          <button class="settings-btn" onclick="exportData()">Export</button>
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"></span>
            <span class="settings-item-label">Import data</span>
          </div>
          <button class="settings-btn" onclick="document.getElementById('importFileInput').click()">Import</button>
          <input type="file" id="importFileInput" style="display:none" accept=".json" onchange="handleImportFile(event)">
        </div>
        
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="settings-item-icon"></span>
            <span class="settings-item-label">Clear all data</span>
          </div>
          <button class="settings-btn danger" onclick="clearAllData()">Clear</button>
        </div>
      </div>
      
      <!-- About Section -->
      <div class="menu-section">
        <div class="menu-about">
          <div class="menu-about-logo">
            <svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg>
          </div>
          <div class="menu-about-name">DropLit</div>
          <div class="menu-about-ver">v0.8.2 by Syntrise</div>
        </div>
      </div>
      
      <!-- Footer with Close button -->
      <div class="main-menu-footer">
        <button class="main-menu-footer-btn" onclick="closeMainMenu()">Close Menu</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="overlay" id="aboutModal"><div class="modal"><div class="about-brand"><div class="about-logo"><svg viewBox="0 0 24 24" fill="white"><path d="M12 2C12 2 5 10.5 5 15C5 18.866 8.134 22 12 22C15.866 22 19 18.866 19 15C19 10.5 12 2 12 2Z"/></svg></div><div class="about-name">DropLit</div><div class="about-ver">v0.8.3 by Syntrise</div></div><div class="modal-text" style="text-align:center">Voice-first idea capture.<br>Long press card to select & merge.</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAbout()">Got it</button></div></div></div>
  <div class="overlay" id="catModal"><div class="modal"><div class="modal-title">Move to</div><div class="cat-grid"><button class="cat-opt" data-cat="tasks" onclick="changeCat('tasks')">Tasks</button><button class="cat-opt" data-cat="ideas" onclick="changeCat('ideas')">Ideas</button><button class="cat-opt" data-cat="handmagic" onclick="changeCat('handmagic')">Handmagic</button><button class="cat-opt" data-cat="design" onclick="changeCat('design')">Design</button><button class="cat-opt" data-cat="bugs" onclick="changeCat('bugs')">Bugs</button><button class="cat-opt" data-cat="questions" onclick="changeCat('questions')">Questions</button><button class="cat-opt" data-cat="sketch" onclick="changeCat('sketch')">Sketch</button><button class="cat-opt" data-cat="scan" onclick="changeCat('scan')">Scan</button><button class="cat-opt" data-cat="inbox" onclick="changeCat('inbox')">Inbox</button></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeCatModal()">Cancel</button></div></div></div>
  <div class="overlay" id="sendModal"><div class="modal"><div class="modal-title">Send</div><div class="send-opts"><div class="send-opt" onclick="sendAI()"><div class="send-icon">AI</div><div class="send-info"><div class="send-title">AI Assistant</div><div class="send-desc">Copy + open Claude</div></div><span class="send-badge">Pro</span></div><div class="send-div">or share via</div><div class="send-opt" onclick="shareNative()"><div class="send-icon">...</div><div class="send-info"><div class="send-title">Share...</div><div class="send-desc">WhatsApp, Telegram</div></div></div><div class="send-opt" onclick="sendMail()"><div class="send-icon">@</div><div class="send-info"><div class="send-title">Email</div><div class="send-desc">Send via email</div></div></div><div class="send-opt" onclick="copyClip()"><div class="send-icon">#</div><div class="send-info"><div class="send-title">Copy</div><div class="send-desc">Copy to clipboard</div></div></div></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeSendModal()">Cancel</button></div></div></div>
  <div class="overlay" id="exportModal"><div class="modal"><div class="modal-title">Export</div><div class="export-box" id="exportBox"></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeExportModal()">Close</button><button class="modal-btn pri" onclick="copyExport()">Copy All</button></div></div></div>
  <div class="overlay" id="delModal"><div class="modal"><div class="modal-title">Delete this idea?</div><div class="modal-text">This action cannot be undone.</div><div class="modal-actions"><button class="modal-btn sec" onclick="closeDelModal()">Cancel</button><button class="modal-btn danger" onclick="confirmDel()">Delete</button></div></div></div>
  <div class="overlay" id="settingsModal"><div class="modal"><div class="modal-title">Settings</div><div class="modal-text">Coming soon:<br><br>- Search<br>- Themes<br>- Custom categories<br>- Cloud sync</div><div class="modal-actions"><button class="modal-btn sec" onclick="exportAll()">Export</button><button class="modal-btn pri" onclick="closeSettings()">Done</button></div></div></div>
  <div class="overlay" id="addCatModal"><div class="modal"><div class="modal-title">Add Category</div><div class="modal-text">Custom categories coming in a future update!</div><div class="modal-actions"><button class="modal-btn pri" onclick="closeAddCatModal()">OK</button></div></div></div>
  <div class="overlay" id="mergeModal"><div class="modal"><div class="modal-title">Merge Preview</div><div class="merge-options"><label class="merge-toggle"><input type="checkbox" id="mergeSimple" onchange="updateMergePreview()"><span>Simple merge (no headers)</span></label></div><div class="merge-preview" id="mergePreview"></div><div class="modal-actions"><button class="modal-btn sec" onclick="closeMergeModal()">Cancel</button><button class="modal-btn sec" onclick="copyMerged()">Copy</button><button class="modal-btn merge" onclick="saveMerged()">Save</button></div></div></div>
  <div class="overlay image-viewer" id="imageViewer" onclick="handleImageViewerClick(event)">
    <div class="image-viewer-close" onclick="closeImageViewer()"></div>
    <div class="image-viewer-markers" id="imageViewerMarkers" onclick="openPhotoMarkers()"></div>
    <div class="image-viewer-ai" onclick="openPhotoAI()"></div>
    <div class="image-counter" id="imageCounter">1 / 1</div>
    <div class="image-viewer-nav prev" id="imgNavPrev" onclick="navigateImage(-1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg></div>
    <div class="image-viewer-nav next" id="imgNavNext" onclick="navigateImage(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg></div>
    <div class="image-viewer-content" id="imageViewerContent">
      <img id="imageViewerImg" src="" alt="Full size">
    </div>
    <div class="image-viewer-panel" onclick="event.stopPropagation()">
      <div class="image-meta" id="imageMeta"></div>
      <div class="image-caption-row">
        <button class="caption-edit-btn" onclick="startEditCaption()">Edit</button>
        <div class="image-caption-display" id="imageCaptionDisplay"></div>
      </div>
      <div class="image-notes-wrap" id="imageNotesWrap">
        <textarea class="image-notes" id="imageNotes" placeholder="Add caption or notes..." rows="2"></textarea>
        <div class="image-edit-actions" id="imageEditActions">
          <button class="img-act" onclick="cancelEditCaption()">Cancel</button>
          <button class="img-act primary" onclick="saveCaption()">Save</button>
        </div>
      </div>
      <div class="image-actions" id="imageActions">
        <button class="img-act" onclick="shareImage()">Share</button>
        <button class="img-act" onclick="saveImageToGallery()">Download</button>
        <button class="img-act delete" onclick="deleteFromViewer()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo AI Tools Modal -->
  <div class="photo-ai-modal" id="photoAIModal" onclick="if(event.target===this)closePhotoAI()">
    <div class="photo-ai-content">
      <div class="photo-ai-header">
        <h3> AI Tools</h3>
        <p>What would you like to do?</p>
      </div>
      <div class="photo-ai-tools">
        <button class="photo-ai-btn" onclick="runPhotoAI('ocr')">
          <div class="icon"></div>
          <div class="info">
            <div class="title">Extract Text (OCR)</div>
            <div class="desc">Read and copy text from image</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="runPhotoAI('describe')">
          <div class="icon"></div>
          <div class="info">
            <div class="title">Describe Image</div>
            <div class="desc">AI generates detailed description</div>
          </div>
        </button>
        <button class="photo-ai-btn" onclick="startEditCaption(); closePhotoAI();">
          <div class="icon"></div>
          <div class="info">
            <div class="title">Edit Caption</div>
            <div class="desc">Add or edit photo notes</div>
          </div>
        </button>
      </div>
      <button class="photo-ai-cancel" onclick="closePhotoAI()">Cancel</button>
    </div>
  </div>

  <!-- Photo AI Result Modal -->
  <div class="photo-ai-result" id="photoAIResult" onclick="if(event.target===this)closePhotoAIResult()">
    <div class="photo-ai-result-content">
      <div class="photo-ai-result-header">
        <h3 id="photoAIResultTitle"> Result</h3>
      </div>
      <div class="photo-ai-result-text" id="photoAIResultText"></div>
      <div class="photo-ai-result-actions">
        <button class="photo-ai-result-btn primary" onclick="savePhotoAIToCaption()">
           Set as Caption
        </button>
        <button class="photo-ai-result-btn secondary" onclick="savePhotoAIToNewDrop()">
           Create New Drop
        </button>
        <button class="photo-ai-result-btn secondary" onclick="copyPhotoAIResult()">
           Copy to Clipboard
        </button>
      </div>
    </div>
  </div>

  <!-- Photo Markers Modal -->
  <div class="photo-markers-modal" id="photoMarkersModal" onclick="if(event.target===this)closePhotoMarkersModal()">
    <div class="photo-markers-content">
      <div class="photo-markers-title"> Add Markers</div>
      <div class="photo-markers-grid" id="photoMarkersGrid"></div>
      <button class="photo-markers-done" onclick="closePhotoMarkersModal()">Done</button>
    </div>
  </div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}
let ideas=JSON.parse(localStorage.getItem('droplit_ideas'))||[];
let curCat='all',curTime='all',sortAsc=true,isRec=false,recognition=null,saved=false;
let sendId=null,delId=null,catChangeId=null,editId=null,activeCardId=null;
let selectMode=false,selectedIds=[];
let lastScrollTop=0,longPressTimer=null;

// AI Configuration
const AI_API_URL = '/api/ai';
let aiProcessing = false;

const CATS={
  tasks:{name:'TASKS',single:'TASK',kw:['task','tasks','todo','','','','',''],isMedia:false},
  ideas:{name:'IDEAS',single:'IDEA',kw:['idea','ideas','','','',''],isMedia:false},
  handmagic:{name:'HANDMAGIC',single:'HANDMAGIC',kw:['handmagic','','',' '],isMedia:false},
  design:{name:'DESIGN',single:'DESIGN',kw:['design','','ui','ux','','',''],isMedia:false},
  bugs:{name:'BUGS',single:'BUG',kw:['bug','bugs','fix','','','','',''],isMedia:false},
  questions:{name:'QUESTIONS',single:'QUESTION',kw:['question','questions','','','','claude',''],isMedia:false},
  link:{name:'LINKS',single:'LINK',kw:['link','url','http','https','www',''],isMedia:false},
  sketch:{name:'SKETCHES',single:'SKETCH',kw:[],isMedia:true},
  scan:{name:'SCANS',single:'SCAN',kw:[],isMedia:true},
  photo:{name:'PHOTOS',single:'PHOTO',kw:[],isMedia:true},
  inbox:{name:'INBOX',single:'INBOX',kw:[],isMedia:false}
};
const MEDIA_CATS=['photo','sketch','scan'];

// Markers system (scalable for future)
const MARKERS={
  heart:'',
  star:'',
  fire:'',
  done:'',
  trash:'',
  think:''
};
// Currently enabled markers (MVP = only heart)
const ENABLED_MARKERS=['heart'];

function parseD(s){
  if(!s||typeof s!=='string')return new Date(0);
  const parts=s.split('.');
  if(parts.length!==3)return new Date(0);
  const[d,m,y]=parts.map(Number);
  return new Date(y,m-1,d);
}
function inDays(s,n){
  if(!s)return false;
  try{return(new Date()-parseD(s))/(864e5)<=n;}catch(e){return false;}
}
function isToday(s){
  if(!s)return false;
  return s===new Date().toLocaleDateString('ru-RU');
}

const ideasWrap=document.getElementById('ideasWrap');
const scrollTopBtn=document.getElementById('scrollTop');
const scrollBottomBtn=document.getElementById('scrollBottom');
let scrollTimeout=null;

ideasWrap.addEventListener('scroll',()=>{
  const st=ideasWrap.scrollTop;
  const maxScroll=ideasWrap.scrollHeight-ideasWrap.clientHeight;
  const dir=st>lastScrollTop?1:-1;
  lastScrollTop=st;
  clearTimeout(scrollTimeout);
  scrollTopBtn.classList.remove('show');
  scrollBottomBtn.classList.remove('show');
  if(maxScroll>300){
    if(dir<0 && st>200) scrollTopBtn.classList.add('show');
    else if(dir>0 && st<maxScroll-200) scrollBottomBtn.classList.add('show');
  }
  scrollTimeout=setTimeout(()=>{
    scrollTopBtn.classList.remove('show');
    scrollBottomBtn.classList.remove('show');
  },2000);
});

function scrollToTop(){ideasWrap.scrollTo({top:0,behavior:'smooth'});scrollTopBtn.classList.remove('show');}
function scrollToBottom(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'smooth'});scrollBottomBtn.classList.remove('show');}
function scrollToBottomInstant(){ideasWrap.scrollTo({top:ideasWrap.scrollHeight,behavior:'instant'});}
function toggleSort(){sortAsc=!sortAsc;document.getElementById('sortBtn').innerHTML=sortAsc?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>';document.getElementById('sortBtn').classList.toggle('desc',!sortAsc);render();}

// Selection mode
function enterSelectMode(id){
  selectMode=true;
  selectedIds=[id];
  activeCardId=null;
  document.body.classList.add('select-mode');
  document.getElementById('fabRecord').style.display='none';
  document.getElementById('fabCamera').style.display='none';
  updateSelectBar();
  render();
}

function cancelSelect(){
  selectMode=false;
  selectedIds=[];
  document.body.classList.remove('select-mode');
  document.getElementById('selectBar').classList.remove('show');
  document.getElementById('fabRecord').style.display='flex';
  document.getElementById('fabCamera').style.display='flex';
  render();
}

function deleteSelected(){
  if(selectedIds.length===0)return;
  const count=selectedIds.length;
  if(confirm('Delete '+count+' selected items?')){
    ideas=ideas.filter(i=>!selectedIds.includes(i.id));
    save();
    cancelSelect();
    render();counts();
    toast(count+' items deleted','info');
  }
}

function toggleSelect(id){
  if(selectedIds.includes(id)){
    selectedIds=selectedIds.filter(x=>x!==id);
    if(selectedIds.length===0) cancelSelect();
  } else {
    selectedIds.push(id);
  }
  updateSelectBar();
  render();
}

function updateSelectBar(){
  document.getElementById('selectCount').textContent=selectedIds.length;
  document.getElementById('selectBar').classList.toggle('show',selectMode&&selectedIds.length>0);
}

function getMergedText(simple=false){
  const selected=ideas.filter(i=>selectedIds.includes(i.id));
  // Sort by timestamp
  selected.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  
  if(simple){
    // Simple merge - just text, double newline between
    return selected.map(i=>{
      if(i.isMedia){
        return i.notes||'[Photo '+i.date+' '+i.time+']';
      }
      return i.text;
    }).join('\n\n');
  }
  
  // List merge with headers
  return selected.map(i=>{
    const cat=CATS[i.category]?.name||'INBOX';
    if(i.isMedia){
      const content=i.notes||'[Photo '+i.date+' '+i.time+']';
      return `- [${cat}] ${content}`;
    }
    return `- [${cat}] ${i.text}`;
  }).join('\n');
}

function updateMergePreview(){
  const simple=document.getElementById('mergeSimple').checked;
  document.getElementById('mergePreview').textContent=getMergedText(simple);
}

function showMergePreview(){
  if(selectedIds.length<2){toast('Select at least 2 cards','warning');return;}
  // Check if any selected item is media
  const hasMedia=selectedIds.some(id=>{
    const item=ideas.find(x=>x.id===id);
    return item&&item.isMedia;
  });
  if(hasMedia){toast('Cannot merge media items','warning');return;}
  
  const mergedText = getMergedText();
  document.getElementById('mergePreview').textContent=mergedText;
  
  // Warning for large merge
  const charCount = mergedText.length;
  if (charCount > 10000) {
    toast(` Large merge: ${Math.round(charCount/1000)}K chars`, 'warning');
  }
  
  document.getElementById('mergeModal').classList.add('show');
}

function closeMergeModal(){document.getElementById('mergeModal').classList.remove('show');}

function copyMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  navigator.clipboard.writeText(getMergedText(simple));
  toast('Copied to clipboard!','success');
  closeMergeModal();
}

function saveMerged(){
  const simple=document.getElementById('mergeSimple').checked;
  const text=getMergedText(simple);
  
  // Check size limit
  const MAX_DROP_SIZE = 50000; // 50KB
  if (text.length > MAX_DROP_SIZE) {
    toast(`Too large! Max: ${MAX_DROP_SIZE/1000}K chars`, 'error');
    return;
  }
  
  const mergedId = Date.now();
  const idea={id:mergedId,text:text,category:'inbox',timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMerged:true};
  ideas.push(idea);
  
  // Save undo
  saveUndo('merge', { mergedId: mergedId, count: selectedIds.length });
  
  save();
  closeMergeModal();
  cancelSelect();
  resetToShowAll();
  toast('Merged & saved!','success');
}

// Card interactions
function handleCardClick(id,e){
  // Ignore clicks on category badge, action buttons, textarea, checkbox, markers
  if(e.target.closest('.card-cat')||e.target.closest('.act')||e.target.closest('.card-ta')||e.target.closest('.card-checkbox')||e.target.closest('.card-markers'))return;
  
  const item=ideas.find(x=>x.id===id);
  
  if(selectMode){
    // In select mode - always toggle selection
    toggleSelect(id);
  } else if(editId && editId !== id) {
    // If editing another card, don't activate this one
    return;
  } else if(item && item.isMedia) {
    // For media cards - open viewer directly
    viewImage(id,e);
  } else {
    // For text cards - toggle expand/collapse
    activeCardId=activeCardId===id?null:id;
    render();
  }
}

function toggleMarker(id,marker,e){
  if(e){e.stopPropagation();}
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Initialize markers array if needed
  if(!item.markers)item.markers=[];
  
  // Toggle marker (silent - no toast per B3 fix)
  const idx=item.markers.indexOf(marker);
  if(idx===-1){
    item.markers.push(marker);
  } else {
    item.markers.splice(idx,1);
  }
  
  save();
  render();
  
  // Update photo markers button if in image viewer
  if(currentImageId === id) {
    updatePhotoMarkersButton();
  }
}

function handleCardLongPress(id){
  if(!selectMode){
    enterSelectMode(id);
    if(navigator.vibrate)navigator.vibrate(50);
  }
}

let touchStartX=0,touchStartY=0;

function cardTouchStart(id,e){
  if(selectMode||editId)return;
  const touch=e.touches[0];
  touchStartX=touch.clientX;
  touchStartY=touch.clientY;
  longPressTimer=setTimeout(()=>handleCardLongPress(id),800);
}

function cardTouchMove(e){
  if(!longPressTimer)return;
  const touch=e.touches[0];
  const dx=Math.abs(touch.clientX-touchStartX);
  const dy=Math.abs(touch.clientY-touchStartY);
  // Cancel if moved more than 10px (scrolling)
  if(dx>10||dy>10){
    clearTimeout(longPressTimer);
    longPressTimer=null;
  }
}

function cardTouchEnd(){
  clearTimeout(longPressTimer);
  longPressTimer=null;
}

document.addEventListener('click',(e)=>{
  if(activeCardId&&!e.target.closest('.card')&&!e.target.closest('.overlay')&&!e.target.closest('.fab-record')&&!e.target.closest('.select-bar')){
    activeCardId=null;render();
  }
});

function initSR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('warning').style.display='block';document.getElementById('fabRecord').style.opacity='0.5';return false;}
  recognition=new SR();
  recognition.lang='ru-RU';
  recognition.continuous=false;
  recognition.interimResults=true;
  recognition.maxAlternatives=1;
  recognition.onstart=async()=>{isRec=true;saved=false;updateRecUI(true);await acquireWakeLock();};
  recognition.onresult=(e)=>{
    let f='',i='';
    for(let x=0;x<e.results.length;x++){if(e.results[x].isFinal)f+=e.results[x][0].transcript;else i+=e.results[x][0].transcript;}
    document.getElementById('recText').textContent=(f||i)||'Listening...';
    if(f&&!saved){saved=true;saveIdea(f.trim());}
  };
  recognition.onerror=(e)=>{
    if(e.error==='no-speech')toast('No speech detected','warning');
    else if(e.error==='not-allowed')toast('Microphone access denied','error');
    isRec=false;updateRecUI(false);releaseWakeLock();
  };
  recognition.onend=()=>{isRec=false;updateRecUI(false);releaseWakeLock();};
  return true;
}

// B4 FIX: Wake Lock to prevent screen from turning off during recording
let wakeLock = null;
async function acquireWakeLock() {
  if ('wakeLock' in navigator) {
    try { wakeLock = await navigator.wakeLock.request('screen'); } 
    catch (err) { console.log('Wake Lock error:', err); }
  }
}
function releaseWakeLock() {
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

function toggleRec(){if(isRec)recognition.stop();else{saved=false;recognition.start();}}
function updateRecUI(on){
  const fab=document.getElementById('fabRecord'),status=document.getElementById('recStatus');
  if(on){fab.classList.add('recording');status.classList.add('show');document.getElementById('recText').textContent='Listening...';}
  else{fab.classList.remove('recording');status.classList.remove('show');}
}
function detectCat(t){
  const l=t.toLowerCase();
  for(const[k,v]of Object.entries(CATS)){
    if(k==='inbox'||!v.kw||v.kw.length===0)continue;
    for(const w of v.kw){
      // Check: starts with word, contains word with spaces, or ends with word
      if(l.startsWith(w+' ')||l.startsWith(w+',')||l.startsWith(w+'.')||
         l.includes(' '+w+' ')||l.includes(' '+w+',')||l.includes(' '+w+'.')||
         l.endsWith(' '+w)||l===w)return k;
    }
  }
  return'inbox';
}
function saveIdea(t){
  const c=detectCat(t);
  const idea={id:Date.now(),text:t,category:c,timestamp:new Date().toISOString(),date:new Date().toLocaleDateString('ru-RU'),time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),isMedia:false};
  ideas.push(idea);save();
  resetToShowAll();
  toast('Saved to '+CATS[c].name,'success');
}

function resetToShowAll(){
  try{
    // Reset filter variables
    curCat='all';
    curTime='7days';
    activeCardId=null;
    sortAsc=true;
    // Update sort button UI
    const sortBtn=document.getElementById('sortBtn');
    if(sortBtn){
      sortBtn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>';
      sortBtn.classList.remove('desc');
    }
    // Remove active class from category buttons
    document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
    // Update time buttons - activate 7d
    document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
    const btn7d=document.querySelector('.time-btn[data-time="7days"]');
    if(btn7d)btn7d.classList.add('active');
    // Render and scroll (instant, no animation)
    render();
    counts();
    setTimeout(()=>{
      const wrap=document.getElementById('ideasWrap');
      if(wrap)wrap.scrollTo({top:wrap.scrollHeight,behavior:'auto'});
    },50);
  }catch(err){
    console.error('resetToShowAll error:',err);
  }
}

function handlePhoto(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing photo...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200; // Max dimension
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    // Compress to JPEG 70% quality
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    savePhoto(dataUrl,null);
  };
  img.onerror=function(){
    toast('Failed to load photo','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read photo','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

function savePhoto(dataUrl,geo){
  const idea={
    id:Date.now(),
    text:'',
    notes:'',
    image:dataUrl,
    category:'photo',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    geo:geo,
    isMedia:true
  };
  ideas.push(idea);
  save();
  toast('Photo saved!','success');
  try{
    resetToShowAll();
  }catch(err){
    // Silent fail - photo is saved
  }
}

// ============================================
// PLUS MENU FUNCTIONS
// ============================================

function togglePlusMenu(){
  const menu=document.getElementById('plusMenu');
  const backdrop=document.getElementById('plusBackdrop');
  const btn=document.getElementById('fabPlus');
  
  if(menu.classList.contains('show')){
    closePlusMenu();
  } else {
    menu.classList.add('show');
    backdrop.classList.add('show');
    btn.classList.add('open');
  }
}

function closePlusMenu(){
  document.getElementById('plusMenu').classList.remove('show');
  document.getElementById('plusBackdrop').classList.remove('show');
  document.getElementById('fabPlus').classList.remove('open');
}

// TEXT NOTE
function openTextInput(){
  closePlusMenu();
  document.getElementById('textInputModal').classList.add('show');
  setTimeout(()=>{
    document.getElementById('textInputArea').focus();
  },100);
}

function closeTextInput(){
  document.getElementById('textInputModal').classList.remove('show');
  document.getElementById('textInputArea').value='';
}

function saveTextNote(){
  const text=document.getElementById('textInputArea').value.trim();
  if(!text){
    toast('Please enter some text','error');
    return;
  }
  
  const category=detectCat(text);
  const idea={
    id:Date.now(),
    text:text,
    category:category,
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
  };
  ideas.push(idea);
  save();
  toast('Note saved!','success');
  closeTextInput();
  resetToShowAll();
}

// PASTE LINK
async function pasteLink(){
  closePlusMenu();
  
  try{
    // Try to read from clipboard
    const text=await navigator.clipboard.readText();
    
    if(text&&isUrl(text.trim())){
      createLinkCard(text.trim());
    } else if(text&&text.trim()){
      // Not a URL but has text - ask user
      toast('Clipboard: "'+text.substring(0,30)+'..."','info');
      // Create as text note with the link
      const category=detectCat(text);
      const idea={
        id:Date.now(),
        text:text.trim(),
        category:category,
        timestamp:new Date().toISOString(),
        date:new Date().toLocaleDateString('ru-RU'),
        time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
      };
      ideas.push(idea);
      save();
      toast('Saved from clipboard!','success');
      resetToShowAll();
    } else {
      toast('Clipboard is empty','error');
    }
  }catch(err){
    // Clipboard API not available or denied
    toast('Cannot access clipboard. Please paste manually.','error');
    openTextInput();
  }
}

function isUrl(str){
  return /^(https?:\/\/|www\.)/i.test(str);
}

function createLinkCard(url){
  // Ensure URL has protocol
  let href=url;
  if(url.startsWith('www.'))href='https://'+url;
  
  const idea={
    id:Date.now(),
    text:href,
    category:'link',
    timestamp:new Date().toISOString(),
    date:new Date().toLocaleDateString('ru-RU'),
    time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    isLink:true
  };
  ideas.push(idea);
  save();
  toast('Link saved!','success');
  resetToShowAll();
}

// UPLOAD IMAGE
function uploadImage(){
  closePlusMenu();
  document.getElementById('imageUpload').click();
}

function handleUploadedImage(e){
  const file=e.target.files[0];
  if(!file)return;
  
  toast('Processing image...','info');
  
  // Compress image before saving
  const img=new Image();
  img.onload=function(){
    const canvas=document.createElement('canvas');
    const maxSize=1200;
    let w=img.width,h=img.height;
    
    if(w>maxSize||h>maxSize){
      if(w>h){h=Math.round(h*maxSize/w);w=maxSize;}
      else{w=Math.round(w*maxSize/h);h=maxSize;}
    }
    
    canvas.width=w;
    canvas.height=h;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    
    const dataUrl=canvas.toDataURL('image/jpeg',0.7);
    
    // Save as uploaded image (no geo)
    const idea={
      id:Date.now(),
      text:'',
      notes:'',
      image:dataUrl,
      category:'photo',
      timestamp:new Date().toISOString(),
      date:new Date().toLocaleDateString('ru-RU'),
      time:new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
      geo:null,
      isMedia:true,
      isUploaded:true
    };
    ideas.push(idea);
    save();
    toast('Image uploaded!','success');
    resetToShowAll();
  };
  img.onerror=function(){
    toast('Failed to load image','error');
  };
  
  const reader=new FileReader();
  reader.onload=function(ev){
    img.src=ev.target.result;
  };
  reader.onerror=function(){
    toast('Failed to read image','error');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

// ============================================
// FILE UPLOAD (v0.8.2)
// ============================================

const MAX_FILE_SIZE = 50 * 1024; // 50KB limit
const SUPPORTED_TEXT_EXTENSIONS = ['txt', 'md', 'csv', 'json'];

function uploadFile(){
  closePlusMenu();
  document.getElementById('fileUpload').click();
}

function handleUploadedFile(e){
  const file = e.target.files[0];
  if (!file) return;
  
  // Check extension
  const ext = file.name.split('.').pop().toLowerCase();
  if (!SUPPORTED_TEXT_EXTENSIONS.includes(ext)) {
    toast('Supported: .txt, .md, .csv, .json', 'error');
    e.target.value = '';
    return;
  }
  
  // Check size
  if (file.size > MAX_FILE_SIZE) {
    const sizeKB = Math.round(file.size / 1024);
    toast(`File too large (${sizeKB}KB). Max: 50KB`, 'error');
    e.target.value = '';
    return;
  }
  
  toast('Reading file...', 'info');
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const text = ev.target.result;
    
    if (!text || text.trim().length === 0) {
      toast('File is empty', 'error');
      return;
    }
    
    // Create drop from file content
    const idea = {
      id: Date.now(),
      text: text.trim(),
      category: detectCat(text.trim()),
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      isImported: true,
      sourceFile: file.name
    };
    
    ideas.push(idea);
    save();
    
    const charCount = text.length;
    toast(`Imported! ${charCount} chars from ${file.name}`, 'success');
    resetToShowAll();
  };
  
  reader.onerror = function() {
    toast('Failed to read file', 'error');
  };
  
  reader.readAsText(file);
  e.target.value = '';
}

function aiProcess(id){toast('AI processing coming soon!','info');}
function openCatModal(id){
  catChangeId=id;
  const item=ideas.find(x=>x.id===id);
  const isMedia=item?.isMedia;
  const grid=document.querySelector('#catModal .cat-grid');
  // Show only appropriate categories
  grid.querySelectorAll('.cat-opt').forEach(btn=>{
    const cat=btn.dataset.cat;
    if(isMedia){
      // Media items can only go to sketch, scan, inbox
      btn.style.display=MEDIA_CATS.includes(cat)?'block':'none';
    } else {
      // Text items can go to all except sketch, scan
      btn.style.display=!CATS[cat]?.isMedia?'block':'none';
    }
  });
  document.getElementById('catModal').classList.add('show');
}
function closeCatModal(){document.getElementById('catModal').classList.remove('show');catChangeId=null;}
function changeCat(c){if(catChangeId){const i=ideas.find(x=>x.id===catChangeId);if(i){saveUndo('category',{id:i.id,previousCategory:i.category,newCategory:c});i.category=c;save();render();counts();toast('Moved to '+CATS[c].name,'success');}}closeCatModal();}
function reqDel(id){delId=id;document.getElementById('delModal').classList.add('show');}
function closeDelModal(){document.getElementById('delModal').classList.remove('show');delId=null;}
function confirmDel(){if(delId){const delItem=ideas.find(x=>x.id===delId);if(delItem)saveUndo('delete',{...delItem});ideas=ideas.filter(x=>x.id!==delId);save();activeCardId=null;render();counts();toast('Deleted','info');}closeDelModal();}
function startEdit(id){if(editId)cancelEdit(editId);editId=id;activeCardId=id;document.body.classList.add('editing-mode');render();setTimeout(()=>{const card=document.querySelector('[data-id="'+id+'"]');const ta=card?.querySelector('.card-ta');if(ta){card.scrollIntoView({behavior:'smooth',block:'center'});ta.focus();}},100);}
function saveEdit(id){const card=document.querySelector('[data-id="'+id+'"]'),ta=card?.querySelector('.card-ta');if(ta){const t=ta.value.trim();if(t){const i=ideas.find(x=>x.id===id);if(i&&t!==i.text){saveUndo('edit',{id:i.id,previousText:i.text});i.text=t;i.category=detectCat(t);save();toast('Saved','success');}}}editId=null;document.body.classList.remove('editing-mode');render();counts();}
function cancelEdit(id){editId=null;document.body.classList.remove('editing-mode');render();}
function openSendModal(id){sendId=id;document.getElementById('sendModal').classList.add('show');}
function closeSendModal(){document.getElementById('sendModal').classList.remove('show');sendId=null;}
function sendAI(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);window.open('https://claude.ai','_blank');toast('Copied to clipboard!','success');}closeSendModal();}
function shareNative(){const i=ideas.find(x=>x.id===sendId);if(i&&navigator.share)navigator.share({title:'DropLit',text:i.text}).catch(()=>{});else if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function sendMail(){const i=ideas.find(x=>x.id===sendId);if(i)window.open('mailto:?subject='+encodeURIComponent('DropLit: '+CATS[i.category].name)+'&body='+encodeURIComponent(i.text));closeSendModal();}
function copyClip(){const i=ideas.find(x=>x.id===sendId);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}closeSendModal();}
function copyIdea(id){const i=ideas.find(x=>x.id===id);if(i){navigator.clipboard.writeText(i.text);toast('Copied','success');}}

function duplicateCard(id){
  const item=ideas.find(x=>x.id===id);
  if(!item)return;
  
  // Create copy with new timestamp
  const now=new Date();
  const copy={
    id: Date.now(),
    text: item.text,
    category: item.category,
    timestamp: now.toISOString(),
    date: now.toLocaleDateString('ru-RU'),
    time: now.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}),
    markers: item.markers ? [...item.markers] : [],
    notes: item.notes || ''
  };
  
  // Copy media if exists
  if(item.isMedia){
    copy.isMedia = true;
    copy.image = item.image;
  }
  
  ideas.push(copy);
  save();
  activeCardId=null;
  render();
  
  toast('Duplicated!','success');
  
  // Scroll to the new card at bottom
  setTimeout(()=>{
    const card=document.querySelector('[data-id="'+copy.id+'"]');
    if(card)card.scrollIntoView({behavior:'smooth',block:'center'});
  },100);
}
function save(){
  try{
    const data=JSON.stringify(ideas);
    localStorage.setItem('droplit_ideas',data);
  }catch(err){
    // Storage full - usually QuotaExceededError
    const sizeMB=(JSON.stringify(ideas).length/1024/1024).toFixed(1);
    toast('Storage full ('+sizeMB+'MB)! Delete old photos','error');
  }
}
function smartTime(i){const td=new Date().toLocaleDateString('ru-RU'),yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');if(i.date===td)return i.time;if(i.date===yd)return'Yesterday '+i.time;const p=i.date.split('.');return p[0]+'.'+p[1]+' '+i.time;}
function filtered(){
  let f=[...ideas].filter(x=>x&&x.date); // Filter out invalid entries
  
  // Apply search filter
  if(searchMode && searchQuery) {
    f = f.filter(x => {
      const text = (x.text || '').toLowerCase();
      const notes = (x.notes || '').toLowerCase();
      return text.includes(searchQuery) || notes.includes(searchQuery);
    });
    return f; // Skip other filters when searching
  }
  
  if(curTime==='today')f=f.filter(x=>isToday(x.date));
  else if(curTime==='7days')f=f.filter(x=>inDays(x.date,7));
  if(curCat!=='all')f=f.filter(x=>x.category===curCat);
  return f;
}

function render(){
  const wrap=document.getElementById('ideasList'),empty=document.getElementById('emptyState'),list=filtered();
  if(!list.length){wrap.innerHTML='';empty.style.display='flex';return;}
  empty.style.display='none';
  const grp={};for(const i of list){if(!grp[i.date])grp[i.date]=[];grp[i.date].push(i);}
  let dates=Object.keys(grp).sort((a,b)=>sortAsc?parseD(a)-parseD(b):parseD(b)-parseD(a));
  let h='';
  const td=new Date().toLocaleDateString('ru-RU'),yd=new Date(Date.now()-864e5).toLocaleDateString('ru-RU');
  for(const d of dates){
    let lbl=d;if(d===td)lbl='Today';else if(d===yd)lbl='Yesterday';
    h+='<div class="date-sep">'+lbl+'</div>';
    let dayIdeas=grp[d];if(!sortAsc)dayIdeas=dayIdeas.slice().reverse();
    for(const i of dayIdeas){
      const isActive=activeCardId===i.id;
      const isEditing=editId===i.id;
      const isSelected=selectedIds.includes(i.id);
      const cc=i.isMedia?0:(i.text?.length||0);
      const isTruncated=cc>500;
      h+='<div class="card'+(isActive?' active':'')+(isEditing?' editing':'')+(isSelected?' selected':'')+'" data-id="'+i.id+'" onclick="handleCardClick('+i.id+',event)" ontouchstart="cardTouchStart('+i.id+',event)" ontouchmove="cardTouchMove(event)" ontouchend="cardTouchEnd()" ontouchcancel="cardTouchEnd()" oncontextmenu="return false;">';
      h+='<div class="card-checkbox">'+(isSelected?'V':'')+'</div>';
      h+='<div class="card-head"><span class="card-cat '+i.category+'" onclick="openCatModal('+i.id+')">'+(CATS[i.category]?.single||'INBOX')+'</span>';
      // Markers (right after category)
      if(i.markers&&i.markers.length){
        h+='<span class="card-marker">'+i.markers.map(m=>MARKERS[m]||'').join('')+'</span>';
      }
      if(i.isMedia)h+='<span class="card-chars">IMG</span>';
      else h+='<span class="card-chars">'+cc+'</span>';
      h+='<span class="card-time">'+smartTime(i)+'</span>';
      h+='</div>';
      if(i.isMedia&&i.image){
        h+='<img class="card-image" src="'+i.image+'" alt="Photo" loading="lazy">';
        // Show date/geo and notes under image
        h+='<div class="card-media-meta">';
        h+='<span>'+i.date+' '+i.time+'</span>';
        if(i.geo)h+='<span>'+i.geo.lat.toFixed(2)+','+i.geo.lng.toFixed(2)+'</span>';
        h+='</div>';
        if(i.notes){
          const notesLong = i.notes.length > 100;
          h+='<div class="card-notes'+(notesLong?'':' expanded')+'" id="notes-'+i.id+'">'+esc(i.notes)+'</div>';
          if(notesLong)h+='<div class="card-more show" onclick="toggleNotesExpand('+i.id+',event)">Show more</div>';
        }
      }
      if(i.text){
        h+='<div class="card-text'+(isTruncated?' truncated':'')+'" id="text-'+i.id+'">'+linkify(i.text)+'</div>';
        if(isTruncated)h+='<div class="card-more show" onclick="toggleExpand('+i.id+',event)">Show more</div>';
      }
      if(!i.isMedia){
        h+='<div class="card-edit"><textarea class="card-ta">'+esc(i.text||'')+'</textarea></div>';
      }
      h+='<div class="card-actions">';
      if(i.isMedia){
        h+='<button class="act" onclick="viewImage('+i.id+',event)">View</button>';
      } else {
        h+='<button class="act ai" onclick="openAITools('+i.id+')">AI</button>';
        h+='<button class="act" onclick="startEdit('+i.id+')">Edit</button>';
      }
      h+='<button class="act" onclick="openSendModal('+i.id+')">Share</button>';
      h+='<button class="act" onclick="copyIdea('+i.id+')">Copy</button>';
      h+='<button class="act" onclick="duplicateCard('+i.id+')">Dup</button>';
      h+='<button class="act" onclick="reqDel('+i.id+')">Del</button>';
      h+='</div>';
      if(!i.isMedia){
        h+='<div class="card-edit-actions"><button class="act primary" onclick="saveEdit('+i.id+')">Save</button><button class="act secondary" onclick="cancelEdit('+i.id+')">Cancel</button></div>';
      }
      // Markers panel at bottom
      h+='<div class="card-markers">';
      for(const mk of Object.keys(MARKERS)){
        const isMarked=i.markers&&i.markers.includes(mk);
        h+='<button class="marker-btn'+(isMarked?' active':'')+'" onclick="toggleMarker('+i.id+',\''+mk+'\',event)">'+MARKERS[mk]+'</button>';
      }
      h+='</div>';
      h+='</div>';
    }
  }
  wrap.innerHTML=h;
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

function linkify(text){
  // First escape HTML, then convert URLs to links
  const escaped=esc(text);
  // URL regex - matches http, https, and www
  const urlRegex=/(\b(https?:\/\/|www\.)[^\s<]+[^\s<.,;:!?\)\]'"])/gi;
  return escaped.replace(urlRegex,(url)=>{
    let href=url;
    if(url.startsWith('www.'))href='https://'+url;
    return '<a href="'+href+'" target="_blank" rel="noopener" onclick="event.stopPropagation()">'+url+'</a>';
  });
}

function toggleExpand(id,e){
  e.stopPropagation();
  const textEl=document.getElementById('text-'+id);
  const btn=e.target;
  if(textEl.classList.contains('expanded')){
    textEl.classList.remove('expanded');
    textEl.classList.add('truncated');
    btn.textContent='Show more';
  } else {
    textEl.classList.add('expanded');
    textEl.classList.remove('truncated');
    btn.textContent='Show less';
  }
}

function toggleNotesExpand(id,e){
  e.stopPropagation();
  const notesEl=document.getElementById('notes-'+id);
  const btn=e.target;
  if(notesEl.classList.contains('expanded')){
    notesEl.classList.remove('expanded');
    btn.textContent='Show more';
  } else {
    notesEl.classList.add('expanded');
    btn.textContent='Show less';
  }
}

let currentImageId=null;
let allMediaIds=[];
let currentMediaIndex=0;
let currentImageOrientation='';

// ============================================
// ZOOM/PAN SYSTEM (iOS/Android standard)
// ============================================

// State
let scale = 1;           // Current zoom level (1 = fit-to-screen)
let offsetX = 0;         // Pan offset X
let offsetY = 0;         // Pan offset Y
const MIN_SCALE = 1;     // Fit to screen
const MAX_SCALE = 4;     // Maximum zoom
const DOUBLE_TAP_SCALE = 2; // Double-tap zoom level

// Touch tracking
let lastTapTime = 0;
let lastTapX = 0;
let lastTapY = 0;

// Pinch state
let isPinching = false;
let pinchStartScale = 1;
let pinchStartDistance = 0;
let pinchCenterX = 0;
let pinchCenterY = 0;

// Pan state  
let isPanning = false;
let panStartX = 0;
let panStartY = 0;
let panStartOffsetX = 0;
let panStartOffsetY = 0;

// Swipe state
let swipeStartX = 0;
let swipeStartY = 0;
let isSwiping = false;

// Caption edit state
let isEditingCaption=false;

function getMediaItems(){
  return ideas.filter(i=>i.isMedia&&i.image);
}

function viewImage(id,e){
  if(e)e.stopPropagation();
  const item=ideas.find(x=>x.id===id);
  if(!item||!item.image)return;
  
  allMediaIds=getMediaItems().map(i=>i.id);
  currentMediaIndex=allMediaIds.indexOf(id);
  currentImageId=id;
  isEditingCaption=false;
  
  // Reset zoom/pan
  resetTransform();
  
  showImagePanel();
  loadCurrentImage();
  updateNavigation();
  updatePhotoMarkersButton();
  
  document.getElementById('imageViewer').classList.add('show');
  
  const content=document.getElementById('imageViewerContent');
  content.addEventListener('touchstart',handleTouchStart,{passive:false});
  content.addEventListener('touchmove',handleTouchMove,{passive:false});
  content.addEventListener('touchend',handleTouchEnd,{passive:false});
}

function loadCurrentImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  img.style.opacity = '1';
  
  // Reset transform
  resetTransform();
  applyTransform(false);
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

function updateCaptionDisplay(item){
  const display=document.getElementById('imageCaptionDisplay');
  if(item.notes&&item.notes.trim()){
    display.textContent=item.notes;
    display.classList.remove('empty');
  } else {
    display.textContent='No caption';
    display.classList.add('empty');
  }
}

function showImagePanel(){
  isEditingCaption=false;
  
  // Show caption row, hide edit area
  const captionRow=document.querySelector('.image-caption-row');
  const notesWrap=document.getElementById('imageNotesWrap');
  
  if(captionRow) captionRow.style.display='flex';
  if(notesWrap) notesWrap.classList.remove('editing');
}

function updateNavigation(){
  const counter=document.getElementById('imageCounter');
  const prevBtn=document.getElementById('imgNavPrev');
  const nextBtn=document.getElementById('imgNavNext');
  
  counter.textContent=(currentMediaIndex+1)+' / '+allMediaIds.length;
  
  if(allMediaIds.length>1){
    prevBtn.classList.toggle('show',currentMediaIndex>0);
    nextBtn.classList.toggle('show',currentMediaIndex<allMediaIds.length-1);
  } else {
    prevBtn.classList.remove('show');
    nextBtn.classList.remove('show');
  }
}

function navigateImage(direction){
  const newIndex=currentMediaIndex+direction;
  if(newIndex<0||newIndex>=allMediaIds.length)return;
  
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom before navigating
  resetTransform();
  
  const img = document.getElementById('imageViewerImg');
  
  // Quick fade transition for button navigation
  img.style.transition = 'opacity 0.15s ease-out';
  img.style.opacity = '0';
  
  setTimeout(() => {
    currentMediaIndex=newIndex;
    currentImageId=allMediaIds[currentMediaIndex];
    loadCurrentImageNoReset();
    
    img.style.transition = 'opacity 0.15s ease-out';
    img.style.opacity = '1';
    updateNavigation();
    updatePhotoMarkersButton();
  }, 100);
}

function loadCurrentImageNoReset(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const img=document.getElementById('imageViewerImg');
  img.classList.remove('portrait','landscape','zoomed');
  
  // Detect orientation
  const tempImg=new Image();
  tempImg.onload=function(){
    currentImageOrientation=(this.height>this.width)?'portrait':'landscape';
    img.classList.add(currentImageOrientation);
  };
  tempImg.src=item.image;
  img.src=item.image;
  
  // Meta info
  let meta='<span>'+item.date+' '+item.time+'</span>';
  if(item.geo){
    meta+='<span>'+item.geo.lat.toFixed(4)+', '+item.geo.lng.toFixed(4)+'</span>';
  }
  document.getElementById('imageMeta').innerHTML=meta;
  
  // Caption display
  updateCaptionDisplay(item);
  
  // Reset to view mode
  showImagePanel();
}

// ============================================
// TRANSFORM HELPERS
// ============================================

function resetTransform(){
  scale = 1;
  offsetX = 0;
  offsetY = 0;
}

function applyTransform(animate = true){
  const img = document.getElementById('imageViewerImg');
  if(!img) return;
  
  img.style.transition = animate ? 'transform 0.25s ease-out' : 'none';
  img.style.transform = `scale(${scale}) translate(${offsetX}px, ${offsetY}px)`;
  
  // Update class for CSS
  if(scale > 1){
    img.classList.remove('portrait','landscape');
    img.classList.add('zoomed');
  } else {
    img.classList.remove('zoomed');
    if(currentImageOrientation){
      img.classList.add(currentImageOrientation);
    }
  }
}

function clampOffset(){
  // Restrict pan so image doesn't go outside bounds
  const img = document.getElementById('imageViewerImg');
  const content = document.getElementById('imageViewerContent');
  if(!img || !content) return;
  
  const contentRect = content.getBoundingClientRect();
  
  // Calculate how much image can move based on scale
  // When scale=1, no movement allowed. When scale>1, allow proportional movement.
  const imgWidth = img.offsetWidth || 300;
  const imgHeight = img.offsetHeight || 300;
  
  const scaledWidth = imgWidth * scale;
  const scaledHeight = imgHeight * scale;
  
  // Max offset is half the overflow (scaled size - container size) / 2, divided by scale
  const maxOffsetX = Math.max(0, (scaledWidth - contentRect.width) / 2 / scale);
  const maxOffsetY = Math.max(0, (scaledHeight - contentRect.height) / 2 / scale);
  
  offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
  offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
}

// ============================================
// TOUCH HANDLERS
// ============================================

function handleTouchStart(e){
  const touches = e.touches;
  
  if(touches.length === 2){
    // PINCH START
    e.preventDefault();
    isPinching = true;
    isPanning = false;
    isSwiping = false;
    
    pinchStartScale = scale;
    pinchStartDistance = getPinchDistance(touches);
    
  } else if(touches.length === 1){
    // SINGLE TOUCH START
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    if(scale > 1){
      // Zoomed in - start panning
      isPanning = true;
      isSwiping = false;
      panStartX = x;
      panStartY = y;
      panStartOffsetX = offsetX;
      panStartOffsetY = offsetY;
    } else {
      // Not zoomed - could be swipe or tap
      isSwiping = true;
      isPanning = false;
      swipeStartX = x;
      swipeStartY = y;
    }
    
    isPinching = false;
  }
}

function handleTouchMove(e){
  const touches = e.touches;
  
  if(isPinching && touches.length === 2){
    // PINCH MOVE
    e.preventDefault();
    
    const newDistance = getPinchDistance(touches);
    const scaleChange = newDistance / pinchStartDistance;
    let newScale = pinchStartScale * scaleChange;
    
    // Clamp scale
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    scale = newScale;
    
    // Apply without animation for smooth feel
    applyTransform(false);
    
  } else if(isPanning && touches.length === 1){
    // PAN MOVE
    e.preventDefault();
    
    const x = touches[0].clientX;
    const y = touches[0].clientY;
    
    // Calculate delta and apply to offset (divide by scale for correct movement)
    offsetX = panStartOffsetX + (x - panStartX) / scale;
    offsetY = panStartOffsetY + (y - panStartY) / scale;
    
    // Clamp to bounds
    clampOffset();
    
    // Apply without animation
    applyTransform(false);
    
  } else if(isSwiping && touches.length === 1 && scale <= 1){
    // SWIPE MOVE - image follows finger
    const deltaX = touches[0].clientX - swipeStartX;
    const deltaY = touches[0].clientY - swipeStartY;
    
    // Only horizontal swipe
    if(Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 5){
      e.preventDefault();
      
      // Move image with finger (with resistance at edges)
      const img = document.getElementById('imageViewerImg');
      let moveX = deltaX;
      
      // Add resistance if at first/last image
      if((currentMediaIndex === 0 && deltaX > 0) || 
         (currentMediaIndex === allMediaIds.length - 1 && deltaX < 0)){
        moveX = deltaX * 0.3; // Rubber band effect
      }
      
      img.style.transition = 'none';
      img.style.transform = `translateX(${moveX}px)`;
      img.style.opacity = Math.max(0.5, 1 - Math.abs(deltaX) / 500);
    }
  }
}

function handleTouchEnd(e){
  const changedTouches = e.changedTouches;
  
  if(isPinching){
    // PINCH END
    isPinching = false;
    
    // Snap to 1 if close
    if(scale < 1.1){
      scale = 1;
      offsetX = 0;
      offsetY = 0;
    } else {
      // Clamp offset after pinch
      clampOffset();
    }
    
    applyTransform(true);
    return;
  }
  
  if(isPanning){
    // PAN END
    isPanning = false;
    
    // Check for double-tap while zoomed (to reset)
    const now = Date.now();
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const dx = Math.abs(x - panStartX);
    const dy = Math.abs(y - panStartY);
    
    // If didn't move much, might be a tap
    if(dx < 10 && dy < 10){
      if(now - lastTapTime < 300){
        // Double tap while zoomed - reset to fit
        e.preventDefault();
        resetTransform();
        applyTransform(true);
        lastTapTime = 0;
        return;
      }
      lastTapTime = now;
    }
    return;
  }
  
  if(isSwiping && scale <= 1){
    // SWIPE END (not zoomed)
    isSwiping = false;
    
    const x = changedTouches[0].clientX;
    const y = changedTouches[0].clientY;
    const deltaX = x - swipeStartX;
    const deltaY = y - swipeStartY;
    const img = document.getElementById('imageViewerImg');
    
    // Check for SWIPE (horizontal, more than 80px threshold)
    if(Math.abs(deltaX) > 80 && Math.abs(deltaY) < 100){
      // Animate current image out
      const direction = deltaX > 0 ? 1 : -1;
      const canNavigate = (direction > 0 && currentMediaIndex > 0) || 
                          (direction < 0 && currentMediaIndex < allMediaIds.length - 1);
      
      if(canNavigate){
        // Slide out completely
        img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
        img.style.transform = `translateX(${direction * 300}px)`;
        img.style.opacity = '0';
        
        setTimeout(() => {
          // Update index
          currentMediaIndex += (direction > 0 ? -1 : 1);
          currentImageId = allMediaIds[currentMediaIndex];
          
          // Position for slide in
          img.style.transition = 'none';
          img.style.transform = `translateX(${-direction * 100}px)`;
          
          loadCurrentImageNoReset();
          
          // Animate in
          setTimeout(() => {
            img.style.transition = 'transform 0.2s ease-out, opacity 0.15s ease-out';
            img.style.transform = 'translateX(0)';
            img.style.opacity = '1';
            updateNavigation();
            updatePhotoMarkersButton();
          }, 20);
        }, 150);
        return;
      }
    }
    
    // Return to center (swipe cancelled or at edge)
    img.style.transition = 'transform 0.25s ease-out, opacity 0.15s ease-out';
    img.style.transform = 'translateX(0)';
    img.style.opacity = '1';
    
    // Check for DOUBLE TAP (to zoom in)
    const now = Date.now();
    const tapDist = Math.sqrt(
      Math.pow(x - lastTapX, 2) + Math.pow(y - lastTapY, 2)
    );
    
    if(now - lastTapTime < 300 && tapDist < 30 && Math.abs(deltaX) < 10){
      // DOUBLE TAP - zoom to 2x centered on tap point
      e.preventDefault();
      doubleTapZoom(x, y);
      lastTapTime = 0;
      lastTapX = 0;
      lastTapY = 0;
    } else {
      lastTapTime = now;
      lastTapX = x;
      lastTapY = y;
    }
  }
  
  isSwiping = false;
  isPanning = false;
}

function doubleTapZoom(tapX, tapY){
  if(scale > 1){
    // Already zoomed - reset to fit
    resetTransform();
  } else {
    // Zoom to 2x, centered on tap point
    const content = document.getElementById('imageViewerContent');
    const img = document.getElementById('imageViewerImg');
    if(!content || !img) return;
    
    const rect = content.getBoundingClientRect();
    
    // Calculate offset to center on tap point
    const tapRelX = tapX - (rect.left + rect.width / 2);
    const tapRelY = tapY - (rect.top + rect.height / 2);
    
    // New scale
    scale = DOUBLE_TAP_SCALE;
    
    // Offset to keep tap point in same screen position
    offsetX = -tapRelX / scale;
    offsetY = -tapRelY / scale;
    
    // Clamp
    clampOffset();
  }
  
  applyTransform(true);
}

function getPinchDistance(touches){
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// Caption editing
function startEditCaption(){
  isEditingCaption=true;
  const item=ideas.find(x=>x.id===currentImageId);
  
  document.getElementById('imageNotes').value=item?.notes||'';
  
  // Show edit area, hide caption row
  document.querySelector('.image-caption-row').style.display='none';
  document.getElementById('imageNotesWrap').classList.add('editing');
  
  setTimeout(()=>{
    document.getElementById('imageNotes').focus();
  },100);
}

function saveCaption(){
  const notes=document.getElementById('imageNotes').value.trim();
  const item=ideas.find(x=>x.id===currentImageId);
  if(item){
    item.notes=notes;
    save();
    render();
    updateCaptionDisplay(item);
  }
  showImagePanel();
}

function cancelEditCaption(){
  showImagePanel();
}

function handleImageViewerClick(e){
  if(e.target.classList.contains('image-viewer')){
    closeImageViewer();
  }
}

function closeImageViewer(){
  if(isEditingCaption){
    saveCaption();
  }
  
  // Reset zoom/pan state
  resetTransform();
  isPinching=false;
  isPanning=false;
  isSwiping=false;
  isEditingCaption=false;
  
  const content=document.getElementById('imageViewerContent');
  content.removeEventListener('touchstart',handleTouchStart);
  content.removeEventListener('touchmove',handleTouchMove);
  content.removeEventListener('touchend',handleTouchEnd);
  
  currentImageId=null;
  allMediaIds=[];
  document.getElementById('imageViewer').classList.remove('show');
  document.getElementById('imageViewerImg').src='';
}

function shareImage(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  fetch(item.image)
    .then(res=>res.blob())
    .then(blob=>{
      const file=new File([blob],'droplit-sketch.jpg',{type:'image/jpeg'});
      if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){
        navigator.share({
          files:[file],
          title:'DropLit Sketch',
          text:item.notes||'Shared from DropLit'
        }).catch(()=>{});
      } else {
        window.open(item.image,'_blank');
        toast('Use browser menu to share','info');
      }
    });
}

function saveImageToGallery(){
  const item=ideas.find(x=>x.id===currentImageId);
  if(!item)return;
  
  const link=document.createElement('a');
  link.href=item.image;
  link.download='droplit-sketch-'+item.id+'.jpg';
  link.click();
  toast('Image saved!','success');
}

// ============================================
// AI FUNCTIONS (v0.8.2)
// ============================================

async function ocrImage() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('ocr', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'ocr', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const existingNotes = item.notes || '';
      const ocrText = data.result;
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- OCR ---\n' + ocrText;
      } else {
        item.notes = ocrText;
      }
      
      if (!item.text) {
        item.text = ocrText.substring(0, 200) + (ocrText.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Text extracted! ', 'success');
      showAIResult('OCR Result', ocrText);
    } else {
      toast(data.error || 'OCR failed', 'error');
    }
  } catch (error) {
    console.error('OCR error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

async function aiDescribe() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('describe', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'describe', image: item.image }),
    });

    const data = await response.json();

    hideAILoading();

    if (data.success && data.result) {
      const description = data.result;
      const existingNotes = item.notes || '';
      
      if (existingNotes) {
        item.notes = existingNotes + '\n\n--- AI Description ---\n' + description;
      } else {
        item.notes = description;
      }
      
      if (!item.text) {
        item.text = description.substring(0, 200) + (description.length > 200 ? '...' : '');
      }
      
      save();
      
      const notesArea = document.getElementById('imgNotes');
      if (notesArea) notesArea.value = item.notes;
      
      toast('Image analyzed! ', 'success');
      showAIResult('AI Description', description);
    } else {
      toast(data.error || 'Analysis failed', 'error');
    }
  } catch (error) {
    console.error('AI describe error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

// AI Result Modal
function showAIResult(title, text) {
  let modal = document.getElementById('aiResultModal');
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'aiResultModal';
    modal.className = 'overlay';
    modal.innerHTML = `
      <div class="modal" style="max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-title" id="aiResultTitle">AI Result</div>
        <div id="aiResultContent" style="flex: 1; overflow-y: auto; padding: 16px 0; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; max-height: 50vh;"></div>
        <div class="ai-result-actions">
          <button class="ai-result-btn primary" onclick="createDropFromResult()"> Create Drop</button>
          <button class="ai-result-btn secondary" onclick="shareResult()"> Share</button>
          <button class="ai-result-btn secondary" onclick="copyAIResult()"> Copy</button>
        </div>
        <div style="text-align: center; padding-top: 12px;">
          <button class="magic-cancel" onclick="closeAIResult()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('aiResultTitle').textContent = title;
  document.getElementById('aiResultContent').textContent = text;
  modal.classList.add('show');
}

function closeAIResult() {
  const modal = document.getElementById('aiResultModal');
  if (modal) modal.classList.remove('show');
}

function copyAIResult() {
  const content = document.getElementById('aiResultContent');
  if (content) {
    navigator.clipboard.writeText(content.textContent);
    toast('Copied!', 'success');
  }
}

// Create Drop from AI result
function createDropFromResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  const title = document.getElementById('aiResultTitle').textContent;
  
  // Determine category based on title
  let category = 'ideas';
  if (title.includes('Poem') || title.includes('')) category = 'ideas';
  if (title.includes('Speech') || title.includes('')) category = 'ideas';
  if (title.includes('Greeting') || title.includes('')) category = 'ideas';
  
  const idea = {
    id: Date.now(),
    text: text,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true // Mark as AI generated
  };
  
  ideas.push(idea);
  save();
  closeAIResult();
  render();
  counts();
  toast('Drop created! ', 'success');
}

// Share AI result
function shareResult() {
  const content = document.getElementById('aiResultContent');
  if (!content) return;
  
  const text = content.textContent;
  
  if (navigator.share) {
    navigator.share({
      text: text
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(text);
    toast('Copied! Paste to share', 'success');
  }
}

// ============================================
// AI MAGIC FUNCTIONS (v0.8.2)
// ============================================

let currentMagicType = 'poem';
let magicRecognition = null;
let isMagicRecording = false;
let magicPhotoData = null; // Store selected photo

const MAGIC_CONFIG = {
  poem: {
    title: ' Create Poem',
    subtitle: 'Tell me what it should be about',
    placeholder: 'Example: Birthday greeting for mom, she loves gardening and has 2 grandkids...',
    styles: [
      { id: 'classic', label: 'Classic' },
      { id: 'funny', label: ' Funny' },
      { id: 'tender', label: ' Tender' },
      { id: 'epic', label: ' Epic' }
    ]
  },
  greeting: {
    title: ' Create Greeting',
    subtitle: 'Who is it for and what occasion?',
    placeholder: 'Example: New Year greeting for colleagues, warm and professional...',
    styles: [
      { id: 'warm', label: ' Warm' },
      { id: 'funny', label: ' Funny' },
      { id: 'formal', label: ' Formal' },
      { id: 'poetic', label: ' Poetic' }
    ]
  },
  speech: {
    title: ' Create Speech',
    subtitle: 'What occasion? Who is the audience?',
    placeholder: 'Example: Wedding toast for my best friend, he loves fishing, we know each other 15 years...',
    styles: [
      { id: 'short', label: ' Short (1-2 min)' },
      { id: 'medium', label: ' Medium (3-5 min)' },
      { id: 'long', label: ' Long (7-10 min)' }
    ]
  }
};

function openMagic(type) {
  closePlusMenu();
  currentMagicType = type;
  magicPhotoData = null; // Reset photo
  
  const config = MAGIC_CONFIG[type];
  if (!config) return;
  
  // Update UI
  document.getElementById('magicTitle').textContent = config.title;
  document.getElementById('magicSubtitle').textContent = config.subtitle;
  document.getElementById('magicInput').placeholder = config.placeholder;
  document.getElementById('magicInput').value = '';
  
  // Reset photo UI
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Update styles
  const stylesContainer = document.getElementById('magicStyles');
  stylesContainer.innerHTML = config.styles.map((s, i) => 
    `<button class="magic-style${i === 0 ? ' active' : ''}" data-style="${s.id}">${s.label}</button>`
  ).join('');
  
  // Add click handlers to styles
  stylesContainer.querySelectorAll('.magic-style').forEach(btn => {
    btn.onclick = () => {
      stylesContainer.querySelectorAll('.magic-style').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });
  
  // Show modal
  document.getElementById('magicModal').classList.add('show');
  setTimeout(() => document.getElementById('magicInput').focus(), 100);
}

function closeMagic() {
  document.getElementById('magicModal').classList.remove('show');
  document.getElementById('magicPhotoMenu').classList.remove('show');
  if (isMagicRecording) {
    stopMagicVoice();
  }
}

// ============================================
// MAGIC PHOTO FUNCTIONS
// ============================================

function togglePhotoMenu() {
  const menu = document.getElementById('magicPhotoMenu');
  menu.classList.toggle('show');
}

function takeMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicCameraInput').click();
}

function chooseMagicPhoto() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  document.getElementById('magicPhotoInput').click();
}

function handleMagicPhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    magicPhotoData = e.target.result;
    showMagicPhotoPreview(magicPhotoData);
  };
  reader.readAsDataURL(file);
  
  // Reset input so same file can be selected again
  event.target.value = '';
}

function showMagicPhotoPreview(dataUrl) {
  document.getElementById('magicPhotoImg').src = dataUrl;
  document.getElementById('magicPhotoPreview').style.display = 'block';
  document.getElementById('magicPhotoBtn').classList.add('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Photo added ';
  document.getElementById('magicInputLabel').textContent = 'Add details about this photo (optional)';
}

function removeMagicPhoto() {
  magicPhotoData = null;
  document.getElementById('magicPhotoPreview').style.display = 'none';
  document.getElementById('magicPhotoBtn').classList.remove('has-photo');
  document.getElementById('magicPhotoBtnText').textContent = 'Add photo (optional)';
  document.getElementById('magicInputLabel').textContent = 'Add details (optional if photo added)';
}

// Drops Picker
function openDropsPicker() {
  document.getElementById('magicPhotoMenu').classList.remove('show');
  
  // Get all photo drops
  const photoDrops = ideas.filter(i => i.image);
  const grid = document.getElementById('dropsPickerGrid');
  
  if (photoDrops.length === 0) {
    grid.innerHTML = '<div class="drops-picker-empty">No photo drops yet.<br>Take some photos first! </div>';
  } else {
    grid.innerHTML = photoDrops.map(drop => `
      <div class="drops-picker-item" onclick="selectDropPhoto('${drop.id}')">
        <img src="${drop.image}" alt="Drop photo">
      </div>
    `).join('');
  }
  
  document.getElementById('dropsPicker').classList.add('show');
}

function closeDropsPicker() {
  document.getElementById('dropsPicker').classList.remove('show');
}

function selectDropPhoto(id) {
  const drop = ideas.find(i => i.id == id);
  if (drop && drop.image) {
    magicPhotoData = drop.image;
    showMagicPhotoPreview(drop.image);
  }
  closeDropsPicker();
}

function toggleMagicVoice() {
  if (isMagicRecording) {
    stopMagicVoice();
  } else {
    startMagicVoice();
  }
}

function startMagicVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    toast('Speech not supported', 'error');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  magicRecognition = new SpeechRecognition();
  magicRecognition.continuous = false; // Single phrase, no duplicates
  magicRecognition.interimResults = true;
  magicRecognition.maxAlternatives = 1;
  magicRecognition.lang = 'ru-RU';
  
  const inputEl = document.getElementById('magicInput');
  const existingText = inputEl.value;
  let finalTranscript = '';
  
  magicRecognition.onresult = (e) => {
    let interim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        finalTranscript += e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    // Show interim while speaking
    document.getElementById('magicVoiceText').textContent = interim || finalTranscript || 'Listening...';
  };
  
  magicRecognition.onerror = (e) => {
    if (e.error === 'no-speech') toast('No speech detected', 'warning');
    stopMagicVoice();
  };
  
  magicRecognition.onend = () => {
    // Append final result to existing text
    if (finalTranscript) {
      inputEl.value = existingText + (existingText ? ' ' : '') + finalTranscript.trim();
    }
    stopMagicVoice();
  };
  
  magicRecognition.start();
  isMagicRecording = true;
  document.getElementById('magicVoiceBtn').classList.add('recording');
  document.getElementById('magicVoiceText').textContent = 'Listening...';
}

function stopMagicVoice() {
  if (magicRecognition) {
    magicRecognition.stop();
    magicRecognition = null;
  }
  isMagicRecording = false;
  document.getElementById('magicVoiceBtn').classList.remove('recording');
  document.getElementById('magicVoiceText').textContent = 'Tap to speak';
}

async function generateMagic() {
  const input = document.getElementById('magicInput').value.trim();
  
  // Need either text or photo
  if (!input && !magicPhotoData) {
    toast('Add a photo or describe what you want', 'error');
    return;
  }
  
  const activeStyle = document.querySelector('.magic-style.active');
  const style = activeStyle ? activeStyle.dataset.style : 'classic';
  
  // Get context
  const context = {
    timeOfDay: getTimeOfDay(),
    location: null
  };
  
  // Close modal and show loading
  closeMagic();
  showAILoading(currentMagicType, false);
  
  try {
    const requestBody = {
      action: currentMagicType,
      text: input,
      style: style,
      context: context
    };
    
    // Add photo if present
    if (magicPhotoData) {
      requestBody.image = magicPhotoData;
    }
    
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody),
    });
    
    const data = await response.json();
    
    hideAILoading();
    
    if (data.success && data.result) {
      const titles = {
        poem: ' Your Poem',
        greeting: ' Your Greeting',
        speech: ' Your Speech'
      };
      
      showAIResult(titles[currentMagicType] || 'AI Result', data.result);
    } else {
      toast(data.error || 'Generation failed', 'error');
    }
  } catch (error) {
    console.error('Magic error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

// ============================================
// AI LOADING INDICATOR (compact, inside modal)
// ============================================

const AI_LOADING_LABELS = {
  poem: 'Creating poem',
  greeting: 'Crafting greeting',
  speech: 'Writing speech',
  summarize: 'Summarizing',
  expand: 'Expanding',
  rewrite: 'Rewriting',
  enhance: 'Enhancing',
  translate: 'Translating',
  tasks: 'Extracting tasks',
  ocr: 'Reading text',
  describe: 'Analyzing image',
  default: 'Processing'
};

let currentLoadingModal = null;

function showAILoading(action, useModal2 = true) {
  const label = AI_LOADING_LABELS[action] || AI_LOADING_LABELS.default;
  
  const loadingHTML = `
    <div class="ai-loading-inline">
      <div class="ai-loading-dots">
        <span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="ai-loading-label">${label}...</div>
    </div>
  `;
  
  if (useModal2) {
    // Use AI Result Modal 2 (for AI Tools)
    currentLoadingModal = 'modal2';
    document.getElementById('aiResult2Title').textContent = ' ' + label;
    document.getElementById('aiResult2Text').innerHTML = loadingHTML;
    document.querySelector('.ai-result-actions').style.display = 'none';
    document.getElementById('aiResult2Category').style.display = 'none';
    document.getElementById('aiResultModal2').classList.add('show');
  } else {
    // Use simple toast for Magic/OCR/Describe
    currentLoadingModal = 'toast';
    toast(label + '...', 'info');
  }
}

function hideAILoading() {
  if (currentLoadingModal === 'modal2') {
    // Restore action buttons
    document.querySelector('.ai-result-actions').style.display = 'flex';
  }
  currentLoadingModal = null;
}

function getTimeOfDay() {
  const hour = new Date().getHours();
  if (hour < 6) return 'night';
  if (hour < 12) return 'morning';
  if (hour < 18) return 'afternoon';
  return 'evening';
}

// ============================================
// AI TOOLS FOR TEXT DROPS (v0.8.2)
// ============================================

let aiToolsDropId = null;
let aiToolsResult = null;
let aiToolsSuggestedCategory = null;

function openAITools(id) {
  const drop = ideas.find(x => x.id === id);
  if (!drop || !drop.text) {
    toast('No text to process', 'error');
    return;
  }
  
  aiToolsDropId = id;
  
  // Show preview
  const previewText = drop.text.length > 200 
    ? drop.text.substring(0, 200) + '...' 
    : drop.text;
  document.getElementById('aiToolsPreviewText').textContent = previewText;
  
  // Show current category
  const catName = CATS[drop.category]?.single || drop.category.toUpperCase();
  document.getElementById('aiToolsCurrentCategory').textContent = catName;
  
  document.getElementById('aiToolsModal').classList.add('show');
}

function closeAITools() {
  document.getElementById('aiToolsModal').classList.remove('show');
  // Don't reset aiToolsDropId here - it's needed for Replace/Create Drop actions
}

async function runAITool(tool) {
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  const checkCategory = document.getElementById('aiToolsCheckCategory').checked;
  const removeLineBreaks = document.getElementById('aiToolsRemoveLineBreaks').checked;
  
  // Close tools modal and show loading overlay
  closeAITools();
  showAILoading(tool);
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: tool,
        text: drop.text,
        checkCategory: checkCategory
      }),
    });
    
    const data = await response.json();
    
    hideAILoading();
    
    if (data.success && data.result) {
      // Parse result (may be JSON or plain text)
      let resultText = data.result;
      let suggestedCat = null;
      
      // Try to extract JSON from response (may have markdown wrapper)
      let jsonStr = resultText;
      const jsonMatch = resultText.match(/```json\s*([\s\S]*?)\s*```/);
      if (jsonMatch) {
        jsonStr = jsonMatch[1];
      } else if (resultText.trim().startsWith('{')) {
        jsonStr = resultText.trim();
      }
      
      try {
        // Try to parse as JSON
        const parsed = JSON.parse(jsonStr);
        if (tool === 'summarize' && parsed.summary) {
          resultText = parsed.summary;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'expand' && parsed.expanded) {
          resultText = parsed.expanded;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'rewrite' && parsed.rewritten) {
          resultText = parsed.rewritten;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'enhance' && parsed.enhanced) {
          resultText = parsed.enhanced;
          suggestedCat = parsed.suggestedCategory;
        } else if (tool === 'tasks' && parsed.tasks) {
          // Create task drops
          createTaskDrops(parsed.tasks);
          return;
        } else {
          // JSON parsed but no expected field - use first text value found
          const textValue = parsed.summary || parsed.expanded || parsed.rewritten || parsed.enhanced || parsed.result || parsed.text;
          if (textValue) {
            resultText = textValue;
            suggestedCat = parsed.suggestedCategory;
          }
          // else keep original resultText (will be cleaned below)
        }
      } catch (e) {
        // Not JSON, use as plain text
        if (tool === 'tasks') {
          // Parse numbered list
          const tasks = resultText.split('\n')
            .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
            .filter(line => line.length > 0);
          createTaskDrops(tasks);
          return;
        }
        // For other tools, clean up any JSON-like artifacts
        if (resultText.trim().startsWith('{') || resultText.trim().startsWith('```')) {
          // Failed to parse, try to extract text manually
          const textMatch = resultText.match(/"(?:summary|expanded|rewritten|text)":\s*"([^"]+)"/);
          if (textMatch) {
            resultText = textMatch[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
          }
        }
      }
      
      // T1 FIX: Remove extra line breaks if option is checked
      if (removeLineBreaks && tool !== 'tasks') {
        resultText = resultText
          .replace(/\n+/g, ' ')      // Replace newlines with space
          .replace(/\s{2,}/g, ' ')   // Replace multiple spaces with single
          .trim();
      }
      
      // Show result modal
      showAIResult2(tool, resultText, drop.category, suggestedCat);
      
    } else {
      toast(data.error || 'Processing failed', 'error');
    }
  } catch (error) {
    console.error('AI Tools error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

// B2 FIX: Store pending tasks for confirmation
let pendingTasks = [];

function createTaskDrops(tasks) {
  if (!tasks || tasks.length === 0) {
    toast('No tasks found', 'warning');
    return;
  }
  
  // Show confirmation modal instead of creating immediately
  pendingTasks = tasks;
  showTasksConfirmModal(tasks);
}

function showTasksConfirmModal(tasks) {
  document.getElementById('tasksCount').textContent = tasks.length;
  document.getElementById('tasksCountBtn').textContent = tasks.length;
  
  const listEl = document.getElementById('tasksPreviewList');
  listEl.innerHTML = tasks.map((task, i) => `
    <div class="tasks-preview-item">
      <span class="tasks-preview-num">${i + 1}</span>
      <span class="tasks-preview-text">${task}</span>
    </div>
  `).join('');
  
  document.getElementById('tasksConfirmModal').classList.add('show');
}

function closeTasksConfirm() {
  document.getElementById('tasksConfirmModal').classList.remove('show');
  pendingTasks = [];
  aiToolsDropId = null;
}

function confirmCreateTasks() {
  if (!pendingTasks || pendingTasks.length === 0) {
    closeTasksConfirm();
    return;
  }
  
  const createdIds = [];
  
  pendingTasks.forEach(taskText => {
    const id = Date.now() + Math.random();
    const idea = {
      id: id,
      text: taskText,
      category: 'tasks',
      timestamp: new Date().toISOString(),
      date: new Date().toLocaleDateString('ru-RU'),
      time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
      aiGenerated: true,
      sourceDropId: aiToolsDropId
    };
    ideas.push(idea);
    createdIds.push(id);
  });
  
  saveUndo('createTasks', { taskIds: createdIds });
  
  save();
  render();
  counts();
  toast(`Created ${pendingTasks.length} tasks! `, 'success');
  
  closeTasksConfirm();
}

// ============================================
// I1 FIX: TRANSLATE FUNCTIONS
// ============================================

function openTranslateModal() {
  closeAITools();
  document.getElementById('translateModal').classList.add('show');
}

function closeTranslateModal() {
  document.getElementById('translateModal').classList.remove('show');
}

async function runTranslate(targetLang) {
  closeTranslateModal();
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (!drop) {
    toast('Drop not found', 'error');
    return;
  }
  
  showAILoading('translate');
  
  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'translate',
        text: drop.text,
        targetLang: targetLang
      }),
    });
    
    const data = await response.json();
    hideAILoading();
    
    if (data.success && data.result) {
      showAIResult2('translate', data.result, drop.category, null);
    } else {
      toast(data.error || 'Translation failed', 'error');
    }
  } catch (error) {
    console.error('Translate error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  }
}

function showAIResult2(tool, text, currentCategory, suggestedCategory) {
  aiToolsResult = text;
  aiToolsSuggestedCategory = suggestedCategory;
  
  const titles = {
    summarize: ' Summary',
    expand: ' Expanded',
    rewrite: ' Rewritten',
    enhance: ' Enhanced',
    translate: ' Translated'
  };
  
  document.getElementById('aiResult2Title').textContent = titles[tool] || ' Result';
  document.getElementById('aiResult2Text').textContent = text;
  
  // Show action buttons (may have been hidden during loading)
  document.querySelector('.ai-result-actions').style.display = 'flex';
  
  // Show category suggestion if available
  const catSection = document.getElementById('aiResult2Category');
  if (suggestedCategory && suggestedCategory !== currentCategory) {
    const currentName = CATS[currentCategory]?.single || currentCategory.toUpperCase();
    const suggestedName = CATS[suggestedCategory]?.single || suggestedCategory.toUpperCase();
    
    document.getElementById('aiResult2CurrentCat').textContent = currentName;
    document.getElementById('aiResult2SuggestedCat').textContent = suggestedName;
    catSection.style.display = 'block';
  } else {
    catSection.style.display = 'none';
  }
  
  document.getElementById('aiResultModal2').classList.add('show');
}

function closeAIResult2() {
  document.getElementById('aiResultModal2').classList.remove('show');
  aiToolsResult = null;
  aiToolsSuggestedCategory = null;
  aiToolsDropId = null; // Reset here when user closes without action
}

function replaceOriginal() {
  if (!aiToolsDropId || !aiToolsResult) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    // Save for undo
    saveUndo('replace', { id: drop.id, originalText: drop.text });
    
    // Save original in drop too
    if (!drop.originalText) {
      drop.originalText = drop.text;
    }
    drop.text = aiToolsResult;
    save();
    render();
    toast('Replaced! ', 'success');
  }
  
  closeAIResult2();
  aiToolsDropId = null;
}

function createNewDrop() {
  if (!aiToolsResult) return;
  
  const sourceDrop = ideas.find(x => x.id === aiToolsDropId);
  const category = aiToolsSuggestedCategory || sourceDrop?.category || 'ideas';
  
  const idea = {
    id: Date.now(),
    text: aiToolsResult,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true,
    sourceDropId: aiToolsDropId
  };
  
  ideas.push(idea);
  save();
  render();
  counts();
  toast('Drop created! ', 'success');
  
  closeAIResult2();
  aiToolsDropId = null;
}

function copyResult2() {
  if (aiToolsResult) {
    navigator.clipboard.writeText(aiToolsResult);
    toast('Copied!', 'success');
  }
}

function keepCategory() {
  aiToolsSuggestedCategory = null;
  document.getElementById('aiResult2Category').style.display = 'none';
}

function acceptCategory() {
  if (!aiToolsDropId || !aiToolsSuggestedCategory) return;
  
  const drop = ideas.find(x => x.id === aiToolsDropId);
  if (drop) {
    drop.category = aiToolsSuggestedCategory;
    save();
    counts();
  }
  
  document.getElementById('aiResult2Category').style.display = 'none';
  toast('Category updated! ', 'success');
}

function deleteFromViewer(){
  if(!currentImageId)return;
  if(confirm('Delete this image?')){
    ideas=ideas.filter(x=>x.id!==currentImageId);
    save();
    closeImageViewer();
    render();
    counts();
    toast('Deleted','info');
  }
}


function counts(){
  try{
    const validIdeas=ideas.filter(x=>x&&x.id&&x.category);
    const cntAll=document.getElementById('cntAll');
    const cntToday=document.getElementById('cntToday');
    const cnt7d=document.getElementById('cnt7d');
    
    if(cntAll)cntAll.textContent=validIdeas.length;
    if(cntToday)cntToday.textContent=validIdeas.filter(x=>x.date&&isToday(x.date)).length;
    if(cnt7d)cnt7d.textContent=validIdeas.filter(x=>x.date&&inDays(x.date,7)).length;
    
    // Count ALL items in each category
    for(const k of Object.keys(CATS)){
      const el=document.getElementById('cnt'+k.charAt(0).toUpperCase()+k.slice(1));
      if(el)el.textContent=validIdeas.filter(x=>x.category===k).length;
    }
  }catch(err){}
}

document.getElementById('timeRow').addEventListener('click',e=>{
  const b=e.target.closest('.time-btn');if(!b)return;
  document.querySelectorAll('.time-btn').forEach(x=>x.classList.remove('active'));
  if(b.dataset.time!=='all')b.classList.add('active');
  curTime=b.dataset.time;curCat='all';activeCardId=null;
  document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));
  render();counts();
});

document.getElementById('cats').addEventListener('click',e=>{
  const c=e.target.closest('.cat');if(!c)return;
  if(c.classList.contains('active')){c.classList.remove('active');curCat='all';}
  else{document.querySelectorAll('.cat').forEach(x=>x.classList.remove('active'));c.classList.add('active');curCat=c.dataset.category;}
  activeCardId=null;render();
});

function addCatPrompt(){document.getElementById('addCatModal').classList.add('show');}
function closeAddCatModal(){document.getElementById('addCatModal').classList.remove('show');}

function exportAll(){
  closeSettings();
  if(!ideas.length){toast('Nothing to export','warning');return;}
  const grp={};for(const i of ideas){if(!grp[i.category])grp[i.category]=[];grp[i.category].push(i);}
  let md='# DropLit Export\n'+new Date().toLocaleDateString('ru-RU')+' | '+ideas.length+' ideas\n\n';
  for(const[k,arr]of Object.entries(grp)){
    md+='## '+CATS[k].name+' ('+arr.length+')\n';
    for(const i of arr)md+='- ['+i.date+' '+i.time+'] '+i.text+'\n';
    md+='\n';
  }
  md+='---\nExported from DropLit v0.8.2';
  document.getElementById('exportBox').textContent=md;
  document.getElementById('exportModal').classList.add('show');
}

function closeExportModal(){document.getElementById('exportModal').classList.remove('show');}
function copyExport(){navigator.clipboard.writeText(document.getElementById('exportBox').textContent);toast('Copied!','success');closeExportModal();}
function openAbout(){document.getElementById('aboutModal').classList.add('show');}
function closeAbout(){document.getElementById('aboutModal').classList.remove('show');}
function openSettings(){document.getElementById('settingsModal').classList.add('show');}
function closeSettings(){document.getElementById('settingsModal').classList.remove('show');}

// ============================================
// MAIN MENU
// ============================================

function openMainMenu() {
  document.getElementById('mainMenu').classList.add('show');
  updateUndoList();
  updateTokenBalance();
  initFontSize(); // Update font size buttons state
}

function closeMainMenu() {
  document.getElementById('mainMenu').classList.remove('show');
}

// ============================================
// UNDO SYSTEM
// ============================================

const MAX_UNDO_HISTORY = 10;
let undoHistory = JSON.parse(localStorage.getItem('droplit_undo') || '[]');

const UNDO_ICONS = {
  delete: '',
  createTasks: '',
  replace: '',
  edit: '',
  merge: '',
  category: '',
  create: ''
};

const UNDO_LABELS = {
  delete: 'Deleted',
  createTasks: 'Created tasks',
  replace: 'Replaced text',
  edit: 'Edited',
  merge: 'Merged drops',
  category: 'Changed category',
  create: 'Created'
};

function saveUndo(action, data) {
  const entry = {
    action,
    data,
    timestamp: Date.now()
  };
  
  undoHistory.unshift(entry);
  if (undoHistory.length > MAX_UNDO_HISTORY) {
    undoHistory = undoHistory.slice(0, MAX_UNDO_HISTORY);
  }
  
  localStorage.setItem('droplit_undo', JSON.stringify(undoHistory));
}

function performUndo(index) {
  const entry = undoHistory[index];
  if (!entry) return;
  
  switch (entry.action) {
    case 'delete':
      // Restore deleted drop
      ideas.push(entry.data);
      toast('Drop restored! ', 'success');
      break;
      
    case 'createTasks':
      // Remove created tasks
      const taskIds = entry.data.taskIds;
      ideas = ideas.filter(i => !taskIds.includes(i.id));
      toast(`${taskIds.length} tasks removed! `, 'success');
      break;
      
    case 'replace':
      // Restore original text
      const dropR = ideas.find(i => i.id === entry.data.id);
      if (dropR) {
        dropR.text = entry.data.originalText;
        toast('Text restored! ', 'success');
      }
      break;
      
    case 'edit':
      // Restore previous text
      const dropE = ideas.find(i => i.id === entry.data.id);
      if (dropE) {
        dropE.text = entry.data.previousText;
        toast('Edit undone! ', 'success');
      }
      break;
      
    case 'merge':
      // Remove merged drop
      ideas = ideas.filter(i => i.id !== entry.data.mergedId);
      toast('Merge undone! ', 'success');
      break;
      
    case 'category':
      // Restore previous category
      const dropC = ideas.find(i => i.id === entry.data.id);
      if (dropC) {
        dropC.category = entry.data.previousCategory;
        toast('Category restored! ', 'success');
      }
      break;
      
    case 'create':
      // Remove created drop
      ideas = ideas.filter(i => i.id !== entry.data.id);
      toast('Creation undone! ', 'success');
      break;
  }
  
  // Remove from history
  undoHistory.splice(index, 1);
  localStorage.setItem('droplit_undo', JSON.stringify(undoHistory));
  
  save();
  render();
  counts();
  updateUndoList();
}

function updateUndoList() {
  const list = document.getElementById('undoList');
  const mainBtn = document.getElementById('undoMainBtn');
  const toggleBtn = document.getElementById('undoToggleBtn');
  const lastInfo = document.getElementById('undoLastInfo');
  
  if (undoHistory.length === 0) {
    mainBtn.disabled = true;
    mainBtn.innerHTML = ' Nothing to Undo';
    lastInfo.textContent = '';
    toggleBtn.style.display = 'none';
    list.innerHTML = '';
    list.classList.remove('show');
    return;
  }
  
  // Enable main button
  mainBtn.disabled = false;
  const lastEntry = undoHistory[0];
  const lastLabel = UNDO_LABELS[lastEntry.action] || 'Action';
  const lastPreview = getUndoPreview(lastEntry);
  mainBtn.innerHTML = ` Undo: ${lastLabel}`;
  
  // Show last action info
  lastInfo.textContent = `${lastPreview}  ${getTimeAgo(lastEntry.timestamp)}`;
  
  // Show toggle button if more than 1 item
  if (undoHistory.length > 1) {
    toggleBtn.style.display = 'block';
    toggleBtn.textContent = `Show all history (${undoHistory.length})`;
  } else {
    toggleBtn.style.display = 'none';
    list.classList.remove('show');
  }
  
  // Build list (hidden by default)
  list.innerHTML = undoHistory.slice(1).map((entry, index) => {
    const icon = UNDO_ICONS[entry.action] || '';
    const label = UNDO_LABELS[entry.action] || 'Action';
    const time = getTimeAgo(entry.timestamp);
    const preview = getUndoPreview(entry);
    
    return `
      <div class="undo-item">
        <div class="undo-item-icon">${icon}</div>
        <div class="undo-item-info">
          <div class="undo-item-title">${label}: ${preview}</div>
          <div class="undo-item-time">${time}</div>
        </div>
        <button class="undo-item-btn" onclick="performUndo(${index + 1})">Undo</button>
      </div>
    `;
  }).join('');
}

function toggleUndoList() {
  const list = document.getElementById('undoList');
  const toggleBtn = document.getElementById('undoToggleBtn');
  const isShown = list.classList.toggle('show');
  toggleBtn.textContent = isShown 
    ? `Hide history (${undoHistory.length})` 
    : `Show all history (${undoHistory.length})`;
}

function undoLast() {
  if (undoHistory.length > 0) {
    performUndo(0);
  }
}

function getUndoPreview(entry) {
  switch (entry.action) {
    case 'delete':
      return truncateText(entry.data.text || 'Drop', 25);
    case 'createTasks':
      return `${entry.data.taskIds.length} tasks`;
    case 'replace':
    case 'edit':
      return truncateText(entry.data.previousText || entry.data.originalText || 'text', 25);
    case 'merge':
      return `${entry.data.count} drops`;
    case 'category':
      return ` ${entry.data.newCategory}`;
    case 'create':
      return truncateText(entry.data.text || 'Drop', 25);
    default:
      return '';
  }
}

function truncateText(text, maxLen) {
  if (!text) return '';
  text = text.replace(/\n/g, ' ').trim();
  if (text.length <= maxLen) return text;
  return text.substring(0, maxLen) + '...';
}

function getTimeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'Just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes} min ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} hr ago`;
  const days = Math.floor(hours / 24);
  return `${days} day${days > 1 ? 's' : ''} ago`;
}

// ============================================
// SEARCH
// ============================================

let searchMode = false;
let searchQuery = '';

function performSearch() {
  const query = document.getElementById('menuSearchInput').value.trim().toLowerCase();
  if (!query) {
    clearSearch();
    return;
  }
  
  searchMode = true;
  searchQuery = query;
  closeMainMenu();
  
  // Show search indicator
  document.getElementById('searchIndicator').style.display = 'flex';
  document.getElementById('searchQueryDisplay').textContent = query;
  
  // Filter ideas by search query
  render();
  
  const count = filtered().length;
  toast(`Found ${count} drop${count !== 1 ? 's' : ''}`, 'info');
}

function clearSearch() {
  searchMode = false;
  searchQuery = '';
  document.getElementById('menuSearchInput').value = '';
  document.getElementById('searchIndicator').style.display = 'none';
  render();
}

let voiceSearchRecognition = null;

function startVoiceSearch() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    toast('Voice search not supported', 'error');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceSearchRecognition = new SpeechRecognition();
  voiceSearchRecognition.continuous = false;
  voiceSearchRecognition.interimResults = false;
  voiceSearchRecognition.lang = navigator.language || 'en-US';
  
  voiceSearchRecognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    document.getElementById('menuSearchInput').value = transcript;
    performSearch();
  };
  
  voiceSearchRecognition.onerror = () => {
    toast('Voice search failed', 'error');
  };
  
  voiceSearchRecognition.start();
  toast('Listening...', 'info');
}

// ============================================
// SETTINGS FUNCTIONS
// ============================================

function toggleDarkMode() {
  const toggle = document.getElementById('darkModeToggle');
  const isDark = toggle.classList.toggle('active');
  document.body.classList.toggle('dark-mode', isDark);
  localStorage.setItem('droplit_darkmode', isDark);
}

function setFontSize(size) {
  // Remove all font size classes
  document.body.classList.remove('font-small', 'font-normal', 'font-large');
  // Add selected
  document.body.classList.add('font-' + size);
  
  // Update buttons
  document.querySelectorAll('.font-size-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
  
  // Save preference
  localStorage.setItem('droplit_fontsize', size);
  
  toast('Font size: ' + size.charAt(0).toUpperCase() + size.slice(1), 'success');
}

function initFontSize() {
  const saved = localStorage.getItem('droplit_fontsize') || 'normal';
  document.body.classList.add('font-' + saved);
  
  // Update buttons when menu opens
  document.querySelectorAll('.font-size-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === saved);
  });
}

function exportData() {
  const data = {
    version: '0.8.2',
    exported: new Date().toISOString(),
    ideas: ideas
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `droplit-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('Data exported! ', 'success');
}

function handleImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.ideas && Array.isArray(data.ideas)) {
        if (confirm(`Import ${data.ideas.length} drops? This will add to existing data.`)) {
          ideas = ideas.concat(data.ideas);
          save();
          render();
          counts();
          toast(`Imported ${data.ideas.length} drops! `, 'success');
        }
      } else {
        toast('Invalid backup file', 'error');
      }
    } catch (err) {
      toast('Failed to parse file', 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function clearAllData() {
  if (confirm('Delete ALL drops? This cannot be undone!')) {
    if (confirm('Are you REALLY sure? All data will be lost!')) {
      ideas = [];
      undoHistory = [];
      save();
      localStorage.removeItem('droplit_undo');
      render();
      counts();
      updateUndoList();
      toast('All data cleared', 'success');
    }
  }
}

// ============================================
// TOKEN BALANCE
// ============================================

async function updateTokenBalance() {
  // For now, show placeholder - will connect to real API later
  document.getElementById('tokenBalance').textContent = ' Free Beta';
  document.getElementById('tokenUsage').textContent = 'Unlimited during beta';
  
  // TODO: Fetch real balance from API
  // try {
  //   const response = await fetch(AI_API_URL + '?action=balance');
  //   const data = await response.json();
  //   document.getElementById('tokenBalance').textContent = formatTokens(data.balance);
  //   document.getElementById('tokenUsage').textContent = `Used: ${formatTokens(data.used)}`;
  // } catch (e) {
  //   document.getElementById('tokenBalance').textContent = 'N/A';
  // }
}

// ============================================
// PHOTO AI TOOLS
// ============================================

let photoAIResult = null;
let photoAIType = null;

function openPhotoAI() {
  document.getElementById('photoAIModal').classList.add('show');
}

function closePhotoAI() {
  document.getElementById('photoAIModal').classList.remove('show');
}

async function runPhotoAI(type) {
  closePhotoAI();
  photoAIType = type;
  
  if (type === 'ocr') {
    await ocrImageNew();
  } else if (type === 'describe') {
    await aiDescribeNew();
  }
}

async function ocrImageNew() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('ocr', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'ocr', image: item.image }),
    });

    const data = await response.json();
    hideAILoading();

    if (data.success && data.result) {
      photoAIResult = data.result;
      showPhotoAIResult(' Extracted Text', photoAIResult);
    } else {
      toast(data.error || 'OCR failed', 'error');
    }
  } catch (error) {
    console.error('OCR error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

async function aiDescribeNew() {
  if (aiProcessing) {
    toast('AI is processing...', 'info');
    return;
  }
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item || !item.image) {
    toast('No image to process', 'error');
    return;
  }

  aiProcessing = true;
  showAILoading('describe', false);

  try {
    const response = await fetch(AI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'describe', image: item.image }),
    });

    const data = await response.json();
    hideAILoading();

    if (data.success && data.result) {
      photoAIResult = data.result;
      showPhotoAIResult(' Image Description', photoAIResult);
    } else {
      toast(data.error || 'Analysis failed', 'error');
    }
  } catch (error) {
    console.error('AI describe error:', error);
    hideAILoading();
    toast('Connection error', 'error');
  } finally {
    aiProcessing = false;
  }
}

function showPhotoAIResult(title, text) {
  document.getElementById('photoAIResultTitle').textContent = title;
  document.getElementById('photoAIResultText').textContent = text;
  document.getElementById('photoAIResult').classList.add('show');
}

function closePhotoAIResult() {
  document.getElementById('photoAIResult').classList.remove('show');
  photoAIResult = null;
  photoAIType = null;
}

function savePhotoAIToCaption() {
  if (!photoAIResult || !currentImageId) return;
  
  const item = ideas.find(x => x.id === currentImageId);
  if (item) {
    // Truncate to 200 chars for caption
    const MAX_CAPTION = 200;
    if (photoAIResult.length > MAX_CAPTION) {
      item.notes = photoAIResult.substring(0, MAX_CAPTION) + '...';
    } else {
      item.notes = photoAIResult;
    }
    save();
    updateImageViewerCaption();
    render();
    toast('Caption updated! ', 'success');
  }
  closePhotoAIResult();
}

function savePhotoAIToNewDrop() {
  if (!photoAIResult) return;
  
  const sourceItem = ideas.find(x => x.id === currentImageId);
  const category = detectCat(photoAIResult);
  
  const idea = {
    id: Date.now(),
    text: photoAIResult,
    category: category,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('ru-RU'),
    time: new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}),
    aiGenerated: true,
    sourceImageId: currentImageId
  };
  
  ideas.push(idea);
  save();
  render();
  counts();
  
  toast('New drop created! ', 'success');
  closePhotoAIResult();
}

function copyPhotoAIResult() {
  if (!photoAIResult) return;
  
  navigator.clipboard.writeText(photoAIResult);
  toast('Copied! ', 'success');
  closePhotoAIResult();
}

function updateImageViewerCaption() {
  const item = ideas.find(x => x.id === currentImageId);
  if (item) {
    const captionDisplay = document.getElementById('imageCaptionDisplay');
    if (captionDisplay) {
      captionDisplay.textContent = item.notes || '';
    }
  }
}

// ============================================
// PHOTO MARKERS
// ============================================

function openPhotoMarkers() {
  if (!currentImageId) return;
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item) return;
  
  // Build markers grid
  const grid = document.getElementById('photoMarkersGrid');
  grid.innerHTML = Object.keys(MARKERS).map(mk => {
    const isActive = item.markers && item.markers.includes(mk);
    return `<button class="photo-marker-btn${isActive ? ' active' : ''}" onclick="togglePhotoMarker('${mk}')">${MARKERS[mk]}</button>`;
  }).join('');
  
  document.getElementById('photoMarkersModal').classList.add('show');
}

function closePhotoMarkersModal() {
  document.getElementById('photoMarkersModal').classList.remove('show');
}

function togglePhotoMarker(marker) {
  if (!currentImageId) return;
  
  const item = ideas.find(x => x.id === currentImageId);
  if (!item) return;
  
  if (!item.markers) item.markers = [];
  
  const idx = item.markers.indexOf(marker);
  if (idx === -1) {
    item.markers.push(marker);
  } else {
    item.markers.splice(idx, 1);
  }
  
  save();
  render();
  updatePhotoMarkersButton();
  
  // Update button state in modal
  const btns = document.querySelectorAll('.photo-marker-btn');
  btns.forEach(btn => {
    const mk = Object.keys(MARKERS).find(k => MARKERS[k] === btn.textContent);
    if (mk) {
      btn.classList.toggle('active', item.markers.includes(mk));
    }
  });
}

function updatePhotoMarkersButton() {
  const item = ideas.find(x => x.id === currentImageId);
  const btn = document.getElementById('imageViewerMarkers');
  if (!btn) return;
  
  if (item && item.markers && item.markers.length > 0) {
    btn.innerHTML = item.markers.map(m => MARKERS[m] || '').join('');
    btn.classList.add('has-markers');
  } else {
    btn.innerHTML = '';
    btn.classList.remove('has-markers');
  }
}

function toast(m,t='info'){
  const w=document.getElementById('toastWrap'),el=document.createElement('div');
  el.className='toast '+t;
  el.innerHTML=({success:'OK',warning:'!',error:'X',info:'i'})[t]+' '+m;
  w.appendChild(el);
  setTimeout(()=>el.classList.add('show'),10);
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),300);},2500);
}

function updateNet(){document.getElementById('netBanner').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);

document.addEventListener('DOMContentLoaded',()=>{
  initSR();render();counts();updateNet();
  setTimeout(scrollToBottomInstant,50);
  
  // Initialize dark mode
  if (localStorage.getItem('droplit_darkmode') === 'true') {
    document.getElementById('darkModeToggle')?.classList.add('active');
    document.body.classList.add('dark-mode');
  }
  
  // Initialize font size
  const savedFontSize = localStorage.getItem('droplit_fontsize') || 'normal';
  document.body.classList.add('font-' + savedFontSize);
});
</script>
</body>
</html>
