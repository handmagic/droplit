<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Recorder + Player (NO MODAL)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #F5F5F4; 
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .header {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      padding: 20px;
      text-align: center;
      color: white;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .body { padding: 24px; }
    .time {
      text-align: center;
      font-size: 3rem;
      font-weight: 700;
      margin: 20px 0;
      font-variant-numeric: tabular-nums;
    }
    .main-btn {
      width: 100%;
      padding: 20px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      margin-bottom: 20px;
      transition: all 0.15s;
    }
    .main-btn.ready { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; }
    .main-btn.recording { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; }
    .main-btn.paused { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; }
    .main-btn.stopped { background: linear-gradient(135deg, #10B981, #059669); color: white; }
    .main-btn:active { transform: scale(0.98); }
    
    /* Player controls */
    .player-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .ctrl-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 20px;
      background: #E7E5E4;
      color: #57534E;
      font-weight: 600;
      cursor: pointer;
    }
    .ctrl-btn:disabled { opacity: 0.4; }
    .ctrl-btn.stop-rec { background: #EF4444; color: white; }
    
    .actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .act-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.15s;
    }
    .act-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .act-btn:active:not(:disabled) { transform: scale(0.95); }
    .act-btn.delete { background: #FEE2E2; color: #991B1B; }
    .act-btn.create { background: #D1FAE5; color: #065F46; }
    .act-btn.share { background: #E0E7FF; color: #3730A3; }
    
    .log {
      margin-top: 20px;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 8px;
      color: #0f0;
      font-family: monospace;
      font-size: 0.7rem;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- NO MODAL - DIRECT ON PAGE -->
  <div class="container">
    <div class="header">RECORDER + PLAYER (NO MODAL)</div>
    <div class="body">
      <div class="time" id="time">0:00</div>
      
      <div class="player-controls">
        <button class="ctrl-btn" id="rewindBtn" onclick="rewind()" disabled>&lt;&lt;</button>
        <button class="ctrl-btn stop-rec" id="stopBtn" onclick="stopRec()" style="display:none;">STOP</button>
        <button class="ctrl-btn" id="playBtn" onclick="playPause()" disabled>PLAY</button>
        <button class="ctrl-btn" id="forwardBtn" onclick="forward()" disabled>&gt;&gt;</button>
      </div>
      
      <button class="main-btn ready" id="mainBtn" onclick="toggleRecord()">
        TAP TO RECORD
      </button>
      
      <div class="actions">
        <button class="act-btn delete" id="deleteBtn" onclick="deleteRec()" disabled>DELETE</button>
        <button class="act-btn create" id="createBtn" onclick="createDrop()" disabled>CREATE</button>
        <button class="act-btn share" id="shareBtn" onclick="shareRec()" disabled>SHARE</button>
      </div>
    </div>
  </div>
  
  <div class="log" id="log">Log:</div>

<script>
function log(msg) {
  const el = document.getElementById('log');
  el.textContent += '\n' + msg;
  el.scrollTop = el.scrollHeight;
}

// State
let state = 'ready';
let blob = null;
let recorder = null;
let chunks = [];
let stream = null;
let startTime = null;
let timerInt = null;
let audioEl = null;

// UI refs
const mainBtn = document.getElementById('mainBtn');
const stopBtn = document.getElementById('stopBtn');
const playBtn = document.getElementById('playBtn');
const rewindBtn = document.getElementById('rewindBtn');
const forwardBtn = document.getElementById('forwardBtn');
const deleteBtn = document.getElementById('deleteBtn');
const createBtn = document.getElementById('createBtn');
const shareBtn = document.getElementById('shareBtn');
const timeEl = document.getElementById('time');

function updateUI() {
  mainBtn.className = 'main-btn ' + state;
  
  if (state === 'ready') mainBtn.textContent = 'TAP TO RECORD';
  else if (state === 'recording') mainBtn.textContent = 'TAP TO PAUSE';
  else if (state === 'paused') mainBtn.textContent = 'TAP TO RESUME';
  else if (state === 'stopped') mainBtn.textContent = 'TAP TO RE-RECORD';
  
  stopBtn.style.display = (state === 'recording' || state === 'paused') ? 'block' : 'none';
  playBtn.style.display = (state === 'recording' || state === 'paused') ? 'none' : 'block';
  
  const hasRec = state === 'stopped' && blob;
  playBtn.disabled = !hasRec;
  rewindBtn.disabled = !hasRec;
  forwardBtn.disabled = !hasRec;
  deleteBtn.disabled = !hasRec;
  createBtn.disabled = !hasRec;
  shareBtn.disabled = !hasRec;
}

function updateTime() {
  const s = Math.floor((Date.now() - startTime) / 1000);
  timeEl.textContent = Math.floor(s/60) + ':' + (s%60).toString().padStart(2,'0');
}

function toggleRecord() {
  if (state === 'ready' || state === 'stopped') startRec();
  else if (state === 'recording') pauseRec();
  else if (state === 'paused') resumeRec();
}

async function startRec() {
  log('startRec');
  chunks = [];
  blob = null;
  
  stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const mime = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
  recorder = new MediaRecorder(stream, {mimeType: mime});
  
  recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
  recorder.onstop = () => {
    blob = new Blob(chunks, {type: recorder.mimeType});
    log('Blob: ' + blob.size);
    stream.getTracks().forEach(t=>t.stop());
    state = 'stopped';
    updateUI();
  };
  
  recorder.start(100);
  state = 'recording';
  startTime = Date.now();
  timerInt = setInterval(updateTime, 100);
  updateUI();
}

function pauseRec() {
  if (recorder?.state === 'recording') {
    recorder.pause();
    state = 'paused';
    clearInterval(timerInt);
    updateUI();
  }
}

function resumeRec() {
  if (recorder?.state === 'paused') {
    recorder.resume();
    state = 'recording';
    timerInt = setInterval(updateTime, 100);
    updateUI();
  }
}

function stopRec() {
  if (recorder && recorder.state !== 'inactive') {
    recorder.stop();
    clearInterval(timerInt);
  }
}

function playPause() {
  if (!blob) return;
  if (audioEl) {
    audioEl.pause();
    audioEl = null;
    playBtn.textContent = 'PLAY';
    return;
  }
  audioEl = new Audio(URL.createObjectURL(blob));
  audioEl.onended = () => { audioEl = null; playBtn.textContent = 'PLAY'; };
  audioEl.play();
  playBtn.textContent = 'PAUSE';
}

function rewind() { if (audioEl) audioEl.currentTime = Math.max(0, audioEl.currentTime - 10); }
function forward() { if (audioEl) audioEl.currentTime += 10; }

function deleteRec() {
  if (audioEl) { audioEl.pause(); audioEl = null; }
  blob = null;
  state = 'ready';
  timeEl.textContent = '0:00';
  updateUI();
  log('Deleted');
}

async function createDrop() {
  if (!blob) return;
  log('Creating drop...');
  createBtn.disabled = true;
  deleteBtn.disabled = true;
  shareBtn.disabled = true;
  createBtn.textContent = 'SAVING...';
  
  const base64 = await new Promise(r => {
    const rd = new FileReader();
    rd.onloadend = () => r(rd.result);
    rd.readAsDataURL(blob);
  });
  
  log('Base64: ' + base64.length);
  createBtn.textContent = 'CREATED!';
  createBtn.style.background = '#10B981';
  
  blob = null;
  state = 'ready';
  timeEl.textContent = '0:00';
  updateUI();
  
  setTimeout(() => {
    createBtn.textContent = 'CREATE';
    createBtn.style.background = '#D1FAE5';
  }, 1500);
}

function shareRec() {
  log('shareRec called');
  if (!blob) return;
  
  const name = 'audio.' + (blob.type.includes('mp4') ? 'm4a' : 'webm');
  const file = new File([blob], name, {type: blob.type});
  log('File: ' + name + ' ' + file.size);
  
  navigator.share({
    files: [file],
    title: 'Audio'
  }).then(() => {
    log('Share OK');
  }).catch(err => {
    log('Share err: ' + err.name + ' ' + err.message);
    if (err.name !== 'AbortError') {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      log('Downloaded');
    }
  });
}

log('Ready');
updateUI();
</script>
</body>
</html>
