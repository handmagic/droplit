<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTEX | Admin Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: #111;
      border-bottom: 1px solid #222;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      color: #f97316;
    }
    .logo span { color: #666; font-weight: 400; }
    .header-actions {
      display: flex;
      gap: 12px;
    }
    .header-btn {
      padding: 8px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .header-btn:hover {
      background: #222;
      color: #fff;
    }
    .header-btn.primary {
      background: #f97316;
      border-color: #f97316;
      color: #fff;
    }
    
    /* Layout */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card .label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }
    .stat-card .change {
      font-size: 12px;
      color: #4ade80;
      margin-top: 4px;
    }
    .stat-card .change.negative { color: #f87171; }
    .stat-card.highlight {
      border-color: #f97316;
      background: linear-gradient(135deg, #1a1008 0%, #111 100%);
    }
    
    /* Sections */
    .section {
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }
    .section-header {
      padding: 16px 20px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
    }
    .section-body {
      padding: 20px;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      font-size: 11px;
      text-transform: uppercase;
      color: #666;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    tr:hover {
      background: #1a1a1a;
    }
    
    /* Status badges */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .badge.success { background: #052e16; color: #4ade80; }
    .badge.warning { background: #422006; color: #f97316; }
    .badge.error { background: #2a0a0a; color: #f87171; }
    .badge.info { background: #0c1929; color: #60a5fa; }
    .badge.neutral { background: #222; color: #888; }
    
    /* Progress bar */
    .progress {
      height: 8px;
      background: #222;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #f97316;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .progress-bar.green { background: #4ade80; }
    
    /* Two columns */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    @media (max-width: 900px) {
      .two-col { grid-template-columns: 1fr; }
    }
    
    /* Drops breakdown */
    .breakdown {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .breakdown-item .name {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .breakdown-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .breakdown-item .count {
      font-weight: 600;
    }
    
    /* Worker status */
    .worker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .worker-card {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px;
    }
    .worker-card .name {
      font-weight: 500;
      margin-bottom: 8px;
    }
    .worker-card .schedule {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    .worker-card .last-run {
      font-size: 11px;
      color: #888;
    }
    
    /* Action buttons */
    .action-btn {
      padding: 6px 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #888;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #333;
      color: #fff;
    }
    .action-btn.danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    /* AI Usage */
    .usage-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .usage-row:last-child { border-bottom: none; }
    .usage-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .usage-value {
      font-weight: 600;
    }
    .usage-cost {
      color: #4ade80;
      font-size: 13px;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* Refresh indicator */
    .refresh-time {
      font-size: 11px;
      color: #444;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">CORTEX <span>/ Admin Dashboard</span></div>
    <div class="header-actions">
      <span class="refresh-time" id="refreshTime">‚Äî</span>
      <button class="header-btn" onclick="refreshAll()">üîÑ Refresh</button>
      <button class="header-btn primary" onclick="window.open('create-command.html')">+ New Command</button>
    </div>
  </header>
  
  <div class="container">
    <!-- Main Stats -->
    <div class="stats-grid" id="mainStats">
      <div class="stat-card">
        <div class="label">Total Drops</div>
        <div class="value" id="totalDrops">‚Äî</div>
      </div>
      <div class="stat-card highlight">
        <div class="label">Pending Commands</div>
        <div class="value" id="pendingCommands">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="label">Active Memories</div>
        <div class="value" id="activeMemories">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="label">Entities</div>
        <div class="value" id="totalEntities">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="label">Embeddings</div>
        <div class="value" id="totalEmbeddings">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="label">Coverage</div>
        <div class="value" id="embeddingsCoverage">‚Äî</div>
      </div>
    </div>
    
    <div class="two-col">
      <!-- Drops Breakdown -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üì¶ Drops Breakdown</h2>
        </div>
        <div class="section-body">
          <div class="breakdown" id="dropsBreakdown">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>
      
      <!-- Commands Status -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">‚ö° Commands Status</h2>
        </div>
        <div class="section-body">
          <div class="breakdown" id="commandsStatus">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Workers -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üîß Workers & Cron Jobs</h2>
        <button class="action-btn" onclick="triggerWorker('health')">Check Health</button>
      </div>
      <div class="section-body">
        <div class="worker-grid" id="workersGrid">
          <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>
    
    <div class="two-col">
      <!-- AI Usage -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">ü§ñ AI Usage (Estimated)</h2>
        </div>
        <div class="section-body">
          <div id="aiUsage">
            <div class="usage-row">
              <div class="usage-label">
                <span>Claude (Analysis)</span>
              </div>
              <div>
                <span class="usage-value" id="claudeTokens">‚Äî</span>
                <span class="usage-cost" id="claudeCost"></span>
              </div>
            </div>
            <div class="usage-row">
              <div class="usage-label">
                <span>OpenAI (Embeddings)</span>
              </div>
              <div>
                <span class="usage-value" id="openaiTokens">‚Äî</span>
                <span class="usage-cost" id="openaiCost"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Recent Insights -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">üîî Recent Insights</h2>
          <button class="action-btn danger" onclick="dismissAllInsights()">Dismiss All</button>
        </div>
        <div class="section-body">
          <div id="recentInsights">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Commands -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìã Recent Commands</h2>
      </div>
      <div class="section-body" style="padding: 0;">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Status</th>
              <th>Trigger</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="commandsTable">
            <tr><td colspan="5" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- System State -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìä System State</h2>
      </div>
      <div class="section-body" style="padding: 0;">
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="systemState">
            <tr><td colspan="3" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = 'https://ughfdhmyflotgsysvrrc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnaGZkaG15ZmxvdGdzeXN2cnJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDgwMTEsImV4cCI6MjA4MjQyNDAxMX0.s6oAvyk6gJU0gcJV00HxPnxkvWIbhF2I3pVnPMNVcrE';
    
    // ===== API HELPER =====
    async function query(endpoint) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }
    
    async function rpc(fn, params = {}) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify(params)
      });
      return response.json();
    }
    
    // ===== LOAD MAIN STATS =====
    async function loadMainStats() {
      try {
        // Get counts using separate queries
        const [drops, commands, memories, entities, embeddings] = await Promise.all([
          query('drops?select=id&limit=1&head=true'),
          query('drops?drop_group=eq.command&exec_status=eq.pending&select=id'),
          query('core_memory?is_active=eq.true&select=id'),
          query('core_entities?select=id'),
          query('drop_embeddings?select=id')
        ]);
        
        // For total drops we need a separate count query
        const dropsRes = await fetch(`${SUPABASE_URL}/rest/v1/drops?select=id`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Prefer': 'count=exact'
          }
        });
        const totalDrops = dropsRes.headers.get('content-range')?.split('/')[1] || '0';
        
        document.getElementById('totalDrops').textContent = totalDrops;
        document.getElementById('pendingCommands').textContent = commands.length || 0;
        document.getElementById('activeMemories').textContent = memories.length || 0;
        document.getElementById('totalEntities').textContent = entities.length || 0;
        document.getElementById('totalEmbeddings').textContent = embeddings.length || 0;
        
        const coverage = totalDrops > 0 ? ((embeddings.length / totalDrops) * 100).toFixed(1) + '%' : '0%';
        document.getElementById('embeddingsCoverage').textContent = coverage;
        
      } catch (error) {
        console.error('Stats error:', error);
      }
    }
    
    // ===== LOAD DROPS BREAKDOWN =====
    async function loadDropsBreakdown() {
      try {
        const drops = await query('drops?select=drop_group,drop_type');
        
        // Count by group
        const groups = {};
        const types = {};
        drops.forEach(d => {
          groups[d.drop_group] = (groups[d.drop_group] || 0) + 1;
          const key = `${d.drop_group}/${d.drop_type}`;
          types[key] = (types[key] || 0) + 1;
        });
        
        const colors = {
          info: '#4ade80',
          command: '#f97316',
          service: '#60a5fa'
        };
        
        let html = '';
        Object.entries(groups).sort((a, b) => b[1] - a[1]).forEach(([group, count]) => {
          html += `
            <div class="breakdown-item">
              <div class="name">
                <div class="dot" style="background: ${colors[group] || '#888'}"></div>
                <span>${group}</span>
              </div>
              <span class="count">${count}</span>
            </div>
          `;
        });
        
        document.getElementById('dropsBreakdown').innerHTML = html || '<p style="color:#666">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        
      } catch (error) {
        console.error('Breakdown error:', error);
      }
    }
    
    // ===== LOAD COMMANDS STATUS =====
    async function loadCommandsStatus() {
      try {
        const commands = await query('drops?drop_group=eq.command&select=exec_status');
        
        const statuses = {};
        commands.forEach(c => {
          statuses[c.exec_status] = (statuses[c.exec_status] || 0) + 1;
        });
        
        const statusColors = {
          pending: '#f97316',
          executed: '#4ade80',
          failed: '#f87171',
          cancelled: '#888',
          expired: '#666'
        };
        
        let html = '';
        Object.entries(statuses).sort((a, b) => b[1] - a[1]).forEach(([status, count]) => {
          html += `
            <div class="breakdown-item">
              <div class="name">
                <div class="dot" style="background: ${statusColors[status] || '#888'}"></div>
                <span>${status}</span>
              </div>
              <span class="count">${count}</span>
            </div>
          `;
        });
        
        document.getElementById('commandsStatus').innerHTML = html || '<p style="color:#666">–ù–µ—Ç –∫–æ–º–∞–Ω–¥</p>';
        
      } catch (error) {
        console.error('Commands status error:', error);
      }
    }
    
    // ===== LOAD WORKERS =====
    async function loadWorkers() {
      const workers = [
        { name: 'process_queue', schedule: '*/5 * * * *', desc: 'Drop Analysis' },
        { name: 'process_events', schedule: '* * * * *', desc: 'Commands' },
        { name: 'generate_embeddings', schedule: '*/5 * * * *', desc: 'Embeddings' },
        { name: 'cleanup_expired', schedule: '0 3 * * *', desc: 'Cleanup' },
        { name: 'proactive_check', schedule: '0 */6 * * *', desc: 'Proactive' }
      ];
      
      try {
        const state = await query('core_state?select=key,value,updated_at');
        const stateMap = {};
        state.forEach(s => stateMap[s.key] = s);
        
        let html = '';
        workers.forEach(w => {
          const lastRun = stateMap[`${w.name.replace('process_', '')}_last_run`] || stateMap['queue_last_run'];
          const lastTime = lastRun?.updated_at ? new Date(lastRun.updated_at).toLocaleString('ru-RU') : '‚Äî';
          
          html += `
            <div class="worker-card">
              <div class="name">${w.desc}</div>
              <div class="schedule"><code>${w.schedule}</code></div>
              <div class="last-run">Last: ${lastTime}</div>
              <button class="action-btn" style="margin-top:8px" onclick="triggerWorker('${w.name}')">Run</button>
            </div>
          `;
        });
        
        document.getElementById('workersGrid').innerHTML = html;
        
      } catch (error) {
        console.error('Workers error:', error);
      }
    }
    
    // ===== LOAD RECENT COMMANDS =====
    async function loadRecentCommands() {
      try {
        const commands = await query('drops?drop_group=eq.command&order=created_at.desc&limit=10&select=id,title,drop_type,exec_status,metadata,created_at,encryption_version');
        
        if (!commands.length) {
          document.getElementById('commandsTable').innerHTML = '<tr><td colspan="5" style="color:#666">–ù–µ—Ç –∫–æ–º–∞–Ω–¥</td></tr>';
          return;
        }
        
        const html = commands.map(cmd => {
          const title = cmd.encryption_version === 2 ? 'üîê [Encrypted]' : (cmd.title || '‚Äî');
          const trigger = cmd.metadata?.trigger_at ? new Date(cmd.metadata.trigger_at).toLocaleString('ru-RU') : '‚Äî';
          const created = new Date(cmd.created_at).toLocaleString('ru-RU');
          
          const statusClass = {
            pending: 'warning',
            executed: 'success',
            failed: 'error'
          }[cmd.exec_status] || 'neutral';
          
          return `
            <tr>
              <td>${title}</td>
              <td>${cmd.drop_type}</td>
              <td><span class="badge ${statusClass}">${cmd.exec_status}</span></td>
              <td>${trigger}</td>
              <td>${created}</td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('commandsTable').innerHTML = html;
        
      } catch (error) {
        console.error('Commands table error:', error);
      }
    }
    
    // ===== LOAD RECENT INSIGHTS =====
    async function loadRecentInsights() {
      try {
        const insights = await query('core_insights?order=created_at.desc&limit=5&select=id,title,status,created_at');
        
        if (!insights.length) {
          document.getElementById('recentInsights').innerHTML = '<p style="color:#666">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
          return;
        }
        
        const html = insights.map(i => {
          const statusClass = {
            pending: 'warning',
            delivered: 'info',
            dismissed: 'neutral'
          }[i.status] || 'neutral';
          
          return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1a1a1a">
              <span style="font-size:14px">${i.title}</span>
              <span class="badge ${statusClass}">${i.status}</span>
            </div>
          `;
        }).join('');
        
        document.getElementById('recentInsights').innerHTML = html;
        
      } catch (error) {
        console.error('Insights error:', error);
      }
    }
    
    // ===== LOAD SYSTEM STATE =====
    async function loadSystemState() {
      try {
        const state = await query('core_state?order=updated_at.desc&limit=10');
        
        if (!state.length) {
          document.getElementById('systemState').innerHTML = '<tr><td colspan="3" style="color:#666">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
          return;
        }
        
        const html = state.map(s => {
          const value = typeof s.value === 'object' ? JSON.stringify(s.value).slice(0, 100) + '...' : s.value;
          const updated = new Date(s.updated_at).toLocaleString('ru-RU');
          return `
            <tr>
              <td><code>${s.key}</code></td>
              <td style="font-size:12px;color:#888">${value}</td>
              <td>${updated}</td>
            </tr>
          `;
        }).join('');
        
        document.getElementById('systemState').innerHTML = html;
        
      } catch (error) {
        console.error('System state error:', error);
      }
    }
    
    // ===== LOAD AI USAGE =====
    async function loadAIUsage() {
      try {
        // Estimate based on analyzed drops and embeddings
        const memories = await query('core_memory?select=id');
        const embeddings = await query('drop_embeddings?select=id');
        
        // Rough estimates
        const claudeTokens = memories.length * 500; // ~500 tokens per analysis
        const openaiTokens = embeddings.length * 200; // ~200 tokens per embedding
        
        const claudeCost = (claudeTokens / 1000000 * 3).toFixed(2); // $3/M tokens (Sonnet)
        const openaiCost = (openaiTokens / 1000000 * 0.02).toFixed(4); // $0.02/M tokens (ada)
        
        document.getElementById('claudeTokens').textContent = claudeTokens.toLocaleString();
        document.getElementById('claudeCost').textContent = `~$${claudeCost}`;
        document.getElementById('openaiTokens').textContent = openaiTokens.toLocaleString();
        document.getElementById('openaiCost').textContent = `~$${openaiCost}`;
        
      } catch (error) {
        console.error('AI usage error:', error);
      }
    }
    
    // ===== TRIGGER WORKER =====
    async function triggerWorker(action) {
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/core-worker`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ action })
        });
        
        const result = await response.json();
        alert(`Worker ${action}: ${JSON.stringify(result, null, 2)}`);
        refreshAll();
        
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    // ===== DISMISS ALL INSIGHTS =====
    async function dismissAllInsights() {
      if (!confirm('Dismiss all pending insights?')) return;
      
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/core_insights?status=eq.pending`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ status: 'dismissed' })
        });
        
        alert('All insights dismissed');
        loadRecentInsights();
        
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
    
    // ===== REFRESH ALL =====
    async function refreshAll() {
      document.getElementById('refreshTime').textContent = 'Loading...';
      
      await Promise.all([
        loadMainStats(),
        loadDropsBreakdown(),
        loadCommandsStatus(),
        loadWorkers(),
        loadRecentCommands(),
        loadRecentInsights(),
        loadSystemState(),
        loadAIUsage()
      ]);
      
      document.getElementById('refreshTime').textContent = new Date().toLocaleTimeString('ru-RU');
    }
    
    // Initial load
    refreshAll();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshAll, 30000);
  </script>
</body>
</html>
